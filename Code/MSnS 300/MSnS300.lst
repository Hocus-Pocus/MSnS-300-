
MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 1
MC68HC908GP32 User Bootloader


                        1  ;***************************************************
                                   ********************************************
                        2  ****************************************************
                                   ********************************************
                        3  ;   MSnS300.asm
                        4  ;
                        5  ;   Based on the work of Bruce Bowling and Al 
                                   Grippo for the original B&G and Hi Res code.
                        6  ;   Also Magnus Bjelk for his megasquirtnspark and 
                                          the msnsextra team as well as all the
                        7  ;   unknown contributors to the MS project.
                        8  ;   Special thanks to Eric Fahlgren with the early 
                                            help integrating with Megatune, and
                        9  ;   Phil Tobin for assisting in integrating with 
                                                                   Tuner Studio
                       10  ;
                       11  ;   Robert Hiebert 2010
                       12  ;
                       13  ; Rev 1: 4/10/11 - KPA bins changed to include 17 
                                    KPA. AFR target tables converted to Lambda.
                       14  ;                  ADC averaging put back in.
                       15  ;
                       16  ; Rev 2: 10/31/11 - Knock detector code added.
                       17  ;
                       18  ; Rev 3: 4/11/12 - ASE counter and bank flow rate 
                                                     variables and code changes
                       19  ;
                       20  ; Rev 4: 6/29/12 - Modify code for tachH:tachL for 
                                       Hi Res RPM calcs. Average 16 readings to
                       21  ;                  to smooth things out.
                       22  ;
                       23  ; Rev 5: 7/16/12 - Revise period averaging for Hi 
                                       Res Tach calcs. Total periods for 250 ms
                       24  ;                  then divide by "tachcnt". Code 
                                                      is slower but works well.
                       25  ;                  Average "batt" and "ego" over 32 
                                                iterations to smooth things out
                       26  ;                  (~250ms update)
                       27  ;
                       28  ;***************************************************
                                   ********************************************
                       29  ;***************************************************
                                   ********************************************
                       30  
                       31  ;***************************************************
                                   ********************************************
                       32  ; This variant of the Megasquirt code was developed 
                                           as part of "Megacontrol", a complete
                       33  ; powertrain management system for fuel, ignition, 
                                   and transmission control replacing the EECIV
                       34  ; on a relatively stock, daily driven 1995 Ford 
                                E-150. The E-150 is equipped with a 4.9L inline
                       35  ; 6 cyl engine 14 #/Hr injectors and E4OD transmissi
                                             on.  Fall back position in case of
                       36  ; "Megacontrol" failure is to revert to EECIV 
                                     control, so it is as close as practical to
                       37  ; "Plug and Play". The code is a compilation of 
                                     Megasquirtnspark, MegasquirtHR, Megaspark,


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 2
MC68HC908GP32 User Bootloader


                       38  ; msns-extra and some additions and revisions of my 
                                    own to suit my own needs. The HR version of
                       39  ; fuel control was chosen for best resolution 
                                running the small stock injectors in "6 squirts
                       40  ; alternating" mode. Added features are a modified 
                                    version of Megabaro, Fuel and Ignition Trim
                       41  ; control, and the vehicle speed and ignition 
                                   monitor inputs. A manual control for the PWM
                       42  ; bypass idle air is part of the transmission 
                                  controller. A Manual Decel Fuel Cut Enable is
                       43  ; also part of the transmission controller.
                       44  ;***************************************************
                                   ********************************************
                       45  
                       46  ;***************************************************
                                   ********************************************
                       47  ;
                       48  ; ----------------------------------- MSnS300 
                             Hardware Wiring ----------------------------------
                       49  ;
                       50  ;***************************************************
                                   ********************************************
                       51  ;
                       52  ; ----- Inputs [port name - function] -----
                       53  ;
                       54  ;  IRQ       - PIP (Profile Ignition Pickup)Input
                       55  ;             (Rising edge at 10 degrees BTDC on 
                                                        Pin 24,inverted to IRQ)
                       56  ;  PTB0/AD0 - Manifold Absolute Pressure
                       57  ;  PTB1/AD1 - Manifold Air Temperature
                       58  ;  PTB2/AD2 - Coolant Temperature
                       59  ;  PTB3/AD3 - Throttle Position Sensor
                       60  ;  PTB4/AD4 - Battery Voltage
                       61  ;  PTB5/AD5 - Exhaust Gas Oxygen
                       62  ;  PTB6/AD6 - Fuel or Ignition Trim
                       63  ;  PTB7/AD7 - Barometric Pressure
                       64  ;  PTA2     - Decel Fuel Cut Enable
                       65  ;  PTA3     - Vehicle Speed
                       66  ;  PTA4     - Ignition Monitor
                       67  ;  PTA5     - Fuel/Ignition Trim Select
                       68  ;  PTA6     - Knock Detector Input
                       69  ;
                       70  ; ----- Outputs [port name - function] -----
                       71  ;
                       72  ;  PTD4/T1CH0 - Injector 1
                       73  ;  PTD5/T1CH1 - Injector 2
                       74  ;  PTA0       - Fuel Pump Relay driver transistor, 
                                                                        sinking
                       75  ;  PTA1        - SPOUT (Spark Output) driver 
                                              transistor, sinking, with pullup,
                       76  ;               for TFI module, 50% duty cycle, 
                                                           fires on rising edge
                       77  ;  PTA7       - Program Loop Frequency Pin
                       78  ;  PTC0        - Accumulated Injector On Time(open 
                                                                     collector)
                       79  ;  PTC1        - Accel LED
                       80  ;  PTC2        - Warmup LED
                       81  ;


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 3
MC68HC908GP32 User Bootloader


                       82  ;***************************************************
                                   ********************************************
                       83  ;***************************************************
                                   ********************************************
                       84  ;
                       85  ; -----Assembler Directives -----
                       86  ;
                       87  ; EQU    - Equate -Define label equal to operand
                       88  ; RMB    - Reserve Memory Byte -  Reserve number of 
                                                                bytes in memory
                       89  ;          as specified by operand
                       90  ; DS#n   - Define Storage - Reserve n number of 
                                                                bytes in memory
                       91  ;          as specified by operand
                       92  ;
                       93  ;***************************************************
                                   ********************************************
                       94  
                       95  ;***************************************************
                                   ********************************************
                       96  ; ram_start         = memory location $0040(64T)(GP3
                                                                          2equ)
                       97  ; ram_last          = memory location $023F(575T)(GP
                                                                         32equ)
                       98  ; rom_start         = memory location $8000(32768)(G
                                                                        P32equ)
                       99  ; rom_last          = memory location $FDFF(65023)(G
                                                                        P32equ)
                      100  ; init_stack        = ram_exec = memory location 
                                                            $01ED(493)(bootr12)
                      101  ; ms_ram_start      = memory location $0040(64)(MS_E
                                                                       CU_HP.h)
                      102  ; ms_ram_end        = memory location $00D0(208)(MS_
                                                                      ECU_HP.h)
                      103  ; ms_rf_start       = memory location $00D0(208)(MS_
                                                                      ECU_HP.h)
                      104  ; ms_rf_end         = memory location $01B0(432)(MS_
                                                                      ECU_HP.h)
                      105  ; ms_ram_size       = {ms_ram_end-ms_ram_start}($00D
                                        0-$0040=$0090)(208-64=144)(MS_ECU_HP.h)
                      106  ; ms_rf_size        = {ms_rf_end-ms_rf_start}}($01B0
                                        -$00D0=$00E0)(432-208=224)(MS_ECU_HP.h)
                      107  ; ms_total_ram_size = {ms_rf_end-ms_ram_start}}($01B
                                        0-$0040=$0170)(432-64=368)(MS_ECU_HP.h)
                      108  ;***************************************************
                                   ********************************************
                      109  
                      110  
 0040                 111       org        ram_start                  ; Origin  Memory location $0040(64)
 0040                 112       include "MSnS300.inc"                ; Include definitions for
                      113  ;************************************************************************************************
                      114  ;************************************************************************************************
                      115  ;   MSnS300.inc (include file for MSnS300.asm)
                      116  ;   
                      117  ;   Based on the work of Bruce Bowling and Al Grippo for the original B&G and Hi Res code.
                      118  ;   Also Magnus Bjelk for his megasquirtnspark and the msnsextra team as well as all the 
                      119  ;   unknown contributors to the MS project.
                      120  ;   Special thanks to Eric Fahlgren with the early help integrating with Megatune, and 
                      121  ;   Phil Tobin for assisting in integrating with Tuner Studio
                      122  ;
                      123  ;   Robert Hiebert 2010
                      124  ;
                      125  ; Rev 1: 4/10/11 - KPA bins changed to include 17 KPA. AFR target tables converted to Lambda.
                      126  ;                  ADC averaging put back in.
                      127  ;
                      128  ; Rev 2: 10/31/11 - Knock detector code added.
                      129  ;
                      130  ; Rev 3: 4/11/12 - ASE counter and bank flow rate variables and code changes
                      131  ;
                      132  ; Rev 4: 6/29/12 - Modify code for tachH:tachL for Hi Res RPM calcs. Average 16 readings to
                      133  ;                  to smooth things out.
                      134  ;
                      135  ; Rev 5: 7/16/12 - Revise period averaging for Hi Res Tach calcs. Total periods for 250 ms
                      136  ;                  then divide by "tachcnt". Code is slower but works well.
                      137  ;                  Average "batt" and "ego" over 32 iterations to smooth things out 
                      138  ;                  (~250ms update)
                      139  ;
                      140  ;***********************************************************************************************
                      141  
                      142  ;***********************************************************************************************
                      143  ;***********************************************************************************************
                      144  ; This variant of the Megasquirt code was developed as part of "Megacontrol", a complete 
                      145  ; powertrain management system for fuel, ignition, and transmission control replacing the EECIV 
                      146  ; on a relatively stock, daily driven 1995 Ford E-150. The E-150 is equipped with a 4.9L inline 
                      147  ; 6 cyl engine 14 #/Hr injectors and E4OD transmission.  Fall back position in case of 
                      148  ; "Megacontrol" failure is to revert to EECIV control, so it is as close as practical to 
                      149  ; "Plug and Play". The code is a compilation of Megasquirtnspark, MegasquirtHR, Megaspark, 
                      150  ; msns-extra and some additions and revisions of my own to suit my own needs. The HR version of 
                      151  ; fuel control was chosen for best resolution running the small stock injectors in "6 squirts 
                      152  ; alternating" mode. Added features are a modified version of Megabaro, Fuel and Ignition Trim 
                      153  ; control, and the vehicle speed and ignition monitor inputs. A manual control for the PWM 
                      154  ; bypass idle air is part of the transmission controller. A Manual Decel Fuel Cut Enable is 
                      155  ; also part of the transmission controller.
                      156  ;***********************************************************************************************
                      157  
                      158  ;***********************************************************************************************
                      159  ;
                      160  ; ----------------------------------- MSnS300 Hardware Wiring ----------------------------------
                      161  ;
                      162  ;***********************************************************************************************
                      163  ;
                      164  ; ----- Inputs [port name - function] -----
                      165  ;
                      166  ;  IRQ       - PIP (Profile Ignition Pickup)Input
                      167  ;             (Rising edge at 10 degrees BTDC on Pin 24,inverted to IRQ)
                      168  ;  PTB0/AD0 - Manifold Absolute Pressure
                      169  ;  PTB1/AD1 - Manifold Air Temperature
                      170  ;  PTB2/AD2 - Coolant Temperature
                      171  ;  PTB3/AD3 - Throttle Position Sensor
                      172  ;  PTB4/AD4 - Battery Voltage
                      173  ;  PTB5/AD5 - Exhaust Gas Oxygen
                      174  ;  PTB6/AD6 - Fuel or Ignition Trim
                      175  ;  PTB7/AD7 - Barometric Pressure
                      176  ;  PTA2     - Decel Fuel Cut Enable
                      177  ;  PTA3     - Vehicle Speed
                      178  ;  PTA4     - Ignition Monitor
                      179  ;  PTA5     - Fuel/Ignition Trim Select(Hi(set) = Fuel Trim, Lo(clr) = Ign Trim)
                      180  ;  PTA6     - Knock Detector Input
                      181  ;
                      182  ; ----- Outputs [port name - function] -----
                      183  ;
                      184  ;  PTD4/T1CH0 - Injector 1
                      185  ;  PTD5/T1CH1 - Injector 2
                      186  ;  PTA0       - Fuel Pump Relay driver transistor, sinking
                      187  ;  PTA1        - SPOUT (Spark Output) driver transistor, sinking, with pullup,
                      188  ;               for TFI module, 50% duty cycle, fires on rising edge
                      189  ;  PTA7       - Program Loop Frequency Pin
                      190  ;  PTC0        - Accumulated Injector On Time(open collector)
                      191  ;  PTC1        - Accel LED
                      192  ;  PTC2        - Warmup LED
                      193  ;
                      194  ;***********************************************************************************************
                      195  ;***********************************************************************************************
                      196  ;
                      197  ; -----Assembler Directives -----
                      198  ;


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 4
MC68HC908GP32 User Bootloader


                      199  ; EQU    - Equate -Define label equal to operand
                      200  ; RMB    - Reserve Memory Byte -  Reserve number of bytes in memory
                      201  ;          as specified by operand
                      202  ; DS#n   - Define Storage - Reserve n number of bytes in memory
                      203  ;          as specified by operand
                      204  ;
                      205  ;***********************************************************************************************
                      206  
                      207  ;***********************************************************************************************
                      208  ; --------------------------------- Input Port Equates -----------------------------------------
                      209  ;***********************************************************************************************
                      210  
 0040                 211  DFC_en      equ 2     ; Decel Fuel Cut Enable on Port A2
 0040                 212  Veh_Spd     equ 3     ; Vehicle Speed Input on Port A3
 0040                 213  Ign_Mon     equ 4     ; Ignition Monitor on Port A4
 0040                 214  Trm_Sel     equ 5     ; Fuel/ Ignition Trim Select on Port A5
 0040                 215  Knk_Det:    equ 6     ; Knock detected on Port A6
                      216  
                      217  ;***********************************************************************************************
                      218  ; ----------------------------------- Output Port Equates --------------------------------------
                      219  ;***********************************************************************************************
                      220  
 0040                 221  inject1     equ 4     ; Injector 1 on Port D4
 0040                 222  inject2     equ 5     ; Injector 2 on Port D5
 0040                 223  fuelp       equ 0     ; Fuel Pump Relay on Port A0
 0040                 224  spark       equ 1     ; Spark Output on Port A1
 0040                 225  Loopchk     equ 7     ; Program loop frequency pin on Port A7
 0040                 226  aiot        equ 0     ; 25.5ms injector on time pulse on Port C0
 0040                 227  aled        equ 1     ; "Accelleration Enrichments" on Port C1
 0040                 228  wled        equ 2     ; "Warmup enrichments" on Port C2
                      229  
                      230  ;***********************************************************************************************
                      231  ; ---------------------- "Squirt" Event Scheduling  bit field equates  -------------------------
                      232  ;***********************************************************************************************
                      233  
 0040                 234  inj1:       equ 0     ; 1 = INJ1 fire          0 = INJ1 no fire
 0040                 235  inj2:       equ 1     ; 1 = INJ2 fire          0 = INJ2 no fire
 0040                 236  sched1:     equ 2     ; 1 = INJ1 scheduled     0 = INJ1 not scheduled
 0040                 237  firing1:    equ 3     ; 1 = INJ1 firing        0 = INJ1 not firing
 0040                 238  sched2:     equ 4     ; 1 = INJ2 scheduled     0 = INJ2 not scheduled
 0040                 239  firing2:    equ 5     ; 1 = INJ2 firing        0 = INJ2 not firing
                      240  
                      241  ;***********************************************************************************************
                      242  ; ----------------------- "Engine" Operating Status bit field equates --------------------------
                      243  ;***********************************************************************************************
                      244  
 0040                 245  running:    equ 0    ; 1 = Engine running      0 = Engine not running
 0040                 246  crank:      equ 1    ; 1 = Engine cranking     0 = Engine not cranking
 0040                 247  startw:     equ 2    ; 1 = Warmup enrich       0 = Not in startup warmup
 0040                 248  warmup:     equ 3    ; 1 = In warmup           0 = Not in warmup
 0040                 249  tpsaen:     equ 4    ; 1 = TPS accel mode      0 = Not in TPS accel mode
 0040                 250  tpsden:     equ 5    ; 1 = Decel mode          0 = Not in decel mode
                      251  
                      252  ;***********************************************************************************************
                      253  ; ------------------------ "Engine2" Operating Status bit field equates ------------------------
                      254  ;***********************************************************************************************
                      255  
 0040                 256  run         equ 0     ; 1 = in Run mode              0 = not in Run mode
 0040                 257  schedspk    equ 1     ; 1 = Spark scheduled flag     0 = "schedspk" cleared
 0040                 258  sparking    equ 2     ; 1 = Spark in progress flag   0 = "sparking" cleared
 0040                 259  started     equ 3     ; 1 = Engine has started       0 = Engine not started
 0040                 260  cant_crank  equ 4     ; 1 = Crank mode inhibit       0 = Crank mode OK
 0040                 261  cant_delay  equ 5     ; 1 = Crank mode delay         0 = Crank mode not delay
                      262  
                      263  ;***********************************************************************************************
                      264  ; -------------------------- "inputs" Operating Status bit field equates -----------------------
                      265  ;***********************************************************************************************
                      266  
 0040                 267  piprise     equ 0     ; 1 = PIP rising edge flag       0 = "piprise" cleared
 0040                 268  adcc        equ 1     ; 1 = ADC complete flag          0 = "adcc" cleared
 0040                 269  MONen       equ 2     ; 1 = Ign Mon KBI enabled        0 = MON KBI disabled
 0040                 270  VSen        equ 3     ; 1 = Veh Spd KBI enabled        0 = VS KBI disabled
 0040                 271  clock100    equ 4     ; 1 = 100mS clock tick           0 = "clock100" cleared
 0040                 272  clock250    equ 5     ; 1 = 250mS clock tick           0 = "clock250" cleared
 0040                 273  clock500    equ 6     ; 1 = 500mS clock tick           0 = "clock500" cleared
                      274  
                      275  ;***********************************************************************************************
                      276  ; ----------------------- "alarmbits" Operating Status bit field equates -----------------------
                      277  ;***********************************************************************************************
                      278  
 0040                 279  knocking:   equ 0     ; 1 = Engine Knock               0 = No Engine Engine Knock
 0040                 280  REVL:       equ 1     ; 1 = Engine Rev Limit           0 = No Engine Rev Limit 
 0040                 281  fldClr:     equ 2     ; 1 = Engine Flood Clear         0 = No Engine Flood Clear
                      282  
                      283  ;***********************************************************************************************
                      284  ; ----------------------- "portAbits" Operating Status bit field equates -----------------------
                      285  ;***********************************************************************************************
                      286  
 0040                 287  FPon:     equ 0    ; 1 = Fuel Pump On            0 = Fuel Pump Not On
 0040                 288  FTen:     equ 5    ; 1 = Fuel Trim Enabled       0 = Ignition Trim Enabled
                      289  
                      290  ;***********************************************************************************************
                      291  ; ----------------------- "portCbits" Operating Status bit field equates -----------------------
                      292  ;***********************************************************************************************
                      293  
 0040                 294  acclLED:     equ 1    ; 1 = Accel LED on          0 = Accel LED not on
 0040                 295  wmLED:       equ 2    ; 1 = Warmup LED on         0 = Warmup LED not on
                      296  
                      297  ;***********************************************************************************************
                      298  ; ---------------------------------------- Misc. equates ---------------------------------------
                      299  ;***********************************************************************************************
                      300  
 0040                 301  Stat_Tim_Ang   equ $0A     ; Static Timing Angle 10 degrees BTDC
 0040                 302  PAGESIZE       equ $A8     ;(168)Size of the data page, used by the P and C commands
                      303  
                      304  ms_ram_start:
                      305  
                      306  ;***********************************************************************************************
                      307  ; --------------------------- RAM Variables (512 bytes available) ------------------------------
                      308  ; I/O registers from $0000 to $0039 (decimal 0 to 63)
                      309  ; Direct page addressing from $0000 to $00FF (decimal 0 to 255)
                      310  ; Ram end at $023F (decimal 575)
                      311  ;***********************************************************************************************
                      312  ;***********************************************************************************************
                      313  ; ---------------------- RS232 Real Time Download and Datalog Variables ------------------------
                      314  ;***********************************************************************************************
                      315  
                      316  ; - Memory Location $0040 (decimal 64)
                      317  
 0040                 318  secl:           ds 1 ; Low seconds - from 0 to 255, then rollover
 0041                 319  map:           ds 1 ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 0042                 320  mat:           ds 1 ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 0043                 321  clt:           ds 1 ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 0044                 322  tps:           ds 1 ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 0045                 323  batt:                  ds 1 ; Battery Voltage ADC Raw Reading - counts (0 - 255)(AD4)
 0046                 324  ego:            ds 1 ; Exhaust Gas Oxygen ADC Raw Reading - counts (0 - 255)(AD5)
 0047                 325  trim:           ds 1 ; Fuel/Ignition Trim ADC Raw Reading - counts (0 - 255)(AD6)
 0048                 326  baro:           ds 1 ; Barometric Pressure ADC Raw Reading - counts (0 - 255)(AD7)
 0049                 327  barometer:      ds 1 ; Current barometer reading in KPA (for MV)
 004A                 328  barocor:        ds 1 ; Barometer Lookup Correction - percent
 004B                 329  warmcor:        ds 1 ; Total Warmup Correction - percent
 004C                 330  aircor:         ds 1 ; Air Density Correction lookup - percent
 004D                 331  Ftrimcor:       ds 1 ; Fuel Trim Correction Factor (85% - 115%)
 004E                 332  gammae:         ds 1 ; Total Gamma Enrichments - percent
 004F                 333  tpsaccel:       ds 1 ; Acceleration enrichment - percent
                      334  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 5
MC68HC908GP32 User Bootloader


                      335  ; - Memory Location $0050 (decimal 80)
                      336  
 0050                 337  rpm20:          ds 1 ; Computed engine RPM - rpm/20
 0051                 338  vecurr:         ds 1 ; Current VE value from lookup table - percent
 0052                 339  pwcalcH:        ds 1 ; high order of calculated pulsewith (16 bits)
 0053                 340  pwcalcL:        ds 1 ; low order of calculated pulsewidth (16 bits)
 0054                 341  pw:             ds 1 ; injector squirt time in 1/10 millesec (0 to 25.5 millisec) - applied
 0055                 342  fd:             ds 1 ; Fuel Delivery PW Lo Res
 0056                 343  fdSecH:         ds 1 ; Fuel Delivery PW Lo Res over 1 second Hi byte
 0057                 344  fdSecL:         ds 1 ; Fuel Delivery PW Lo Res over 1 second Lo byte
 0058                 345  tachH:          ds 1 ; Tachometer period averaged over 16 periods Hi byte 
 0059                 346  tachL:          ds 1 ; Tachometer period averaged over 16 periods Lo byte 
 005A                 347  Spk_Ang_Fac:    ds 1 ; Spark Angle Factor (from ST table)
 005B                 348  Trm_Ang_Fac:    ds 1 ; Trim Angle Factor (from IgnTrimcor table)
 005C                 349  Dly_Ang_Fac:    ds 1 ; Delay Angle Factor (Spk_Ang_Fac + Trm_Ang_Fac)
 005D                 350  odoSec:         ds 1 ; Odometer counts over 1 second
 005E                 351  VS_pH:          ds 1 ; Vehicle speed period Hi byte
 005F                 352  VS_pL:          ds 1 ; Vehicle speed period Lo byte
                      353  
                      354  ; - Memory Location $0060 (decimal 96)
                      355  
 0060                 356  MON_pH:         ds 1 ; MON period Hi byte (MON_tsH - PIP_tsH)
 0061                 357  MON_pL:         ds 1 ; MON period Lo byte (MON_tsL - PIP_tsL)
 0062                 358  tpsp:           ds 1 ; Throttle position percent
 0063                 359  engine:         ds 1 ; Variable bit-field to hold engine current status
 0064                 360  alarmbits:      ds 1 ; Engine Alarm Status Bit Field
 0065                 361  portAbits:      ds 1 ; Port A status Bit field
 0066                 362  portCbits:      ds 1 ; Port C Status Bit Field
 0067                 363  BnkflowHmv:     ds 1 ; Injector bank flow rate L/hr x 10 Hi byte for MV
 0068                 364  BnkflowLmv:     ds 1 ; Injector bank flow rate L/hr x 10 Lo byte for MV
                      365  
                      366  ;***********************************************************************************************
                      367  ; This marks the end of the real time download variables, 41 in total
                      368  ;***********************************************************************************************
                      369  
                      370  ;***********************************************************************************************
                      371  ; Bit Field Variables
                      372  ;***********************************************************************************************
                      373  
 0069                 374  engine2:        ds 1 ; Variable bit-field to hold engine current status #2
 006A                 375  squirt:         ds 1 ; Event variable bit field for Injector Firing
 006B                 376  inputs:         ds 1 ; Bit field variable for input status flags
                      377  
                      378  ;***********************************************************************************************
                      379  ; ADC Conversion Variables
                      380  ;***********************************************************************************************
                      381  
 006C                 382  kpa:            ds 1 ; MAP value in units of KPa
 006D                 383  coolant:        ds 1 ; Coolant temperature in Degrees F + 40 (allows -40 degress to fit in int)
                      384  
                      385  ;***********************************************************************************************
                      386  ; ADC Calculation Variables
                      387  ;***********************************************************************************************
                      388  
 006E                 389  adsel:      ds 1 ; ADC Selector Variable
                      390  
                      391  ;***********************************************************************************************
                      392  ; Fuel Calculation Variables
                      393  ;***********************************************************************************************
                      394  
 006F                 395  pwnadH:        ds 1     ; Calculated PW without Accel and deadband Hi byte
                      396  
                      397  ; - Memory Location $0070 (decimal 112)
                      398  
 0070                 399  pwnadL:        ds 1     ; Calculated PW without Accel and deadband Lo byte
 0071                 400  fdhrH:         ds 1     ; Calc PW without deadband Hi byte (fuel delivery)
 0072                 401  fdhrL:         ds 1     ; Calc PW without deadband Lo byte (fuel delivery)
 0073                 402  deadband:      ds 1     ; Injector deadband in 100uS resolution
 0074                 403  tpsfuelcut:    ds 1     ; TPS Fuel Cut (percent)
                      404  
                      405  ;***********************************************************************************************
                      406  ; Engine RPM -> RPM = 12000/(ncyl * (rpmph - rpmpl))
                      407  ;***********************************************************************************************
                      408  
 0075                 409  rpmph:      ds 1 ; High part of RPM Period
 0076                 410  rpmpl:      ds 1 ; Low part of RPM Period
 0077                 411  rpmch:      ds 1 ; Counter for high part of RPM
 0078                 412  rpmcl:      ds 1 ; Counter for low part of RPM
                      413  
                      414  ;***********************************************************************************************
                      415  ; Timer Variables
                      416  ;***********************************************************************************************
                      417  
 0079                 418  mSx250:     ds 1 ; 250 Milliseconds counter
 007A                 419  mSx100:     ds 1 ; 100 Milliseconds counter
 007B                 420  mS:         ds 1 ; Milliseconds counter
 007C                 421  uSx100:     ds 1 ; 100 Microseconds counter
 007D                 422  sech:       ds 1 ; high seconds - rollover at 65536 secs (1110.933 minutes, 18.51 hours)
 007E                 423  tpsaclk:    ds 1 ; TPS enrichment timer clock in 0.1 second resolution
 007F                 424  asecount:   ds 1 ; Counter value for after-start enrichment counter - every ignition pulse
                      425  
                      426  ; - Memory Location $0080 (decimal 128)
                      427  
 0080                 428  last_tps:   ds 1 ; TPS reading updated every 0.1 seconds
 0081                 429  igncount:   ds 1 ; Ignition pulse counter
 0082                 430  altcount:   ds 1 ; Alternate count selector
 0083                 431  tpsaclkcmp: ds 1 ; Comparison value for TPS acceleration time - from lookup table
                      432  
                      433  ;***********************************************************************************************
                      434  ; SCI parameters/variables
                      435  ;***********************************************************************************************
                      436  
 0084                 437  txcnt:      ds 1 ; SCI transmitter count (incremented)
 0085                 438  txgoal:     ds 1 ; SCI number of bytes to transmit
 0086                 439  txmode:     ds 1 ; Transmit mode flag
 0087                 440  rxoffset:   ds 1 ; offset placeholder when receiving VE/constants vis. SCI
                      441  
                      442  ;***********************************************************************************************
                      443  ; Routines for integer math - storage variables
                      444  ;***********************************************************************************************
                      445  
 0088                 446  INTACC1       rmb 4
 008C                 447  INTACC2       rmb 4
                      448  
                      449  
                      450  ; - Memory Location $0090 (decimal 144)(at INTACC2+2)
                      451  
                      452  ;***********************************************************************************************
                      453  ; Temporary variables
                      454  ;***********************************************************************************************
                      455  
 0090                 456  tmp1    ds 1
 0091                 457  tmp2    ds 1
 0092                 458  tmp3    ds 1
 0093                 459  tmp4    ds 1
 0094                 460  tmp5    ds 1
 0095                 461  tmp6    ds 1
 0096                 462  tmp7    ds 1
 0097                 463  tmp8    ds 1
 0098                 464  tmp9    ds 1
 0099                 465  tmp10   ds 1
 009A                 466  tmp11   ds 1
 009B                 467  tmp12   ds 1
 009C                 468  tmp13   ds 1
 009D                 469  tmp14   ds 1
 009E                 470  tmp15   ds 1


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 6
MC68HC908GP32 User Bootloader


 009F                 471  tmp16   ds 1
                      472  
                      473  ; - Memory location $00A0 (decimal 160)
                      474  
 00A0                 475  tmp17   ds 1
 00A1                 476  tmp18   ds 1
 00A2                 477  tmp19   ds 1
 00A3                 478  tmp20   ds 1
 00A4                 479  tmp21   ds 1
 00A5                 480  tmp22   ds 1
                      481  
                      482  
                      483  ;***********************************************************************************************
                      484  ; ----------------------------- Spark Timing  Control Variables --------------------------------
                      485  ;***********************************************************************************************
                      486  
 00A6                 487  PIP_tsH:        ds 1     ; PIP timestamp current reading Hi byte
 00A7                 488  PIP_tsL:        ds 1     ; PIP timestamp current reading Lo byte
 00A8                 489  PIP_tsH_prv:    ds 1     ; PIP timestamp previous reading Hi byte
 00A9                 490  PIP_tsL_prv:    ds 1     ; PIP timestamp previous reading Lo byte
 00AA                 491  PIP_pH_prv:     ds 1     ; PIP period Hi byte previous
 00AB                 492  PIP_pL_prv:     ds 1     ; PIP period Lo byte previous
 00AC                 493  PIP_pH_dif:     ds 1     ; PIP period difference Hi byte(PIP_pH - PIP_pH_prv)
 00AD                 494  PIP_pL_dif:     ds 1     ; PIP period difference Lo byte(PIP_pL - PIP_pL_prv)
 00AE                 495  PIP_pH:         ds 1     ; PIP period Hi byte (PIP_tsH - PIP_tsH_prv)
 00AF                 496  PIP_pL:         ds 1     ; PIP period Lo byte (PIP_tsL - PIP_tsL_prv)
                      497  
                      498  ; - Memory location $00B0 (decimal 176)
                      499  
 00B0                 500  PIP_pH_pred:    ds 1     ; Predicted PIP period Hi byte (PIP_pH + PIP_pH_dif)
 00B1                 501  PIP_pL_pred:    ds 1     ; Predicted PIP period Lo byte (PIP_pL + PIP_pL_dif)
 00B2                 502  Delay_pH:       ds 1     ; Delay period from PIP to SPOUT, Hi byte
 00B3                 503  Delay_pL:       ds 1     ; Delay period from PIP to SPOUT, Lo byte
                      504                           ;(16 bit result of Mul_Hi:Mul_Mid:Mul_Lo / $FF)
 00B4                 505  CH1_onH:        ds 1     ; T2CH1 output compare for SPOUT rising, Hi byte
 00B5                 506  CH1_onL:        ds 1     ; T2CH1 output compare for SPOUT rising, Lo byte
                      507                           ;(PIP_tsH:PIP_tsL + Delay_pH:Delay_pL)
 00B6                 508  SPOUT_tsH:      ds 1     ; SPOUT timestamp current reading Hi byte
 00B7                 509  SPOUT_tsL:      ds 1     ; SPOUT timestamp current reading Lo byte
 00B8                 510  PIP_periodH:    ds 1     ; PIP period Hi byte (for SPOUT off calcs)
 00B9                 511  PIP_periodL:    ds 1     ; PIP period Lo byte (for SPOUT off calcs)
 00BA                 512  SPOUTon_pH:     ds 1     ; SPOUT on period Hi byte
 00BB                 513  SPOUTon_pL:     ds 1     ; SPOUT on period Lo byte
                      514                           ;(50% duty cycle, half of PIP period)
 00BC                 515  CH1_offH:       ds 1     ; T2CH1 output compare for SPOUT falling, Hi byte
 00BD                 516  CH1_offL:       ds 1     ; T2CH1 output compare for SPOUT falling, Lo byte
                      517                           ;(SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL)
                      518  
                      519  
                      520  ;***********************************************************************************************
                      521  ; ------------------------- Ignition Monitor Calculation Variables -----------------------------
                      522  ;***********************************************************************************************
                      523  
 00BE                 524  MON_tsH:          ds 1     ; MON timestamp Hi byte current reading
 00BF                 525  MON_tsL:          ds 1     ; MON timestamp Lo byte current reading
                      526  
                      527  ; - Memory location $00C0  (decimal 192)
                      528  
                      529  ;***********************************************************************************************
                      530  ; ------------------------------------ Misc. Variables -----------------------------------------
                      531  ;***********************************************************************************************
                      532  
 00C0                 533  LoopCounter:    ds 1     ; Loop counter for main loop frequency check
 00C1                 534  MinPIP:         ds 1     ; Minimum PIP signals required for period calcs
 00C2                 535  burnSrc:        ds 2     ; Burn routine variable
 00C4                 536  page:           ds 1     ; Page selection variable
 00C5                 537  flocker:        ds 1     ; Burner locking semaphor
                      538  
                      539  ;***********************************************************************************************
                      540  ; ------------------------------------- Burner variables ---------------------------------------
                      541  ;***********************************************************************************************
                      542  
 00C6                 543  burnDst:        ds 2     ; Burn routine variable
 00C8                 544  burnCount:      ds 1     ; Burn routine variable
                      545  
                      546  ;***********************************************************************************************
                      547  ; ------------------------------ Fuel burn calculation variables -------------------------------
                      548  ;***********************************************************************************************
                      549  
 00C9                 550  fdcntr:         ds 1     ; Counter for AIOT trigger on
 00CA                 551  aiotcntr:       ds 1     ; Counter for AIOT trigger off
 00CB                 552  fdtH:           ds 1     ; Fuel deleivery Lo Res total Hi byte
 00CC                 553  fdtL:           ds 1     ; Fuel deleivery Lo Res total Lo byte
                      554  
                      555  ;***********************************************************************************************
                      556  ; ---------------------------- Vehicle speed calculation variables -----------------------------
                      557  ;***********************************************************************************************
                      558  
 00CD                 559  VScH:          ds 1      ; 100uS counter for vehicle speed Hi byte
 00CE                 560  VScL:          ds 1      ; 100uS counter for MPH Lo byte
 00CF                 561  odo:           ds 1      ; Odometer pulse counter
                      562  
                      563  ; - Memory location $00CA (decimal 202)
                      564  
                      565  ;***********************************************************************************************
                      566  ; Tachometer calculation variables
                      567  ;***********************************************************************************************
                      568  
 00D0                 569  tachcurH:       ds 1    ; Tachometer period current Hi byte 
 00D1                 570  tachcurL:       ds 1    ; Tachometer period current Lo byte 
 00D2                 571  tachTH:         ds 1    ; Tachometer period total Hi byte 
 00D3                 572  tachTM:         ds 1    ; Tachometer period total Mid byte 
 00D4                 573  tachTL:         ds 1    ; Tachometer period total Lo byte
 00D5                 574  tachcnt:        ds 1    ; Tachometer counter for tachometer period averaging time
                      575  
                      576  ;***********************************************************************************************
                      577  ; "batt" average calculation variables
                      578  ;***********************************************************************************************
                      579       
 00D6                 580  battTH:         ds 1    ; Battery ADC total Hi Byte     
 00D7                 581  battTL:         ds 1    ; Battery ADC total Lo Byte     
 00D8                 582  battcnt:        ds 1    ; Counter for battery voltage ADC averaging
                      583  
                      584  ;***********************************************************************************************
                      585  ; "ego" average calculation variables
                      586  ;***********************************************************************************************
                      587       
 00D9                 588  egoTH:          ds 1    ; EGO ADC total Hi Byte     
 00DA                 589  egoTL:          ds 1    ; EGO ADC total Lo Byte     
 00DB                 590  egocnt:         ds 1    ; Counter for EGO voltage ADC averaging
 00DC                 591  blank1:         ds 1    ; Placeholder     
 00DD                 592  blank2:         ds 1    ; Placeholder     
 00DE                 593  blank3:         ds 1    ; Placeholder     
 00DF                 594  blank4:         ds 1    ; Placeholder     
                      595  
                      596  ; - Memory location $00DA (decimal 202)
                      597       
                      598  ms_ram_end:
                      599  
                      600  
                      601  ;***********************************************************************************************
                      602  ; - Page 1(TS page 1) VE table (table copied into RAM on demand)
                      603  ;***********************************************************************************************
                      604  
                      605  ms_rf_start:
                      606  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 7
MC68HC908GP32 User Bootloader


 00E0                 607  VE_r               rmb $90     ; 144 bytes for VE Table
                      608  
                      609  ; - Memory location $016A (decimal 362)
                      610   
 0170                 611  RPMRANGEVE_r       rmb $0C     ; 12 VE Table RPM Bins for 2-D interpolation
 017C                 612  KPARANGEVE_r       rmb $0C     ; 12 VE Table MAP Pressure Bins for 2_D interpolation
                      613  
                      614  ; - Memory location $0182 (decimal 386)
                      615  
                      616  ms_rf_end:
                      617  
                      618  ;***********************************************************************************************
                      619  ; - Page 2(TS page 2) ST table (table copied into RAM on demand)
                      620  ;***********************************************************************************************
                      621  
 0188                 622  ST_r             equ  ms_rf_start         ; Spark timing table
 0188                 623  RPMRANGEST_r     equ {ms_rf_start + $90}  ; Spark timing RPM bins for 2-D interpolation
 0188                 624  KPARANGEST_r     equ {ms_rf_start + $9C}  ; Spark timing MAP pressure bins for 2-D interpolation
                      625  
                      626  ;***********************************************************************************************
                      627  ; - Page 3(TS page 3) AFR1 table (table copied into RAM on demand)(Used by MLV only)
                      628  ;***********************************************************************************************
                      629  
 0188                 630  AFR1_r             equ  ms_rf_start         ; AFR1 table
 0188                 631  RPMRANGEAFR1_r     equ {ms_rf_start + $90}  ; AFR1 RPM bins for 2-D interpolation
 0188                 632  KPARANGEAFR1_r     equ {ms_rf_start + $9C}  ; AFR1 MAP pressure bins for 2-D interpolation
                      633  
                      634  ;***********************************************************************************************
                      635  ; - Page 4(TS page 4) AFR2 table (table copied into RAM on demand)(Used by MLV only)
                      636  ;***********************************************************************************************
                      637  
 0188                 638  AFR2_r             equ  ms_rf_start         ; AFR2 table
 0188                 639  RPMRANGEAFR2_r     equ {ms_rf_start + $90}  ; AFR2 RPM bins for 2-D interpolation
 0188                 640  KPARANGEAFR2_r     equ {ms_rf_start + $9C}  ; AFR2 MAP pressure bins for 2-D interpolation
                      641  
                      642  ;***********************************************************************************************
                      643  ; - Page 5(TS page 5) Constants always run from Flash so no need to copy to RAM
                      644  ;***********************************************************************************************
                      645  
                      646  ;*WWURANGE         rmb $0A     ; WWU Table temperature Bins for 2_D interp.
                      647  ;*WWU              rmb $0A     ; Warmup bins(fn temp)
                      648  ;*TPSDOTRATE       rmb $04     ; TPSAQ table TPS count DOT for 2_D interp.
                      649  ;*TPSAQ            rmb $04     ; TPS accel amount (fn TPSDOT)(0.1mS res)
                      650  ;*cwu              rmb $01     ; Crank Pulse Width at -40 F)(0.1mS res)
                      651  ;*cwh              rmb $01     ; Crank Pulse Width at 170 F)(0.1mS res)
                      652  ;*awev             rmb $01     ; After-start Warmup % enrichment add-on
                      653  ;*awc              rmb $01     ; After-start number of cycles
                      654  ;*tpsacold         rmb $01     ; Cold accel amount (at -40F)(0.1ms res)
                      655  ;*tpsthresh        rmb $01     ; Accel TPS DOT threshold
                      656  ;*tpsasync         rmb $01     ; TPS Acceleration clock value
                      657  ;*req_fuel         rmb $01     ; Fuel Constant
                      658  ;*divider          rmb $01     ; IRQ divide factor for pulse
                      659  ;*Alternate        rmb $01     ; Alternate injector drivers
                      660  ;*InjOpen          rmb $01     ; Injector Open Time
                      661  ;*battfac          rmb $01     ; Battery Gamma Factor
                      662  ;*floodClear       rmb $01     ; tpsADC value for flood clear
                      663  ;*acmult           rmb $01     ; Accel cold mult factor (%)
                      664  ;*pru              rmb $01     ; Primer Pulse Width at -40 F)(0.1mS res)
                      665  ;*prh              rmb $01     ; Primer Pulse Width at 170 F)(0.1mS res)
                      666  ;*PIP_Angle        rmb $01     ; PIP Angle in crank degrees(4cyl=180. 6cyl=120, 8cyl=90
                      667  ;*CT_cnt           rmb $01     ; Closed throttle position ADC count
                      668  ;*WOT_cnt          rmb $01     ; Wide Open throttle position ADC count
                      669  ;*ASEhi            rmb $01     ; Set point above which ASE is active
                      670  ;*ASElo            rmb $01     ; Set point below which ASE is active
                      671  ;*tpsdq            rmb $01     ; Deacceleration fuel cut
                      672  ;*DFC_RPM          rmb $01     ; Decel Fuel Cut min RPM(rpm20)
                      673  ;*DFC_TPS          rmb $01     ; Decel Fuel Cut min TPS ADC counts
                      674  ;*dbCor            rmb $01     ; Deadband correction added to "fd"
                      675  ;*BnkflowH         rmb $01     ; BnkflowH        Injector bank flow rate L/hr x 10 Hi byte 
                      676                                 ;                 configuration variable
                      677  ;*BnkflowL         rmb $01     ; BnkflowL        Injector bank flow rate L/hr x 10 Lo byte 
                      678                                 ;                 configuration variable
                      679  ;*ASEtype          rmb $01     ; ASEtype         Configuration variable for ASE counter type
                      680                                 ;                 0 = ignition cycles, 1 = 100 ms counter, 
                      681                                 ;                 2 = 250 ms counter, 3 = 500 ms counter 
                      682                                 ;                 4 = 1 second counter
                      683  
                      684  
                      685  ;***********************************************************************************************
                      686  ; - RAM copy equates
                      687  ;***********************************************************************************************
                      688  
 0188                 689  ms_ram_size       equ {ms_ram_end-ms_ram_start}
 0188                 690  ms_rf_size        equ {ms_rf_end-ms_rf_start}
 0188                 691  ms_total_ram_size equ {ms_rf_end-ms_ram_start}
                      692  
                      693                                            ; MSnS300.asm
                      694  
                      695  
                      696  ;***********************************************************************************************
                      697  ;
                      698  ; Main Routine Here - Initialization and main loop
                      699  ;
                      700  ; Note: Org down 128 bytes below the "rom_start" point because of erase bug in bootloader
                      701  ;       routine. Only B&G HiRes and Megasquirtnspark use the 256 offset, all others use 128???
                      702  ;
                      703  ;***********************************************************************************************
                      704  
 8128                 705       org     {rom_start + 128}     ; Origin at memory location $8000 + $80 = $8080
                      706                                    ; (32768 + 128 = 32896)
                      707  Start:
 8128 [03] 4501ED     708       ldhx    #init_stack+1    ; Load index register with value in init_stack+1
                      709                               ;(Set the stack Pointer)($01ED + 1 = $01EE = 494
 812B [02] 94         710       txs                    ; Transfer value in index register Lo byte to stack
                      711                               ;(Move before burner to avoid conflict)
                      712  
                      713  
                      714  ;***********************************************************************************************
                      715  ; - Set the phase lock loop for a bus frequency of 8.003584mhz
                      716  ;  (Boot loader initially sets it at 7.3728mhz)
                      717  ;***********************************************************************************************
                      718  
                      719  ;PllSet:
 812C [04] 1936       720       bclr    BCS,pctl                ; Select external Clock Reference
 812E [04] 1B36       721       bclr    PLLON,pctl              ; Turn Of PLL
 8130 [04] 6E0236     722       mov     #$02,pctl               ; Set P and E Bits
 8133 [04] 6ED03A     723       mov     #$D0,pmrs               ; Set L ($C0 for 7.37 MHz)
 8136 [04] 6E0338     724       mov     #$03,pmsh               ; Set N (MSB)
 8139 [04] 6ED139     725       mov     #$D1,pmsl               ; Set N (LSB) ($84 for 7.37 MHz)
 813C [04] 1E37       726       bset    AUTO,pbwc         ; Enable automatic bandwidth control
 813E [04] 1A36       727       bset    PLLON,pctl              ; Turn back on PLL
                      728  
                      729  PLL_wait:
 8140 [05] 0D37FD     730       brclr   LOCK,pbwc,PLL_wait  ; Wait for PLL to lock
 8143 [04] 1836       731       bset    BCS,pctl            ; Select VCO as base clock
                      732  
                      733  ;***********************************************************************************************
                      734  ; - Set up the port data-direction registers, Set directions
                      735  ;   Preset state of pins to become outputs
                      736  ;***********************************************************************************************
                      737  
                      738  ; Port A
 8145 [04] 6EFF0D     739       mov     #$FF,PTAPUE     ; Move %11111111 to Port A pullup enable reg Set all pullups to
                      740                               ; (connect unused pins to VDD, output direction clears pullup)
 8148 [04] 6E0200     741       mov     #$02,PORTA      ; Move %00000010 to Port A Data Regisister (preinit) Loopchk Lo,
                      742                               ; Spark Hi, fuelp Lo,(SPOUT Lo, fuel pump off)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 8
MC68HC908GP32 User Bootloader


 814B [04] 6E8304     743       mov     #$83,DDRA       ; Move %10000011 to Port A Data Direction Register Inputs on
                      744                               ; PTA6,5,4,3,2,= Knk_Det,Trm_Sel,Ign_Mon,Veh_Spd,DFC_en
                      745                               ; Outputs on PTA7,1,0 = Loopchk, Spark, Fuel Pump
                      746  
                      747  ; Port B
 814E [03] 3F05       748       clr     DDRB            ; Clear Port B Data Direction Register (Set as inputs,
                      749                               ; "ADSEL" will select channel)
                      750  
                      751  ; Port C
 8150 [04] 6EFF0E     752       mov     #$FF,PTCPUE     ; Move %11111111 to Port C pullup enable reg (Set all pullups to
                      753                               ; connect unused pins to VDD, output direction clears pullup)
 8153 [03] 3F02       754       clr          PORTC      ; Move %00000000 to Port C Data Register(Preinit all low)
 8155 [04] 6E0706     755       mov     #$07,DDRC       ; Move %00000111 to Port C Data Direction Register,
                      756                               ; Inputs on PTC7,6,5,4,3 = NA,NA,NA,NA,NA
                      757                               ; Outputs on PTC2,1,0 = Wled,Aled,Sled
                      758  
                      759  ; Port D
 8158 [04] 6EFF0F     760       mov     #$FF,PTDPUE     ; Move %11111111 to Port C pullup enable reg (Set all pullups to
                      761                               ; connect unused pins to VDD, output direction clears pullup)
 815B [04] 6E3003     762       mov     #$30,PORTD      ; Move %00110000 to Port D Data Direction Register (preinit output
                      763                               ; pins 5,4 Hi)(Turn off injectors (inverted output)
 815E [04] 6EF007     764       mov     #$F0,DDRD       ; Move %11110000 to Port D Data Direction Register (Injectors on
                      765                               ; PTD4,5)(PTD6,7 not available, set as outputs)
                      766  
                      767  ; Port E
 8161 [03] 3F08       768       clr     PORTE         ; Clear Port E Data Register (to avoid glitches)
 8163 [04] 6E010C     769       mov     #$01,DDRE     ; Move %00000001 to Port E Data Direction Register(Serial Comm Port)
                      770  
                      771  
                      772  ;***********************************************************************************************
                      773  ; - Set up TIM2 as a free running ~1us counter. Set Channel 0 output compare
                      774  ;   to generate the ~100us(.1ms) clock tick. Interupt vector "TIM2CH0_ISR:"
                      775  ;   Set Channel 1 output compare for SPOUT control.
                      776  ;   Interupt vector "TIM2CH1_ISR:"
                      777  ; - NOTE! The channels on this timer are not connected to any pins so pin
                      778  ;   state is irrelevant.
                      779  ;***********************************************************************************************
                      780  
 8166 [04] 6E332B     781       mov     #$33,T2SC       ; Move %00110011 into Timer2 Status and Control Register
                      782                               ;(Disable interupts, stop timer)(Prescale and counter cleared))
                      783                               ;(Prescale for bus frequency / 8)
 8169 [04] 6EFF2E     784       mov     #$FF,T2MODH     ; Move dec 255 into T2 modulo register Hi
 816C [04] 6EFF2F     785       mov     #$FF,T2MODL     ; Move dec 255 into T2 modulo register Lo(free running timer)
 816F [03] 3F31       786       clr     T2CH0H          ; Clear T2CH0 O/C register Hi byte
 8171 [04] 6E6432     787       mov     #$64,T2CH0L     ; Move decimal 100 into T2CH0 O/C register Lo byte(~100uS)
 8174 [04] 6E5430     788       mov     #$54,T2SC0      ; Move %01010100 into T2CH0 Status and Control Register.
                      789                               ;(Output compare, interrupt enabled)
 8177 [03] 3F34       790       clr     T2CH1H          ; Clear T2CH1 O/C register Hi byte
 8179 [03] 3F35       791       clr     T2CH1L          ; Clear T2CH1 O/C register Lo byte
 817B [04] 6E1433     792       mov     #$14,T2SC1      ; Move %00010100 into T2CH1 Status and Control Register.
                      793                               ; (Output compare, interrupt disabled)
 817E [04] 6E132B     794       mov     #$13,T2SC       ; Move %00010011 into Timer2 Status and Control Register.
                      795                               ; (Disable interupts, reset counter, counter Active,
                      796                               ; Prescale for bus frequency /8. 8,003,584hz/8=1,000,448hz
                      797                               ; = .0000009995sec
                      798  
                      799  
                      800  ;***********************************************************************************************
                      801  ; Set up TIM1 as a free running ~1us counter. Set channels 0 and 1 for output
                      802  ; compare, pulsewidth control of injectors. INJ1 on T1SC0 and INJ2 on T1SC1
                      803  ; Initialize output pins logic state 1 (injectors off)
                      804  ;***********************************************************************************************
                      805  
 8181 [04] 6E3320     806       mov     #$33,T1SC       ; Move %00110011 into Timer1 Status and Control Register
                      807                               ;(Disable interupts, stop timer)(Prescale and counter cleared))
                      808                               ;(Prescale for bus frequency / 8)
 8184 [04] 6EFF23     809       mov     #$FF,T1MODH     ; Move decimal 255 into T1 modulo reg Hi
 8187 [04] 6EFF24     810       mov     #$FF,T1MODL     ; Move decimal 255 into T1 modulo reg Lo
 818A [04] 6E0025     811       mov     #$00,T1SC0      ; Move %00000000 into Timer1 Channel 0 Status and Control Register
                      812                               ;(Normal port output initialized logic 1)(injector off)
 818D [04] 6E0028     813       mov     #$00,T1SC1      ; Move %00000000 into Timer1 Channel 1 Status and Control Register
                      814                               ;(Normal port output initialized logic 1)(injector off)
 8190 [04] 6E0026     815       mov     #$00,T1CH0H     ; Move decimal 0 to T1CH0 register Hi
 8193 [04] 6E0127     816       mov     #$01,T1CH0L     ; Move decimal 1 to T1CH0 register Lo
 8196 [04] 6E0029     817       mov     #$00,T1CH1H     ; Move decimal 0 to T1CH0 register Hi
 8199 [04] 6E012A     818       mov     #$01,T1CH1L     ; Move decimal 1 to T1CH0 register Lo
                      819  
                      820  
                      821  ;***********************************************************************************************
                      822  ; - Set up Serial Communications Interface Module
                      823  ;***********************************************************************************************
                      824  
 819C [04] 6E3019     825       mov     #$30,SCBR       ; Move %0110000 into SCI Baud Rate Register
                      826                               ; (8003584/(64*13*1)=9619.7 baud)
 819F [04] 1C13       827       bset     ENSCI,SCC1     ; Set enable SCI bit of SCI Control Register 1(Enable SCI)
 81A1 [04] 1414       828       bset     RE,SCC2        ; Set receiver enable bit of SCI Control Reg 2(Enable receiver)
 81A3 [04] 1A14       829       bset     SCRIE,SCC2     ; Set SCI receive interrupt enable bit of SCI Control Reg 2
                      830                               ;(Enable Rcv. Interrupt)
 81A5 [03] B616       831       lda      SCS1           ; Load accumulator with SCI Status Register 1
                      832                               ;(Clear SCI transmitter Empty Bit)
 81A7 [03] 3F84       833       clr      TXCNT          ; Clear SCI transmitter count(incremented)(characters transmitted)
 81A9 [03] 3F85       834       clr      TXGOAL         ; Clear SCI number of bytes to transmit
                      835                               ;(characters to be transmitted)
                      836  
                      837  
                      838  ;***********************************************************************************************
                      839  ; - Set up IRQ Interrupt (Rising edge of PIP on Pin 24, hardware inverted)
                      840  ;***********************************************************************************************
                      841  
 81AB [04] 6E041D     842       mov     #$04,INTSCR     ; Move %00000100 into IRQ Status and Control Register
                      843                               ; (Enable IRQ (turn on interrupts))(falling edge only)
                      844  
                      845  
                      846  ;***********************************************************************************************
                      847  ; - Set up Keyboard Interrupt, Ign Mon on PTA4, Veh Speed on PTA3
                      848  ;***********************************************************************************************
                      849  
 81AE [04] 6E021A     850       mov     #$02,INTKBSCR       ; Move %00000010 into Keyboard Status and Control Register
                      851                                   ;(Keyboard interrupts masked, interrupts on falling edges only)
 81B1 [04] 6E181B     852       mov     #$18,INTKBIER       ; Move %00011000 into Keyboard Interrupt Enable Register
                      853                                   ;(Keyboard interrupts on PTA4,3)
 81B4 [04] 141A       854       bset    ackk,INTKBSCR       ; Set the Keyboard Acknowledge bit of Keyboard Status and
                      855                                   ; Control Register(clear any false interrupts)
 81B6 [04] 166B       856       bset    VSen,inputs         ; Set "VSen" bit of "inputs" variable
 81B8 [04] 146B       857       bset    MONen,inputs        ; Set "MONen" bit of "inputs" variable
 81BA [04] 131A       858       bclr    imaskk,INTKBSCR     ; Clear the Interrupt Mask bit of Keyboard Status and Control
                      859                                   ; Register(enable interrupts)
                      860  
                      861  ;***********************************************************************************************
                      862  ;   Set all RAM to known value - for code runaway protection.
                      863  ;   If there is ever a code runaway, and processor tries executing this as an opcode ($32)
                      864  ;   then a reset will occur.
                      865  ;***********************************************************************************************
                      866  
 81BC [03] 450040     867       ldhx   #ram_start      ;Point to start of RAM $0040(64)
                      868  
                      869  ClearRAM:
 81BF [02] A632       870       lda     #$32             ; This is an illegal op-code - cause reset if executed
 81C1 [02] F7         871       sta    ,x              ;Set RAM location
 81C2 [02] AF01       872       aix    #1              ;advance pointer
 81C4 [03] 650240     873       cphx   #ram_last+1     ;$23F + 1 = $240(576)  done ?
 81C7 [03] 26F6       874       bne    ClearRAM        ;loop back if not
                      875  
                      876  ;***********************************************************************************************
                      877  ; - Clear all variables
                      878  ;***********************************************************************************************


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 9
MC68HC908GP32 User Bootloader


                      879  
 81C9 [03] 3F40       880       clr     secl         ; low seconds - from 0 to 255, then rollover
 81CB [03] 3F41       881       clr     map          ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 81CD [03] 3F42       882       clr     mat          ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 81CF [03] 3F43       883       clr     clt          ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 81D1 [03] 3F44       884       clr     tps          ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 81D3 [03] 3F45       885       clr     batt         ; Battery Voltage ADC Raw Reading - counts (0 - 255)(AD4)
 81D5 [03] 3F46       886       clr     ego          ; Exhaust Gas Oxygen ADC Raw Reading - counts (0 - 255)(AD5)
 81D7 [03] 3F47       887       clr     trim         ; Fuel/Ignition Trim ADC Raw Reading - counts (0 - 255)(AD6)
 81D9 [03] 3F48       888       clr     baro         ; Barometric Pressure ADC Raw Reading - counts (0 - 255)(AD7)
 81DB [03] 3F49       889       clr     barometer    ; Current barometer reading in KPA (for MV)
 81DD [03] 3F4A       890       clr     barocor      ; Barometer Lookup Correction - percent
 81DF [03] 3F4B       891       clr     warmcor      ; Total Warmup Correction - percent
 81E1 [03] 3F4C       892       clr     aircor       ; Air Density Correction lookup - percent
 81E3 [03] 3F4D       893       clr     Ftrimcor     ; Fuel Trim Correction Factor (85% - 115%)
 81E5 [03] 3F4E       894       clr     gammae       ; Total Gamma Enrichments - percent
 81E7 [03] 3F4F       895       clr     tpsaccel     ; Acceleration enrichment - percent
 81E9 [03] 3F50       896       clr     rpm20        ; Computed engine RPM - rpm/20
 81EB [03] 3F51       897       clr     vecurr       ; Current VE value from lookup table - percent
 81ED [03] 3F52       898       clr     pwcalcH      ; high order of calculated pulsewith (16 bits)
 81EF [03] 3F53       899       clr     pwcalcL      ; low order of calculated pulsewidth (16 bits)
 81F1 [03] 3F54       900       clr     pw           ; injector squirt time in 1/10 millesec (0 to 25.5 millisec) - applied
 81F3 [03] 3F55       901       clr     fd           ; Fuel Delivery PW Lo Res
 81F5 [03] 3F56       902       clr     fdSecH       ; Fuel Delivery PW Lo Res over 1 second Hi byte
 81F7 [03] 3F57       903       clr     fdSecL       ; Fuel Delivery PW Lo Res over 1 second Lo byte
 81F9 [03] 3F58       904       clr     tachH        ; Tachometer period averaged over 16 periods Hi byte
 81FB [03] 3F59       905       clr     tachL        ; Tachometer period averaged over 16 periods Lo byte
 81FD [03] 3F5A       906       clr     Spk_Ang_Fac  ; Spark Angle Factor (from ST table)
 81FF [03] 3F5B       907       clr     Trm_Ang_Fac  ; Trim Angle Factor (from IgnTrimcor table)
 8201 [03] 3F5C       908       clr     Dly_Ang_Fac  ; Delay Angle Factor (Spk_Ang_Fac + Trm_Ang_Fac)
 8203 [03] 3F5D       909       clr     odoSec       ; Odometer counts over 1 second
 8205 [03] 3F5E       910       clr     VS_pH        ; Vehicle speed period Hi byte
 8207 [03] 3F5F       911       clr     VS_pL        ; Vehicle speed period Lo byte
 8209 [03] 3F60       912       clr     MON_pH       ; MON period Hi byte (MON_tsH - PIP_tsH)
 820B [03] 3F61       913       clr     MON_pL       ; MON period Lo byte (MON_tsL - PIP_tsL)
 820D [03] 3F62       914       clr     tpsp         ; Throttle position percent
 820F [03] 3F63       915       clr     engine       ; Variable bit-field to hold engine current status
 8211 [03] 3F64       916       clr     alarmbits    ; Engine Alarm Status Bit Field
 8213 [03] 3F65       917       clr     portAbits    ; Port A status Bit field
 8215 [03] 3F66       918       clr     portCbits    ; Port C Status Bit Field
 8217 [03] 3F69       919       clr     engine2      ; Variable bit-field to hold engine current status #2
 8219 [03] 3F6A       920       clr     squirt       ; Event variable bit field for Injector Firing
 821B [03] 3F6B       921       clr     inputs       ; Bit field variable for input status flags
 821D [03] 3F6E       922       clr     adsel        ; ADC Selector Variable
 821F [03] 3F6F       923       clr     pwnadH       ; Calculated PW without Accel and deadband Hi byte
 8221 [03] 3F70       924       clr     pwnadL       ; Calculated PW without Accel and deadband Lo byte
 8223 [03] 3F71       925       clr     fdhrH        ; Calc PW without deadband Hi byte (fuel delivery)
 8225 [03] 3F72       926       clr     fdhrL        ; Calc PW without deadband Lo byte (fuel delivery)
 8227 [03] 3F74       927       clr     tpsfuelcut   ; TPS Fuel Cut (percent)
 8229 [03] 3F73       928       clr     deadband     ; Injector deadband in 100uS resolution
 822B [03] 3F6C       929       clr     kpa          ; MAP value in units of KPa
 822D [03] 3F6D       930       clr     coolant      ; Coolant temperature in Degrees F+40 (allows -40F to fit in int)
 822F [03] 3F75       931       clr     rpmph        ; High part of RPM Period
 8231 [03] 3F76       932       clr     rpmpl        ; Low part of RPM Period
 8233 [03] 3F77       933       clr     rpmch        ; Counter for high part of RPM
 8235 [03] 3F78       934       clr     rpmcl        ; Counter for low part of RPM
 8237 [03] 3F79       935       clr     mSx250       ; 250 Milliseconds counter
 8239 [03] 3F7A       936       clr     mSx100       ; 100 Milliseconds counter
 823B [03] 3F7B       937       clr     mS           ; Milliseconds counter
 823D [03] 3F7C       938       clr     uSx100       ; 100 Microseconds counter
 823F [03] 3F7D       939       clr     sech         ; high seconds - rollover at 65536 secs (1110.933 minutes, 18.51 hours)
 8241 [03] 3F7E       940       clr     tpsaclk      ; TPS enrichment timer clock in 0.1 second resolution
 8243 [03] 3F7F       941       clr     asecount     ; Counter value for after-start enrichment counter - every ignition pulse
 8245 [03] 3F80       942       clr     last_tps     ; TPS reading updated every 0.1 seconds
 8247 [03] 3F81       943       clr     igncount     ; Ignition pulse counter
 8249 [03] 3F82       944       clr     altcount     ; Alternate count selector
 824B [03] 3F83       945       clr     tpsaclkcmp   ; Comparison value for TPS acceleration time - from lookup table
 824D [03] 3F84       946       clr     txcnt        ; SCI transmitter count (incremented)
 824F [03] 3F85       947       clr     txgoal       ; SCI number of bytes to transmit
 8251 [03] 3F86       948       clr     txmode       ; Transmit mode flag
 8253 [03] 3F87       949       clr     rxoffset     ; offset placeholder when receiving VE/constants vis. SCI
 8255 [03] 3F88       950       clr     INTACC1
 8257 [03] 3F8C       951       clr     INTACC2
 8259 [03] 3F90       952       clr     tmp1
 825B [03] 3F91       953       clr     tmp2
 825D [03] 3F92       954       clr     tmp3
 825F [03] 3F93       955       clr     tmp4
 8261 [03] 3F94       956       clr     tmp5
 8263 [03] 3F95       957       clr     tmp6
 8265 [03] 3F96       958       clr     tmp7
 8267 [03] 3F97       959       clr     tmp8
 8269 [03] 3F98       960       clr     tmp9
 826B [03] 3F99       961       clr     tmp10
 826D [03] 3F9A       962       clr     tmp11
 826F [03] 3F9B       963       clr     tmp12
 8271 [03] 3F9C       964       clr     tmp13
 8273 [03] 3F9D       965       clr     tmp14
 8275 [03] 3F9E       966       clr     tmp15
 8277 [03] 3F9F       967       clr     tmp16
 8279 [03] 3FA0       968       clr     tmp17
 827B [03] 3FA1       969       clr     tmp18
 827D [03] 3FA2       970       clr     tmp19
 827F [03] 3FA3       971       clr     tmp20
 8281 [03] 3FA4       972       clr     tmp21
 8283 [03] 3FA5       973       clr     tmp22
 8285 [03] 3FA6       974       clr     PIP_tsH         ; PIP timestamp current reading Hi byte
 8287 [03] 3FA7       975       clr     PIP_tsL         ; PIP timestamp current reading Lo byte
 8289 [03] 3FA8       976       clr     PIP_tsH_prv     ; PIP timestamp previous reading Hi byte
 828B [03] 3FA9       977       clr     PIP_tsL_prv     ; PIP timestamp previous reading Lo byte
 828D [03] 3FAA       978       clr     PIP_pH_prv      ; PIP period Hi byte previous
 828F [03] 3FAB       979       clr     PIP_pL_prv      ; PIP period Lo byte previous
 8291 [03] 3FAC       980       clr     PIP_pH_dif      ; PIP period difference Hi byte
                      981                               ;(PIP_pH - PIP_pH_prv)
 8293 [03] 3FAD       982       clr     PIP_pL_dif      ; PIP period difference Lo byte
                      983                               ;(PIP_pL - PIP_pL_prv)
 8295 [03] 3FAE       984       clr     PIP_pH          ; PIP period Hi byte (PIP_tsH - PIP_tsH_prv)
 8297 [03] 3FAF       985       clr     PIP_pL          ; PIP period Lo byte (PIP_tsL - PIP_tsL_prv)
 8299 [03] 3FB0       986       clr     PIP_pH_pred     ; Predicted PIP period Hi byte(PIP_pH + PIP_pH_dif)
 829B [03] 3FB1       987       clr     PIP_pL_pred     ; Predicted PIP period Lo byte(PIP_pL + PIP_pL_dif)
 829D [03] 3FB2       988       clr     Delay_pH        ; Delay period from PIP to SPOUT, Hi byte
 829F [03] 3FB3       989       clr     Delay_pL        ; Delay period from PIP to SPOUT, Lo byte
                      990                               ;(16 bit result of Mul_Hi:Mul_Mid:Mul_Lo / $FF)
 82A1 [03] 3FB4       991       clr     CH1_onH         ; T2CH1 output compare for SPOUT rising, Hi byte
 82A3 [03] 3FB5       992       clr     CH1_onL         ; T2CH1 output compare for SPOUT rising, Lo byte
                      993                               ;(PIP_tsH:PIP_tsL + Delay_pH:Delay_pL)
 82A5 [03] 3FB6       994       clr     SPOUT_tsH       ; SPOUT timestamp current reading Hi byte
 82A7 [03] 3FB7       995       clr     SPOUT_tsL       ; SPOUT timestamp current reading Lo byte
 82A9 [03] 3FB8       996       clr     PIP_periodH     ; PIP period Hi byte (for SPOUT off calcs)
 82AB [03] 3FB9       997       clr     PIP_periodL     ; PIP period Lo byte (for SPOUT off calcs)
 82AD [03] 3FBA       998       clr     SPOUTon_pH      ; SPOUT on period Hi byte
 82AF [03] 3FBB       999       clr     SPOUTon_pL      ; SPOUT on period Lo byte
                     1000                               ;(50% duty cycle, half of PIP period)
 82B1 [03] 3FBC      1001       clr     CH1_offH        ; T2CH1 output compare for SPOUT falling, Hi byte
 82B3 [03] 3FBD      1002       clr     CH1_offL        ; T2CH1 output compare for SPOUT falling, Lo byte
                     1003                               ;(SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL)
 82B5 [03] 3FBE      1004       clr     MON_tsH         ; MON timestamp Hi byte current reading
 82B7 [03] 3FBF      1005       clr     MON_tsL         ; MON timestamp Lo byte current reading
 82B9 [03] 3FC0      1006       clr     LoopCounter     ; Loop counter for main loop frequency check
 82BB [03] 3FC1      1007       clr     MinPIP          ; Minimum PIP signals required for period calcs
 82BD [03] 3FC4      1008       clr     page            ; Page selection variable
 82BF [03] 3FC5      1009       clr     flocker         ; Burner locking semaphor
 82C1 [03] 3FC2      1010       clr     burnSrc         ; Burn routine variable
 82C3 [03] 3FC6      1011       clr     burnDst         ; Burn routine variable
 82C5 [03] 3FC8      1012       clr     burnCount       ; Burn routine variable
 82C7 [03] 3FC9      1013       clr     fdcntr          ; Counter for AIOT trigger on
 82C9 [03] 3FCA      1014       clr     aiotcntr        ; Counter for AIOT trigger off


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 10
MC68HC908GP32 User Bootloader


 82CB [03] 3FCB      1015       clr     fdtH            ; Fuel deleivery Lo Res total Hi byte
 82CD [03] 3FCC      1016       clr     fdtL            ; Fuel deleivery Lo Res total Lo byte
 82CF [03] 3FCD      1017       clr     VScH            ; 100uS counter for vehicle speed Hi byte
 82D1 [03] 3FCE      1018       clr     VScL            ; 100uS counter for MPH Lo byte
 82D3 [03] 3FCF      1019       clr     odo             ; Odometer pulse counter
 82D5 [03] 3FD0      1020       clr     tachcurH        ; Tachometer period current Hi byte
 82D7 [03] 3FD1      1021       clr     tachcurL        ; Tachometer period current Lo byte
 82D9 [03] 3FD2      1022       clr     tachTH          ; Tachometer period total Hi byte
 82DB [03] 3FD3      1023       clr     tachTM          ; Tachometer period total Mid byte
 82DD [03] 3FD4      1024       clr     tachTL          ; Tachometer period total Lo byte
 82DF [03] 3F67      1025       clr     BnkflowHmv      ; Injector bank flow rate L/hr x 10 Hi byte for MV
 82E1 [03] 3F68      1026       clr     BnkflowLmv      ; Injector bank flow rate L/hr x 10 Lo byte for MV
 82E3 [03] 3FD5      1027       clr     tachcnt         ; Tachometer counter for tachometer period averaging time
 82E5 [03] 3FD6      1028       clr     battTH          ; Battery ADC total Hi Byte
 82E7 [03] 3FD7      1029       clr     battTL          ; Battery ADC total Lo Byte
 82E9 [03] 3FD8      1030       clr     battcnt         ; Counter for battery voltage ADC averaging
 82EB [03] 3FD9      1031       clr     egoTH           ; EGO ADC total Hi Byte
 82ED [03] 3FDA      1032       clr     egoTL           ; EGO ADC total Lo Byte
 82EF [03] 3FDB      1033       clr     egocnt          ; Counter for EGO voltage ADC averaging
                     1034  
                     1035  ;***********************************************************************************************
                     1036  ; - Initialize critical variables to some other acceptable starting value
                     1037  ;***********************************************************************************************
                     1038  
 82F1 [02] A603      1039       lda     #$03
 82F3 [03] B7C1      1040       sta     MinPip
                     1041  
 82F5 [02] A646      1042       lda     #$46
 82F7 [03] B741      1043       sta     map
                     1044  
 82F9 [02] A664      1045       lda     #$64
 82FB [03] B74C      1046       sta     aircor
 82FD [03] B751      1047       sta     vecurr
 82FF [03] B74A      1048       sta     barocor
 8301 [03] B74B      1049       sta     warmcor
 8303 [03] B74D      1050       sta     Ftrimcor
                     1051  
 8305 [02] A6BB      1052       lda     #$BB
 8307 [03] B741      1053       sta     map
 8309 [03] B742      1054       sta     mat
 830B [03] B743      1055       sta     clt
 830D [03] B744      1056       sta     tps
 830F [03] B745      1057       sta     batt
 8311 [02] A6FF      1058       lda     #$FF
 8313 [03] B780      1059       sta     last_tps
 8315 [03] B7AA      1060       sta     PIP_pH_prv     ; 305 RPM 6 cyl, 229 RPM 8 cyl
 8317 [03] B7AB      1061       sta     PIP_pL_prv     ; 305 RPM 6 cyl, 229 RPM 8 cyl
 8319 [03] B758      1062       sta     tachH          ; 305 RPM 6 cyl, 229 RPM 8 cyl
 831B [03] B759      1063       sta     tachL          ; 305 RPM 6 cyl, 229 RPM 8 cyl
                     1064  
                     1065  ;*********************************************************************************************
                     1066  ; Copy injector bank flow rate configurable constants from Flash memory to RAM for use by
                     1067  ; Megaview in fuel burn calculations.
                     1068  ;*********************************************************************************************
                     1069  
 831D [04] C6E435    1070       lda     BnkflowH     ; Load accumulator with value in "BnkflowH"
 8320 [03] B767      1071       sta     BnkflowHmv   ; Copy to "BnkflowHmv"
 8322 [04] C6E436    1072       lda     BnkflowL     ; Load accumulator with value in "BnkflowL"
 8325 [03] B768      1073       sta     BnkflowLmv   ; Copy to "BnkflowLmv"
                     1074  
                     1075  ;***********************************************************************************************
                     1076  ; - Fire up the ADC, and perform one conversion, Set up clock source for ADC
                     1077  ;   Do an initial conversion just to stabilize the ADC
                     1078  ;***********************************************************************************************
                     1079  
                     1080  Stb_ADC:
 8327 [02] A670      1081       lda     #%01110000     ; Load accumulator with %01110000
 8329 [03] B73E      1082       sta     ADCLK          ; Copy to ADC Clock Register( bus clock/8 = ~1mhz )
 832B [02] A602      1083       lda     #%00000010          ; Load accumulator with %00000010 (one conversion, no interrupt
                     1084                              ; on channel AD2)
 832D [03] B73C      1085       sta     ADSCR          ; Copy to ADC Status and Control Register
                     1086  
                     1087  ADCWait:
 832F [05] 0F3CFD    1088       brclr   coco,ADSCR,ADCWait  ; If "conversions complete flag" bit of ADC Status and Control
                     1089                                   ; Register is clear, branch to ADCWait:(keep looping while
                     1090                                   ; COnversion COmplete flag = 0)
 8332 [03] B63D      1091       lda     ADR                 ; Load accumulator with value in ADC Result Variable
 8334 [03] B743      1092       sta     clt                 ; Copy to Coolant Temperature 8 bit ADC
                     1093  
                     1094  ;***********************************************************************************************
                     1095  ;  Do the ADC conversion again for Coolant Temperature, then determine the actual
                     1096  ;   temperature from the Thermfac table
                     1097  ;***********************************************************************************************
                     1098  
 8336 [02] A602      1099       lda     #%00000010          ; Load accumulator with %00000010(one conversion, no interrupt on
                     1100                              ; channel AD2)
 8338 [03] B73C      1101       sta     ADSCR          ; Copy to ADC Status and Control Register
                     1102  
                     1103  ADCWait2:
 833A [05] 0F3CFD    1104       brclr   coco,ADSCR,ADCWait2 ; If "conversions complete flag" bit of ADC Status and Control
                     1105                                   ; Register is clear, branch to ADCWait2:
                     1106                                   ; (keep looping while COnversion COmplete flag = 0)
 833D [03] B63D      1107       lda     ADR                 ; Load accumulator with value in ADC Result Variable
 833F [03] B743      1108       sta     clt                 ; Copy to Coolant Temperature 8 bit ADC
 8341 [03] 3F6E      1109       clr     adsel               ; Clear the ADC channel selector variable
 8343 [01] 8C        1110       clrh                        ; Clear index register Hi byte
 8344 [03] B643      1111       lda     clt                 ; Load accumulator with value in Coolant Temperature  ADC
 8346 [01] 97        1112       tax                         ; Copy to index register Lo byte
 8347 [04] D6F200    1113       lda     thermfactor,x       ; Load accumulator with value in thermfactor table,
                     1114                                   ; offset in index register Lo byte(modified for Ford sensor)
 834A [03] B76D      1115       sta     coolant             ; Copy to Coolant Temp in degreesF+40
                     1116  
                     1117  
                     1118  ;***********************************************************************************************
                     1119  ; - Primer Pulse Width is directly set by the coolant temperature value of
                     1120  ;   "pru" (at -40 degrees) and "prh" (at 165 degrees) - value is interpolated
                     1121  ;   Load the Final Pulse Width variable with the Prime Pulse value * 100 and
                     1122  ;   schedule the injectors to be fired on the first 100uS clock tick.
                     1123  ;
                     1124  ;   Note! In order for the Prime Pulse to be effective, the fuel system must
                     1125  ;   be at normal operating pressure. If there is insufficient residual
                     1126  ;   pressure, it may be necessary to turn the ignition switch off after the
                     1127  ;   fuel pump stops(1 second with no IRQ signal), then switch on and start.
                     1128  ;***********************************************************************************************
                     1129  
                     1130  INTERP_PRIME_PW:
 834C [02] A600      1131       lda     #$00             ; Load accumulator with decimal 0
 834E [03] B790      1132       sta     tmp1             ; Copy to tmp1 variable
 8350 [02] A6CD      1133       lda     #$CD             ; Load accumulator with decimal 205
                     1134                                ; 165 + 40 degrees (offset in lookup table)
 8352 [03] B791      1135       sta     tmp2             ; Copy to tmp2 variable
 8354 [04] C6E42A    1136       lda     pru              ; Load accumulator with value in Primer Pulse
                     1137                                ; Width at -40 F)
 8357 [03] B792      1138       sta     tmp3             ; Copy to "tmp3"
 8359 [04] C6E42B    1139       lda     prh              ; Load accumulator with value in Primer Pulse
                     1140                                ; Width at 165 F)
 835C [03] B793      1141       sta     tmp4             ; Copy to "tmp4"
 835E [05] 4E6D94    1142       mov     coolant,tmp5     ; Move value at current coolant temp to tmp5
 8361 [05] CD8E31    1143       jsr     lininterp        ; Jump to Lininterp: (interpolation subroutine)
 8364 [03] B695      1144       lda     tmp6             ; Load accumulator with value in tmp6 variable
                     1145                                ; (result of calculation)
 8366 [03] B754      1146       sta     pw               ; Copy to "pw"
 8368 [03] B755      1147       sta     fd               ; Copy to "fd"
 836A [01] 97        1148       tax                      ; Tansfer value in accumulator to index register Lo byte
 836B [02] A664      1149       lda     #$64             ; Load accumulator with decimal 100
 836D [05] 42        1150       mul                      ; Multiply X:A<-(X)x(A)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 11
MC68HC908GP32 User Bootloader


 836E [03] BF52      1151       stx     pwcalch          ; Copy result Hi byte to "pwcalch"
 8370 [03] B753      1152       sta     pwcalcl          ; Copy result Lo byte to "pwcalcl"
 8372 [04] 1000      1153       bset    fuelp,porta      ; Set "fuelp" bit of Port A (energise fuel pump relay)
 8374 [04] 1065      1154       bset    FPon,portAbits   ; Set "FPon" bit of "portAbits"
 8376 [04] 146A      1155       bset    sched1,squirt    ; Set "sched1" bit of "squirt"
 8378 [04] 106A      1156       bset    inj1,squirt      ; Set "inj1" bit of "squirt"
 837A [04] 186A      1157       bset    sched2,squirt    ; Set "sched2" bit of "squirt"
 837C [04] 126A      1158       bset    inj2,squirt      ; Set "inj2" bit of "squirt"
 837E [04] 1063      1159       bset    running,engine   ; Set "running" bit of "engine"
                     1160  
                     1161  
                     1162  ;***********************************************************************************************
                     1163  ; - Enable interrupts
                     1164  ;***********************************************************************************************
                     1165  
 8380 [02] 9A        1166       cli                      ; Clear interrupt mask
                     1167  
                     1168  ;***********************************************************************************************
                     1169  ;***********************************************************************************************
                     1170  ;***************************    M A I N  E V E N T  L O O P     ********************************
                     1171  ;***********************************************************************************************
                     1172  ;***********************************************************************************************
                     1173  
                     1174  ;***********************************************************************************************
                     1175  ; - Toggle "Loopchk" bit on Port A each program loop so frequency can
                     1176  ;   be checked with a scope or frequency meter.(for program developement)
                     1177  ;***********************************************************************************************
                     1178  
                     1179  LOOPER:
 8381 [04] 33C0      1180       com     LoopCounter      ; Ones compliment "LoopCounter"(flip state of "LoopCounter")
 8383 [03] 2604      1181       bne     SET_LOOPCHK      ; If the Z bit of CCR is clear, branch to SET_LOOPCHK:
 8385 [04] 1F00      1182       bclr    Loopchk,PORTA    ; Clear "Loopchk" bit of Port A (LED off)
 8387 [03] 2002      1183       bra     LOOPCHK_DONE     ; Branch to LOOPCHK_DONE:
                     1184  
                     1185  SET_LOOPCHK:
 8389 [04] 1E00      1186       bset    Loopchk,PORTA    ; Set "Loopchk" bit of Port A (LED on)
                     1187  
                     1188  LOOPCHK_DONE:
                     1189  
                     1190  ;***********************************************************************************************
                     1191  ;
                     1192  ; - KnockSenseMS output "TIM is normally high (+5 volts), and goes low (0 volts) when it
                     1193  ;   detects a knock. TIM is connected to X1, a header pin on the daughter board which
                     1194  ;   connects to header socket X1 on the MS board. X1 is traced to HC908 pin 39
                     1195  ;   (PTA6) which was a spare input. PTA6 is polled every time through the main loop. If it is
                     1196  ;   high knocking (bit 0) of alarmbits is cleared. If it is low, the bit is set.
                     1197  ;
                     1198  ;***********************************************************************************************
                     1199  
                     1200  ;**********************************************************************************************
                     1201  ; - Check the state of the Knock Sensor Input and act accordingly
                     1202  ;**********************************************************************************************
                     1203  
                     1204  ;CHK_KNOCK:
 838B [05] 0D0007    1205       brclr   Knk_Det,porta,KNOCK_ON        ; If "Knk" (PTA6) is low, branch to KNOCK_ON:
 838E [05] 016409    1206       brclr   knocking,alarmbits,KNOCK_DONE ; If "knocking" bit of "alarmbits" is already clear,
                     1207                                             ; branch to KNOCK_DONE:
 8391 [04] 1164      1208       bclr    knocking,alarmbits            ; Clear "knocking" bit of "alarmbits"
 8393 [03] 2005      1209       bra     KNOCK_DONE                    ; Branch to KNOCK_DONE:
                     1210  
                     1211  KNOCK_ON:
 8395 [05] 006402    1212       brset   knocking,alarmbits,KNOCK_DONE ; If "knocking" bit of "alarmbits" is already set,
                     1213                                             ; branch to KNOCK_DONE:
 8398 [04] 1064      1214       bset    knocking,alarmbits            ; Set "knocking" bit of "alarmbits"
                     1215  
                     1216  KNOCK_DONE:
                     1217  
                     1218  ;***********************************************************************************************
                     1219  ; - On start up, until we have received a minimum of 3 PIP signals so
                     1220  ;   that 0.1uS period calculations will be valid, prohibit "Run" mode.
                     1221  ;***********************************************************************************************
                     1222  
 839A [03] B6C1      1223       lda     MinPIP       ; Load accumulator with value in "MinPIP" variable
 839C [03] 2702      1224       beq     MINPIP_DONE  ; If Z bit of CCR is set, branch to MINPIP_DONE:
 839E [04] 1169      1225       bclr    run,engine2  ; Clear "run" bit of "engine2" variable
                     1226  
                     1227  MINPIP_DONE:
                     1228  
                     1229  ;***********************************************************************************************
                     1230  ; - Check the state of the Fuel/Igntion Trim Selector switch input on PTA5
                     1231  ;   Pin Hi (set)   = Fuel Trim
                     1232  ;   Pin Lo (clear) = Ign Trim
                     1233  ;***********************************************************************************************
                     1234  
 83A0 [05] 0A0002    1235       brset   Trm_Sel,porta,FTRM_ON      ; If "Trm_Sel" (PTA5) is set (Hi) branch to FTRM_ON:
 83A3 [03] 2007      1236       bra     ITRM_ON                    ; Branch to ITRM_ON:
                     1237  
                     1238  FTRM_ON:
 83A5 [05] 0A6509    1239       brset   FTen,portAbits,TRMSEL_DONE ; If "FTen" bit of "tconf" variable is clear, branch to
                     1240                                          ; TRMSEL_DONE:("ftrm" already set, skip over)
 83A8 [04] 1A65      1241       bset    FTen,portAbits             ; Set "FTen" bit of "portAbits" variable
 83AA [03] 2005      1242       bra     TRMSEL_DONE                ; Branch to TRMSEL_DONE:
                     1243  
                     1244  ITRM_ON:
 83AC [05] 0B6502    1245       brclr   FTen,portAbits,TRMSEL_DONE ; If "FTen" bit of "portAbits" variable is clear, branch to
                     1246                                          ; TRMSEL_DONE::("ftrm" already clear, skip over)
 83AF [04] 1B65      1247       bclr    FTen,portAbits             ; Clear "FTen" bit of "portAbits" variable
                     1248  
                     1249  TRMSEL_DONE:
                     1250  
                     1251  ;***********************************************************************************************
                     1252  ; - Check to see if Vehicle Speed on PTA3, or Ignition Monitor on PTA4 is high so it can be
                     1253  ;   re-enabled for keyboard interrupts
                     1254  ;***********************************************************************************************
                     1255  
 83B1 [05] 076B05    1256       brclr   VSen,inputs,CHK_VS_HI      ; If "VSen" bit of "inputs" var is clear, branch to
                     1257                                          ; CHK_VS_HI:
                     1258  
                     1259  CHK_MON_DIS:
 83B4 [05] 056B13    1260       brclr   MONen,inputs,CHK_MON_HI    ; If "MONen" bit of "inputs" var is clear, branch to
                     1261                                          ; CHK_MON_HI:
 83B7 [03] 2020      1262       bra     EN_KYBD_DONE               ; Branch to EN_KYBD_DONE:
                     1263  
                     1264  CHK_VS_HI:
 83B9 [04] 1704      1265       bclr     Veh_Spd,DDRA              ; Clear "Veh_Spd" bit of Port A Data Direction Register
                     1266                                          ;(Make sure PTA3 is configured as an input so it can
                     1267                                          ; be read)
 83BB [05] 0700F6    1268       brclr   Veh_Spd,porta,CHK_MON_DIS  ; If "Veh_Spd" bit of Port A is clear, branch to
                     1269                                          ; CHK_MON_DIS:
                     1270                                          ;(pin is Lo, check Ign Mon)
                     1271  
                     1272  ;**********************************************************************************************
                     1273  ; ------------------------------ Re enable Vehicle Speed KBI ----------------------------------
                     1274  ; To avoid false interrupts, configure pin as output, set, logic Hi, enable KBI, and restore
                     1275  ; pin to input.
                     1276  ;**********************************************************************************************
                     1277  
 83BE [04] 1604      1278       bset     Veh_Spd,DDRA       ; Set "Veh_Spd" bit of Port A Data Direction Register
                     1279                                   ; (pin is output)
 83C0 [04] 1600      1280       bset     Veh_Spd,porta      ; Set "Veh_Spd" pin of Port A (pin is Hi)
 83C2 [04] 161B      1281       bset     Veh_Spd,INTKBIER   ; Set "Veh_Spd" bit of Keyboard Interrupt Enable Register
                     1282                                   ; (enable pin for interrupt)
 83C4 [04] 1704      1283       bclr     Veh_Spd,DDRA       ; Clear "Veh_Spd" bit of Port A Data Direction Register
                     1284                                   ; (pin is input)
 83C6 [04] 166B      1285       bset     VSen,inputs        ; Set "VSen" bit of "inputs" variable
 83C8 [03] 20EA      1286       bra      CHK_MON_DIS        ; Branch to CHK_MON_DIS:


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 12
MC68HC908GP32 User Bootloader


                     1287  
                     1288  CHK_MON_HI:
 83CA [04] 1904      1289       bclr     Ign_Mon,DDRA               ; Clear "Ign_Mon" bit of Port A Data Direction
                     1290                                           ; Register(Make sure PTA4 is configured as an input
                     1291                                           ; so it can be read)
 83CC [05] 09000A    1292       brclr   Ign_Mon,porta,EN_KYBD_DONE  ; If "Ign_Mon" bit of Port A is clear, branch to
                     1293                                           ;EN_KYBD_DONE:(pin is Lo, continue loop)
                     1294  
                     1295  ;**********************************************************************************************
                     1296  ; ------------------------------ Re enable Ignition Monitor KBI -------------------------------
                     1297  ; To avoid false interrupts, configure pin as output, set, logic Hi, enable KBI, and restore
                     1298  ; pin to input.
                     1299  ;**********************************************************************************************
                     1300  
 83CF [04] 1804      1301       bset     Ign_Mon,DDRA       ; Set "Ign_Mon" bit of Port A Data Direction Register
                     1302                                   ; (pin is output)
 83D1 [04] 1800      1303       bset     Ign_Mon,porta      ; Set "Ign_Mon" pin of Port A (pin is Hi)
 83D3 [04] 181B      1304       bset     Ign_Mon,INTKBIER   ; Set "Ign_Mon" bit of Keyboard Interrupt Enable Register
                     1305                                   ; (enable pin for interrupt)
 83D5 [04] 1904      1306       bclr     Ign_Mon,DDRA       ; Clear "Ign_Mon" bit of Port A Data Direction Register
                     1307                                   ; (pin is input)
 83D7 [04] 146B      1308       bset     MONen,inputs       ; Set "MONen" bit of "inputs" variable
                     1309  
                     1310  EN_KYBD_DONE:
                     1311  
                     1312  ;***********************************************************************************************
                     1313  ; - At cranking and low engine speeds, PIP "mirrors" SPOUT. If we are not in "Run" mode,
                     1314  ;   control SPOUT here.
                     1315  ;***********************************************************************************************
                     1316  
                     1317  ;SLOW_SPOUT:
 83D9 [05] 006908    1318       brset   run,engine2,SLOW_SPOUT_DONE  ; If "run" bit of "engine2 variable is set,
                     1319                                            ; branch to SLOW_SPOUT_DONE:
 83DC [03] 2E04      1320       bil     SET_SPOUT_HI                 ; If IRQ pin is low (PIP Hi), branch to SET_SPOUT_HI
 83DE [04] 1200      1321       bset    spark,PORTA                  ; Set "spark" bit of Port A(SPOUT falling edge)
 83E0 [03] 2002      1322       bra     SLOW_SPOUT_DONE              ; Branch to SLOW_SPOUT_DONE:
                     1323  
                     1324  SET_SPOUT_HI:
 83E2 [04] 1300      1325       bclr    spark,PORTA                  ; Clear "spark" bit of Port A (SPOUT rising edge)
                     1326  
                     1327  SLOW_SPOUT_DONE:
                     1328  
                     1329  ;***********************************************************************************************
                     1330  ; - If we are in "Run" mode, and if a spark is not in progress, and if a
                     1331  ;   spark has been scheduled, set and arm TIM1 CH0 with new output compare
                     1332  ;   value to drive SPOUT Hi and fire coil.
                     1333  ;***********************************************************************************************
                     1334  
 83E4 [05] 01690F    1335       brclr   run,engine2,DELAY_DONE       ; If "run" bit of "engine2 variable is clear,
                     1336                                            ; branch to DELAY_DONE:
 83E7 [05] 04690C    1337       brset   sparking,engine2,DELAY_DONE  ; If "sparking" bit of "engine2" variable is set,
                     1338                                            ; branch to DELAY_DONE:
 83EA [05] 036909    1339       brclr   schedspk,engine2,DELAY_DONE  ; If "schedspk" bit of "engine2" variable is clear,
                     1340                                            ; branch to DELAY_DONE:
                     1341  
                     1342  
                     1343  ;***********************************************************************************************
                     1344  ; - Set and arm TIM2 Chan 1 output compare value to fire coil
                     1345  ;   CH1_ocH:CH1_ocL = T2CH1H:T2CH1L
                     1346  ;***********************************************************************************************
                     1347  
                     1348  ;SPARK_DELAY:
 83ED [01] 8C        1349       clrh                      ; Clear index register Hi byte
 83EE [04] 55B4      1350       ldhx    CH1_onH           ; Load index register with value in CH1 on O/C value H:L
 83F0 [04] 3534      1351       sthx    T2CH1H            ; Copy to TIM2 CH1 register H:L
                     1352                                 ;(output compare value for SPOUT rising edge)
 83F2 [04] 1C33      1353       bset    CHxIE,T2SC1       ; Enable interrupt requests TIM2 channel 1
                     1354                                 ; Status and Control Register
 83F4 [04] 1369      1355       bclr    schedspk,engine2  ; Clear "schedspk" bit of "engine2" variable
                     1356  
                     1357  DELAY_DONE:
                     1358  
                     1359  
                     1360  ;***********************************************************************************************
                     1361  ; ---------------------------------------- ADC Section -----------------------------------------
                     1362  ;
                     1363  ; - All tables are pre-computed for all 256 different values and stored in FLASH.
                     1364  ; - Battery voltage is in volts * 10 (volts)
                     1365  ; - Air/Fuel ratio in in A/F * 10 (afrwbo2).
                     1366  ; - Manifold Air and Coolant temperatures are in degrees F plus 40 ("airtemp"
                     1367  ;   and "coolant"). This allows unsigned numbers for full temperature range
                     1368  ; - Barometric and Manifold Air pressures are in Kilopascals ("barometer"
                     1369  ;   and "kpa"). Barometric and Air density correction factors are in percent,
                     1370  ;   with 100 being no correction ("barocor" and "aircor")
                     1371  ; - "trim" is the raw ADC reading of a 10k Fuel/Ign Trim potentiometer.
                     1372  ;   "Ftrimcor" is the fuel correction factor from -15% to +15% (85 to 115)
                     1373  ;   Centre position of the pot is 0 correction (100%).
                     1374  ;   "Itrimcor" is the ignition trim correction factor, 10 degrees advance
                     1375  ;   or retard. 0 = 10 degrees retard, 10 = no trim, 20 = 10 degrees advance.
                     1376  ;***********************************************************************************************
                     1377  
                     1378  ;***********************************************************************************************
                     1379  ; - Update the ADC readings and conversions. This is done only once per ADC conversion complete
                     1380  ;   interrupt, in the first pass through the main loop after the interrupt routine has been
                     1381  ;   completed.
                     1382  ;***********************************************************************************************
                     1383  
 83F6 [05] 026B03    1384       brset   adcc,inputs,ADC_LOOKUPS  ; If "adcc" bit of "inputs" variable is set, branch to
                     1385                                        ; ADC_LOOKUPS:
 83F9 [03] CC8475    1386       jmp     NO_ADC_PASS              ; Jump to NO_ADC_PASS:
                     1387  
                     1388  ADC_LOOKUPS:
                     1389  
                     1390  ;***********************************************************************************************
                     1391  ; - Linear Interpolation of ADC value:
                     1392  ;   tmp1 = Lo ADC(CT_cnt)
                     1393  ;   tmp2 = Hi ADC(WOT_cnt)
                     1394  ;   tmp3 = Lo end of scale(0%)
                     1395  ;   tmp4 = Hi end of scale(100%)
                     1396  ;   tmp5 = ADC value
                     1397  ;   tmp6 = Result
                     1398  ;***********************************************************************************************
                     1399  
                     1400  ;tpspCalc:
                     1401  
 83FC [04] C6E42D    1402       lda     CT_cnt            ; Load accumulator with value in "CT_cnt"
 83FF [03] B790      1403       sta     tmp1              ; Copy to "tmp1"
 8401 [04] C6E42E    1404       lda     WOT_cnt           ; Load accumulator with value in "WOT_cnt"
 8404 [03] B791      1405       sta     tmp2              ; Copy to "tmp2"
 8406 [04] 6E0092    1406       mov     #$00,tmp3         ; Move zero to "tmp3"(0%)
 8409 [04] 6E6493    1407       mov     #$64,tmp4         ; Move decimal 100 to "tmp4"(100%)
 840C [05] 4E4494    1408       mov     tps,tmp5          ; Move value in "tps" to "tmp5"(ADC value)
 840F [05] CD8E31    1409       jsr     lininterp         ; Jump to subroutine at linenterp:
 8412 [03] B695      1410       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 8414 [03] B762      1411       sta     tpsp              ; Copy to "tpsp"(Throttle percent opening)
                     1412  
                     1413  ;***********************************************************************************************
                     1414  ; - No Trim defaults:
                     1415  ;   Ftrimcor    = #$64(decimal 100 =  100% = no trim)
                     1416  ;   Trm_Ang_Fac = #$15(decimal 21 = 10 degrees 6 cyl = no trim)(120/255=.4705)(10/.4705=21)
                     1417  ;   Trm_Ang_Fac = #$1C(decimal 28 = 10 degrees 8 cyl = no trim)(90/255=.3529)(10/.3529=28)
                     1418  ;***********************************************************************************************
                     1419  
                     1420  ;TrimCheck:
 8416 [05] 0A6519    1421       brset   FTen,portAbits,FtrimCalc   ; If "FTen" bit of "portAbits" variable is set, branch
                     1422                                          ;  to FtrimCalc:


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 13
MC68HC908GP32 User Bootloader


                     1423  
                     1424  ;***********************************************************************************************
                     1425  ; - Linear Interpolation of ADC value:
                     1426  ;   tmp1 = (0)
                     1427  ;   tmp2 = (255)
                     1428  ;   tmp3 = High end of scale(6cyl=20/.4706=42($2A)) (8cyl=20/.3529=57($39))
                     1429  ;   tmp4 = Lo end of scale(6cyl=0) (8cyl=0)
                     1430  ;   tmp5 = ADC value
                     1431  ;   tmp6 = Result
                     1432  ;***********************************************************************************************
                     1433  
                     1434  ;ItrimCalc:
 8419 [03] 3F90      1435       clr     tmp1              ; Clear "tmp1"(0 volts)
 841B [04] 6EFF91    1436       mov     #$FF,tmp2         ; Move decimal 255 to "tmp2"(5 volts)
 841E [04] 6E2A92    1437       mov     #$2A,tmp3         ; Move decimal 42 to "tmp3" (20 degrees 6 cyl)
 8421 [03] 3F93      1438       clr     tmp4              ; Clear "tmp4"(0 degrees)
 8423 [05] 4E4794    1439       mov     trim,tmp5         ; Move value in "trim" to "tmp5"(ADC value)
 8426 [05] CD8E31    1440       jsr     lininterp         ; Jump to subroutine at linenterp:
 8429 [03] B695      1441       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 842B [03] B75B      1442       sta     Trm_Ang_Fac       ; Copy to Trim Angle Factor variable
 842D [04] 6E644D    1443       mov     #$64,Ftrimcor     ; Move decimal 100 into "Ftrimcor"(no fuel trim)
 8430 [03] 2018      1444       bra     CHK_TRM_DONE      ; Branch to CHK_TRM_DONE
                     1445  
                     1446  
                     1447  ;***********************************************************************************************
                     1448  ; - Linear Interpolation of ADC value:
                     1449  ;   tmp1 = 0
                     1450  ;   tmp2 = 255
                     1451  ;   tmp3 = High end of scale(115%=115($73))
                     1452  ;   tmp4 = Lo end of scale(85%=85($55))
                     1453  ;   tmp5 = ADC value
                     1454  ;   tmp6 = Result
                     1455  ;***********************************************************************************************
                     1456  
                     1457  FtrimCalc:
 8432 [03] 3F90      1458       clr     tmp1              ; Clear "tmp1"(0 volts)
 8434 [04] 6EFF91    1459       mov     #$FF,tmp2         ; Move decimal 255 to "tmp2"(5 volts)
 8437 [04] 6E7392    1460       mov     #$73,tmp3         ; Move decimal 115 to "tmp3" (115%)
 843A [04] 6E5593    1461       mov     #$55,tmp4         ; Move decimal 85 to "tmp4"(85%)
 843D [05] 4E4794    1462       mov     trim,tmp5         ; Move value in "trim" to "tmp5"(ADC value)
 8440 [05] CD8E31    1463       jsr     lininterp         ; Jump to subroutine at linenterp:
 8443 [03] B695      1464       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 8445 [03] B74D      1465       sta     Ftrimcor          ; Copy to Fuel Trim Correction Factor
 8447 [04] 6E155B    1466       mov     #$15,Trm_Ang_Fac  ; Move decimal 21 into "Trm_Ang_Fac" (no ign trim 6 cyl)
                     1467  
                     1468  CHK_TRM_DONE:
 844A [01] 8C        1469       clrh                      ; Clear index register Hi byte
                     1470  
                     1471  ;KPA_CALC:
 844B [03] B641      1472       lda     map                  ; Load accumulator with value in MAP ADC
 844D [01] 97        1473       tax                          ; Copy to index register Lo byte
 844E [04] D6F100    1474       lda     KPAFACTOR4250rjh,x   ; Load accumulator with value in KPAFACTOR4250rjh table
                     1475                                    ; offset in index register Lo byte
 8451 [03] B76C      1476       sta     kpa                  ; Copy to Manifold Air Pressure in Kilopascals
                     1477  
                     1478  ;BAROM_CALC:
 8453 [03] B648      1479       lda     baro                 ; Load accumulator with value in Barometric Pressure ADC
 8455 [01] 97        1480       tax                          ; Copy to index register Lo byte
 8456 [04] D6F100    1481       lda     KPAFACTOR4250rjh,x   ; Load accumulator with value in KPAFACTOR4250rjh table,
                     1482                                    ; offset in index register Lo byte
 8459 [03] B749      1483       sta     barometer            ; Copy to Barometric Pressure in Kilopascals
                     1484  
                     1485  ;BARO_CALC:
 845B [03] B648      1486       lda     baro                 ; Load accumulator with value in Barometric Pressure ADC
 845D [01] 97        1487       tax                          ; Copy to index register Lo byte
 845E [04] D6F000    1488       lda     BAROFAC4250rjh,x     ; Load accumulator with value in BAROFAC4250rjh table,
                     1489                                    ; offset in index register Lo byte
 8461 [03] B74A      1490       sta     barocor              ; Copy to Barometer Correction
                     1491  
                     1492  ;AIR_CALC:
 8463 [03] B642      1493       lda     mat               ; Load accumulator with value in Manifold Air Temperatue ADC
 8465 [01] 97        1494       tax                       ; Copy to index register Lo byte
 8466 [04] D6F300    1495       lda     airdenfactor,x    ; Load accumulator with value in airdenfactor table,
                     1496                                 ; offset in index register Lo byte(modified for Ford sensor)
 8469 [03] B74C      1497       sta     aircor            ; Copy to Air Density Correction
                     1498  
                     1499  ;CLT_CALC:
 846B [03] B643      1500       lda     clt               ; Load accumulator with value in Coolant Temperature ADC
 846D [01] 97        1501       tax                       ; Copy to index register Lo byte
 846E [04] D6F200    1502       lda     thermfactor,x     ; Load accumulator with value in thermfactor table,
                     1503                                 ; offset in index register Lo byte(modified for Ford sensor)
 8471 [03] B76D      1504       sta     coolant           ; Copy to Coolant Temp in degreesF+40
                     1505  
                     1506  ADC_DONE:
 8473 [04] 136B      1507       bclr    adcc,inputs       ; Clear "adcc" bit of "inputs" variable
                     1508  
                     1509  NO_ADC_PASS:
                     1510  
                     1511  ;***********************************************************************************************
                     1512  ; - Spark scheduling, as well as RPM calculations are done only once in the
                     1513  ;   main loop after the PIP rising edge signal has been received, the
                     1514  ;   interrupt routine has been completed, and relevent variables updated.
                     1515  ;***********************************************************************************************
                     1516  
 8475 [05] 006B03    1517       brset   piprise,inputs,PIP_PASS          ; If "piprise" bit of "inputs" variable is set,
                     1518                                                ; branch to PIP_PASS:
 8478 [03] CC857D    1519       jmp     NO_PIP_PASS                      ; Jump to NO_PIP_PASS:
                     1520  
                     1521  PIP_PASS:
                     1522  
                     1523  ;***********************************************************************************************
                     1524  ;
                     1525  ; ------------- IGNITION CALCULATION and SCHEDULING SECTION -----------------
                     1526  ;
                     1527  ; To simplify the igntion calculations, the angles are scaled by a factor of
                     1528  ; 256. The PIP Angle Factor is 256, and all other angles are scaled to this.
                     1529  ;
                     1530  ;***********************************************************************************************
                     1531  
                     1532  ;***********************************************************************************************
                     1533  ; - Calculate Period
                     1534  ;   PIP_tsH:PIP_tsL - PIP_tsH_prv:PIP_tsL_prv = PIP_pH:PIP_pL
                     1535  ;***********************************************************************************************
                     1536  
                     1537  IGNITION_CALCS:
 847B [03] B6A7      1538       lda     PIP_tsL        ; Load accumulator with value in PIP timestamp Lo byte
 847D [03] B0A9      1539       sub     PIP_tsL_prv    ; Subtract A<-(A)-(M) PIP Timestamp previous Lo byte
 847F [03] B7AF      1540       sta     PIP_pL         ; Copy result to PIP period Lo byte variable
 8481 [03] B7D1      1541       sta     tachcurL       ; Copy to "tachcurL"
 8483 [03] B6A6      1542       lda     PIP_tsH        ; Load accumulator with value in PIP timestamp Hi byte
 8485 [03] B2A8      1543       sbc     PIP_tsH_prv    ; Subtract with carry A<-(A)-(M)-(C)
                     1544                              ;(PIP Timestamp previous Hi byte)
 8487 [03] B7AE      1545       sta     PIP_pH         ; Copy result to PIP period Hi byte variable
 8489 [03] B7D0      1546       sta     tachcurH       ; Copy to "tachcurH"
                     1547  
                     1548  ;***********************************************************************************************
                     1549  ; - 1/02/11 Skip the "predicted period" thing to see if it makes any real world difference
                     1550  ;***********************************************************************************************
                     1551  
 848B [03] B6AF      1552       lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
 848D [03] B7B1      1553       sta     PIP_pL_pred     ; Copy to "PIP_pL_pred"(for SPOUT on calcs)
 848F [03] B7B9      1554       sta     PIP_PeriodL     ; Copy to "PIP_PeriodL"(for SPOUT off calcs)
 8491 [03] B6AE      1555       lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
 8493 [03] B7B0      1556       sta     PIP_pH_pred     ; Copy to "PIP_pH_pred"(for SPOUT on calcs)
 8495 [03] B7B8      1557       sta     PIP_PeriodH     ; Copy to "PIP_PeriodH"(for SPOUT off calcs)
                     1558  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 14
MC68HC908GP32 User Bootloader


                     1559  
                     1560  ;*;***********************************************************************************************
                     1561  ;*; - Calculate "predicted" period to compensate for acceleration/deceleration Tom Hafner
                     1562  ;*;   (megaspark) reported better results with this method so I've always used it)
                     1563  ;*;***********************************************************************************************
                     1564  
                     1565  ;*     lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
                     1566  ;*     sub     PIP_pL_prv      ; Subtract A<-(A)-(M)(PIP_pL - PIP_pL_prv = PIP_pL_dif)
                     1567  ;*     sta     PIP_pL_dif      ; Copy result to "PIP_pL_dif" variable
                     1568  ;*     lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
                     1569  ;*     sbc     PIP_pH_prv      ; Subtract with carry A<-(A)-(M)-(C)
                     1570  ;*                             ;(PIP_pH - PIP_pH_prv = PIP_pH_dif)
                     1571  ;*     sta     PIP_pH_dif      ; Copy result to "PIP_pH_dif" variable
                     1572  ;*     lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
                     1573  ;*     add     PIP_pL_dif      ; Add without Carry A<-(A)+(M)(PIP_pL + PIP_pL_dif = PIP_pL_pred)
                     1574  ;*     sta     PIP_pL_pred     ; Copy to "PIP_pL_pred" variable(for SPOUT on calcs)
                     1575  ;*     sta     PIP_PeriodL     ; Copy to PIP Period Lo byte(for SPOUT off calcs)
                     1576  ;*     lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
                     1577  ;*     adc     PIP_pH_dif      ; Add with Carry A<-(A)+(M)
                     1578  ;*                             ; (PIP_pH + PIP_pH_dif = PIP_pH_pred)
                     1579  ;*     sta     PIP_pH_pred     ; Copy to "PIP_pH_pred" variable(for SPOUT on calcs)
                     1580  ;*     sta     PIP_PeriodH     ; Copy to PIP Period Hi byte(for SPOUT off calcs)
                     1581  
                     1582  ;***********************************************************************************************
                     1583  ; - Calculate delay time from PIP rising edge to drive SPOUT Hi (on).
                     1584  ;   This is a magical bit of code that Magnus uses and took me the longest
                     1585  ;   time to understand. I originally developed the long math routine version
                     1586  ;   with UMUL32 and UDVD32,,which worked, but got my program loop frequency
                     1587  ;   down to about 768HZ @ ~6450RPM 8cyl, where the ignition starts to falter.
                     1588  ;   This code runs at ~973HZ @ ~6450, and 963HZ @ ~8205RPM 8cyl until falter.
                     1589  ;   (The falter may be due to the duty cycle of my "superstim" IRQ input.)
                     1590  ;   It is simply an 8 bit by 16 bit multiply, which yields a 24 bit result.
                     1591  ;   By ignoring the least significant byte, you effectively divide the 24
                     1592  ;   bit result by 256, rounded down.
                     1593  ;   So, the PIP Period Predicted * Delay Angle Factor / PIP Angle Factor
                     1594  ;   = Delay Period
                     1595  ;
                     1596  ;   PIP_pH_pred:PIP_pL_pred * Dly_Ang_Fac / $01:00 = Delay_pH:Delay_pL.
                     1597  ;
                     1598  ;***********************************************************************************************
                     1599  
                     1600  ;DELAY_CALC:
 8497 [03] B65C      1601       lda     Dly_Ang_Fac     ; Load accumulator with value in Delay Angle Factor
 8499 [03] BEB0      1602       ldx     PIP_pH_pred     ; Load index register Lo byte with value in PIP period predicted Hi
 849B [05] 42        1603       mul                     ; Multiply (X:A)<-(X)*(A)
 849C [03] BF90      1604       stx     tmp1            ; Copy value in index register Lo byte to tmp1 variable
                     1605                               ; (result Hi byte)
 849E [03] B791      1606       sta     tmp2            ; Copy value in accumulator to tmp2 variable
                     1607                               ;(result Lo byte)
 84A0 [03] B65C      1608       lda     Dly_Ang_Fac     ; Load accumulator with value in Delay
 84A2 [03] BEB1      1609       ldx     PIP_pL_pred     ; Load index register Lo byte with value in PIP period predicted Lo
 84A4 [05] 42        1610       mul                     ; Multiply (X:A)<-(X)*(A)
 84A5 [01] 9F        1611       txa                     ; Transfer value in index register Lo byte to accumulator
                     1612                               ;(result Hi byte to accumulator)
 84A6 [03] BB91      1613       add     tmp2            ; Add (A)<-(A)+(M)(Lo byte result of Hi byte
                     1614                               ; mul + Hi byte result of Lo byte mul)
 84A8 [03] B7B3      1615       sta     Delay_pL        ; Copy result to Delay Period Lo byte variable
 84AA [03] B690      1616       lda     tmp1            ; Load accumulator with value in tmp1 variable
                     1617                               ;(Hi byte result of Hi byte mul)
 84AC [02] A900      1618       adc     #$0             ; Add with carry decimal 0 (A)<-(A)+(M)+(C)(just add the carry)
 84AE [03] B7B2      1619       sta     Delay_pH        ; Copy result to Delay Period Hi byte variable
                     1620  
                     1621  
                     1622  ;***********************************************************************************************
                     1623  ; - Calculate the output compare value for delay from PIP to SPOUT
                     1624  ;   PIP_tsH:PIP_tsL + Delay_pH:Delay_pL = CH1_onH:CH1_onL
                     1625  ;***********************************************************************************************
                     1626  
                     1627  ;CALC_OC:
 84B0 [03] B6A7      1628       lda     PIP_tsL            ; Load accumulator with value in "PIP_tsL"
 84B2 [03] BBB3      1629       add     Delay_pL           ; Add without Carry A<-(A)+(M)(PIP_tsL + Delay_pL)
 84B4 [01] 97        1630       tax                        ; Transfer result in accumulator to index register Lo byte
 84B5 [03] B6A6      1631       lda     PIP_tsH            ; Load accumulator with value in "PIP_tsH"
 84B7 [03] B9B2      1632       adc     Delay_pH           ; Add with Carry A<-(A)+(M)
 84B9 [03] B7B4      1633       sta     CH1_onH            ; Copy to CH1 on O/C value Hi byte
 84BB [03] BFB5      1634       stx     CH1_onL            ; Copy to CH1 on O/C value Lo byte
 84BD [04] 1269      1635       bset    schedspk,engine2   ; Set "schedspk" bit of "engine2" variable
                     1636  
                     1637  
                     1638  ;***********************************************************************************************
                     1639  ; - Calculate SPOUT on time (50% duty cycle, half PIP predicted period)
                     1640  ;***********************************************************************************************
                     1641  
 84BF [03] BEB9      1642       ldx     PIP_periodL      ; Load index register Lo byte with value in PIP Period Lo byte
 84C1 [03] B6B8      1643       lda     PIP_periodH      ; Load accumulator with value in PIP Period Hi byte
 84C3 [01] 44        1644       lsra                     ; Logical shift right accumulator
 84C4 [01] 56        1645       rorx                     ; Rotate right through carry index register Lo byte
                     1646                                ; (these 2 steps = A:X / 2)
 84C5 [03] B7BA      1647       sta     SPOUTon_pH       ; Copy to Spout on period Hi byte
 84C7 [03] BFBB      1648       stx     SPOUTon_pL       ; Copy to Spout on period Lo byte
                     1649  
                     1650  
                     1651  ;***********************************************************************************************
                     1652  ; - Save the current timestamp as timestamp previous for next calculations
                     1653  ;***********************************************************************************************
                     1654  
 84C9 [05] 4EA6A8    1655       mov     PIP_tsH,PIP_tsH_prv  ; Copy value in PIP_tsH to PIP_tsH_prv
 84CC [05] 4EA7A9    1656       mov     PIP_tsL,PIP_tsL_prv  ; Copy value in PIP_tsL to PIP_tsL_prv
                     1657  
                     1658  
                     1659  ;***********************************************************************************************
                     1660  ; - Save the current period as period previous for next calculations
                     1661  ;***********************************************************************************************
                     1662  
 84CF [05] 4EAEAA    1663       mov     PIP_pH,PIP_pH_prv  ; Copy value in PIP_pH to PIP_pH_prv
 84D2 [05] 4EAFAB    1664       mov     PIP_pL,PIP_pL_prv  ; Copy value in PIP_pL to PIP_pL_prv
                     1665  
                     1666  ;IGN_CALCS_DONE:
                     1667  
                     1668  ;***********************************************************************************************
                     1669  ;
                     1670  ; ---------------------------------- RPM CALCULATION SECTION -----------------------------------
                     1671  ;
                     1672  ; RPM = CONSTANT/PERIOD
                     1673  ; Where:
                     1674  ; RPM         = Engine RPM
                     1675  ; RPM_K = 16 bit constant using .1ms clock tick (10khz)
                     1676  ;               ((10,000tickpsec*60secpmin)/(number of cyl/(stroke/2)))
                     1677  ; RPM_P = 16 bit period count between IRQ pulsed lines in 0.1ms
                     1678  ;               resolution
                     1679  ;   RPM_K
                     1680  ;   ----- = RPM
                     1681  ;   RPM_P
                     1682  ;
                     1683  ; 6cyl 4stroke RPMK = ((10,000*60)/3) = 200,000
                     1684  ; 8cyl 4stroke RPMK = ((10,000*60)/4) = 150,000
                     1685  ;
                     1686  ; We use the 100uS clock tick to calculate RPM/20. This allows us to use an
                     1687  ; 8 bit variable with a range of 0 to 5,100 RPM
                     1688  ; Our formula is now:
                     1689  ;
                     1690  ; rpm = constant/period
                     1691  ; Where:
                     1692  ; rpm         = Engine RPM/20 (0 to 5,100 RPM to fit in 8 bit variable)
                     1693  ; RPMk:RPMk+1 = 16 bit constant using 100uS clock tick (10khz)
                     1694  ;               ((10,000tickpsec*60secpmin)/(number of cyl/(stroke/2)))/20


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 15
MC68HC908GP32 User Bootloader


                     1695  ; RPMpH:RPMpL = 16 bit period count between IRQ pulsed lines in 100uS
                     1696  ;               resolution
                     1697  ;   rpmk:rpmk+1
                     1698  ;   ----------- = rpm
                     1699  ;   RPMpH:RPMpL
                     1700  ;
                     1701  ; 6cyl 4stroke rpmK = ((10,000*60)/3)/20 = 10,000 = $2710
                     1702  ; 8cyl 4stroke rpmK = ((10,000*60)/4)/20 = 7,500  = $1D4C
                     1703  ; 6cyl RPM resolution is ~05@~1000, ~20@~2000, ~76@~3000, and ~128@~5000
                     1704  ; 8cyl RPM resolution is ~06@~1000, ~27@~2000, ~61@~3000, and ~172@~5000
                     1705  ;***********************************************************************************************
                     1706  
                     1707  ;***********************************************************************************************
                     1708  ; - Calculate Engine RPM/20.
                     1709  ;***********************************************************************************************
                     1710  
                     1711  ;RPM_COMP:
 84D5 [04] 5575      1712       ldhx    RPMph               ; Load index register with value in RPM Period Hy byte
 84D7 [03] 2728      1713       beq     RPM_CALC_DONE       ; If Z bit of CCR is set, branch to RPM_CALC_DONE:
 84D9 [02] 8B        1714       pshh                        ; Push value in index register Hi byte to stack
 84DA [02] 86        1715       pula                        ; Pull value in stack to accumulator
 84DB [01] 4D        1716       tsta                        ; Test accumulator for Z or N
 84DC [03] 2717      1717       beq     FAST_RPM_CALC       ; If the Z bit of CCR is set, branch to FAST_RPM_CALC:
                     1718  
                     1719  ;SLOW_RPM_CALC:
 84DE [03] 3F88      1720       clr     intacc1             ; Clear intacc1 variable
 84E0 [03] 3F89      1721       clr     intacc1+1           ; Clear intacc1+1 variable
 84E2 [04] 358C      1722       sthx    intacc2             ; Copy value in index register to intacc2 variable
 84E4 [02] A627      1723       lda     #$27                ; Load accumulator with $27 ("RPMk" 6 cyl)
 84E6 [03] B78A      1724       sta     intacc1+2           ; Copy to "intacc1+2
 84E8 [02] A610      1725       lda     #$10                ; Load accumulator with $10 ("RPMk+1" 6 cyl)
 84EA [03] B78B      1726       sta     intacc1+3           ; Copy to "intacc1+3"
 84EC [05] CD8E86    1727       jsr     udvd32              ; Jump to subroutine udvd32 (32x16 divide)
 84EF [03] B68B      1728       lda     intacc1+3           ; Load accumulator with value in intacc1+3(8-bit RPM result)
 84F1 [03] B750      1729       sta     rpm20               ; Copy to "rpm20"
 84F3 [03] 200C      1730       bra     RPM_CALC_DONE       ; Branch to RPM_CALC_DONE:
                     1731  
                     1732  FAST_RPM_CALC:
 84F5 [02] A627      1733       lda     #$27          ; Load accumulator with $27 ("RPMk" 6 cyl)
 84F7 [02] 87        1734       psha                  ; Push value in accumulator to stack
 84F8 [02] 8A        1735       pulh                  ; Pull value from stack to index register Hi byte
 84F9 [02] A610      1736       lda     #$10          ; Load accumulator with $10 ("RPMK+1" 6 cyl)
 84FB [07] 52        1737       div                   ; Divide (A = (H:A) / X)
 84FC [05] CD8F12    1738       jsr     DIVROUND      ; Jump to "DIVROUND" subroutine,(round result)
 84FF [03] B750      1739       sta     rpm20         ; Copy to "rpm20"
                     1740  
                     1741  RPM_CALC_DONE:
                     1742  
                     1743  ;**********************************************************************************************
                     1744  ; - Check for over speed. If overspeed, set the alarm bit which will skip over the Injector
                     1745  ;   Firing Control in the 100uS section which should slow things down in a hurry
                     1746  ;;**********************************************************************************************
                     1747  
 8501 [03] B650      1748       lda     rpm20                       ; Load accumulator with value in "rpm20"
 8503 [02] A1E1      1749       cmp     #$E1                        ; Compare with decimal 225(4500RPM)
 8505 [03] 2407      1750       bhs     REV_LIMIT                   ; If (A=>(M), branch to REV_LIMIT:
 8507 [05] 036409    1751       brclr   REVL,alarmbits,REV_LIM_DONE ; If "REVL" bit of "alarmbits" is clear, branch to
                     1752                                           ; REV_LIM_DONE:(bit already clear, skip over)
 850A [04] 1364      1753       bclr    REVL,alarmbits              ; Clear "REVL" bit of "alarmbits"
 850C [03] 2005      1754       bra     REV_LIM_DONE                ; Branch to REV_LIM_DONE
                     1755  
                     1756  REV_LIMIT:
                     1757  
 850E [05] 026402    1758       brset   REVL,alarmbits,REV_LIM_DONE ; If "REVL" bit of "alarmbits" is set, branch to
                     1759                                           ; REV_LIM_DONE:(bit already set, skip over)
 8511 [04] 1264      1760       bset    REVL,alarmbits              ; Set "REVL" bit of "alarmbits"
                     1761  
                     1762  REV_LIM_DONE:
                     1763  
                     1764  ;***********************************************************************************************
                     1765  ; - Determine if engine RPMs are high enough that the ~1uS TIM2 counter
                     1766  ;   won't overflow between PIP signals, and that the engine has actually
                     1767  ;   started.(for ignition calcs)
                     1768  ;   At ~1uS, 65535 rollover occurs at 305.18 RPM 6cyl, and 228.88 RPM 8cyl
                     1769  ;   Start/Run break point for fuel is at 320 RPM, so this Lo limit is
                     1770  ;   set to 340 RPM
                     1771  ;***********************************************************************************************
                     1772  
 8513 [03] B650      1773       lda     rpm20             ; Load accumulator with value in RPM/20
 8515 [02] A111      1774       cmp     #$11              ; Compare it with decimal 17(340 RPM)
 8517 [03] 2204      1775       bhi     SET_RUN_E2        ; If (A)>(M), branch to SET_RUN_E2:
 8519 [04] 1169      1776       bclr    run,engine2       ; Clear "run" bit of "engine2" variable
 851B [03] 2002      1777       bra     CHK_LO_SPD_DONE   ; Branch to CHK_LO_SPD_DONE:
                     1778  
                     1779  SET_RUN_E2:
 851D [04] 1069      1780       bset    run,engine2       ; Set "run" bit of "engine2" variable
                     1781  
                     1782  CHK_LO_SPD_DONE:
                     1783  
                     1784  ;***********************************************************************************************
                     1785  ; - The high resolution tach uses a time stamp from the ~1uS counters T2CNTH:T2CNTL which
                     1786  ;   overflows at 306.044 RPM for 6 cyl, and 227.84 RPM for 8 cyl engines.
                     1787  ;   It is saved as tachcurH:tachcurL
                     1788  ;
                     1789  ;   Resolution @ 5000 RPM is 1.25 RPM 6 cyl, 1.67 RPM 8 cyl
                     1790  ;   Resolution @ 2500 RPM is 0.31 RPM 6 cyl, 0.42 RPM 8 cyl
                     1791  ;   Resolution @ 1000 RPM is 0.05 RPM 6 cyl, 0.07 RPM 8 cyl
                     1792  ;
                     1793  ;   tachcurH:tachcurL is added to tachTH:tachTM:TachTL for 250 ms, then divided by the value of
                     1794  ;   "tachcnt" which was incemented at every trigger signal, to smooth the read out.
                     1795  ;
                     1796  ;***********************************************************************************************
                     1797  
                     1798  ;***********************************************************************************************
                     1799  ; - First make sure that our engine speed is above roll over point for the 16 bit period value.
                     1800  ;   If it is, do the Hi Res tach period averaging calculations, if not rail tachH:tachL, clear
                     1801  ;   "tachcnt" so it will be at zero when the revs are within range and skip over.
                     1802  ;***********************************************************************************************
                     1803  
 851F [05] 00690B    1804       brset   run,engine2,HI_RES_TACH     ; If "run" bit of "engine2" variable is set,
                     1805                                           ; branch to HI_RES_TACH:
 8522 [02] A6FF      1806       lda     #$FF                        ; Load accumulator with decimal 255
 8524 [03] B758      1807       sta     tachH                       ; Copy to "tachH"
 8526 [03] B759      1808       sta     tachL                       ; Copy to "tachL"
 8528 [03] 3FD5      1809       clr     tachcnt                     ; Clear "tachcnt"
 852A [03] CC856F    1810       jmp     HI_RES_TACH_DONE            ; Branch to HI_RES_TACH_DONE:
                     1811  
                     1812  HI_RES_TACH:
 852D [03] B6D4      1813       lda     tachTL       ; Load accumulator with value in "tachTL" (total Lo byte)
 852F [03] BBD1      1814       add     tachcurL     ; Add "tachcurL" A<-(A)+(M)(current period Lo Byte)
 8531 [03] B7D4      1815       sta     tachTL       ; Copy to "tachTL"(result Lo byte)(updated total Lo byte
 8533 [03] B6D3      1816       lda     tachTM       ; Load accumulator with value in "tachTM" (total Mid byte)
 8535 [03] B9D0      1817       adc     tachcurH     ; Add with carry "tachcurH" A<-(A)+(M)(current period Hi Byte)
 8537 [03] B7D3      1818       sta     tachTM       ; Copy to "tachTM"(result Mid byte)(updated total Mid byte
 8539 [03] B6D2      1819       lda     tachTH       ; Load accumulator with value in "tachTH" (total Hi Byte)
 853B [02] A900      1820       adc     #$0          ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 853D [03] B7D2      1821       sta     tachTH       ; Copy to "tachTH"(result Hi byte)(updated total Hi byte
                     1822  
                     1823  ;***********************************************************************************************
                     1824  ; - Check "clock250,inputs" to see if it's time to average the period values
                     1825  ;***********************************************************************************************
                     1826  
 853F [05] 0A6B02    1827       brset   clock250,inputs,AV_HI_RES_PERIOD     ; If "clock250" bit of "inputs variable is
                     1828                                                    ; set, branch to AV_HO_RES_PERIOD:
 8542 [03] 202B      1829       bra     HI_RES_TACH_DONE                     ; Branch to HI_RES_TACH_DONE:
                     1830  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 16
MC68HC908GP32 User Bootloader


                     1831  AV_HI_RES_PERIOD:
 8544 [03] 3F88      1832       clr     intacc1             ; Clear intacc1 (divident Hi Byte)
 8546 [03] 3F89      1833       clr     intacc1+1           ; Clear intacc1+1 (dividend Mid Hi Byte)
 8548 [03] 3F8C      1834       clr     intacc2             ; Clear intacc2 (divisor Hi Byte)
 854A [03] B6D2      1835       lda     tachTH              ; Load accumulator with value in "tachTH"
 854C [03] B789      1836       sta     intacc1+1           ; Copy to intacc1+1 (dividend Mid Hi Byte)
 854E [03] B6D3      1837       lda     tachTM              ; Load accumulator with value in "tachTM"
 8550 [03] B78A      1838       sta     intacc1+2           ; Copy to intacc1+2 (dividend Mid Lo Byte)
 8552 [03] B6D4      1839       lda     tachTL              ; Load accumulator with value in "tachTL"
 8554 [03] B78B      1840       sta     intacc1+3           ; Copy to intacc1+3 (dividend Lo Byte)
 8556 [03] B6D5      1841       lda     tachcnt             ; Load accumulator with value in "tachcnt"
 8558 [03] B78D      1842       sta     intacc2+1           ; Copy to intacc2+1 (divisor Lo Byte)
 855A [05] CD8E86    1843       jsr     udvd32              ; Jump to "udcd32" subroutine (32x16 divide)
 855D [03] B68B      1844       lda     intacc1+3           ; Load accumulator with value in intacc1+3 (result Lo Byte)
 855F [03] B759      1845       sta     tachL               ; Copy to "tachL"
 8561 [03] B68A      1846       lda     intacc1+2           ; Load accumulator with value in intacc1+2 (result Hi Byte)
 8563 [03] B758      1847       sta     tachH               ; Copy to "tachH"
 8565 [03] 3FD2      1848       clr     tachTH              ; Clear "tachTH" (total Hi Byte)
 8567 [03] 3FD3      1849       clr     tachTM              ; Clear "tachTM" (total Mid Byte)
 8569 [03] 3FD4      1850       clr     tachTL              ; Clear "tachTL" (total Lo Byte)
 856B [03] 3FD5      1851       clr     tachcnt             ; Clear "tachcnt" (tachometer period averaging counter)
 856D [04] 1B6B      1852       bclr    clock250,inputs     ; Clear "clock250" bit of "inputs" variable
                     1853  
                     1854  HI_RES_TACH_DONE:
                     1855  
                     1856  ;***********************************************************************************************
                     1857  ; - Determine if engine RPMs are high enough that we have finished cranking,
                     1858  ;   and that the engine has actually started. (for fuel calcs)
                     1859  ;***********************************************************************************************
                     1860  
                     1861  ;CHK_CRANK:
 856F [03] B650      1862       lda     rpm20             ; Load accumulator with value in RPM/20
 8571 [02] A111      1863       cmp     #$11              ; Compare it with decimal 17(340 RPM)
 8573 [03] 2204      1864       bhi     ENG_START         ; If (A)>(M), branch to ENG_START:
 8575 [04] 1769      1865       bclr    started,engine2   ; Clear "started" bit of "engine2" variable
 8577 [03] 2002      1866       bra     PIP_PASS_DONE     ; Branch to PIP_PASS_DONE:
                     1867  
                     1868  ENG_START:
 8579 [04] 1669      1869       bset    started,engine2   ; Set "started" bit of "engine2" variable
                     1870  
                     1871  PIP_PASS_DONE:
 857B [04] 116B      1872       bclr    piprise,inputs    ; Clear "piprise" bit of "inputs" variable
                     1873  
                     1874  NO_PIP_PASS:
 857D [05] 08694A    1875       brset   cant_crank,engine2,WARM_UP_ENRICH ; If "cant_crank" bit of "engine2" variable is
                     1876                                                 ; set, branch to WARM_UP_ENRICH:
 8580 [05] 066947    1877       brset   started,engine2,WARM_UP_ENRICH    ; If "started" bit of "engine2" variable is
                     1878                                                 ; set, branch to WARM_UP_ENRICH:
                     1879  
                     1880  
                     1881  ;***********************************************************************************************
                     1882  ;
                     1883  ; ------------------------------------- Cranking Mode ------------------------------------------
                     1884  ;
                     1885  ; Pulsewidth is directly set by the coolant temperature value of
                     1886  ;  CWU (at -40 degrees) and CWH (at 165 degrees) - value is interpolated
                     1887  ;
                     1888  ;***********************************************************************************************
                     1889  
                     1890  ;CRANKING_SET:
 8583 [04] 1263      1891       bset    crank,engine    ; Set crank bit of engine variable
 8585 [04] 1563      1892       bclr    startw,engine   ; Clear startw bit of engine variable
 8587 [04] 1763      1893       bclr    warmup,engine   ; Clear warmup bit of engine variable
 8589 [04] C6E428    1894       lda     floodClear       ; Load accumulator with value in "floodClear"(flood clear trigger)
 858C [03] B144      1895       cmp     tps              ; Compare with current throttle position ADC reading
 858E [03] 220F      1896       bhi     INTERP_CRANK_PW ; If (A)>(M), branch to INTERP_CRANK_PW:
                     1897  
                     1898  FLOOD_CLEAR:
 8590 [02] A601      1899       lda     #$01             ; Load accumulator with decimal 1(0.001 ms pulsewidth)
 8592 [03] B753      1900       sta     pwcalcl          ; Copy to "pwcalcl"
 8594 [03] 3F52      1901       clr     pwcalch          ; Clear "pwcalch"
 8596 [03] 3F54      1902       clr     pw               ; Clear "pw"
 8598 [03] 3F55      1903       clr     fd               ; Clear "fd"
 859A [04] 1464      1904       bset    fldClr,alarmbits ; Set "fldClr" bit of "alarmbits"
 859C [03] CC8381    1905       jmp     LOOPER           ; Jump to LOOPER: (Keep looping until "floodClear">"tps"
                     1906  
                     1907  INTERP_CRANK_PW:
 859F [04] 1564      1908       bclr    fldClr,alarmbits ; Clear "fldClr" bit of "alarmbits"
 85A1 [02] A600      1909       lda     #$00             ; Load accumulator with decimal 0
 85A3 [03] B790      1910       sta     tmp1             ; Copy to tmp1 variable
 85A5 [02] A6CD      1911       lda     #$CD             ; Load accumulator with decimal 205 165 + 40 degrees
                     1912                                ; (offset in lookup table)
 85A7 [03] B791      1913       sta     tmp2             ; Copy to tmp2 variable
 85A9 [04] C6E41C    1914       lda     cwu              ; Load accumulator with value in "cwu"
 85AC [03] B792      1915       sta     tmp3             ; Copy to "tmp3"
 85AE [04] C6E41D    1916       lda     cwh              ; Load accumulator with value in "cwh"
 85B1 [03] B793      1917       sta     tmp4             ; Copy to "tmp4"
 85B3 [05] 4E6D94    1918       mov     coolant,tmp5     ; Move value at current coolant temp to tmp5
 85B6 [05] CD8E31    1919       jsr     lininterp        ; Jump to Lininterp: (interpolation subroutine)
 85B9 [03] B695      1920       lda     tmp6             ; Load accumulator with value in tmp6 variable
                     1921                                ; (result of calculation)
 85BB [03] B754      1922       sta     pw               ; Copy to "pw"
 85BD [03] B755      1923       sta     fd               ; Copy to "fd"
 85BF [01] 97        1924       tax                      ; Transfer value in accumulator to index reg Lo
 85C0 [02] A664      1925       lda     #$64             ; Load accumulator with decimal 100
 85C2 [05] 42        1926       mul                      ; Multiply X:A <-(X)*(A)
 85C3 [03] BF52      1927       stx     pwcalch          ; Copy value in index register to
                     1928                                ; Calculated pulsewidth Hi byte
 85C5 [03] B753      1929       sta     pwcalcl          ; Copy value in acumulator to
                     1930                                ; Calculated pulsewidth Lo byte
 85C7 [03] CC8381    1931       jmp     LOOPER           ; Jump to LOOPER: (loop until engine starts)
                     1932  
                     1933  
                     1934  ;***********************************************************************************************
                     1935  ;
                     1936  ; ----------------------- Warm Up and After Start Enrichment section ---------------------------
                     1937  ;
                     1938  ; The Warm-up enrichment is a linear interpolated value from WWU (10 points)
                     1939  ; which are placed at configurabletemperatures in the WWURANGE table originally set at
                     1940  ; -40, -20, 0, +20, +40, +60, +80, +100, +130, and +160 degrees F
                     1941  ;
                     1942  ; The After Start enrichment is active below the user set point ASElo,
                     1943  ; and active above user set point ASEhi, and is added to the warm up
                     1944  ; enrichment percent value.
                     1945  ;
                     1946  ; Method:
                     1947  ;
                     1948  ; 1) If (warmup, engine is set) then:
                     1949  ; 2) Perform ordered table search of WWU (using coolant variable) to
                     1950  ;    determine which bin.
                     1951  ; 3) Perform linear interpolation to get interpolated warmup enrichment
                     1952  ;    percent
                     1953  ; 4)  else clear warmup bit in engine
                     1954  ;
                     1955  ; Also, the after-start enrichment value is calculated and applied here - it
                     1956  ;  is an added percent value on top of the warmup enrichment, and is applied
                     1957  ;  for the number of INJ1 firings specified in AWC. This enrichment starts
                     1958  ;  at a value of AWEV at first, then it linearly interpolates down to zero
                     1959  ;  after AWC cycles.
                     1960  ;
                     1961  ; where:
                     1962  ; warmup, engine = "warm up" bit of "engine" variable
                     1963  ; startw, engine = "after start enrichment" bit of "engine" variable
                     1964  ; awc            = After-start number of cycles
                     1965  ; asecount       = Counter value for after-start enrichment counter,
                     1966  ;                  every IRQ (NOW EVERY INJ1 FIRING!)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 17
MC68HC908GP32 User Bootloader


                     1967  ; AWEV           = After-start Warmup Percent enrichment add-on value
                     1968  ; warmcor        = After Start and Warmup Enrichment percent value
                     1969  ;
                     1970  ; 1) If (startw, engine is set) then:
                     1971  ; 2)  compare if (awc < asecount) then:
                     1972  ; 3)  x1=0, x2=AWC, y1=AWEV, y2=0, x=asecount, y=tmp6(ASE%)
                     1973  ; 4)  warmcor + tmp6 = warmcor
                     1974  ; 5)  else clear startw bit in engine
                     1975  ;
                     1976  ;***********************************************************************************************
                     1977  
                     1978  WARM_UP_ENRICH:
 85CA [05] 036330    1979       brclr   crank,engine,WUE1     ; If the "crank" bit of "engine" variable is clear,
                     1980                                     ; branch to WUE1:
 85CD [04] 1363      1981       bclr    crank,engine          ; Clear "crank" bit of "engine" variable
 85CF [03] B66D      1982       lda     coolant               ; Load accumulator with value in "coolant"
 85D1 [02] A1C8      1983       cmp     #$C8                  ; Compare value in accumulator with decimal 200 (160F)
 85D3 [03] 220A      1984       bhi     NO_WARMUP             ; If "coolant" > 160F, branch to NO_WARMUP:
 85D5 [04] 1564      1985       bclr    fldClr,alarmbits      ; Clear "fldClr" bit of "alarmbits"
 85D7 [04] 1663      1986       bset    warmup,engine         ; Set "warmup" bit of "engine" variable
 85D9 [04] 1402      1987       bset    wled,PORTC            ; Warmup LED on, Port C
 85DB [04] 1466      1988       bset    wmLED,portCbits       ; Set "wmLED" bit of "portCbits"
 85DD [03] 2008      1989       bra     CHECK_ASE_LO          ; Branch to CHECK_ASE_LO:
                     1990  
                     1991  NO_WARMUP:
 85DF [04] 1564      1992       bclr    fldClr,alarmbits  ; Clear "fldClr" bit of "alarmbits"
 85E1 [04] 1763      1993       bclr    warmup,engine     ; Clear "warmup" bit of "engine" variable
 85E3 [04] 1502      1994       bclr    wled,PORTC        ; Warmup LED off, Port C
 85E5 [04] 1566      1995       bclr    wmLED,portCbits   ; Clear "wmLED" bit of "portCbits"
                     1996  
                     1997  
                     1998  CHECK_ASE_LO:
 85E7 [04] C1E430    1999       cmp     ASElo             ; Compare value in accumulator ("coolant") with value in
                     2000                                 ; "ASElo"
 85EA [03] 2202      2001       bhi     CHECK_ASE_HI      ; If "coolant" > "ASElo", branch to CHECK_ASE_HI:
 85EC [03] 2005      2002       bra     DO_ASE            ; Branch to DO_ASE:
                     2003  
                     2004  CHECK_ASE_HI:
 85EE [04] C1E42F    2005       cmp     ASEhi             ; Compare value in accumulator ("coolant") with value in
                     2006                                 ; "ASEhi"
 85F1 [03] 2506      2007       blo     NO_ASE            ; If "coolant" < "ASEhi", branch to NO_ASE:
                     2008  
                     2009  DO_ASE:
 85F3 [04] 1463      2010       bset    startw,engine     ; Set "startw" bit of "engine" variable
 85F5 [03] 3F7F      2011       clr     asecount          ; Clear the after-start enrichment counter variable
 85F7 [03] 2004      2012       bra     WUE1              ; Branch to WUE1:
                     2013  
                     2014  NO_ASE:
 85F9 [04] 1564      2015       bclr    fldClr,alarmbits  ; Clear "fldClr" bit of "alarmbits"
 85FB [04] 1563      2016       bclr    startw,engine     ; Clear "startw" bit of "engine" variable
                     2017  
                     2018  WUE1:
 85FD [05] 066305    2019       brset   warmup,engine,WUE2     ; If "warmup" bit of "engine" is set, branch to WUE2:
 8600 [05] 046338    2020       brset   startw,engine,WUE3     ; If "startw" bit of "engine" is set, branch to WUE3:
 8603 [03] 2064      2021       bra     WUE_ASE_DONE           ; Branch to WUE_ASE_DONE:
                     2022  
                     2023  
                     2024  WUE2:
 8605 [03] 45E400    2025       ldhx    #WWURANGE                 ; Load Index register with address of first byte of WWURANGE
 8608 [04] 3590      2026       sthx    tmp1               ; Copy value into tmp1 variable
 860A [02] A609      2027       lda     #$09               ; Load accumulator with decimal 9
 860C [03] B792      2028       sta     tmp3               ; Copy value into tmp3 variable
 860E [03] B66D      2029       lda     coolant           ; Load accumulator with current coolant temp
 8610 [03] B793      2030       sta     tmp4               ; Copy value into tmp4 variable
 8612 [05] CD8E16    2031       jsr     ORD_TABLE_FIND     ; jump to subroutine ORD_TABLE_FIND (result in tmp5)
 8615 [01] 8C        2032       clrh                       ; Clear index register hi byte
 8616 [03] B694      2033       lda     tmp5               ; Load accumulator with result from ORD_TABLE_FIND
 8618 [01] 97        2034       tax                        ; Copy it to index register Lo byte
 8619 [04] D6E40A    2035       lda     WWU,x              ; Load the accumulator with the warmup bin from index
                     2036                                  ; register Lo byte
 861C [03] B793      2037       sta     tmp4               ; Copy it to the tmp4 variable
 861E [01] 5A        2038       decx                       ; Decrement index reg Lo byt(move down 1 bin)
 861F [04] D6E40A    2039       lda     WWU,x              ; Load accumulator with new bin value
 8622 [03] B792      2040       sta     tmp3               ; Copy it to the tmp3 variable
 8624 [05] 4E6D94    2041       mov     coolant,tmp5       ; Move current coolant temp to tmp5 variable
 8627 [05] CD8E31    2042       jsr     lininterp          ; Jump to Lininterp subroutine(result in temp6)
 862A [05] 4E954B    2043       mov     tmp6,warmcor       ; Copy to Total Warmup Correction variable
 862D [03] B64B      2044       lda     warmcor            ; Load accumulator with Warmup Correction variable
 862F [02] A164      2045       cmp     #$64               ; Compare it to decimal 100
 8631 [03] 260C      2046       bne     ASE1               ; If not equal, branch to ASE1:
                     2047  
                     2048  ;***********************************************************************************************
                     2049  ; Outside of WUE range - clear WUE mode
                     2050  ;***********************************************************************************************
                     2051  
 8633 [04] 1564      2052       bclr    fldClr,alarmbits  ; Clear "fldClr" bit of "alarmbits"
 8635 [04] 1763      2053       bclr    warmup,engine     ; Clear "warmup" bit of "engine" variable
 8637 [04] 1502      2054       bclr    wled,PORTC        ; Warmup LED off, Port C
 8639 [04] 1566      2055       bclr    wmLED,portCbits   ; Clear "wmLED" bit of "portCbits"
                     2056  
                     2057  
                     2058  WUE3:
 863B [02] A664      2059       lda     #$64              ; Load accumulator with decimal 100
 863D [03] B74B      2060       sta     warmcor           ; Copy value to Warmup Correction variable
                     2061  
                     2062  ASE1:
 863F [05] 056327    2063       brclr   startw,engine,WUE_ASE_DONE     ; If "startw" bit of "engine" variable is clear,
                     2064                                              ; branch to WUE_ASE_DONE:
 8642 [03] B67F      2065       lda     asecount                       ; Load accumulator with Counter value for
                     2066                                              ; after-start enrichment counter
 8644 [04] C1E41F    2067       cmp     awc                            ; Compare to After-start number of cycles
 8647 [03] 221C      2068       bhi     ASE_END                        ; If higher, branch to ASE_END:
                     2069  
                     2070  ;ASE2:
 8649 [03] 3F90      2071       clr     tmp1            ; Clear tmp1 variable
 864B [04] C6E41F    2072       lda     AWC             ; Load accumulator with value in After-start number of cycles
 864E [03] B791      2073       sta     tmp2            ; Copy to tmp2 variable
 8650 [04] C6E41E    2074       lda     AWEV            ; Load accumulator with value in After-start Warmup Percent
                     2075                               ; enrichment add-on value
 8653 [03] B792      2076       sta     tmp3            ; Copy to tmp3 variable
 8655 [03] 3F93      2077       clr     tmp4            ; Clear tmp4 variable
 8657 [05] 4E7F94    2078       mov     asecount,tmp5   ; Move Counter value for after-start enrichment counter to
                     2079                               ; tmp5 variable
 865A [05] CD8E31    2080       jsr     lininterp       ; Jump to Liniterp subroutine, (result in tmp6)
 865D [03] B695      2081       lda     tmp6            ; Load accumulator with value in tmp6
 865F [03] BB4B      2082       add     warmcor         ; Add it to Warmup Correction variable (result in accumulator)
 8661 [03] B74B      2083       sta     warmcor         ; Copy new value to Warmup Correction variable
 8663 [03] 2004      2084       bra     WUE_ASE_DONE    ; Branch to WUE_ASE_DONE:
                     2085  
                     2086  ;***********************************************************************************************
                     2087  ; Outside of ASE range - clear ASE mode
                     2088  ;***********************************************************************************************
                     2089  
                     2090  ASE_END:
 8665 [04] 1564      2091       bclr    fldClr,alarmbits ; Clear "fldClr" bit of "alarmbits"
 8667 [04] 1563      2092       bclr    startw,engine    ; Clear "startw" bit of "engine" variable
                     2093  
                     2094  WUE_ASE_DONE:
                     2095  
                     2096  ;***********************************************************************************************
                     2097  ;
                     2098  ; ------------------------- Throttle Acceleration Enrichment section ---------------------------
                     2099  ;
                     2100  ; NOTE! This version modifies the original code for manual control of fuel
                     2101  ;       cut at decreasing and steady state TPS. It has 3 permisives, above
                     2102  ;       minimum RPM, at closed throttle, and a permissive from the


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 18
MC68HC908GP32 User Bootloader


                     2103  ;       transmision controller.
                     2104  ;
                     2105  ; Method is the following, where:
                     2106  ;
                     2107  ; tps         = Throttle Position Sensor ADC Raw Reading, counts, 0-5 volts
                     2108  ; last_tps    = TPS reading updated every 0.1 seconds
                     2109  ; tpsthresh   = Accel TPS difference over time threshold
                     2110  ; TPSAEN      = "engine" bit4, 0 = not in TPS accel mode 1 = TPS accel mode
                     2111  ; TPSDEN      = "engine" bit5, 0 = not in deaccel mode   1 = in deaccel mode
                     2112  ; TPSAQ       = TPS acceleration amount (function of TPSDOT) in 0.1 ms units
                     2113  ; TPSDQ       = Deceleration fuel cut  100 = no fuel cut, 1 = 99% fuel cut
                     2114  ; TPSACLK     = TPS enrichment timer clock in 0.1 second resolution
                     2115  ; TPSACLKCMP  = Comparison value for TPS acceleration time - from lookup table
                     2116  ; TPSACCEL    = Acceleration enrichment % (0 = 0% enrich, 255 = 255% enrich)
                     2117  ; TPSFUELCUT  = TPS fuel cut % variable ( 1 = 99% cut, 100 = 0% cut)
                     2118  ; rpm         = Computed engine RPM - rpm/20 (20 RPM resolution)
                     2119  ; DFC_en      = Decel Fuel Cut Enable on PTA2
                     2120  ;
                     2121  ;
                     2122  ;   ACCELERATION ENRICHMENT:
                     2123  ;   If (tps < lasr_tps) go to DEACCELERATION ENRICHMENT
                     2124  ;   If (tps - last_tps) > tpsthresh and TPSAEN = 0 then (accel enrichemnt):
                     2125  ;   {
                     2126  ;    1) Set acceleration mode
                     2127  ;    2) Continuously determine rate-of-change of throttle, and perform
                     2128  ;        interpolation of TPSAQ values to determine acceleration
                     2129  ;        enrichment amount to apply.
                     2130  ;   }
                     2131  ;   If (TPSACLK > TPSACLKCMP) and TPSAEN = 1, then:
                     2132  ;   {
                     2133  ;    1) Clear TPSAEN bit in engine
                     2134  ;    2) Set TPSACCEL to 100% (no enrichment)
                     2135  ;    3) Go to end of section
                     2136  ;   }
                     2137  ;
                     2138  ;
                     2139  ;   DEACCELERATION ENRICHMENT:
                     2140  ;    If (lasr_tps - tps > tpsthresh then (deaccelleration fuel cut)
                     2141  ;    {
                     2142  ;     If (TPSAEN = 1) then:
                     2143  ;     {
                     2144  ;      1) TPSACCEL = 100 percent (no acceleration)
                     2145  ;      2) Clear TPSAEN bit in ENGINE
                     2146  ;      3) Go to end of section
                     2147  ;    }
                     2148  ;    If (RPM > 60 (1200 RPM) then (fuel cut mode):
                     2149  ;    {
                     2150  ;      1) Set TPSACCEL value to TPSDQ
                     2151  ;      2) Set TPSDEN bit in ENGINE
                     2152  ;      3) Go to end of section
                     2153  ;    }
                     2154  ;   }
                     2155  ;   else
                     2156  ;   {
                     2157  ;    If (TPSDEN = 1) then
                     2158  ;    {
                     2159  ;      1) Clear TPSACCEL value in ENGINE
                     2160  ;      2) TPSACCEL = 100%
                     2161  ;      3) Go to end of section
                     2162  ;    }
                     2163  ;   }
                     2164  ;
                     2165  ;***********************************************************************************************
                     2166  
                     2167  ;***********************************************************************************************
                     2168  ; - Acceleration enrichment calculations are done only once in the first
                     2169  ;   pass through the main loop after the 100mS clock tick signal has been
                     2170  ;   received, the interrupt routine has been completed, and relevent
                     2171  ;   variables updated.
                     2172  ;***********************************************************************************************
                     2173  
                     2174  ;     brset   clock100,inputs,TAE ; If "clock100" bit of "inputs" variable is
                     2175                                    ; clear, branch to TAE:
                     2176  ;     jmp     NO_CLOCK_PASS       ; Jump to NO_CLOCK_PASS:
                     2177  
                     2178  
                     2179  TAE:
 8669 [02] 9B        2180       sei                       ; Set interrupt mask bit
 866A [05] 4E4490    2181       mov     tps,tmp1          ; Move Throttle Position reading to tmp1 var
 866D [05] 4E8091    2182       mov     last_tps,tmp2     ; Move Last Throttle Position reading to tmp2
 8670 [02] 9A        2183       cli                       ; Clear interupt mask bit
 8671 [03] B690      2184       lda     tmp1              ; Load accumulator with value in tmp1
 8673 [03] B191      2185       cmp     tmp2              ; Compare accumulator with tmp2
 8675 [03] 255D      2186       blo     TDE2              ; If (A)<(M) branch to TDE2: (deacelleration section)
                     2187  
                     2188  ;AE_CHK:
 8677 [03] B690      2189       lda     tmp1                             ; Load accumulator with value in tmp1 (TPS)
 8679 [03] B091      2190       sub     tmp2                             ; Subtract, A<-(A)-(M) (TPS - Last_TPS)
 867B [04] C1E421    2191       cmp     tpsthresh                        ; Compare result to Accel TPS DOT threshold value
 867E [03] 2552      2192       blo     B_LO_CONT                        ; If (A)<(M), branch to B_LO_CONT:
 8680 [05] 08631B    2193       brset   tpsaen,engine,AE_COMP_SHOOT_AMT  ; If "TPSAEN" bit of "engine" is set branch to
                     2194                                                ; AE_COMP_SHOOT_AMT:
                     2195  
                     2196  ;***********************************************************************************************
                     2197  ; Add in accelleration  enrichement
                     2198  ;***********************************************************************************************
                     2199  
 8683 [04] C6E418    2200       lda     tpsaq               ; Load accumulator with value in first element
                     2201                                   ;(start out using first element)
                     2202                                   ;(will determine actual next time around)
 8686 [03] B74F      2203       sta     tpsaccel            ; Copy to Acceleration percent amount
                     2204                                   ; (used in later calculations)
 8688 [03] 3F7E      2205       clr     tpsaclk             ; Clear Comparison value for TPS accel time var
 868A [04] C6E422    2206       lda     tpsasync                 ; Load accumulator with TPS Accel clock value
 868D [03] B783      2207       sta     tpsaclkcmp          ; Copy to Comparison value for TPS accel time
                     2208                                   ;(Shoot time comparison value)
 868F [04] 1863      2209       bset    tpsaen,engine       ; Set "tpsaen" bit of "engine" variable
 8691 [04] 1B63      2210       bclr    tpsden,engine       ; Clear "tpsden" bit of "engine" variable
 8693 [04] 1202      2211       bset    aled,PORTC               ; Set Acceleration Enrichments LED output
 8695 [04] 1266      2212       bset    acclLED,portCbits   ; Set "acclLED" bit of "portCbits"
 8697 [04] 1502      2213       bclr    wled,PORTC          ; Clear warmup LED, Port C
 8699 [04] 1566      2214       bclr    wmLED,portCbits     ; Clear "wmLED" bit of "portCbits"
 869B [03] CC8798    2215       jmp     TDE_DONE            ; Jump to TDE_DONE:
                     2216  
                     2217  
                     2218  ;***********************************************************************************************
                     2219  ; First, calculate Cold temperature add-on enrichment value from coolant
                     2220  ;  value TPSACOLD, from -40 degrees to 165 degrees.
                     2221  ;
                     2222  ; Then determine cold temperature multiplier value ACCELMULT (in percent),
                     2223  ;  from -40 degrees to 165 degrees.
                     2224  ;
                     2225  ; Next, Calculate Shoot amount (quantity) for accel enrichment from table.
                     2226  ;  Find bins (between) for corresponding TPSDOT, and linear interpolate
                     2227  ;  to find enrichment amount (from TPSAQ). This is continuously
                     2228  ;  checked every time thru main loop while in acceleration mode,
                     2229  ;  and the highest value is latched and used.
                     2230  ;
                     2231  ; The final acceleration applied is
                     2232  ;  AE = Alookup(TPSDOT) * (ACCELMULT/100) + TPSACOLD
                     2233  ;
                     2234  ;***********************************************************************************************
                     2235  
                     2236  AE_COMP_SHOOT_AMT:
                     2237  
                     2238  ;***********************************************************************************************


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 19
MC68HC908GP32 User Bootloader


                     2239  ; First, the "added" amount based on cold temperatures
                     2240  ;***********************************************************************************************
                     2241  
 869E [02] A600      2242       lda     #$00              ; Load accumulator with 0 (0 -> - 40 degrees)
 86A0 [03] B790      2243       sta     tmp1              ; Copy to tmp1 variable
 86A2 [02] A6CD      2244       lda     #$CD              ; Load accumulator with decimal 205
                     2245                                 ; 165 + 40 degrees (offset in lookup table)
 86A4 [03] B791      2246       sta     tmp2              ; Copy to to tmp2 variable (this is the amount at coldest)
 86A6 [04] C6E420    2247       lda     tpsacold          ; Load accumulator with value in "tpsacold"
 86A9 [03] B792      2248       sta     tmp3              ; Copy to tmp3 variable
 86AB [04] 6E0093    2249       mov     #$00,tmp4         ; Move decimal 0 to tmp4 variable (no enrichemnt add on at warm
                     2250                                 ; temperature)
 86AE [05] 4E6D94    2251       mov     coolant,tmp5      ; Move current coolant temp value to tmp5 var
 86B1 [05] CD8E31    2252       jsr     lininterp         ; Jump to liniterp subroutine (result in tmp6)
 86B4 [05] 4E959C    2253       mov     tmp6,tmp13        ; Move result to tmp13 (save here temporarily)
                     2254  
                     2255  ;***********************************************************************************************
                     2256  ; Second, find the multiplier (ACCELMULT) amount based on cold temperatures
                     2257  ;***********************************************************************************************
                     2258  
 86B7 [02] A600      2259       lda     #$00             ; Load accumulator with 0 (0 -> - 40 degrees)
 86B9 [03] B790      2260       sta     tmp1             ; Copy to tmp1 variable
 86BB [02] A6CD      2261       lda     #$CD             ; Load accumulator with decimal 205 (165 + 40 degrees)
                     2262                                ; (offset in lookup table)
 86BD [03] B791      2263       sta     tmp2             ; Copy to to tmp2 variable
 86BF [04] C6E429    2264       lda     ACMULT           ; load accumulator with Acceleration cold multiplication factor
                     2265                                ; (percent/100)
 86C2 [03] B792      2266       sta     tmp3             ; Copy to tmp3 variable (This is the amount at coldest)
 86C4 [04] 6E6493    2267       mov     #$64,tmp4        ; Move decimal 100 to tmp4 variable
                     2268                                ;(1.00 multiplier at 165 degrees)
 86C7 [05] 4E6D94    2269       mov     coolant,tmp5     ; Move coolant temperature to tmp5 variable
 86CA [05] CD8E31    2270       jsr     lininterp        ; Jump to liniterp subroutine (result in tmp6)
 86CD [05] 4E959D    2271       mov     tmp6,tmp14       ; Move result to tmp14 (save here temporarily)
                     2272  
                     2273  ;***********************************************************************************************
                     2274  ; This is here to extend the branch range for the instructions earlier
                     2275  ; (long-jumps)
                     2276  ;***********************************************************************************************
                     2277  
 86D0 [03] 2004      2278       bra     END_AE_LONGBRANCH    ; Branch to END_AE_LONGBRANCH:
                     2279  
                     2280  B_LO_CONT:
 86D2 [03] 2057      2281       bra     TAE_CHK_TIME         ; Branch to TAE_CHK_TIME:
                     2282  
                     2283  TDE2:
 86D4 [03] 207F      2284       bra     TDE                  ; Branch to TDE:
                     2285  
                     2286  END_AE_LONGBRANCH:
                     2287  
                     2288  
                     2289  ;***********************************************************************************************
                     2290  ; Now the lookup table amount based on TPSDOT (TPS difference over time)
                     2291  ;***********************************************************************************************
                     2292  
 86D6 [03] 45E414    2293       ldhx    #tpsdotrate     ; Load Index register with value in "tpsdotrate"
 86D9 [04] 3590      2294       sthx    tmp1            ; Copy to tmp1 variable
 86DB [02] A60F      2295       lda     #$0F            ; Load accumulator with decimal 15 (300RPM)
 86DD [03] B792      2296       sta     tmp3            ; Copy to TMP3 variable
 86DF [03] B644      2297       lda     tps             ; Load accumulator with value in Throttle Position Sensor ADC
 86E1 [03] B080      2298       sub     last_tps        ; Subract it from the last TPS value
 86E3 [03] B793      2299       sta     tmp4            ; Copy result to tmp4 variable ( TPSDOT )
 86E5 [03] B799      2300       sta     tmp10           ; Copy result in tmp10 variable as well (Save away for later
                     2301                               ; use below)
 86E7 [05] CD8E16    2302       jsr     ord_table_find  ; Jump to subroutine ord_table_find( result in tmp5 )
 86EA [01] 8C        2303       clrh                    ; Clear the Index Register
 86EB [03] B694      2304       lda     tmp5            ; Load accumulator with value in tmp5
 86ED [01] 97        2305       tax                     ; Transfer Index Register Lo byte
 86EE [04] D6E418    2306       lda     TPSAQ,x         ; Load accumulator with TPS acceleration amount
                     2307                               ; (TPSAQ is entry, offset in index register Lo
 86F1 [03] B793      2308       sta     tmp4            ; Copy to tmp4 variable
 86F3 [01] 5A        2309       decx                    ; Decrement index register Lo byte
 86F4 [04] D6E418    2310       lda     TPSAQ,x         ; Load accumulator with this new value
 86F7 [03] B792      2311       sta     tmp3            ; Copy it to tmp3 variable
 86F9 [03] B699      2312       lda     tmp10           ; Load accumulator with value in tmp10
 86FB [03] B794      2313       sta     tmp5            ; Copy it to tmp5 variable
 86FD [05] CD8E31    2314       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
                     2315  
                     2316  ;***********************************************************************************************
                     2317  ; Now, the final applied acceleration enrichment amount is
                     2318  ; ((TMP6 * tmp14)/100) + tmp13
                     2319  ;  AE = Alookup(TPSDOT) * (ACCELMULT/100) + TPSACOLD
                     2320  ;***********************************************************************************************
                     2321  
                     2322  ;FIND_TOTAL_A:
 8700 [03] B695      2323       lda     tmp6            ; Load accumulator with value in tmp6( result of lininterp)
 8702 [01] 97        2324       tax                     ; Transfer to index register Lo byte
 8703 [03] B69D      2325       lda     tmp14           ; Load accumulator with value in tmp14
 8705 [05] 42        2326       mul                     ; Multiply tmp6 by tmp14
 8706 [02] 89        2327       pshx                    ; Push index register Lo onto stack
 8707 [02] 8A        2328       pulh                    ; Pull index register L to index register Hi
 8708 [02] AE64      2329       ldx     #$64            ; Load index register low with decimal 100
 870A [07] 52        2330       div                     ; Divide A<-(H:A)/(X);H<-Remainder
 870B [03] 250E      2331       bcs     UPPER_RAIL_AE   ; If the C bit of CCR is set, branch to UPPER_RAIL_AE:
 870D [02] 87        2332       psha                    ; Push accumulator onto stack
 870E [02] 8B        2333       pshh                    ; Push index register high onto stack
 870F [02] 86        2334       pula                    ; Pull index register high into accumulator
 8710 [02] A132      2335       cmp     #$32            ; Compare accumulator with decimal 50
 8712 [03] 9304      2336       ble     NDA1            ; If less than or equal to, branch to NDA1:
 8714 [02] 86        2337       pula                    ; Pull value from stack to accumulator
 8715 [01] 4C        2338       inca                    ; Increment accumulator
 8716 [03] 2007      2339       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2340  
                     2341  NDA1:
 8718 [02] 86        2342       pula                    ; Pull value from stack to accumulator
 8719 [03] 2004      2343       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2344  
                     2345  UPPER_RAIL_AE:
 871B [02] A6C8      2346       lda     #$C8            ; Load accumulator with decimal 200(Set to 20 milliseconds railed)
 871D [03] 2000      2347       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2348  
                     2349  ADD_TO_AE:
 871F [03] BB9C      2350       add     tmp13            ; Add value in accumulator with value in tmp13(Add on the amount
                     2351                                ;(computed in col temperature enrich above)
 8721 [03] B795      2352       sta     tmp6             ; Copy result to tmp6 variable
 8723 [03] B14F      2353       cmp     TPSACCEL         ; Compare with Acceleration percent amount
 8725 [03] 2504      2354       blo     TAE_CHK_TIME     ; If lower, branch to TAE_CHK_TIME:
 8727 [03] B695      2355       lda     tmp6             ; Load accumulator with value in tmp6
                     2356                                ; (Replace with this higher value)
 8729 [03] B74F      2357       sta     TPSACCEL         ; Copy value to Acceleration percent amount
                     2358  
                     2359  
                     2360  ;***********************************************************************************************
                     2361  ; Check if acceleration is done
                     2362  ;***********************************************************************************************
                     2363  
                     2364  TAE_CHK_TIME:
 872B [05] 0A6306    2365       brset   tpsden,engine,RST_ACCEL ; If deceleration bit of "Engine" variable is set,
                     2366                                       ; branch to RST_ACCEL:
 872E [03] B67E      2367       lda     tpsaclk                 ; Load accumulator with value in TPS enrichment timer clock
 8730 [03] B183      2368       cmp     tpsaclkcmp              ; Compare it to Comparison value for TPS acceleration time
 8732 [03] 2564      2369       blo     TDE_DONE                ; If lower, branch to TDE_DONE:
                     2370  
                     2371  RST_ACCEL:
 8734 [04] 1963      2372       bclr    tpsaen,engine       ; Clear "tpsaen" bit of "engine" variable
 8736 [02] A664      2373       lda     #$64                ; Load accumulator with decimal 100
 8738 [03] B774      2374       sta     tpsfuelcut          ; Copy to TPS Fuel Cut % variable (0% cut)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 20
MC68HC908GP32 User Bootloader


 873A [04] 1302      2375       bclr    aled,PORTC          ; Clear acceleration LED output Port C
 873C [04] 1366      2376       bclr    acclLED,portCbits   ; Clear "acclLED" bit of "portCbits"
 873E [03] 3F4F      2377       clr     tpsaccel            ; Clear Acceleration enrich % var (0% enrich)
 8740 [04] 1B63      2378       bclr    tpsden,engine       ; Clear "tpsden" bit of "engine" variable
                     2379  
                     2380  ;***********************************************************************************************
                     2381  ; - Check to see if we have permissives for manual decel fuel cut during steady state throttle.
                     2382  ;***********************************************************************************************
                     2383  
 8742 [05] 040048    2384       brset   DFC_en,porta,TDE_CHK_DONE  ; If "DFC_en" bit on Port A is set, branch to
                     2385                                          ; TDE_CHK_DONE:
                     2386                                          ; (Check if transmision status will allow DFC)
 8745 [03] B644      2387       lda     tps                        ; Load accumulator with value in tps ADC
 8747 [04] C1E433    2388       cmp     dfc_tps                    ; Compare it with value in Decel Fuel Cut min TPS
 874A [03] 2241      2389       bhi     TDE_CHK_DONE               ; If (A)>(M), branch to TDE_CHK_DONE:
 874C [03] B650      2390       lda     rpm20                      ; Load accumulator with value in RPM/20
 874E [04] C1E432    2391       cmp     dfc_rpm                    ; Compare it value in DFC minimum RPM/20 var
 8751 [03] 253A      2392       blo     TDE_CHK_DONE               ; If (A)<(M), branch to TDE_CHK_DONE:
 8753 [03] 202D      2393       bra     SET_FUEL_CUT               ; Branch to SET_FUEL_CUT:
                     2394  
                     2395  ;***********************************************************************************************
                     2396  ; - Deceleration fuel cut mode
                     2397  ;***********************************************************************************************
                     2398  
                     2399  TDE:
 8755 [03] B691      2400       lda     tmp2                            ; Load accumulator with value in tmp2(last_tps)
 8757 [03] B090      2401       sub     tmp1                            ; A<-(A)-(M)(last_tps - tps)
 8759 [04] C1E421    2402       cmp     tpsthresh                       ; Compare result with value in "tpsthresh"
 875C [03] 252F      2403       blo     TDE_CHK_DONE                    ; If A<M, branch to TDE_CHK_DONE:
 875E [05] 096310    2404       brclr   tpsaen,engine,TDE_CHK_FUEL_CUT  ; If "tpsaen" bit of "engine" variable is set,
                     2405                                               ; branch to TDE_CHK_DONE:
 8761 [02] A664      2406       lda     #$64                            ; Load accumulator with decimal 100
 8763 [03] B774      2407       sta     tpsfuelcut                      ; Copy to "tpsfuelcut" variable
 8765 [03] 3F4F      2408       clr     tpsaccel                        ; Clear "tpsaccel" variable
 8767 [04] 1963      2409       bclr    tpsaen,engine                   ; Clear "tpsaen" bit of "engine" variable
 8769 [04] 1302      2410       bclr    aled,PORTC                      ; Clear "aled" bit of Port C ("A" LED off)
 876B [04] 1366      2411       bclr    acclLED,portCbits               ; Clear "acclLED" bit of "portCbits"
 876D [04] 1B63      2412       bclr    tpsden,engine                   ; Clear "tpsden" bit of "engine" variable
 876F [03] 2027      2413       bra     TDE_DONE                        ; Branch to TDE_DONE:
                     2414  
                     2415  ;**********************************************************************************************
                     2416  ; - Check to see if we have permissives for manual decel fuel cut during decreasing throttle.
                     2417  ;**********************************************************************************************
                     2418  
                     2419  TDE_CHK_FUEL_CUT:
 8771 [05] 040019    2420       brset   DFC_en,porta,TDE_CHK_DONE  ; If "DFC_en" bit on Port A is set, branch to
                     2421                                          ; TDE_CHK_DONE:
                     2422                                          ; (Check if transmision status will allow DFC)
 8774 [03] B644      2423       lda     tps                        ; Load accumulator with value in tps ADC
 8776 [04] C1E433    2424       cmp     dfc_tps                    ; Compare it with value in Decel Fuel Cut min TPS
 8779 [03] 2212      2425       bhi     TDE_CHK_DONE               ; If (A)>(M), branch to TDE_CHK_DONE:
 877B [03] B650      2426       lda     rpm20                      ; Load accumulator with value in RPM/20
 877D [04] C1E432    2427       cmp     dfc_rpm                    ; Compare it value in DFC minimum RPM/20 var
 8780 [03] 250B      2428       blo     TDE_CHK_DONE               ; If (A)<(M), branch to TDE_CHK_DONE:
                     2429  
                     2430  SET_FUEL_CUT:
 8782 [04] C6E431    2431       lda     TPSDQ          ; Load accumulator with value in "tpsdq"
 8785 [03] B774      2432       sta     tpsfuelcut     ; Copy to "tpsfuelcut"
 8787 [04] 1A63      2433       bset    tpsden,engine  ; Set "tpsden" bit of "engine" variable
 8789 [04] 1963      2434       bclr    tpsaen,engine  ; Clear "tpsaen" bit of "engine" variable
 878B [03] 200B      2435       bra     TDE_DONE       ; Branch to TDE_DONE:
                     2436  
                     2437  TDE_CHK_DONE:
 878D [05] 0B6308    2438       brclr   tpsden,engine,TDE_DONE  ; If "tpsden" bit of "engine"
                     2439                                 ; variable is clear, branch to TDE_DONE:
 8790 [04] 1B63      2440       bclr    tpsden,engine     ; Clear "tpsden" bit of "engine" variable
 8792 [02] A664      2441       lda     #$64              ; Load accumulator with decimal 100
 8794 [03] B774      2442       sta     tpsfuelcut        ; Copy to "tpsfuelcut" variable
 8796 [03] 3F4F      2443       clr     tpsaccel          ; Clear "tpsaccel" variable
                     2444  
                     2445  TDE_DONE:
 8798 [04] 196B      2446       bclr    clock100,inputs   ; Clear "clock100" bit of "inputs" variable
                     2447  
                     2448  NO_CLOCK_PASS:
                     2449  
                     2450  ;***********************************************************************************************
                     2451  ;
                     2452  ; VE 3-D Table Lookup
                     2453  ;
                     2454  ;  This is used to determine value of VE based on RPM and MAP
                     2455  ;  The table looks like:
                     2456  ;
                     2457  ;     105 +....+....+....+....+....+....+....+
                     2458  ;         ....................................
                     2459  ;      00 +....+....+....+....+....+....+....+
                     2460  ;                    ...
                     2461  ;  KPA                ...
                     2462  ;                        ...
                     2463  ;      35 +....+....+....+....+....+....+....+
                     2464  ;         5    15   25   35   45   55   65   75 RPM/20
                     2465  ;
                     2466  ;
                     2467  ; Steps:
                     2468  ;  1) Find the bracketing KPA positions via ORD_TABLE_FIND, put index in
                     2469  ;      tmp8 and bounding values in tmp9(kpa1) and tmp10(kpa2)
                     2470  ;  2) Find the bracketing RPM positions via ORD_TABLE_FIND, store index in
                     2471  ;      tmp11 and bounding values in tmp13(rpm1) and tmp14(rpm2)
                     2472  ;  3) Using the VE table, find the table VE values for tmp15=VE(kpa1,rpm1),
                     2473  ;      tmp16=VE(kpa1,rpm2), tmp17 = VE(kpa2,rpm1), and tmp18 = VE(kpa2,rpm2)
                     2474  ;  4) Find the interpolated VE value at the lower KPA range :
                     2475  ;      x1=rpm1, x2=rpm2, y1=VE(kpa1,rpm1), y2=VE(kpa1,rpm2) - put in tmp19
                     2476  ;  5) Find the interpolated VE value at the upper KPA range :
                     2477  ;      x1=f1, x2=rpm2, y1=VE(kpa2,rpm1), y2=VE(kpa2,rpm2) - put in tmp11
                     2478  ;  6) Find the final VE value using the two interpolated VE values:
                     2479  ;      x1=kpa1, x2=kpa2, y1=VE_FROM_STEP_4, y2=VE_FROM_STEP_5
                     2480  ;
                     2481  ;***********************************************************************************************
                     2482  
                     2483  ;VETABLELOOKUP:
                     2484  
                     2485  ;VE_STEP_1:
 879A [03] 45E09C    2486       ldhx    #KPARANGEVE_f       ; Load index register with value in KPARANGEVE table
 879D [04] 3590      2487       sthx    tmp1                ; Copy value to tmp1 variable
 879F [04] 6E0B92    2488       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 87A2 [05] 4E6C93    2489       mov     kpa,tmp4            ; Move value in "kpa" to "tmp4"
 87A5 [05] CD8E16    2490       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 87A8 [03] B690      2491       lda     tmp1                ; Load accumulator with value in tmp1
 87AA [03] B691      2492       lda     tmp2                ; Load accumulator with value in tmp2
 87AC [05] 4E9497    2493       mov     tmp5,tmp8                  ; move value from tmp5 to tmp8 (Index)
 87AF [05] 4E9098    2494       mov     tmp1,tmp9                  ; move value from tmp1 to tmp9 (X1)
 87B2 [05] 4E9199    2495       mov     tmp2,tmp10                 ; move value from tmp2 to tmp10 (X2)
                     2496  
                     2497  ;VE_STEP_2:
 87B5 [03] 45E090    2498       ldhx    #RPMRANGEVE_f       ; Load index register with value from RPMRANGEVE table
 87B8 [04] 3590      2499       sthx    tmp1                ; Copy value to tmp1 variable
 87BA [04] 6E0B92    2500       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 87BD [05] 4E5093    2501       mov     rpm20,tmp4          ; Move value in "rpm20" to "tmp4"
 87C0 [05] CD8E16    2502       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 87C3 [05] 4E949A    2503       mov     tmp5,tmp11                 ; Move value from tmp5 to tmp11 (Index)
 87C6 [05] 4E909C    2504       mov     tmp1,tmp13                 ; Move value from tmp1 to tmp13 (X1)
 87C9 [05] 4E919D    2505       mov     tmp2,tmp14                 ; Move value from tmp2 to tmp14 (X2)
                     2506  
                     2507  ;VE_STEP_3:
 87CC [01] 8C        2508          clrh              ; Clear index register Hi byte
 87CD [02] AE0C      2509          ldx     #$0C      ; Load index register Lo byte with decimal 13
 87CF [03] B697      2510          lda     tmp8      ; Load accumulator with value in "tmp8"


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 21
MC68HC908GP32 User Bootloader


 87D1 [01] 4A        2511          deca              ; Decrement value in accumulator
 87D2 [05] 42        2512          mul               ; Multiply X:A<-(X)x(A)
 87D3 [03] BB9A      2513          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 87D5 [01] 4A        2514          deca              ; Decrement value in accumulator
 87D6 [01] 97        2515          tax               ; Transfer value in accumulator to index register Lo byte
 87D7 [05] CD8F7B    2516          jsr     VE1X      ; Jump to subroutine at VE1X:
 87DA [03] B79E      2517          sta     tmp15     ; Copy result to "tmp15"
 87DC [01] 5C        2518          incx              ; Increment value in index rgister Lo byte
 87DD [05] CD8F7B    2519          jsr     VE1X      ; Jump to subroutine at VE1X:
 87E0 [03] B79F      2520          sta     tmp16     ; Copy result to "tmp16"
 87E2 [02] AE0C      2521          ldx     #$0C      ; Load index register Lo byte with decimal 13
 87E4 [03] B697      2522          lda     tmp8      ; Load accumulator with value in "tmp8"
 87E6 [05] 42        2523          mul               ; Multiply X:A<-(X)x(A)
 87E7 [03] BB9A      2524          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 87E9 [01] 4A        2525          deca              ; Decrement value in accumulator
 87EA [01] 97        2526          tax               ; Transfer value in accumulator to index register Lo byte
 87EB [05] CD8F7B    2527          jsr     VE1X      ; Jump to subroutine at VE1X:
 87EE [03] B7A0      2528          sta     tmp17     ; Copy result to "tmp17"
 87F0 [01] 5C        2529          incx              ; Increment value in index rgister Lo byte
 87F1 [05] CD8F7B    2530          jsr     VE1X      ; Jump to subroutine at VE1X:
 87F4 [03] B7A1      2531          sta     tmp18     ; Copy result to "tmp18"
                     2532  
                     2533  ;VE_STEP_4:
 87F6 [05] 4E9C90    2534       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 87F9 [05] 4E9D91    2535       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 87FC [05] 4E9E92    2536       mov     tmp15,tmp3      ; Move value from tmp15 variable to tmp3 variable
 87FF [05] 4E9F93    2537       mov     tmp16,tmp4      ; Move value from tmp16 variable to tmp4 variable
 8802 [05] 4E5094    2538       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 8805 [05] CD8E31    2539       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8808 [05] 4E95A2    2540       mov     tmp6,tmp19      ; Move value from tmp6 variable to tmp19 variable
                     2541  
                     2542  ;VE_STEP_5:
 880B [05] 4E9C90    2543       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 880E [05] 4E9D91    2544       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8811 [05] 4EA092    2545       mov     tmp17,tmp3      ; Move value from tmp17 variable to tmp3 variable
 8814 [05] 4EA193    2546       mov     tmp18,tmp4      ; Move value from tmp18 variable to tmp4 variable
 8817 [05] 4E5094    2547       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 881A [05] CD8E31    2548       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 881D [05] 4E959A    2549       mov     tmp6,tmp11      ; Move value from tmp6 variable to tmp11 variable
                     2550  
                     2551  ;VE_STEP_6:
 8820 [05] 4E9890    2552       mov     tmp9,tmp1        ; Move value from tmp9 variable to tmp1 variable
 8823 [05] 4E9991    2553       mov     tmp10,tmp2       ; Move value from tmp10 variable to tmp2 variable
 8826 [05] 4EA292    2554       mov     tmp19,tmp3       ; Move value from tmp19 variable to tmp3 variable
 8829 [05] 4E9A93    2555       mov     tmp11,tmp4       ; Move value from tmp11 variable to tmp4 variable
 882C [05] 4E6C94    2556       mov     kpa,tmp5         ; Move value in MAP value in units of KPa to tmp5
 882F [03] B66C      2557       lda     kpa         ; Load accumulator with value in MAP value in KPa
 8831 [05] CD8E31    2558       jsr     lininterp        ; Jump to subroutine lininterp (result in tmp6)
 8834 [05] 4E9551    2559       mov     tmp6,vecurr ; Move value from tmp6 variable to Current VE
                     2560                           ; value from lookup table - percent
                     2561  
                     2562  
                     2563  ;***********************************************************************************************
                     2564  ;
                     2565  ; ---------------------------- Computation of Fuel Parameters ----------------------------------
                     2566  ;
                     2567  ; Remainders are maintained for hi-resolution mode
                     2568  ;
                     2569  ; Where:
                     2570  ;  Ftrimcor   = Fuel trim correction factor (85 to 115)(-15% to +15%)
                     2571  ;  warmcor    = Total warmup enrichment,(Warmup and After Start)
                     2572  ;               (0 to 255)(0% to 255%)(prctical values 100 to 175)
                     2573  ;  Tpsfuelcut = TPS fuel cut amount (1 = 99% cut, 100 = 0% cut)
                     2574  ;  barocorr   = Barometric pressure correction (27 to 141)(27% to 141%)
                     2575  ;               (practical value 100 to 110)
                     2576  ;  aircorr    = Air Density correction ( 90 to 105) (90% to 105%)
                     2577  ;  kpa        = Manifold Absolute Pressure (12 to 255kpa)
                     2578  ;               (practical value naturally aspirated 15 to 98)
                     2579  ;  vecurr     = Volumetric Efficiency (0 to 255)
                     2580  ;               (practical value naturally aspirated 25 to 150)
                     2581  ;               (Actually, the VE table is a combination of
                     2582  ;                volumetric efficiency and Lambda. Both can change with
                     2583  ;                RPM and load, so they are combined in a common 3D Table)
                     2584  ;  REQ_FUEL   = Required fuel pulse width (0 - 25.5mS) at 100%VE, 68
                     2585  ;               degrees F Manifold Air Temp and atmospheric pressure to
                     2586  ;               achieve stoichiometric air fuel ratio for 1 cylinder per
                     2587  ;               combustion cycle (720 crank degrees)
                     2588  ;
                     2589  ; Step 1 (warmcor * Tpsfuelcut)/100 = R1 + rem1/100
                     2590  ; Step 2 (barocor * Aircor)/100 = R2 + rem2/100
                     2591  ; Step 3 ((R1 + rem1/100) * (R2 + rem2/100)) / 100 = R3 + rem3/100
                     2592  ; Step 4 (Ftrimcor * vecurr)/100 = R4 + rem4/100
                     2593  ; Step 5 ((R3 + rem3/100) * (R4 + rem4/100)) /100 = R5 + rem5/100
                     2594  ; Step 6 (kpa * REQ_FUEL)/100 = R6 + rem6/100
                     2595  ; Step 7 ((R5 + rem5/100) * (R6 + rem6/100))  = R7 + rem7/100
                     2596  ;
                     2597  ;  The result in R7 is the 1 microsecond result
                     2598  ;
                     2599  ; NOTE!! It is important to note that the results of all steps except
                     2600  ; step 7 cannot exceed 25500, or the calculations will not be accurate
                     2601  ;
                     2602  ;***********************************************************************************************
                     2603  
                     2604  ;***********************************************************************************************
                     2605  ;
                     2606  ; -------------------------- Computation of Normalized Variables -------------------------------
                     2607  ;
                     2608  ;  The following is the form of the evaluation for the normalized variables:
                     2609  ;
                     2610  ;  (A rem A * B)
                     2611  ;  -------------  = C rem C
                     2612  ;      100
                     2613  ;
                     2614  ;  Where A = Whole part of the percentage,
                     2615  ;        rem A = Remainder of A from previous calculation (range 0 to 99)
                     2616  ;        B = Percentage multiplied (this always has a zero remainder)
                     2617  ;        C = Whole part of result
                     2618  ;        rem C = remainder of result
                     2619  ;
                     2620  ;
                     2621  ;  Calculation is performed by the following method:
                     2622  ;
                     2623  ;     |(A * B) + (rem A * B)|
                     2624  ;     |          -----------|
                     2625  ;     |              100    |
                     2626  ;     ----------------------- = C rem C
                     2627  ;             100
                     2628  ;
                     2629  ;
                     2630  ;   Inputs:  tmp10 = A
                     2631  ;            tmp11 = rem A
                     2632  ;            tmp12 = B
                     2633  ;            tmp13 = rem B
                     2634  ;
                     2635  ;   Outputs: tmp10 = C
                     2636  ;            tmp11 = rem C
                     2637  ;            tmp13 = high order part of (A rem A) * B
                     2638  ;            tmp14 = low order part of (A rem A) * B
                     2639  ;
                     2640  ;***********************************************************************************************
                     2641  
                     2642  ;WARMACCEL_COMP:
                     2643  
 8837 [05] 4E4B99    2644       mov     warmcor,tmp10      ; Warmup Correction in tmp10
 883A [03] 3F9A      2645       clr     tmp11              ; tmp11 is zero
 883C [05] 4E749B    2646       mov     tpsfuelcut,tmp12   ; tpsfuelcut in tmp12


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 22
MC68HC908GP32 User Bootloader


 883F [03] 3F9C      2647       clr     tmp13              ; tmp13 is zero
 8841 [05] CD8F25    2648       jsr     Supernorm          ; Multiply and divide by 100(warmcor and tpsfuelcut)
                     2649                                  ;(result in tmp10:tmp11)=R1+rem1/100
 8844 [05] 4E9990    2650       mov     tmp10,tmp1              ; save whole result in tmp1
 8847 [05] 4E9A91    2651       mov     tmp11,tmp2              ; save remainder in tmp2(tmp1:tmp2 is R1+rem1/100)
 884A [05] 4E4A99    2652       mov     barocor,tmp10      ; tmp10 is barometer percent
 884D [03] 3F9A      2653       clr     tmp11              ; zero to tmp11
 884F [05] 4E4C9B    2654       mov     aircor,tmp12       ; air temp correction % in tmp12
 8852 [03] 3F9C      2655       clr     tmp13              ; tmp13 is zero
 8854 [05] CD8F25    2656       jsr     Supernorm          ; Multiply and divide by 100(barocor and aircor)
                     2657                                  ;(result in tmp10:tmp11)=R2+rem2/100
 8857 [05] 4E909B    2658       mov     tmp1,tmp12              ; move saved tmp1 into tmp12
 885A [05] 4E919C    2659       mov     tmp2,tmp13              ; move saved tmp2 into tmp13
 885D [05] CD8F25    2660       jsr     Supernorm          ; Multiply and divide by 100(R1+rem1/100 and R2+rem2/100)
                     2661                                  ;(result in tmp10:tmp11)=R3+rem3/100
 8860 [05] 4E9994    2662       mov     tmp10,tmp5              ; save whole result into tmp5
 8863 [05] 4E9A95    2663       mov     tmp11,tmp6              ; save remainder into tmp6(R3+rem3/100)
 8866 [03] B699      2664       lda     tmp10              ;(R3)
 8868 [03] B74E      2665       sta     gammae             ; Copy to "Gammae" variable
 886A [05] 4E4D99    2666       mov     Ftrimcor,tmp10     ; Fuel Trim correction percent into tmp10
 886D [03] 3F9A      2667       clr     tmp11              ; Remainder is zero
 886F [05] 4E519B    2668       mov     vecurr,tmp12       ; VE into tmp12
 8872 [03] 3F9C      2669       clr     tmp13              ; Remainder is zero
 8874 [05] CD8F25    2670       jsr     Supernorm          ; Multiply and divide by 100(Ftrimcor and vecurr)
                     2671                                  ;(result in tmp10:tmp11)=R4+rem4/100
 8877 [05] 4E949B    2672       mov     tmp5,tmp12              ; move saved tmp5 into tmp12
 887A [05] 4E959C    2673       mov     tmp6,tmp13              ; move saved tmp6 into tmp13
 887D [05] CD8F25    2674       jsr     Supernorm          ; Multiply and divide by 100(R3+rem3/100 and R4+rem4/100)
                     2675                                  ;(result in tmp10:tmp11)=R5+rem5/100
 8880 [05] 4E9992    2676       mov     tmp10,tmp3              ; save whole result into tmp3
 8883 [05] 4E9A93    2677       mov     tmp11,tmp4              ; save remainder into tmp4(R5+rem5/100)
 8886 [05] 4E6C99    2678       mov     kpa,tmp10          ; MAP into tmp10
 8889 [03] 3F9A      2679       clr     tmp11              ; tmp11 is zero
 888B [04] C6E423    2680       lda     REQ_FUEL           ; Load accumulator with value in "REQ_FUEL"
 888E [03] B79B      2681       sta     tmp12              ; Copy to tmp12 variable
 8890 [03] 3F9C      2682       clr     tmp13              ; tmp13 is zero
 8892 [05] CD8F25    2683       jsr     Supernorm          ; Multiply and divide by 100(kpa and REQ_FUEL)
                     2684                                  ;(result in tmp10:tmp11)=R6+rem6/100
 8895 [05] 4E929B    2685       mov     tmp3,tmp12              ; move saved tmp3 into tmp12
 8898 [05] 4E939C    2686       mov     tmp4,tmp13              ; move saved tmp4 into tmp13
 889B [05] CD8F25    2687       jsr     Supernorm               ; Multiply and divide by 100(R5+rem5/100 and R6+rem6/100)
                     2688                                  ;(result in tmp13:tmp14)=R7+rem7/100
 889E [05] 4E9C6F    2689       mov     tmp13,pwnadH       ; Move value in tmp13 to "pwnadH"
 88A1 [05] 4E9D70    2690       mov     tmp14,pwnadL       ; Move value in tmp14 to "pwnadL"
                     2691  
                     2692  
                     2693  ************************************************************************************************
                     2694  **
                     2695  ** Calculation of Battery Voltage Correction for Injector Opening Time
                     2696  **
                     2697  ** Injector open time is implemented as a linear function of
                     2698  **  battery voltage, from 7.2 volts (61 ADC counts) to 19.2 volts (164 counts),
                     2699  **  with 13.2 volts (113 counts) being the nominal operating voltage
                     2700  **
                     2701  ** INJOPEN = injector open time at 13.2 volts in mms
                     2702  ** BATTFAC = injector open adjustment factor 6 volts from 13.2V in mms
                     2703  **
                     2704  **
                     2705  ** + (INJOPEN + BATTFAC)
                     2706  ** +   *
                     2707  ** +                     (INJOPEN)
                     2708  ** +                         *
                     2709  ** +                                       (INJOPEN - BATTFAC)
                     2710  ** +                                               *
                     2711  ** +
                     2712  ** ++++++++++++++++++++++++++++++++++++++++++++++++++++++
                     2713  **    6.0V                 13.2V                16.2
                     2714  **
                     2715  ***********************************************************************************************
                     2716  
                     2717  BATT_CORR_COMP:
 88A4 [02] A63D      2718       lda     #61T        ; Load accumulator with decimal 61
 88A6 [03] B790      2719       sta     tmp1        ; Copy to "tmp1"
 88A8 [02] A6A4      2720       lda     #164T       ; Load accumulator with decimal 164
 88AA [03] B791      2721       sta     tmp2        ; Copy to "tmp2"
 88AC [04] C6E426    2722       lda     injopen     ; Load accumulator with value in "injopen"
 88AF [04] CBE427    2723       add     battfac     ; Add A<-(A)+(M)
 88B2 [03] B792      2724       sta     tmp3        ; Copy result to "tmp3"
 88B4 [04] C6E426    2725       lda     injopen     ; Load accumulator with value in "injopen"
 88B7 [04] C0E427    2726       sub     battfac     ; Subtract A<-(A)-(M)
 88BA [03] B793      2727       sta     tmp4        ; Copy result to "tmp4"
 88BC [03] 2A02      2728       bpl     MBFF        ; Branch to MBFF: if plus(Check if minus condition)
 88BE [03] 3F93      2729       clr     tmp4        ; Clear "tmp4"
                     2730  MBFF:
 88C0 [05] 4E4594    2731       mov     batt,tmp5   ; Move value in "batt" to "tmp5"
 88C3 [05] CD8E31    2732       jsr     lininterp   ; Jump to subroutine at lininterp:(injector open time in tmp6)
 88C6 [03] B695      2733       lda     tmp6        ; Load accumulator with value in tmp6
 88C8 [03] B773      2734       sta     deadband    ; Copy to Injector Deadband variable.
                     2735  
                     2736  
                     2737  ;***********************************************************************************************
                     2738  ;
                     2739  ; --------------------------- Calculation of Final Pulse Width ---------------------------------
                     2740  ;-----------
                     2741  ; The following equation is evaluated here:
                     2742  ;
                     2743  ; Where:
                     2744  ;  pwnadH:pwnadL   = Calculated Pulse Width without accelleration enrichment
                     2745  ;                    and injector deadband, in 1uS resolution
                     2746  ;  tpsaccel        = Accelleration Enrichment in 100uS resolution
                     2747  ;  fdhrH:fdhrL     = Calculated Pulse Width without injector deadband,
                     2748  ;                    in 1uS resolution (Fuel delivery)
                     2749  ;  deadband        = Injector deadband in 100uS resolution
                     2750  ;  pwcalch:pwcalcl = Final pulse width in 1uS resolution
                     2751  ;
                     2752  ;  pwnadH:pwnadL + (tpsaccel*100) = fdH:fdL
                     2753  ;
                     2754  ;  fdhrH:fdhrL + (deadband*100) = pwcalcH:pwcalcL
                     2755  ;
                     2756  ;***********************************************************************************************
                     2757  
                     2758  FINAL_PW_CALC:
 88CA [03] B64F      2759       lda     tpsaccel     ; Load accumulator with value in "tpsaccel"
 88CC [02] AE64      2760       ldx     #$64         ; Load index register Lo byte with decimal 100
 88CE [05] 42        2761       mul                  ; Multiply (X:A <-(X)*(A)
 88CF [03] BB70      2762       add     pwnadL       ; Add (A)<-(A)+(X) Calculated PW Lo byte
 88D1 [03] B772      2763       sta     fdhrL        ; Copy result to Fuel delivery PW Hi Res Lo byte
 88D3 [01] 9F        2764       txa                  ; Transfer value in index register Lo byte to accumulator
 88D4 [03] B96F      2765       adc     pwnadH       ; Add with carry (A)<-(A)+(X)+(C) Calculated PW Hi byte
 88D6 [03] B771      2766       sta     fdhrH        ; Copy result to Fuel Delivery PW Hi Res Hi byte
 88D8 [03] B673      2767       lda     deadband     ; Load accumulator with value in "Deadband"
 88DA [02] AE64      2768       ldx     #$64         ; Load index register Lo byte with decimal 100
 88DC [05] 42        2769       mul                  ; Multiply (X:A <-(X)*(A)
 88DD [03] BB72      2770       add     fdhrL        ; Add (A)<-(A)+(X) Fuel Delivery PW Hi Res Lo byte
 88DF [03] B753      2771       sta     pwcalcL      ; Copy result to Final Pulse Width Lo byte
 88E1 [01] 9F        2772       txa                  ; Transfer value in index register Lo byte to accumulator
 88E2 [03] B971      2773       adc     fdhrH        ; Add with carry (A)<-(A)+(X)+(C) Fuel Delivery Pulse Width Hi Res
                     2774                            ; Hi byte
 88E4 [03] B752      2775       sta     pwcalcH      ; Copy result to Final Pulse Width Hi byte
                     2776  
                     2777  ;***********************************************************************************************
                     2778  ; - Divide pwcalcH:pwcalcL by 100 to produce Lo Res version ("pw") for TS and MT display,
                     2779  ;   and Fuel Burn Calcs
                     2780  ;***********************************************************************************************
                     2781  
 88E6 [04] 5552      2782       ldhx     pwcalcH          ; Load index register with value in pwcalcH:pwcalcL


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 23
MC68HC908GP32 User Bootloader


 88E8 [01] 9F        2783       txa                       ; Transfer value in index register Lo byte to accumulator
 88E9 [02] AE64      2784       ldx      #$64             ; Load index register Lo byte with decimal 100
 88EB [07] 52        2785       div                       ; Divide (A)<-(H:A)/(X);(H)rem
 88EC [05] CD8F12    2786       jsr      DIVROUND         ; Jump to "DIVROUND" subroutine(round result)
 88EF [03] B754      2787       sta      pw               ; Copy result to Final Pulse Width for display variable
                     2788                                 ;(0.1mS resolution)
                     2789  
                     2790  ;***********************************************************************************************
                     2791  ; - Divide fdhrH:fdhrL by 100, then add to ("dbCor") variable to produce Lo Res version ("fd")
                     2792  ;   for MV and MT display, and Fuel Burn Calcs
                     2793  ;   It is assumed that even with a 0.9 ms dead band the actual deadband may be less which can be
                     2794  ;   tuned around, but skews the fuel burn calcultaions especially at smaller pulse widths.
                     2795  ;   Adding the "dbCor" value will attempt to solve this problem by making the fuel delivery
                     2796  ;   variable larger
                     2797  ;***********************************************************************************************
                     2798  
 88F1 [04] 5571      2799       ldhx     fdhrH          ; Load index register with value in fdhrH:fdhrL
 88F3 [01] 9F        2800       txa                     ; Transfer value in index register Lo byte to accumulator
 88F4 [02] AE64      2801       ldx      #$64           ; Load index register Lo byte with decimal 100
 88F6 [07] 52        2802       div                     ; Divide (A)<-(H:A)/(X);(H)rem
 88F7 [05] CD8F12    2803       jsr      DIVROUND       ; Jump to "DIVROUND" subroutine(round result)
 88FA [04] CBE434    2804       add      dbCor          ; Add A<-(A)+(M) Deadband correction
 88FD [03] B755      2805       sta      fd             ; Copy result to Fuel Delivery Lo Res variable
                     2806  
                     2807  ;***********************************************************************************************
                     2808  ;
                     2809  ; ST 3-D Table Lookup
                     2810  ;
                     2811  ;  This is used to determine value of Spark Angle minus 8 degrees ST,
                     2812  ;   based on RPM and MAP
                     2813  ;  The table looks like:
                     2814  ;
                     2815  ;     105 +....+....+....+....+....+....+....+
                     2816  ;         ....................................
                     2817  ;      00 +....+....+....+....+....+....+....+
                     2818  ;                    ...
                     2819  ;  KPA                ...
                     2820  ;                        ...
                     2821  ;      35 +....+....+....+....+....+....+....+
                     2822  ;         5    15   25   35   45   55   65   75 RPM/20
                     2823  ;
                     2824  ;
                     2825  ; Steps:
                     2826  ;  1) Find the bracketing KPA positions via ORD_TABLE_FIND, put index in
                     2827  ;      tmp8 and bounding values in tmp9(kpa1) and tmp10(kpa2)
                     2828  ;  2) Find the bracketing RPM positions via ORD_TABLE_FIND, store index in
                     2829  ;      tmp11 and bounding values in tmp13(rpm1) and tmp14(rpm2)
                     2830  ;  3) Using the ST table, find the table ST values for tmp15=ST(kpa1,rpm1),
                     2831  ;      tmp16=ST(kpa1,rpm2), tmp17 = ST(kpa2,rpm1), and tmp18 = ST(kpa2,rpm2)
                     2832  ;  4) Find the interpolated ST value at the lower KPA range :
                     2833  ;      x1=rpm1, x2=rpm2, y1=ST(kpa1,rpm1), y2=ST(kpa1,rpm2) - put in tmp19
                     2834  ;  5) Find the interpolated ST value at the upper KPA range :
                     2835  ;      x1=rpm1, x2=rpm2, y1=ST(kpa2,rpm1), y2=ST(kpa2,rpm2) - put in tmp11
                     2836  ;  6) Find the final ST value using the two interpolated ST values:
                     2837  ;      x1=kpa1, x2=kpa2, y1=ST_FROM_STEP_4, y2=ST_FROM_STEP_5
                     2838  ;
                     2839  ;***********************************************************************************************
                     2840  
                     2841  ;STTABLELOOKUP:
                     2842  
                     2843  ;ST_STEP_1:
 88FF [03] 45E19C    2844       ldhx    #KPARANGEST_f       ; Load index register with value in KPARANGEST table
 8902 [04] 3590      2845       sthx    tmp1                ; Copy value to tmp1 variable
 8904 [04] 6E0B92    2846       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 8907 [05] 4E6C93    2847       mov     kpa,tmp4            ; Move value in "kpa" to "tmp4"
 890A [05] CD8E16    2848       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 890D [03] B690      2849       lda     tmp1                ; Load accumulator with value in tmp1
 890F [03] B691      2850       lda     tmp2                ; Load accumulator with value in tmp2
 8911 [05] 4E9497    2851       mov     tmp5,tmp8                  ; move value from tmp5 to tmp8 (Index)
 8914 [05] 4E9098    2852       mov     tmp1,tmp9                  ; move value from tmp1 to tmp9 (X1)
 8917 [05] 4E9199    2853       mov     tmp2,tmp10                 ; move value from tmp2 to tmp10 (X2)
                     2854  
                     2855  ;ST_STEP_2:
 891A [03] 45E190    2856       ldhx    #RPMRANGEST_f       ; Load index register with value from RPMRANGEST table
 891D [04] 3590      2857       sthx    tmp1                ; Copy value to tmp1 variable
 891F [04] 6E0B92    2858       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 8922 [05] 4E5093    2859       mov     rpm20,tmp4          ; Move value in "rpm20" to "tmp4"
 8925 [05] CD8E16    2860       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 8928 [05] 4E949A    2861       mov     tmp5,tmp11                 ; Move value from tmp5 to tmp11 (Index)
 892B [05] 4E909C    2862       mov     tmp1,tmp13                 ; Move value from tmp1 to tmp13 (X1)
 892E [05] 4E919D    2863       mov     tmp2,tmp14                 ; Move value from tmp2 to tmp14 (X2)
                     2864  
                     2865  ;ST_STEP_3:
 8931 [01] 8C        2866          clrh              ; Clear index register Hi byte
 8932 [02] AE0C      2867          ldx     #$0C      ; Load index register Lo byte with decimal 13
 8934 [03] B697      2868          lda     tmp8      ; Load accumulator with value in "tmp8"
 8936 [01] 4A        2869          deca              ; Decrement value in accumulator
 8937 [05] 42        2870          mul               ; Multiply X:A<-(X)x(A)
 8938 [03] BB9A      2871          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 893A [01] 4A        2872          deca              ; Decrement value in accumulator
 893B [01] 97        2873          tax               ; Transfer value in accumulator to index register Lo byte
 893C [05] CD8F89    2874          jsr     VE2X      ; Jump to subroutine at VE2X:
 893F [03] B79E      2875          sta     tmp15     ; Copy result to "tmp15"
 8941 [01] 5C        2876          incx              ; Increment value in index rgister Lo byte
 8942 [05] CD8F89    2877          jsr     VE2X      ; Jump to subroutine at VE2X:
 8945 [03] B79F      2878          sta     tmp16     ; Copy result to "tmp16"
 8947 [02] AE0C      2879          ldx     #$0C      ; Load index register Lo byte with decimal 13
 8949 [03] B697      2880          lda     tmp8      ; Load accumulator with value in "tmp8"
 894B [05] 42        2881          mul               ; Multiply X:A<-(X)x(A)
 894C [03] BB9A      2882          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 894E [01] 4A        2883          deca              ; Decrement value in accumulator
 894F [01] 97        2884          tax               ; Transfer value in accumulator to index register Lo byte
 8950 [05] CD8F89    2885          jsr     VE2X      ; Jump to subroutine at VE2X:
 8953 [03] B7A0      2886          sta     tmp17     ; Copy result to "tmp17"
 8955 [01] 5C        2887          incx              ; Increment value in index rgister Lo byte
 8956 [05] CD8F89    2888          jsr     VE2X      ; Jump to subroutine at VE2X:
 8959 [03] B7A1      2889          sta     tmp18     ; Copy result to "tmp18"
                     2890  
                     2891  ;ST_STEP_4:
 895B [05] 4E9C90    2892       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 895E [05] 4E9D91    2893       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8961 [05] 4E9E92    2894       mov     tmp15,tmp3      ; Move value from tmp15 variable to tmp3 variable
 8964 [05] 4E9F93    2895       mov     tmp16,tmp4      ; Move value from tmp16 variable to tmp4 variable
 8967 [05] 4E5094    2896       mov     rpm20,tmp5      ; Move Throttle Position Sensor ADC to tmp5 variable
 896A [05] CD8E31    2897       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 896D [05] 4E95A2    2898       mov     tmp6,tmp19      ; Move value from tmp6 variable to tmp19 variable
                     2899  
                     2900  ;ST_STEP_5:
 8970 [05] 4E9C90    2901       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 8973 [05] 4E9D91    2902       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8976 [05] 4EA092    2903       mov     tmp17,tmp3      ; Move value from tmp17 variable to tmp3 variable
 8979 [05] 4EA193    2904       mov     tmp18,tmp4      ; Move value from tmp18 variable to tmp4 variable
 897C [05] 4E5094    2905       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 897F [05] CD8E31    2906       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8982 [05] 4E959A    2907       mov     tmp6,tmp11      ; Move value from tmp6 variable to tmp11 variable
                     2908  
                     2909  ;ST_STEP_6:
 8985 [05] 4E9890    2910       mov     tmp9,tmp1        ; Move value from tmp9 variable to tmp1 variable
 8988 [05] 4E9991    2911       mov     tmp10,tmp2       ; Move value from tmp10 variable to tmp2 variable
 898B [05] 4EA292    2912       mov     tmp19,tmp3       ; Move value from tmp19 variable to tmp3 variable
 898E [05] 4E9A93    2913       mov     tmp11,tmp4       ; Move value from tmp11 variable to tmp4 variable
 8991 [05] 4E6C94    2914       mov     kpa,tmp5         ; Move value in MAP value in units of KPa to tmp5
 8994 [05] CD8E31    2915       jsr     lininterp        ; Jump to subroutine lininterp (result in tmp6)
 8997 [05] 4E955A    2916       mov     tmp6,Spk_Ang_Fac
                     2917  
                     2918  ;***********************************************************************************************


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 24
MC68HC908GP32 User Bootloader


                     2919  ; - Calculate the Delay Angle Factor from PIP to SPOUT
                     2920  ;***********************************************************************************************
                     2921  
 899A [03] B65A      2922       lda     Spk_Ang_Fac         ; Load acumulator with value in Spark Angle Factor variable
 899C [03] BB5B      2923       add     Trm_Ang_Fac         ; Add with value in Trim Angle Factor(A<-(A)+(M))
 899E [03] 2504      2924       bcs     RAIL_DL_ANG_FAC     ; If C bit of CCR is set, branch to RAIL_DL_ANG_FAC
 89A0 [03] B75C      2925       sta     Dly_Ang_Fac         ; Copy Result to Delay Angle Factor var
 89A2 [03] 2004      2926       bra     DLY_ANG_CALC_DONE   ; Branch to DLY_ANG_CALC_DONE
                     2927  
                     2928  RAIL_DL_ANG_FAC:
 89A4 [02] A6FF      2929       lda     #$FF            ; Load accumultor with decimal 255 (maximum delay = 255/256*period)
 89A6 [03] B75C      2930       sta     Dly_Ang_Fac     ; Copy Result to Delay Angle variable
                     2931  
                     2932  DLY_ANG_CALC_DONE:
                     2933  
                     2934  ;***********************************************************************************************
                     2935  ;***********************************************************************************************
                     2936  
                     2937  LOOP_DONE:
 89A8 [03] CC8381    2938       jmp     LOOPER     ; Jump to LOOPER: (End of Main Loop!!!)
                     2939  
                     2940  ;***********************************************************************************************
                     2941  ;***********************************************************************************************
                     2942  
                     2943  
                     2944  ;***********************************************************************************************
                     2945  ;
                     2946  ;* * * * * * * * * * * * * * * * * *   Interrupt Section * * * * * * * * * * * * * * * * * * * *
                     2947  ;
                     2948  ; NOTE!!! If the interrupt service routine modifies the H register, or uses the indexed
                     2949  ; addressing mode, save the H register (pshh) and then restore it (pulh) prior to exiting
                     2950  ; the routine
                     2951  ;
                     2952  ;***********************************************************************************************
                     2953  
                     2954  ;***********************************************************************************************
                     2955  ;
                     2956  ; -------------------- Following interrupt service routines in priority order ------------------
                     2957  ;
                     2958  ; IRQ_ISR:     - PIP input (PIP input Hi, IRQ Lo, hardware inverted)
                     2959  ;
                     2960  ; TIM2CH0_ISR: - TIM2 CH0 output compare ($0064 * 1uS) (100us Timer Tick)
                     2961  ;
                     2962  ; TIM2CH1_ISR: - TIM2 CH1 output compare (SPOUT control)
                     2963  ;
                     2964  ; SCIRCV_ISR:  - SCI receive
                     2965  ;
                     2966  ; SCITX_ISR:   - SCI transmit
                     2967  ;
                     2968  ; KYBD_ISR:    - Keyboard interrupt (Vehicle Speed and Ignition Monitor)from High to Low
                     2969  ;                (hardware inverted)
                     2970  ;
                     2971  ; ADC_ISR:     - ADC Conversion Complete
                     2972  ;
                     2973  ;***********************************************************************************************
                     2974  
                     2975  ;***********************************************************************************************
                     2976  ;===============================================================================================
                     2977  ; - IRQ - Input trigger (PIP rising edge,IRQ falling edge, hardware inverted)
                     2978  ;   SPOUT signal scheduling time stamps,
                     2979  ;   Decrement minPIP counter.
                     2980  ;   Increment afterstart enrichment counter.
                     2981  ;   Determine RPM period.
                     2982  ;   Injector scheduling.
                     2983  ;===============================================================================================
                     2984  ;***********************************************************************************************
                     2985  
                     2986  IRQ_ISR:
 89AB [02] 8B        2987       pshh             ; Push value in index register Hi byte to stack
                     2988  
                     2989  
                     2990  ;***********************************************************************************************
                     2991  ; - Get 0.1uS Timestamp for SPOUT "on" calculations
                     2992  ;   T2CNTH:T2CNTL = PIP_tsH:PIP_tsL
                     2993  ;***********************************************************************************************
                     2994  
                     2995  GET_TIMESTAMP:
 89AC [03] B62D      2996       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte
                     2997                           ;(Unlatch any previous reads)
 89AE [03] BE2C      2998       ldx     T2CNTH      ; Load index register Lo byte with value in TIM2 Counter Register Hi
 89B0 [03] BFA6      2999       stx     PIP_tsH     ; Copy to PIP Timestamp Hi byte variable
 89B2 [03] B62D      3000       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte
 89B4 [03] B7A7      3001       sta     PIP_tsL     ; Copy to PIP Timestamp Lo byte variable
                     3002  
                     3003  ;***********************************************************************************************
                     3004  ; - Check to see if we have received a minimum of 3 PIP signals so that
                     3005  ;   period calculations will be valid
                     3006  ;***********************************************************************************************
                     3007  
                     3008  CHECK_PIPn:
 89B6 [03] B6C1      3009       lda   MinPIP         ; Load accumulator with value in Minimum PIP signals required for
                     3010                            ; period calculations
 89B8 [03] 2704      3011       beq   PIP_OK         ; If Z bit of CCR is set, branch to PIP_OK:
 89BA [04] 3AC1      3012       dec   MinPIP         ; Decrement "MinPIP" variable
 89BC [03] 2000      3013       bra   RPM_PERIOD     ; Branch to RPM_PERIOD:
                     3014  
                     3015  PIP_OK:
                     3016  
                     3017  ;***********************************************************************************************
                     3018  ; - Determine the RPM period in 100uS resolution from the RPM counter values
                     3019  ;***********************************************************************************************
                     3020  
                     3021  RPM_PERIOD:
 89BE [03] B677      3022       lda     RPMcH          ; Load accumulator with value in RPM counter Hi byte
 89C0 [03] B775      3023       sta     RPMpH          ; Copy to RPM Period Hi byte
 89C2 [03] B678      3024       lda     RPMcL          ; Load accumulator with value in RPM counter Lo byte
 89C4 [03] B776      3025       sta     RPMpL          ; Copy to RPM Period Low byte
 89C6 [03] 3F77      3026       clr     RPMcH          ; Clear RPM counter Hi byte
 89C8 [03] 3F78      3027       clr     RPMcL          ; Clear RPM counter Lo byte
                     3028  
                     3029  ;***********************************************************************************************
                     3030  ; - Increment the counter for the Hi Res tachometer period averageing.
                     3031  ;***********************************************************************************************
                     3032  
 89CA [04] 3CD5      3033       inc     tachcnt        ; Increment the tachometer averaging counter
                     3034  
                     3035  ;***********************************************************************************************
                     3036  ; If we are in ASE mode, and ignition cycle counter has been selected, Increment after-start
                     3037  ; enrichment counter
                     3038  ;***********************************************************************************************
                     3039  
 89CC [05] 05630B    3040       brclr   startw,engine,NO_IGN_COUNT     ; If "startw" bit of "engine" variable is clear,
                     3041                                              ; branch to NO_IGN_COUNT:
 89CF [04] C6E437    3042       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 89D2 [02] A100      3043       cmp     #$0               ; Compare it with decimal 0
 89D4 [03] 2702      3044       beq     DO_IGN_COUNT      ; IF Z bit of CCR is set, branch to DO_IGN_COUNT: (ASEtype = 0)
 89D6 [03] 2002      3045       bra     NO_IGN_COUNT      ; Branch to NO_IGN_COUNT: (ASEtype not = 0)
                     3046  
                     3047  DO_IGN_COUNT:
                     3048  
 89D8 [04] 3C7F      3049       inc    asecount           ; Increment the ASE counter
                     3050  
                     3051  NO_IGN_COUNT:
                     3052  
                     3053  ;***********************************************************************************************
                     3054  ; ------------------------------------- Fuel Section -------------------------------------------


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 25
MC68HC908GP32 User Bootloader


                     3055  ; - "divider" is the "ignition counts per injection" constant set in Tuner Studio
                     3056  ; - "alternate" is the "Injection Mode" constant set in Tuner Studio(0 = sim,1 = alternate)
                     3057  ;***********************************************************************************************
                     3058  
                     3059  DO_FUEL:
 89DA [05] 006306    3060       brset    running,engine,RUN_SET    ; If "running" bit of"engine" variable is set,
                     3061                                          ; branch to RUN_SET:
 89DD [04] 1000      3062       bset     fuelp,PORTA               ; Set Fuel Pump Relay on Port A0(Turn on fuel Pump)
 89DF [04] 1065      3063       bset     FPon,portAbits            ; Set "FPon" bit of "PortAbits"
 89E1 [04] 1063      3064       bset     running,engine            ; Set "running" bit of "engine" variable
                     3065  
                     3066  RUN_SET:
 89E3 [05] 026313    3067       brset    crank,engine,SCHED_SQUIRT ; If "crank" bit of "engine" variable is set,
                     3068                                          ; branch to SCHED_SQUIRT:
                     3069                                          ; (Inject on every pulse if cranking)
 89E6 [04] 3C81      3070       inc      igncount                  ; Increment Ignition pulse counter
 89E8 [03] B681      3071       lda      igncount                  ; Load accumulator with value in Ign pulse counter
 89EA [04] C1E424    3072       cmp      divider                   ; Compare with Ignition counts per injection
 89ED [03] 270A      3073       beq      SCHED_SQUIRT              ; If Z bit in CCR is set((A)=(M))
                     3074                                          ; branch to SCHED_SQUIRT:
 89EF [03] B681      3075       lda      igncount                       ; Load accumulator with Ignition pulse counter
 89F1 [02] A108      3076       cmp      #$08                      ; Compare with decimal 8
                     3077                                          ;(The maximum allowed - reset if match)
 89F3 [03] 2623      3078       bne      IRQ_DONE                       ; If not equal, branch to IRQ_DONE:
 89F5 [03] 3F81      3079       clr      igncount                  ; Clear Ignition pulse counter variable
 89F7 [03] 201F      3080       bra      IRQ_DONE                  ; Branch to IRQ_DONE:
                     3081  
                     3082  SCHED_SQUIRT:
 89F9 [03] 3F81      3083       clr      igncount                  ; Clear Ignition pulse counter variable
                     3084  
                     3085  CRANK_CHK:
 89FB [05] 026316    3086       brset     crank,engine,SCHED_BOTH   ; If crank bit of engine variable is set, branch
                     3087                                           ; to SCHED_BOTH:
 89FE [04] C6E425    3088       lda       alternate                 ; Load accumulator with value in "alternate"(0 or 1)
 8A01 [03] 2711      3089       beq       SCHED_BOTH                ; If Z bit of CCR is set(A)=(M), branch to
                     3090                                           ; SCHED_BOTH:
 8A03 [04] 3C82      3091       inc       altcount                  ; Increment Alternate count selector variable
 8A05 [05] 008206    3092       brset     0,altcount,SCHED_INJ2     ; If 0 bit of "altcount" variable is set, branch to
                     3093                                           ; SCHED_INJ2:
                     3094  
                     3095  SCHED_INJ1:
 8A08 [04] 146A      3096       bset    sched1,squirt     ; Set "sched1" bit of "squirt" variable
 8A0A [04] 196A      3097       bclr    sched2,squirt     ; Clear "sched2" bit of "squirt" variable
 8A0C [03] 200A      3098       bra     IRQ_DONE          ; Branch to IRQ_DONE:
                     3099  
                     3100  SCHED_INJ2:
 8A0E [04] 186A      3101       bset    sched2,squirt    ; Set "sched2" bit of "squirt" variable
 8A10 [04] 156A      3102       bclr    sched1,squirt     ; Clear "sched1" bit of "squirt" variable
 8A12 [03] 2004      3103       bra     IRQ_DONE          ; Branch to IRQ_DONE:
                     3104  
                     3105  SCHED_BOTH:
 8A14 [04] 146A      3106       bset    sched1,squirt     ; Set "sched1" bit of "squirt" variable
 8A16 [04] 186A      3107       bset    sched2,squirt     ; Set "sched2" bit of "squirt" variable
                     3108  
                     3109  IRQ_DONE:
 8A18 [04] 106B      3110       bset    piprise,inputs    ; Set "piprise" bit of "inputs" variable
 8A1A [02] 8A        3111       pulh                      ; Pull value from stack to index register Hi
 8A1B [07] 80        3112       rti                       ; Return from interrupt
                     3113  
                     3114  
                     3115  ;***********************************************************************************************
                     3116  ;===============================================================================================
                     3117  ; - TIM2 CH0 Interrupt (100 uS clock tick)
                     3118  ; - Generate time rates:
                     3119  ;   100 Microseconds,(RPM, VS counters, Overspeed check, Stall check, Injector firing
                     3120  ;                     control, Update fuel burn variables)
                     3121  ;   Milliseconds,(for ADC conversions)
                     3122  ;   100 Milliseconds,(for TPS DOT calculations)
                     3123  ;   Seconds,(for fuel burn calc variables for TS and MV)
                     3124  ;===============================================================================================
                     3125  ;***********************************************************************************************
                     3126  
                     3127  ;***********************************************************************************************
                     3128  ; - Read the current TIM2 CH0 counter value and add decimal 100 for the new
                     3129  ;   100uS clock tick O/C value
                     3130  ;***********************************************************************************************
                     3131  
                     3132  TIM2CH0_ISR:
 8A1C [02] 8B        3133       pshh                  ; Push value in index register Hi byte to stack
 8A1D [03] B630      3134       lda     T2SC0         ; Load accumulator with value in TIM2 CH0 Status and Control Register
                     3135                             ; (Arm CHxF flag clear)
 8A1F [04] 1F30      3136       bclr    CHxF,T2SC0    ; Clear CHxF bit of TIM2 CH0 Status and Control Register
 8A21 [04] 5531      3137       ldhx    T2CH0H        ; Load index register with value in TIM2 CH0 register H:L
                     3138                             ; (output compare value)
 8A23 [02] AF64      3139       aix     #$64          ; Add decimal 100 (100 uS)
 8A25 [04] 3531      3140       sthx    T2CH0H        ; Copy result to TIM2 CH0 register(new output compare value)
                     3141  
                     3142  ;==============================================================================================
                     3143  ;******************************** 100 Microsecond section *************************************
                     3144  ;==============================================================================================
                     3145  
                     3146  ;**********************************************************************************************
                     3147  ; - Check the value of the AIOT trigger off counter variable, if other than zero, decrement it.
                     3148  ;   When it reaches zero, shut the AIOT trigger off(open collector output)
                     3149  ;**********************************************************************************************
                     3150  
 8A27 [03] B6CA      3151       lda     aiotcntr          ; Load accumulator with value in "aiotcntr"
 8A29 [03] 270A      3152       beq     AIOT_CHK_DONE     ; If "Z" bit of "CCR is set, branch to AIOT_CHK_DONE:
 8A2B [04] 3ACA      3153       dec     aiotcntr          ; Decrement "aiotcntr"
 8A2D [03] B6CA      3154       lda     aiotcntr          ; load accumulator with value in "aiotcntr"
 8A2F [03] 2702      3155       beq     AIOT_OFF          ; If "Z" bit of "CCR is set, branch to AIOT_OFF:
 8A31 [03] 2002      3156       bra     AIOT_CHK_DONE     ; Branch to AIOT_CHK_DONE:
                     3157  
                     3158  AIOT_OFF:
 8A33 [04] 1102      3159       bclr    aiot,portC        ; Clear "aiot" bit of Port C (AIOT trigger off)
                     3160  
                     3161  AIOT_CHK_DONE:
                     3162  
                     3163  ;**********************************************************************************************
                     3164  ; - Increment the VS counter
                     3165  ;**********************************************************************************************
                     3166  
                     3167  INC_VS_CNTR:
 8A35 [04] 3CCE      3168       inc     VScL             ; Increment counter for VS Lo byte
 8A37 [03] 2602      3169       bne     VS_CNTR_DONE     ; If the Z bit of the CCR is clear, branch to VS_CNTR_DONE:
 8A39 [04] 3CCD      3170       inc     VScH             ; Increment counter for VS Hi byte
                     3171  
                     3172  VS_CNTR_DONE:
                     3173  
                     3174  ;**********************************************************************************************
                     3175  ; - Increment the RPM counter
                     3176  ;**********************************************************************************************
                     3177  
                     3178  ;INC_RPM_CNTR:
 8A3B [04] 3C78      3179       inc      rpmcl           ; Increment counter for RPM Lo byte
 8A3D [03] 2602      3180       bne      RPM_CNTR_DONE  ; If the Z bit of the CCR is clear, branch to RPM_CNTR_DONE:
                     3181                                ;(Increment "rpmch" when "rpmcl" rolls over)
 8A3F [04] 3C77      3182       inc      rpmch           ; Increment counter for RPM Hi byte
                     3183  
                     3184  RPM_CNTR_DONE:
 8A41 [05] 026478    3185       brset   REVL,alarmbits,INC_CUS_JMP ; If "REVL" bit of "alarmbits" is set, branch to
                     3186                                          ; INC_CUS_JMP:(Over speed situation. Skip over firing
                     3187                                          ; control to slow engine down in a hurry)
                     3188  
                     3189  ;**********************************************************************************************
                     3190  ; - Check for stall and take appropriate action


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 26
MC68HC908GP32 User Bootloader


                     3191  ;**********************************************************************************************
                     3192  
                     3193  CHECK_STALL:
 8A44 [03] B677      3194       lda      rpmch              ; Load accumulator with Counter for RPM Hi byte
 8A46 [02] A164      3195       cmp      #$64               ; Compare with decimal 100 (If rpmch is 100
                     3196                                   ; (RPM Period = 2.56 sec) then engine not turning over)
 8A48 [03] 2612      3197       bne      INJ_FIRE_CNTL      ; If (A)not=(M), branch to INJ_FIRE_CNTL:
 8A4A [03] 3F63      3198       clr      engine             ; Clear "engine" variable
                     3199                                   ;(Engine is stalled, clear all in engine)
 8A4C [04] 1100      3200       bclr     fuelp,PORTA        ; Clear "Fuel Pump" output Port A(Turn off fuel pump)
 8A4E [04] 1165      3201       bclr     FPon,portAbits     ; Clear "FPon" bit of "portAbits"
 8A50 [04] 1200      3202       bset     spark,PORTA        ; Set "spark" bit of Port A (SPOUT falling edge)
 8A52 [03] 3F77      3203       clr      rpmch              ; Clear Counter for high part of RPM
 8A54 [03] 3F78      3204       clr      rpmcl              ; Clear Low part of RPM Period
 8A56 [03] 3F50      3205       clr      rpm20              ; Clear Computed engine RPM - rpm/20 variable
 8A58 [04] 1969      3206       bclr     cant_crank,engine2 ; Clear "cant_crank" bit in "engine"(OK to crank again)
 8A5A [03] 2060      3207       bra      INC_CUS_JMP        ; Branch to INC_CUS_JMP:
                     3208                                   ;(engine not turning over, skip Injector Firing Control)
                     3209  
                     3210  
                     3211  ;**********************************************************************************************
                     3212  ;
                     3213  ;=================== Injector Firing Control = Main Injector Control Logic ====================
                     3214  ;
                     3215  ; An injector is scheduled to be fired - because the other bank *may* be
                     3216  ; firing, we have to do a little monkey business with the timer. Here we stop
                     3217  ; the timer counting, but we do not reset the count to zero - this lets us
                     3218  ; subtract both channel's OC compare value from the current timer value and
                     3219  ; re-write back in. Later on, we stop the timer again (already stopped) but
                     3220  ; this time the count is reset to zero. Because we do the following below,
                     3221  ; the other channel's count is still valid for a future OC. If there is not
                     3222  ; a OC compare pending in the other channel, we still do this because it does
                     3223  ; not hurt anything and it takes less time to do the subtraction than it does
                     3224  ; to determine if there is a OC compare pending.....
                     3225  ; This code allows pulsewidths to overlap - up to 65.535ms PW
                     3226  ;
                     3227  ;**********************************************************************************************
                     3228  
                     3229  INJ_FIRE_CNTL:
 8A5C [05] 046A06    3230       brset   sched1,squirt,INJSTRT   ; If "sched1" bit of "squirt" variable is set,
                     3231                                       ; branch to INJSTRT:
 8A5F [05] 086A03    3232       brset   sched2,squirt,INJSTRT   ; If "sched2" bit of "squirt" variable is set,
                     3233                                       ; branch to INJSTRT:
 8A62 [03] CC8AF2    3234       jmp     INJ_FIRE_CNTL_DONE      ; Jump to INJ_FIRE_CNTL_DONE:
                     3235  
                     3236  ;**********************************************************************************************
                     3237  ; - Stop Timer so it can be set up - no timer clock reset
                     3238  ;   Subtract OC values from current timer count, and re-write back in.
                     3239  ;**********************************************************************************************
                     3240  
                     3241  INJSTRT:
 8A65 [04] 6E2320    3242       mov      #$23,T1SC     ; Move %00100011 into Timer1 Status and Control Register
                     3243                              ; (Stop timer, reset timer counter, prescale for 1uS)
 8A68 [03] B626      3244       lda      T1CH0H        ; Load accumulator with value in Timer1 Channel 0 Register Hi byte
 8A6A [03] B021      3245       sub      T1CNTH        ;Subtract value in Timer1 Counter Register Hi (A<-(A)-(M))
 8A6C [03] B726      3246       sta      T1CH0H        ; Copy to Timer1 Channel 0 Register Hi byte
 8A6E [03] B627      3247       lda      T1CH0L        ; Load accumulator with value in Timer1 Channel 0 Register Lo byte
 8A70 [03] B022      3248       sub      T1CNTL        ; Subtract value in Timer1 Counter Register Lo byte(A<-(A)-(M))
 8A72 [03] B727      3249       sta      T1CH0L        ; Copy to Timer1 Channel 0 Register Lo bytr
 8A74 [03] B629      3250       lda      T1CH1H        ; Load accumulator with value in Timer1 Channel 1 Register Hi byte
 8A76 [03] B021      3251       sub      T1CNTH        ; Subtract value in Timer1 Counter Register Hi byte(A<-(A)-(M))
 8A78 [03] B729      3252       sta      T1CH1H        ; Copy to Timer1 Channel 1 Register Hi byte
 8A7A [03] B62A      3253       lda      T1CH1L        ; Load accumulator with value in Timer1 Channel 1 Register Lo byte
 8A7C [03] B022      3254       sub      T1CNTL        ; Subtract value in Timer1 Counter Register Lo byte(A<-(A)-(M))
 8A7E [03] B72A      3255       sta      T1CH1L        ; Copy to Timer1 Channel 1 Register Lo byte
                     3256  
 8A80 [05] 046A05    3257       brset   sched1,squirt,NEW_SQUIRT1  ; If "sched1" bit of "squirt" is set, branch to
                     3258                                          ; NEW_SQUIRT1:
                     3259  
                     3260  INJF1:
 8A83 [05] 086A38    3261       brset   sched2,squirt,NEW_SQUIRT2  ; If "sched2" bit of "squirt" is set, branch to
                     3262                                          ; NEW_SQUIRT2:
                     3263  
                     3264  INJF2:
 8A86 [03] 206A      3265       bra     INJ_FIRE_CNTL_DONE         ; Branch to INJ_FIRE_CNTL_DONE:
                     3266  
                     3267  
                     3268  ;**********************************************************************************************
                     3269  ;=========================== Injector #1 - Start New Injection ================================
                     3270  ;**********************************************************************************************
                     3271  
                     3272  NEW_SQUIRT1:
 8A88 [04] 156A      3273       bclr    sched1,squirt     ; Clear "sched1" bit of "squirt"(is now current operation)
 8A8A [04] 6E3320    3274       mov     #$33,T1SC         ; Move %00110011 into TIM1 Status and Control Register
                     3275                                 ; (Disable interrupts, stop timer, reset counter,
                     3276                                 ; prescale for 1uS)
 8A8D [05] 4E5226    3277       mov     pwcalcH,T1CH0H    ; Move value in Final Pulse Width Hi byte
                     3278                                 ; to TIM1 CHO O/C Register Hi byte
 8A90 [05] 4E5327    3279       mov     pwcalcL,T1CH0L    ; Move value in Final Pulse Width Lo byte
                     3280                                 ; to TIM1 CHO O/C Register Lo byte
                     3281                                 ; pulsewidth to TIM1 CH0 register Lo byte
 8A93 [04] 6E1025    3282       mov     #$10,T1SC0        ; Move %00010000 into TIM1 CH0 Status and Control Register
                     3283                                 ; (Make this normal port output init logic 1)
 8A96 [04] 6E1C25    3284       mov     #$1C,T1SC0        ; Move %00011100 into TIM1 CH0 Status and Control register
                     3285                                 ; (Disable interupts,set output on compare)
 8A99 [04] 6E0320    3286       mov     #$03,T1SC         ; Move %00000011 into TIM1 Status and Control Register
                     3287                                 ; (Disable interrupts, start timer, prescale for 1uS)
                     3288  
                     3289  ;***********************************************************************************************
                     3290  ; - Update Fuel Delivery Pulse Width Lo Res Total so the results can be used by TS and MV to
                     3291  ;   calculate current fuel burn.
                     3292  ;***********************************************************************************************
                     3293  
 8A9C [03] B655      3294       lda     fd        ; Load accumulator with value in Fuel Delivery PW Lo Res
 8A9E [03] BBCC      3295       add     fdtL      ; Add (A)<-(A)+(M) (Fuel Delivery PW Lo Res + Fuel
                     3296                         ; Delivery Pulse width Lo Res total Lo byte)
 8AA0 [03] B7CC      3297       sta     fdtL      ; Copy result to "fdtL" (update fdtL)
 8AA2 [03] B6CB      3298       lda     fdtH      ; Load accumulator with value in Fuel Delivery Pulse
                     3299                         ; width Lo Res Total Hi byte
 8AA4 [02] A900      3300       adc     #$00      ; Add with carry (A)<-(A)+(M)+(C) (just the carry)
 8AA6 [03] B7CB      3301       sta     fdtH      ; Copy result to "fdtH" (update fdtH)
                     3302  
                     3303  ;***********************************************************************************************
                     3304  ; - Update the Fuel Delivery Lo Res counter so that on roll over a pulsed signal can be sent
                     3305  ;   to the totalizer(open collector output)
                     3306  ;***********************************************************************************************
                     3307  
 8AA8 [03] B655      3308       lda     fd               ; Load accumulator with value in "fd"
 8AAA [03] BBC9      3309       add     fdcntr           ; Add (A)<-(A)+(M)
 8AAC [03] 2504      3310       bcs     TOTALIZER1       ; If the carry bit of CCR is set, branch to TOTALIZER1:
 8AAE [03] B7C9      3311       sta     fdcntr           ; Copy to "fdcntr"
 8AB0 [03] 2008      3312       bra     TOTALIZER_DONE1  ; Branch to TOTALIZER_DONE1:
                     3313  
                     3314  TOTALIZER1:
 8AB2 [03] B7C9      3315       sta     fdcntr           ; Copy to "fdcntr"
 8AB4 [04] 1002      3316       bset    aiot,portC       ; Set "aiot" bit of port C(Totalizer trigger on)
 8AB6 [02] A61E      3317       lda     #$1E             ; Load accumulator with decimal 30(3mS)
 8AB8 [03] B7CA      3318       sta     aiotcntr         ; Copy to "aiotcntr"(3mS on time)
                     3319  
                     3320  TOTALIZER_DONE1:
 8ABA [03] 20C7      3321       bra     INJF1            ; Branch to INJFI:
                     3322  
                     3323  ;***********************************************************************************************
                     3324  ; - Long branch for INC_CUS:
                     3325  ;***********************************************************************************************
                     3326  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 27
MC68HC908GP32 User Bootloader


                     3327  INC_CUS_JMP:
 8ABC [03] 2034      3328       bra     INC_CUS     ; Branch to INC_CUS_:
                     3329  
                     3330  ;***********************************************************************************************
                     3331  ;============================= Injector #2 - Start New Injection ===============================
                     3332  ;***********************************************************************************************
                     3333  
                     3334  NEW_SQUIRT2:
 8ABE [04] 196A      3335       bclr    sched2,squirt     ; Clear "sched2" bit of "squirt"(is now current operation)
 8AC0 [04] 6E3320    3336       mov     #$33,T1SC         ; Move %00110011 into TIM1 Status and Control Register
                     3337                                 ;(Disable interrupts, stop timer, reset counter,
                     3338                                 ; prescale for 1uS)
 8AC3 [05] 4E5229    3339       mov     pwcalcH,T1CH1H    ; Move value in Final Pulse Width Hi byte
                     3340                                 ; to TIM1 CH1 O/C Register Hi byte
 8AC6 [05] 4E532A    3341       mov     pwcalcL,T1CH1L    ; Move value in Final Pulse Width Lo byte
                     3342                                 ; to TIM1 CH1 O/C Register Lo byte
                     3343                                 ; pulsewidth to TIM1 CH0 register Lo byte
 8AC9 [04] 6E1028    3344       mov     #$10,T1SC1        ; Move %00010000 into TIM1 CH1 Status and Control Register
                     3345                                 ;(Make this normal port output init logic 1
 8ACC [04] 6E1C28    3346       mov     #$1C,T1SC1        ; Move %00011100 into TIM1 CH1 Status and Control register
                     3347                                 ;(Disable interupts,set output on compare)
 8ACF [04] 6E0320    3348       mov     #$03,T1SC         ; Move %00000011 into TIM1 Status and Control Register
                     3349                                 ; (Disable interrupts, start timer, prescale for 1uS)
                     3350  
                     3351  
                     3352  ;***********************************************************************************************
                     3353  ; - Update Fuel Delivery Pulse Width Lo Res Total so the results can be used by TS and MV to
                     3354  ;   calculate current fuel burn.
                     3355  ;***********************************************************************************************
                     3356  
 8AD2 [03] B655      3357       lda     fd        ; Load accumulator with value in Fuel Delivery PW Lo Res
 8AD4 [03] BBCC      3358       add     fdtL      ; Add (A)<-(A)+(M) (Fuel Delivery PW Lo Res + Fuel
                     3359                         ; Delivery Pulse width Lo Res total Lo byte)
 8AD6 [03] B7CC      3360       sta     fdtL      ; Copy result to "fdtL" (update fdtL)
 8AD8 [03] B6CB      3361       lda     fdtH      ; Load accumulator with value in Fuel Delivery Pulse
                     3362                         ; width Lo Res Total Hi byte
 8ADA [02] A900      3363       adc     #$00      ; Add with carry (A)<-(A)+(M)+(C) (just the carry)
 8ADC [03] B7CB      3364       sta     fdtH      ; Copy result to "fdtH" (update fdtH)
                     3365  
                     3366  ;***********************************************************************************************
                     3367  ; - Update the Fuel Delivery Lo Res counter so that on roll over a pulsed signal can be sent
                     3368  ;   to the totalizer(open collector output)
                     3369  ;***********************************************************************************************
                     3370  
 8ADE [03] B655      3371       lda     fd               ; Load accumulator with value in "fd"
 8AE0 [03] BBC9      3372       add     fdcntr           ; Add (A)<-(A)+(M)
 8AE2 [03] 2504      3373       bcs     TOTALIZER2       ; If the carry bit of CCR is set, branch to TOTALIZER2:
 8AE4 [03] B7C9      3374       sta     fdcntr           ; Copy to "fdcntr"
 8AE6 [03] 2008      3375       bra     TOTALIZER_DONE2  ; Branch to TOTALIZER_DONE2:
                     3376  
                     3377  TOTALIZER2:
 8AE8 [03] B7C9      3378       sta     fdcntr           ; Copy to "fdcntr"
 8AEA [04] 1002      3379       bset    aiot,portC       ; Set "aiot" bit of port C(Totalizer trigger on)
 8AEC [02] A61E      3380       lda     #$1E             ; Load accumulator with decimal 30(3mS)
 8AEE [03] B7CA      3381       sta     aiotcntr         ; Copy to "aiotcntr"(3mS on time)
                     3382  
                     3383  TOTALIZER_DONE2:
 8AF0 [03] 2094      3384       bra     INJF2            ; Branch to INJF2:
                     3385  
                     3386  INJ_FIRE_CNTL_DONE:
                     3387  
                     3388  ;***********************************************************************************************
                     3389  ; - Increment 100 Microsecond counter
                     3390  ;***********************************************************************************************
                     3391  
                     3392  INC_CUS:
 8AF2 [04] 3C7C      3393       inc     uSx100                ; Increment 100 Microsecond counter
 8AF4 [03] B67C      3394       lda     uSx100                ; Load accumulator with 100 Microsecond counter
 8AF6 [02] A10A      3395       cmp     #$0A                  ; Compare it with decimal 10
 8AF8 [03] 266A      3396       bne     TIM2CH0_ISR_JMP       ; If not equal, branch to TIM2CH0_ISR_JMP:
                     3397  
                     3398  ;===============================================================================================
                     3399  ;********************************* millisecond section *****************************************
                     3400  ;===============================================================================================
                     3401  
                     3402  
                     3403  ;***********************************************************************************************
                     3404  ; - Fire off another ADC conversion, channel is pointed to by "adsel"
                     3405  ;***********************************************************************************************
                     3406  
                     3407  FIRE_ADC:
 8AFA [03] B66E      3408       lda     adsel          ; Load accumulator with ADC Selector Variable
 8AFC [02] AA40      3409       ora     #%01000000     ; Inclusive "or" with %01000000 and ADC Selector
                     3410                              ; Variable ( result in accumulator )
                     3411                              ;(Enables interupt with channel selected)
 8AFE [03] B73C      3412       sta     adscr          ; Copy result to ADC Status and Control Register
                     3413  
                     3414  ;***********************************************************************************************
                     3415  ; - Increment millisecond counter
                     3416  ;***********************************************************************************************
                     3417  
                     3418  INC_mS:
 8B00 [03] 3F7C      3419       clr     uSx100              ; Clear 100 Microsecond counter
 8B02 [04] 3C7B      3420       inc     mS                  ; Increment Millisecond counter
 8B04 [03] B67B      3421       lda     mS                  ; Load accumulator with value in Millisecond counter
 8B06 [02] A164      3422       cmp     #$64                ; Compare it with decimal 100
 8B08 [03] 270A      3423       beq     DO_100MS            ; IF Z bit of CCR is set, branch to DO_100MS: (mS=100)
 8B0A [02] A1C8      3424       cmp     #$C8                ; Compare it with decimal 200
 8B0C [03] 2706      3425       beq     DO_100MS            ; IF Z bit of CCR is set, branch to DO_100MS: (mS=200)
 8B0E [02] A1FA      3426       cmp     #$FA                ; Compare it with decimal 250
 8B10 [03] 271A      3427       beq     DO_250MS            ; IF Z bit of CCR is set, branch to DO_250MS: (mS=250)
 8B12 [03] 2050      3428       bra     TIM2CH0_ISR_JMP     ; Branch to TIM2CH0_ISR_JMP:
                     3429  
                     3430  ;===============================================================================================
                     3431  ;*********************************** 100 Millisecond section ***********************************
                     3432  ;===============================================================================================
                     3433  
                     3434  DO_100MS:
                     3435  
                     3436  ;**********************************************************************************************
                     3437  ; If we are in ASE mode, and 100 ms counter has been selected, Increment after-start
                     3438  ; enrichment counter
                     3439  ;**********************************************************************************************
                     3440  
 8B14 [05] 05630B    3441       brclr   startw,engine,NO_100MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     3442                                              ; branch to NO_100MS_COUNT:
 8B17 [04] C6E437    3443       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8B1A [02] A101      3444       cmp     #$1               ; Compare it with decimal 1
 8B1C [03] 2702      3445       beq     DO_100MS_COUNT    ; IF Z bit of CCR is set, branch to DO_100MS_COUNT: (ASEtype = 1)
 8B1E [03] 2002      3446       bra     NO_100MS_COUNT    ; Branch to NO_100MS_COUNT: (ASEtype not = 1)
                     3447  
                     3448  DO_100MS_COUNT:
                     3449  
 8B20 [04] 3C7F      3450       inc    asecount           ; Increment the ASE counter
                     3451  
                     3452  NO_100MS_COUNT:
                     3453  
                     3454  ;***********************************************************************************************
                     3455  ; - Increment "tpsaclk" counter for TPS DOT calculations
                     3456  ;***********************************************************************************************
                     3457  
 8B22 [04] 3C7E      3458       inc     tpsaclk     ; Increment "tpsaclk" counter
                     3459  
                     3460  ;***********************************************************************************************
                     3461  ; - Save current TPS reading in last_tps variable to compute TPSDOT in
                     3462  ;   acceleration enrichment section


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 28
MC68HC908GP32 User Bootloader


                     3463  ;***********************************************************************************************
                     3464  
 8B24 [03] B644      3465       lda     tps                 ; Load accumulator with value in TPS ADC
 8B26 [03] B780      3466       sta     last_tps            ; Copy to last TPS variable
 8B28 [04] 186B      3467       bset    clock100,inputs     ; Set "clock100" bit of "inputs" variable
 8B2A [03] 2075      3468       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     3469  
                     3470  
                     3471  ;===============================================================================================
                     3472  ;********************************* 250 Millisecond section *************************************
                     3473  ;===============================================================================================
                     3474  
                     3475  DO_250MS:
 8B2C [04] 1A6B      3476       bset    clock250,inputs     ; Set "clock250" bit of "inputs" variable
                     3477  
                     3478  ;**********************************************************************************************
                     3479  ; If we are in ASE mode, and 250 ms counter has been selected, Increment after-start
                     3480  ; enrichment counter
                     3481  ;**********************************************************************************************
                     3482  
 8B2E [05] 05630B    3483       brclr   startw,engine,NO_250MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     3484                                              ; branch to NO_250MS_COUNT:
 8B31 [04] C6E437    3485       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8B34 [02] A102      3486       cmp     #$2               ; Compare it with decimal 2
 8B36 [03] 2702      3487       beq     DO_250MS_COUNT    ; IF Z bit of CCR is set, branch to DO_250MS_COUNT: (ASEtype = 2)
 8B38 [03] 2002      3488       bra     NO_250MS_COUNT    ; Branch to NO_250MS_COUNT: (ASEtype not = 2)
                     3489  
                     3490  DO_250MS_COUNT:
                     3491  
 8B3A [04] 3C7F      3492       inc    asecount           ; Increment the ase counter
                     3493  
                     3494  NO_250MS_COUNT:
                     3495  
                     3496  ;***********************************************************************************************
                     3497  ; - Increment 250 Millisecond counter and check to see if it's time to do the "500mS" section
                     3498  ;***********************************************************************************************
                     3499  
 8B3C [03] 3F7B      3500       clr     mS                  ; Clear Millisecond counter
 8B3E [04] 3C79      3501       inc     mSx250              ; Increment 250 Millisecond counter
 8B40 [03] B679      3502       lda     mSx250              ; Load accumulator with value in 250 Millisecond counter
 8B42 [02] A102      3503       cmp     #$02                ; Compare with decimal 2
 8B44 [03] 2706      3504       beq     DO_500MS            ; If the Z bit of CCR is set, branch to DO_500MS:
 8B46 [02] A104      3505       cmp     #$04                ; Compare with decimal 4
 8B48 [03] 2702      3506       beq     DO_500MS            ; If the Z bit of CCR is set,branch to DO_500MS:
 8B4A [03] 2055      3507       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     3508  
                     3509  ;==============================================================================================
                     3510  ;********************************* 500 Millisecond section ************************************
                     3511  ;==============================================================================================
                     3512  
                     3513  DO_500MS:
 8B4C [04] 1C6B      3514       bset    clock500,inputs     ; Set "clock500" bit of "inputs" variable
                     3515  
                     3516  ;**********************************************************************************************
                     3517  ; If we are in ASE mode, and 500 ms counter has been selected, Increment after-start
                     3518  ; enrichment counter
                     3519  ;**********************************************************************************************
                     3520  
 8B4E [05] 05630B    3521       brclr   startw,engine,NO_500MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     3522                                              ; branch to NO_500MS_COUNT:
 8B51 [04] C6E437    3523       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8B54 [02] A103      3524       cmp     #$3               ; Compare it with decimal 3
 8B56 [03] 2702      3525       beq     DO_500MS_COUNT    ; IF Z bit of CCR is set, branch to DO_500MS_COUNT: (ASEtype = 3)
 8B58 [03] 2002      3526       bra     NO_500MS_COUNT    ; Branch to NO_500MS_COUNT: (ASEtype not = 3)
                     3527  
                     3528  DO_500MS_COUNT:
                     3529  
 8B5A [04] 3C7F      3530       inc    asecount           ; Increment the ASE counter
                     3531  
                     3532  NO_500MS_COUNT:
                     3533  
                     3534  ;***********************************************************************************************
                     3535  ; - Check to see if it's time to do the "Seconds" section
                     3536  ;***********************************************************************************************
                     3537  
 8B5C [03] B679      3538       lda     mSx250              ; Load accumulator with value in 250 Millisecond counter
 8B5E [02] A104      3539       cmp     #$04                ; Compare with decimal 4
 8B60 [03] 2704      3540       beq     DO_SEC              ; If the Z bit of CCR is set,  branch to DO_SEC:
 8B62 [03] 203D      3541       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     3542  
                     3543  ;***********************************************************************************************
                     3544  ; - Long branch for TIM2CH0_ISR_DONE:
                     3545  ;***********************************************************************************************
                     3546  
                     3547  TIM2CH0_ISR_JMP:
 8B64 [03] 203B      3548       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     3549  
                     3550  ;===============================================================================================
                     3551  ;************************************* Seconds section *****************************************
                     3552  ;===============================================================================================
                     3553  
                     3554  DO_SEC:
                     3555  
                     3556  ;**********************************************************************************************
                     3557  ; If we are in ASE mode, and Seconds counter has been selected, Increment after-start
                     3558  ; enrichment counter
                     3559  ;**********************************************************************************************
                     3560  
 8B66 [05] 05630B    3561       brclr   startw,engine,NO_SEC_COUNT   ; If "startw" bit of "engine" variable is clear,
                     3562                                              ; branch to NO_SEC_COUNT:
 8B69 [04] C6E437    3563       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8B6C [02] A104      3564       cmp     #$4               ; Compare it with decimal 4
 8B6E [03] 2702      3565       beq     DO_SEC_COUNT      ; IF Z bit of CCR is set, branch to DO_SEC_COUNT: (ASEtype = 4)
 8B70 [03] 2002      3566       bra     NO_SEC_COUNT      ; Branch to NO_SEC_COUNT: (ASEtype not = 4)
                     3567  
                     3568  DO_SEC_COUNT:
                     3569  
 8B72 [04] 3C7F      3570       inc    asecount           ; Increment the ASE counter
                     3571  
                     3572  NO_SEC_COUNT:
                     3573  
                     3574  ;***********************************************************************************************
                     3575  ; - Save the current fuel delivery lo res total as "fdSecH:fdSecL" so it can be used by TS
                     3576  ;   and MV in fuel burn calculations
                     3577  ;***********************************************************************************************
                     3578  
 8B74 [03] B6CC      3579       lda     fdtL       ; Load accumulator with value in "fdtL"
 8B76 [03] B757      3580       sta     fdSecL     ; Copy to "fdSecL"
 8B78 [03] B6CB      3581       lda     fdtH       ; Load accumulator with value in "fdtH"
 8B7A [03] B756      3582       sta     fdSecH     ; Copy to "fdSecH"
 8B7C [03] 3FCC      3583       clr     fdtL       ; Clear "fdtL"
 8B7E [03] 3FCB      3584       clr     fdtH       ; Clear "fdtH"
                     3585  
                     3586  ;***********************************************************************************************
                     3587  ; - Update the Odometer counts over the last second variable
                     3588  ;***********************************************************************************************
                     3589  
 8B80 [03] B6CF      3590       lda     odo         ; Load accumulator with value in Odometer pulse counter variable
 8B82 [03] B75D      3591       sta     odoSec      ; Copy result to Odometer counts over last second variable
 8B84 [03] 3FCF      3592       clr     odo         ; Clear Odometer pulse counter variable
                     3593  
                     3594  ;***********************************************************************************************
                     3595  ; - Crank Mode Inhibit. Make a 1 to 2 second delay after engine starts. Then inhibit crank
                     3596  ;    mode unless engine completely stalls. This is to prohibit re-entry to crank mode under
                     3597  ;    abnormally low idle RPMs
                     3598  ;    * If running and !cranking and !cant_delay, then set cant_delay


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 29
MC68HC908GP32 User Bootloader


                     3599  ;    * If running and !cranking and cant_delay, then set cant_crank
                     3600  ;    * Else clear cant_delay
                     3601  ;***********************************************************************************************
                     3602  
 8B86 [05] 02630E    3603       brset   crank,engine,CANT_OFF        ; If "crank" bit of "engine" is set, branch to
                     3604                                            ; CANT_OFF
 8B89 [05] 01630B    3605       brclr   running,engine,CANT_OFF      ; If "running" bit of "engine" variable is clear,
                     3606                                            ; branch to CANT_OFF:
 8B8C [05] 0A6904    3607       brset   cant_delay,engine2,CANT_SET  ; If "cant_delay" bit of "engine2" is set, branch to
                     3608                                            ; CANT_SET:
 8B8F [04] 1A69      3609       bset    cant_delay,engine2           ; Set "cant_off" bit of "engine2"(set timer bit)
 8B91 [03] 2006      3610       bra     INC_SEC                      ; Branch to INC_SEC:
                     3611  
                     3612  CANT_SET:
 8B93 [04] 1869      3613       bset    cant_crank,engine2     ; Set "cant_crank" bit of "engine2"(inhibit crank mode)
 8B95 [03] 2002      3614       bra     INC_SEC                ; Branch to INC_SEC:
                     3615  
                     3616  CANT_OFF:
 8B97 [04] 1B69      3617       bclr    cant_delay,engine2     ; Clear "cant_delay" bit of "engine2"(clear timer bit)
                     3618  
                     3619  ;***********************************************************************************************
                     3620  ; - Increment Seconds counter
                     3621  ;***********************************************************************************************
                     3622  
                     3623  INC_SEC:
 8B99 [03] 3F79      3624       clr     mSx250              ; Clear 0.25 Second variable
 8B9B [04] 3C40      3625       inc     secl                ; Increment "Seconds" Lo byte variable
 8B9D [03] 2602      3626       bne     TIM2CH0_ISR_DONE    ; If the Z bit of CCR is clear, branch to TIM2CH0_ISR_DONE:
 8B9F [04] 3C7D      3627       inc     sech                ; Increment "Seconds" Hi byte variable
                     3628  
                     3629  TIM2CH0_ISR_DONE:
 8BA1 [02] 8A        3630       pulh                        ; Pull value from stack to index register Hi byte
 8BA2 [07] 80        3631       rti                         ; Return from interrupt
                     3632  
                     3633  ;***********************************************************************************************
                     3634  ;
                     3635  ; --------------------------- T2SC1 Interrupt (SPOUT Control) ----------------------------------
                     3636  ;
                     3637  ;***********************************************************************************************
                     3638  
                     3639  ;***********************************************************************************************
                     3640  ;
                     3641  ; - TIM2 CH1 interrupts twice per ignition event. The first is SPOUT rising
                     3642  ;   edge. This is the delay from PIP rising edge to SPOUT rising edge, which
                     3643  ;   signals the TFI module to fire the coil. TIM2 CH1 was armed and set with
                     3644  ;   the delay,(O/C value) in the main loop after the preceding ignition
                     3645  ;   sequence was finished.
                     3646  ;   In this first interrupt, the SPOUT signal is driven Hi, and the interrupt
                     3647  ;   flag is cleared. The TIM2 counter value is read to get a new timestamp
                     3648  ;   to calculate the new O/C value for the next interrupt which will be to
                     3649  ;   generate the SPOUT falling edge.
                     3650  ;   When the second interrupt is received, the SPOUT signal is driven Lo,
                     3651  ;   the interrupt flag is cleared, and the O/C interrupts are disabled.
                     3652  ;   This prepares TIM2 CH1 to be armed and set with the new O/C value for
                     3653  ;   rising SPOUT, which has already been calculated in the main loop.
                     3654  ;
                     3655  ;***********************************************************************************************
                     3656  
                     3657  TIM2CH1_ISR:
 8BA3 [02] 8B        3658       pshh                                 ; Push value in index register hi byte to stack
 8BA4 [05] 05690C    3659       brclr   sparking,engine2,SET_LO_OC   ; If "sparking" bit of "engine2"
                     3660                                            ; variable is clear, branch to SET_LO_OC:
 8BA7 [03] B633      3661       lda     T2SC1                        ; Load accumulator with value in
                     3662                                            ; TIM2 CH1 Status and Control Register
                     3663                                            ;(Arm CHxF flag clear)
 8BA9 [04] 1F33      3664       bclr    CHxF,T2SC1                   ; Clear CHxF bit of TIM2 CH1 Status and
                     3665                                            ; Control Register (clear interrupt flag)
 8BAB [04] 1D33      3666       bclr    CHxIE,T2SC1                  ; Disable interrupt requests TIM2 channel 1
                     3667                                            ; Status and Control Register
 8BAD [04] 1200      3668       bset    spark,PORTA                  ; Set "spark" bit of Port A
                     3669                                            ;(SPOUT falling edge)(Idle LED on)
 8BAF [04] 1569      3670       bclr    sparking,engine2             ; Clear "sparking" bit of "engine2" variable
 8BB1 [03] 2024      3671       bra     IGN_SEQ_DONE                 ; Branch to IGN_SEQ_DONE:
                     3672  
                     3673  SET_LO_OC:
                     3674  
                     3675  ;***********************************************************************************************
                     3676  ; - Get 1.0uS Timestamp for SPOUT "0ff" O/C calculations
                     3677  ;   T2CNTH:T2CNTL = SPOUT_tsH:SPOUT_tsL
                     3678  ;***********************************************************************************************
                     3679  
 8BB3 [03] B62D      3680       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte
                     3681                           ;(Unlatch any previous reads)
 8BB5 [03] BE2C      3682       ldx     T2CNTH      ; Load index register Lo byte with value in TIM2 Counter Register Hi
 8BB7 [03] BFB6      3683       stx     SPOUT_tsH   ; Copy to SPOUT Timestamp Hi byte variable
 8BB9 [03] B62D      3684       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte
 8BBB [03] B7B7      3685       sta     SPOUT_tsL   ; Copy to SPOUT Timestamp Lo byte variable
                     3686  
                     3687  ;***********************************************************************************************
                     3688  ; - Calculate the output compare value for delay from SPOUT rising edge to
                     3689  ;   SPOUT falling edge.
                     3690  ;   SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL = CH1_offH:CH1_offL
                     3691  ;***********************************************************************************************
                     3692  
                     3693  CALC_OFF_OC:
 8BBD [03] B6B7      3694       lda     SPOUT_tsL      ; Load accumulator with value in "SPOUT_tsL"
 8BBF [03] BBBB      3695       add     SPOUTon_pL     ; Add without Carry A<-(A)+(M)
                     3696                              ;(SPOUT_tsL + SPOUTon_pL)
 8BC1 [01] 97        3697       tax                    ; Transfer result in accumulator to index
                     3698                              ; register Lo byte
 8BC2 [03] B6B6      3699       lda     SPOUT_tsH      ; Load accumulator with value in "PIP_tsH"
 8BC4 [03] B9BA      3700       adc     SPOUTon_pH     ; Add with Carry A<-(A)+(M)
 8BC6 [03] B7BC      3701       sta     CH1_offH       ; Copy to CH1 off O/C value Hi byte
 8BC8 [03] BFBD      3702       stx     CH1_offL       ; Copy to CH1 off O/C value Lo byte
                     3703  
                     3704  ;***********************************************************************************************
                     3705  ; - Set and arm TIM2 Chan 1 output compare value to drive SPOUT Lo
                     3706  ;   CH1_offH:CH1_offL = T2CH1H:T2CH1L
                     3707  ;***********************************************************************************************
                     3708  
                     3709  OFF_DELAY:
 8BCA [03] B633      3710       lda     T2SC1          ; Load accumulator with value in TIM2 CH1 Status and Control Reg
                     3711                              ;(Arm CHxF flag clear)
 8BCC [04] 1F33      3712       bclr    CHxF,T2SC1     ; Clear CHxF bit of TIM2 CH1 Status and Control Register
                     3713                              ;(clear interrupt flag)
 8BCE [01] 8C        3714       clrh                   ; Clear index register Hi byte
 8BCF [04] 55BC      3715       ldhx    CH1_offH       ; Load index register with value in CH1 off O/C value H:L
 8BD1 [04] 3534      3716       sthx    T2CH1H         ; Copy to TIM2 CH1 register H:L
                     3717                              ;(output compare value for SPOUT rising edge)
                     3718  
                     3719  ;***********************************************************************************************
                     3720  ; - Drive SPOUT Hi to command TFI module to fire coil.
                     3721  ;***********************************************************************************************
                     3722  
 8BD3 [04] 1300      3723       bclr    spark,PORTA        ; Clear "spark" bit of Port A (SPOUT rising edge)(idle LED off)
 8BD5 [04] 1469      3724       bset    sparking,engine2   ; Set "sparking" bit of "engine2" variable
                     3725  
                     3726  
                     3727  IGN_SEQ_DONE:
 8BD7 [02] 8A        3728       pulh                       ; Pull value from stack to index register Hi byte
 8BD8 [07] 80        3729       rti                        ; Return from interrupt routine
                     3730  
                     3731  
                     3732  
                     3733  ;***********************************************************************************************
                     3734  ;


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 30
MC68HC908GP32 User Bootloader


                     3735  ; -------------------- Serial Communications Interface ----------------------
                     3736  ;
                     3737  ; Communications is established when the PC communications program sends
                     3738  ; a command character - the particular character sets the mode:
                     3739  ;
                     3740  ; "A" = send all of the realtime variables via txport.(Output Channel Get Command)
                     3741  ; "V" = send the VE table and constants via txport (128 bytes)(Page Read Command)
                     3742  ; "W"+<offset>+<newbyte> = receive new VE or constant byte value and store in offset location
                     3743  ;                          (Page value(byte)write command)
                     3744  ; "X"+<offset>+<count>+<newbyte>+<newbyte>... = receive series of new data bytes(chunk write)
                     3745  ; "B" = jump to flash burner routine and burn VE/constant values in RAM into flash
                     3746  ; "C" = Test communications - echo back SECL
                     3747  ; "Q" = Send over Embedded Code Revision Number (irrelevant in Extra, send zero)
                     3748  ; "S" = Signature - update every time there is a change in data format
                     3749  ; "T" = full code revision in text. 32 bytes
                     3750  ; "P"+<page> = Load page of data from Flash to RAM(page select(activate))
                     3751  ;
                     3752  ; txmode:
                     3753  ;              01 = Getting realtime data
                     3754  ;              02 = ?
                     3755  ;              03 = Sending VE
                     3756  ;              04 = Sending Signature
                     3757  ;              05 = Getting offset VE
                     3758  ;              06 = Getting data VE
                     3759  ;              07 = Getting offset chunk write
                     3760  ;              08 = Getting count  chunk write
                     3761  ;              09 = Getting data   chunk write
                     3762  ;              0C = getting table number
                     3763  ;              0E = format string
                     3764  ;
                     3765  ; NOTE!!! txgoal = number of bytes to send + 1
                     3766  ;
                     3767  ;***********************************************************************************************
                     3768  
                     3769  SCIRCV_ISR:
 8BD9 [02] 8B        3770       pshh                 ; Push value in index register Hi byte to Stack
 8BDA [03] B616      3771       lda     SCS1         ; Load accumulator with value in "SCS1"
                     3772                            ;(Clear the SCRF bit by reading this register)
 8BDC [03] B686      3773       lda     txmode       ; Load accumulator with value in "txmode" variable
                     3774                            ;(Check if we are in the middle of a receive new VE/constant)
 8BDE [02] A105      3775       cmp     #$05         ; Compare with decimal 5
 8BE0 [03] 2719      3776       beq     TXMODE_5     ; If the Z bit of CCR is set, branch to TXMODE_5:
 8BE2 [02] A106      3777       cmp     #$06         ; Compare with decimal 6
 8BE4 [03] 271D      3778       beq     TXMODE_6     ; If the Z bit of CCR is set, branch to TXMODE_6:
 8BE6 [02] A107      3779       cmp     #$07         ; Compare with decimal 7
 8BE8 [03] 2725      3780       beq     TXMODE_7     ; If the Z bit of CCR is set, branch to TXMODE_7:
 8BEA [02] A108      3781       cmp     #$08         ; Compare with decimal 8
 8BEC [03] 2729      3782       beq     TXMODE_8     ; If the Z bit of CCR is set, branch to TXMODE_8:
 8BEE [02] A109      3783       cmp     #$09         ; Compare with decimal 8
 8BF0 [03] 272D      3784       beq     TXMODE_9     ; If the Z bit of CCR is set, branch to TXMODE_8:
 8BF2 [02] A10C      3785       cmp     #$0C         ; Compare with decimal 12
 8BF4 [03] 2702      3786       beq     TXMODE_C1    ; If the Z bit of CCR is set, branch to TXMODE_C1:
 8BF6 [03] 2039      3787       bra     CHECK_TXCMD  ; Branch to CHECK_TXCMD:
                     3788  
                     3789  TXMODE_C1:
 8BF8 [03] CC8D12    3790       jmp     TXMODE_C     ; Jump to "TXMODE_C"
                     3791  
                     3792  TXMODE_5:
 8BFB [05] 4E1887    3793       mov     SCDR,rxoffset   ; Move value in "SCDR" to "rxoffset"
 8BFE [04] 3C86      3794       inc     txmode          ; Increment ""txmode"(continue to next mode)
 8C00 [03] CC8CC5    3795       jmp     DONE_RCV        ; Jump to DONE_RCV:
                     3796  
                     3797  TXMODE_6:
 8C03 [01] 8C        3798       clrh                 ; Clear index register Hi byte
 8C04 [03] B618      3799       lda     SCDR         ; Load accumulator with value in "SCDR"
 8C06 [03] BE87      3800       ldx     rxoffset     ; Load index register Lo byte with value in "rxoffset"
 8C08 [03] E7E0      3801       sta     VE_r,x       ; Copy to VE table, offset in index register Lo byte
 8C0A [03] 3F86      3802       clr     txmode       ; Clear "txmode" variable
 8C0C [03] CC8CC5    3803       jmp     DONE_RCV     ; Jump to DONE_RCV:
                     3804  
                     3805  TXMODE_7:
 8C0F [05] 4E1887    3806       mov     SCDR,rxoffset   ; Move value in "SCDR" to "rxoffset"
 8C12 [04] 3C86      3807       inc     txmode          ; (continue to next mode)
 8C14 [03] CC8CC5    3808       jmp     DONE_RCV        ; Jump to DONE_RCV:
                     3809  
                     3810  TXMODE_8:
 8C17 [05] 4E1885    3811       mov     SCDR,txgoal   ; Move value in "SCDR" to "txgoal"
 8C1A [04] 3C86      3812       inc     txmode        ; (continue to next mode)
 8C1C [03] CC8CC5    3813       jmp     DONE_RCV      ; Jump to DONE_RCV:
                     3814  
                     3815  TXMODE_9:
 8C1F [01] 8C        3816       clrh
 8C20 [03] B618      3817       lda     SCDR              ; Load accumulator with value in "SCDR"
                     3818                                 ;(Get the command byte)
 8C22 [03] BE87      3819       ldx     rxoffset          ; Load index register Lo byte with value in "rxoffset"
 8C24 [03] E7E0      3820       sta     VE_r,x            ; Copy to "VE-r" offset in index register Lo byte
 8C26 [04] 3C87      3821       inc     rxoffset          ; Increment "rxoffset"
 8C28 [04] 3A85      3822       dec     txgoal            ; Decrement "txgoal"
 8C2A [03] 2602      3823       bne     TXMODE_9_CONT     ; If Z bit ofCCR is clear, branch to TXMODE_9_CONT:
                     3824                                 ; "txgoal" not complete, keep looping)
 8C2C [03] 3F86      3825       clr     txmode            ; Clear "txmode"
                     3826  
                     3827  TXMODE_9_CONT:
 8C2E [03] CC8CC5    3828       jmp     DONE_RCV          ; Jump to DONE_RCV:(long branch)
                     3829  
                     3830  CHECK_TXCMD:
 8C31 [03] B618      3831       lda     SCDR       ; Load accumulator with value in "SCDR" (Get the command byte)
 8C33 [02] A141      3832       cmp     #$41       ; Compare it with decimal 65 = ASCII "A"
 8C35 [03] 272B      3833       beq     MODE_A     ; If the Z bit of CCR is set, branch to Mode_A:
 8C37 [02] A142      3834       cmp     #$42       ; Compare it with decimal 66 = ASCII "B"
 8C39 [03] 2731      3835       beq     MODE_B     ; If the Z bit of CCR is set, branch to Mode_B:
 8C3B [02] A143      3836       cmp     #$43       ; Compare it with decimal 67 = ASCII "C"
 8C3D [03] 2741      3837       beq     MODE_C     ; If the Z bit of CCR is set, branch to Mode_C:
 8C3F [02] A156      3838       cmp     #$56       ; Compare it with decimal 86 = ASCII "V"
 8C41 [03] 2756      3839       beq     MODE_V     ; If the Z bit of CCR is set, branch to Mode_V:
 8C43 [02] A157      3840       cmp     #$57       ; Compare it with decimal 87 = ASCII "W"
 8C45 [03] 275D      3841       beq     MODE_W     ; If the Z bit of CCR is set, branch to Mode_W:
 8C47 [02] A151      3842       cmp     #$51       ; Compare it with decimal 81 = ASCII "Q"
 8C49 [03] 2744      3843       beq     MODE_Q     ; If the Z bit of CCR is set, branch to Mode_Q:
 8C4B [02] A150      3844       cmp     #$50       ; Compare it with decimal 80 = ASCII "P"
 8C4D [03] 273B      3845       beq     MODE_P     ; If the Z bit of CCR is set, branch to Mode_P:
 8C4F [02] A153      3846       cmp     #$53       ; Compare it with decimal 83 = ASCII "S"
 8C51 [03] 2765      3847       beq     MODE_S     ; If the Z bit of CCR is set, branch to Mode_S:
 8C53 [02] A152      3848       cmp     #$52       ; Compare it with decimal 82 = ASCII "R"
 8C55 [03] 270B      3849       beq     MODE_R     ; If the Z bit of CCR is set, branch to Mode_R:
 8C57 [02] A158      3850       cmp     #$58       ; Compare it with decimal 88 = ASCII "X"
 8C59 [03] 274F      3851       beq     MODE_X     ; If the Z bit of CCR is set, branch to Mode_X:
 8C5B [02] A154      3852       cmp     #$54       ; Compare it with decimal 84 = ASCII "T"
 8C5D [03] 2750      3853       beq     MODE_T     ; If the Z bit of CCR is set, branch to Mode_T:
 8C5F [03] CC8CC5    3854       jmp     DONE_RCV   ; Jump to DONE_RCV:
                     3855  
                     3856  MODE_R:                     ; (will accept either command)
                     3857  MODE_A:
 8C62 [02] A62A      3858       lda     #$2A           ; Load accumulator with decimal 42(41 real time variables for
                     3859                              ; MV and TS)(Set this for the number of bytes to send +1)
 8C64 [03] B785      3860       sta     txgoal         ; Copy to "txgoal" variable
 8C66 [03] 3F84      3861       clr     txcnt          ; Clear "txcnt"
 8C68 [02] A601      3862       lda     #$01           ; Load accumulator with decimal 1
 8C6A [03] 2053      3863       bra     EN_XMIT        ; Branch to EN_XMIT:
                     3864  
                     3865  MODE_B:
 8C6C [03] B6C4      3866       lda     page             ; Load accumulator with value in "page"(determined by TS)
 8C6E [04] 1B14      3867       bclr    SCRIE,SCC2       ; Clear "SCRIE" bit of "SCC2"
 8C70 [04] 6ECCC5    3868       mov     #$CC,flocker     ; Move $CC to "flocker" (permit burner routine)
 8C73 [05] CD8FD8    3869       jsr     burnConst        ; Jump to "burnConst" subroutine
 8C76 [03] 3FC5      3870       clr     flocker          ; Clear "flocker"(prohibit burner routine)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 31
MC68HC908GP32 User Bootloader


 8C78 [03] 3F86      3871       clr     txmode           ; Clear "txmode" variable
 8C7A [03] B6C4      3872       lda     page             ; Load accumulator with value in "page"(determined by TS)
 8C7C [04] 1A14      3873       bset    SCRIE,SCC2       ; Set "SCRIE" bit of "SCC2"
 8C7E [03] 2045      3874       bra     DONE_RCV         ; Branch to DONE_RCV:
                     3875  
                     3876  MODE_C:
 8C80 [03] 3F84      3877       clr     txcnt          ; Clear "txcnt" (Just send back SECL variable to test comm port)
 8C82 [02] A601      3878       lda     #$01           ; Load accumulator with decimal 1
 8C84 [03] B785      3879       sta     txgoal         ; Copy to "txgoal" variable
 8C86 [02] A601      3880       lda     #$01           ; Load accumulator with decimal 1
 8C88 [03] 2035      3881       bra     EN_XMIT        ; Branch to EN_XMIT:
                     3882  
                     3883  MODE_P:
 8C8A [04] 6E0C86    3884       mov     #$0C,txmode    ; Move deciaml 12 to "txmode"
 8C8D [03] 2036      3885       bra     DONE_RCV       ; Branch to DONE_RCV:
                     3886  
                     3887  MODE_Q:
 8C8F [03] 3F84      3888       clr     txcnt          ; Clear "txcnt"(irrelevant)
 8C91 [02] A601      3889       lda     #$01           ; Load accumulator with decimal 1
 8C93 [03] B785      3890       sta     txgoal         ; Copy to "txgoal" variable
 8C95 [02] A605      3891       lda     #$05           ; Load accumulator with decimal 5
 8C97 [03] 2026      3892       bra     EN_XMIT        ; Branch to EN_XMIT:
                     3893  
                     3894  MODE_V:
 8C99 [03] 3F84      3895       clr     txcnt                ; Clear "txcnt"
 8C9B [04] 6EA885    3896       mov     #PAGESIZE,txgoal     ; Move deciaml 168 into "txgoal"
 8C9E [03] B6C4      3897       lda     page                 ; Load accumulator with value in "page"(determined by TS)
 8CA0 [02] A603      3898       lda     #$03                 ; Load accumulator with decimal 3
 8CA2 [03] 201B      3899       bra     EN_XMIT              ; Branch to EN_XMIT:
                     3900  
                     3901  MODE_W:
 8CA4 [02] A605      3902       lda     #$05         ; Load accumulator with decimal 5(constant value)
 8CA6 [03] B786      3903       sta     txmode       ; Copy to "txmode" variable
 8CA8 [03] 201B      3904       bra     DONE_RCV     ; Branch to DONE_RCV:
                     3905  
                     3906  MODE_X:
 8CAA [04] 6E0786    3907       mov     #$07,txmode     ; Move decimal 7 into "txmode"(offset)
 8CAD [03] 2016      3908       bra     DONE_RCV        ; Branch to DONE_RCV:
                     3909  
                     3910  MODE_T:
 8CAF [03] 3F84      3911       clr     txcnt           ; Clear "txcnt"
 8CB1 [04] 6E2085    3912       mov     #$20,txgoal     ; Move decimal 32 into "txgoal"(code revision)
 8CB4 [02] A60E      3913       lda     #$0E            ; Load accumulator with decimal 14
 8CB6 [03] 2007      3914       bra     EN_XMIT         ; Branch to EN_XMIT:
                     3915  
                     3916  MODE_S:
 8CB8 [03] 3F84      3917       clr     txcnt           ; Clear "txcnt"
 8CBA [04] 6E2085    3918       mov     #$20,txgoal     ; Move decimal 32 into "txgoal"(code format)
 8CBD [02] A604      3919       lda     #$04            ; Load accumulator with decimal 4
                     3920  
                     3921  EN_XMIT:
 8CBF [03] B786      3922       sta     txmode         ; Copy to "txmode" variable
 8CC1 [04] 1614      3923       bset    TE,SCC2        ; Set "TE" bit of SCC2(Enable Transmit)
 8CC3 [04] 1E14      3924       bset    SCTIE,SCC2     ; Set "SCTIE" bit of SCC2(Enable transmit interrupt)
                     3925  
                     3926  DONE_RCV:
 8CC5 [02] 8A        3927       pulh                 ; Pull value from Stack to index register Hi byte
 8CC6 [07] 80        3928       rti                  ; Return from interrupt
                     3929  
                     3930  ;***********************************************************************************************
                     3931  ;------------------------------ Transmit Character Interrupt Handler ---------------------------
                     3932  ;***********************************************************************************************
                     3933  
                     3934  SCITX_ISR:
 8CC7 [02] 8B        3935       pshh                       ; Push value in index register Hi byte to Stack
 8CC8 [03] B616      3936       lda     SCS1               ; Load accumulator with value in "SCS1"
                     3937                                  ; (Clear the SCRF bit by reading this register)
 8CCA [01] 8C        3938       clrh                       ; Clear index register Hi byte
 8CCB [03] B684      3939       lda     txcnt              ; Load accumulator with value in "txcnt" variable
 8CCD [01] 97        3940       tax                        ; Transfer value in accumulator to index register Lo byte
 8CCE [03] B686      3941       lda     txmode             ; Load accumulator with value in "txmode" variable
 8CD0 [03] 2761      3942       beq     TX_DONE            ; If 0, branch to TX_DONE:(sanity check)
 8CD2 [02] A105      3943       cmp     #$05               ; Compare it with decimal 5
 8CD4 [03] 2726      3944       beq     IN_Q_MODE          ; If the Z bit of CCR is set, branch to IN_Q_MODE:
 8CD6 [02] A104      3945       cmp     #$04               ; Compare with decimal 4
 8CD8 [03] 271D      3946       beq     IN_S_MODE          ; If equal, branch to IN_S_MODE:
 8CDA [02] A10E      3947       cmp     #$0E               ; Compare with decimal 14
 8CDC [03] 2714      3948       beq     IN_T_MODE          ; If equal, branch to IN_T_MODE:
 8CDE [02] A101      3949       cmp     #$01               ; Compare it with decimal 1
 8CE0 [03] 2706      3950       beq     IN_A_OR_C_MODE     ; If equal, branch to IN_A_OR_C_MODE:
 8CE2 [02] A103      3951       cmp     #$03               ; Compare it with decimal 3
 8CE4 [03] 2706      3952       beq     IN_V_MODE          ; If equal, branch to IN_V_MODE:
 8CE6 [03] 204B      3953       bra     TX_DONE            ; Branch to TX_DONE:
                     3954  
                     3955  
                     3956  IN_A_OR_C_MODE:
 8CE8 [03] E640      3957       lda     secl,X      ; Load accumulator with value in address "secl", offset in index
                     3958                           ; register Lo byte
 8CEA [03] 2013      3959       bra     CONT_TX     ; Branch to CONT_TX:
                     3960  
                     3961  IN_V_MODE
 8CEC [03] B6C4      3962       lda     page          ; Load accumulator with value in "page"(determined by TS)
 8CEE [03] E6E0      3963       lda     VE_r,x        ; Load accumulator with value in address "VE_r", offset in index
                     3964                             ; register Lo byte
 8CF0 [03] 200D      3965       bra     CONT_TX       ; Branch to CONT_TX:
                     3966  
                     3967  IN_T_MODE:
 8CF2 [04] D68F98    3968       lda     textversion_f,x     ; Load accumulator with value in "testversion_f" offset in
                     3969                                   ; index register Lo byte
 8CF5 [03] 2008      3970       bra     CONT_TX             ; Branch to CONT_TX:
                     3971  
                     3972  IN_S_MODE:
 8CF7 [04] D68FB8    3973       lda     Signature,x     ;Load accumulator with value in "signature", offset in index
                     3974                               ; register Lo byte
 8CFA [03] 2003      3975       bra     CONT_TX         ; Branch to CONT_TX:
                     3976  
                     3977  IN_Q_MODE
 8CFC [04] D68F97    3978       lda     REVNUM,X       ; Load accumulator with value in address "REVNUM", offset in
                     3979                              ; index register Lo byte
                     3980  
                     3981  CONT_TX:
 8CFF [03] B718      3982       sta     SCDR           ; Copy to "SCDR" variable (Send char)
 8D01 [03] B684      3983       lda     txcnt          ; Load accumulator with value in "txcnt" variable
 8D03 [01] 4C        3984       inca                   ; Increment value in accumulator (Increase number of chars sent)
 8D04 [03] B784      3985       sta     txcnt          ; Copy to "txcnt" variable
 8D06 [03] B185      3986       cmp     txgoal         ; Compare it to value in "txgoal" (Check if done)
 8D08 [03] 2606      3987       bne     DONE_BYTE      ; If the Z bit of CCR is clear, branch to DONE_BYTE:
                     3988                              ;(Branch if NOT done to DONE_XFER !?!?!)
                     3989  
                     3990  FIN_TX:
 8D0A [03] 3F84      3991       clr     txcnt          ; Clear "txcnt"
 8D0C [03] 3F85      3992       clr     txgoal         ; Clear "txgoal"
 8D0E [03] 3F86      3993       clr     txmode         ; Clear "txmode"
                     3994  
                     3995  DONE_BYTE:
 8D10 [02] 8A        3996       pulh                   ; Pull value from Stack to index register Hi byte
 8D11 [07] 80        3997       rti                    ; Return from interrupt
                     3998  
                     3999  TXMODE_C:
 8D12 [03] B618      4000       lda     SCDR            ; Load accumulator with value in "SCDR"(expect 1 to 3)
 8D14 [03] B1C4      4001       cmp     page            ; Compare with value in "page"(check if already loaded)
 8D16 [03] 2715      4002       beq     DONE_LOAD       ; If equal, branch to DONE_LOAD:
 8D18 [01] 5F        4003       clrx                    ; Clear index register Lo byte
 8D19 [03] B7C4      4004       sta     page            ; Copy to "page"
 8D1B [02] ABDF      4005       add     #$DF            ; Add (A)<-(A)+(M)decimal 223
                     4006                               ;(Hi byte - 1 of next memory location)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 32
MC68HC908GP32 User Bootloader


 8D1D [02] 87        4007       psha                    ; Push value in accumulator to Stack
 8D1E [02] 8A        4008       pulh                    ; Pull value from Stack to index register Hi byte
 8D1F [04] 1B14      4009       bclr     SCRIE,SCC2     ; Clear"SCRIE" bit of"SCC2"
                     4010                               ;(Turn off receive interrrupt so we don't re-enter)
 8D21 [02] 9A        4011       cli                     ; Re-enable interrupts
                     4012  
                     4013  LOAD_TABLE:
 8D22 [02] F6        4014       lda     0,x             ; Load accumulator with 0 , offset in index register Lo byte(H:X)
 8D23 [02] 8B        4015       pshh                    ; Push value in index register Hi byte to Stack
 8D24 [01] 8C        4016       clrh                    ; Clear index register Hi byte
 8D25 [03] E7E0      4017       sta     VE_r,x          ; Copy to "VE-r", offset in index register Lo byt(Dump into RAM)
 8D27 [02] 8A        4018       pulh                    ; Pull valus from STack to index register Hi byte
 8D28 [01] 5C        4019       incx                    ; Increment value in index register Lo byte(increment counter)
 8D29 [02] A3A9      4020       cpx     #PAGESIZE+1     ; Compare value in index rgister Lo byte to "PAGESIZE+1"
 8D2B [03] 26F5      4021       bne     LOAD_TABLE      ; If not equal, branch to LOAD_TABLE:(keep looping)
                     4022  
                     4023  DONE_LOAD:
 8D2D [04] 1A14      4024       bset    SCRIE,SCC2      ; Clear "SCRIE" bit of "SCC2"
 8D2F [03] 3F86      4025       clr     txmode          ; Clear "txmode"
 8D31 [02] 8A        4026       pulh                    ; Pull value from Stack to index register Hi byte
 8D32 [07] 80        4027       rti                     ; Return from interrupt
                     4028  
                     4029  TX_DONE:                     ; (We get here after we've sent the last byte)
 8D33 [04] 1714      4030       bclr     TE,SCC2        ; Clear "TE" bit of "SCC2"
 8D35 [04] 1F14      4031       bclr     SCTIE,SCC2     ; Clear "SCTIE" bit of "SCC2"
 8D37 [02] 8A        4032       pulh                    ; Pull value from Stack to index register Hi byte
 8D38 [07] 80        4033       rti                     ; Return from interrupt
                     4034  
                     4035  
                     4036  ;***********************************************************************************************
                     4037  ;
                     4038  ; ---------------------------- Interrupt for ADC conversion complete ---------------------------
                     4039  ;
                     4040  ; ADC channel is set by "adsel" variable which starts at 0. This reads channel 0, which is
                     4041  ; "map". When the conversion complete interrupt is requested the current value in "map" is
                     4042  ; stored as current "map" value. The "adsel" variable is then incremented to the next channel
                     4043  ; and the process repeats until all channels are read, at which time, "adsel" is cleared to
                     4044  ; start the sequence again.
                     4045  ;
                     4046  ; "ADR" values are averaged with values in memory to reduce "digit rattle" and minimize the
                     4047  ; effects of spikes
                     4048  ;
                     4049  ;***********************************************************************************************
                     4050  
                     4051  ;***********************************************************************************************
                     4052  ;   This new code goes one step further to smooth out "batt" (adsel=4) and "ego" (adsel=5).
                     4053  ;   "adsel" is updated avery 0.001s, so there is a new value for each ADC every 0.008s.
                     4054  ;   Every time either "batt" or "ego" is updated, the value of "ADR" is totalled and it's
                     4055  ;   counter value is incremented. When the counter reaches 32 the total is divided by 32 and the
                     4056  ;   value of "batt" or "ego is updated, which works out to be every ~256ms.
                     4057  ;***********************************************************************************************
                     4058  
                     4059  ADC_ISR:
 8D39 [02] 8B        4060       pshh                 ; Push index register Hi byte on to stack (Do this because processor
                     4061                            ; does not stack H)
 8D3A [01] 8C        4062       clrh                 ; Clear index register Hi byte
                     4063  
                     4064  ;***********************************************************************************************
                     4065  ; - First determine if we are updating "batt" or "ego" and branch accordingly
                     4066  ;***********************************************************************************************
                     4067  
 8D3B [03] B66E      4068       lda     adsel         ; Load accumulator with value in ADC Channel Selector
 8D3D [02] A104      4069       cmp     #$04          ; Compare it to decimal 4
 8D3F [03] 2706      4070       beq     BATT_CNT      ; If Z bit of CCR is set (operands equal) branch to BATT_CNT:
 8D41 [02] A105      4071       cmp     #$05          ; Compare it to decimal 5
 8D43 [03] 2738      4072       beq     EGO_CNT       ; If Z bit of CCR is set (operands equal) branch to EGO_CNT:
 8D45 [03] 2073      4073       bra     NOT_BATT_EGO  ; Branch to NOT_BATT_EGO:
                     4074  
                     4075  BATT_CNT:
 8D47 [03] B63D      4076       lda     ADR          ; Load accumulator with value in ADC Data Register(this also clears
                     4077                            ; conversion complete and interupt enable bit)
 8D49 [03] BBD7      4078       add     battTL       ; Add without Carry A<-(A)+(M) "ADR" + "battTL" (total Lo Byte)
 8D4B [03] B7D7      4079       sta     battTL       ; Copy to "battTL" (update total Lo Byte))
 8D4D [03] B6D6      4080       lda     battTH       ; Load accumulator with value in "battTH" (total Hi Byte)
 8D4F [02] A900      4081       adc     #$0          ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 8D51 [03] B7D6      4082       sta     battTH       ; Copy to "battT" (update total Hi Byte))
 8D53 [04] 3CD8      4083       inc     battcnt      ; Increment "battcnt" variable
                     4084  
                     4085  ;***********************************************************************************************
                     4086  ; - Check the value of "battcnt" to see if it's time to average the values
                     4087  ;***********************************************************************************************
                     4088  
 8D55 [03] B6D8      4089       lda     battcnt      ; Load accumulator with value in "battcnt"
 8D57 [02] A120      4090       cmp     #$20         ; Compare value in "battcnt" to decimal 32
 8D59 [03] 2702      4091       beq     BATT_AV;     ; If Z bit of CCR is set (operands equal) branch to BATT_AV:
 8D5B [03] 2054      4092       bra     AV_DONE      ; Branch to AV_DONE:
                     4093  
                     4094  BATT_AV:
                     4095  ;***********************************************************************************************
                     4096  ; - First divide by 2
                     4097  ;***********************************************************************************************
                     4098  
 8D5D [04] 34D6      4099       lsr     battTH     ; Logical shift right "battTH" (divide by 2 Hi Byte)
 8D5F [04] 36D7      4100       ror     battTL     ; Rotate right throught carry "battTL" (divide by 2 Lo Byte)
                     4101  
                     4102  ;***********************************************************************************************
                     4103  ; - Second divide by 2 (2x2=4 divide)
                     4104  ;***********************************************************************************************
                     4105  
 8D61 [04] 34D6      4106       lsr     battTH     ; Logical shift right "battTH" (divide by 2 Hi Byte)
 8D63 [04] 36D7      4107       ror     battTL     ; Rotate right throught carry "battTL" (divide by 2 Lo Byte)
                     4108  
                     4109  ;***********************************************************************************************
                     4110  ; - Third divide by 2 (2x2x2=8 divide)
                     4111  ;***********************************************************************************************
                     4112  
 8D65 [04] 34D6      4113       lsr     battTH     ; Logical shift right "battTH" (divide by 2 Hi Byte)
 8D67 [04] 36D7      4114       ror     battTL     ; Rotate right throught carry "battTL" (divide by 2 Lo Byte)
                     4115  
                     4116  ;***********************************************************************************************
                     4117  ; - Fourth divide by 2 (2x2x2x2=16 divide)
                     4118  ;***********************************************************************************************
                     4119  
 8D69 [04] 34D6      4120       lsr     battTH     ; Logical shift right "battTH" (divide by 2 Hi Byte)
 8D6B [04] 36D7      4121       ror     battTL     ; Rotate right throught carry "battTL" (divide by 2 Lo Byte)
                     4122  
                     4123  ;***********************************************************************************************
                     4124  ; - Fifth divide by 2 (2x2x2x2x2=32 divide)
                     4125  ;***********************************************************************************************
                     4126  
 8D6D [04] 34D6      4127       lsr     battTH     ; Logical shift right "battTH" (divide by 2 Hi Byte)
 8D6F [04] 36D7      4128       ror     battTL     ; Rotate right throught carry "battTL" (divide by 2 Lo Byte)
 8D71 [03] B6D7      4129       lda     battTL     ; Load accumulator with value in "battTL"
 8D73 [03] B745      4130       sta     batt       ; Copy to "batt"
 8D75 [03] 3FD6      4131       clr     battTH     ; Clear "battTH"
 8D77 [03] 3FD7      4132       clr     battTL     ; Clear "battTL"
 8D79 [03] 3FD8      4133       clr     battcnt    ; Clear "battcnt"
 8D7B [03] 2034      4134       bra     AV_DONE    ; Brancht to AV_DONE:
                     4135  
                     4136  EGO_CNT:
 8D7D [03] B63D      4137       lda     ADR        ; Load accumulator with value in ADC Data Register(this also clears
                     4138                          ; conversion complete and interupt enable bit)
 8D7F [03] BBDA      4139       add     egoTL      ; Add without Carry A<-(A)+(M) "ADR" + "egoTL" (total Lo Byte)
 8D81 [03] B7DA      4140       sta     egoTL      ; Copy to "egoTL" (update total Lo Byte))
 8D83 [03] B6D9      4141       lda     egoTH      ; Load accumulator with value in "egoTH" (total Hi Byte)
 8D85 [02] A900      4142       adc     #$0        ; Add with carry decimal zero A<-(A)+(M)(just the carry)


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 33
MC68HC908GP32 User Bootloader


 8D87 [03] B7D9      4143       sta     egoTH      ; Copy to "egoT" (update total Hi Byte))
 8D89 [04] 3CDB      4144       inc     egocnt     ; Increment "egocnt" variable
                     4145  
                     4146  ;***********************************************************************************************
                     4147  ; - Check the value of "egocnt" to see if it's time to average the values
                     4148  ;***********************************************************************************************
                     4149  
 8D8B [03] B6DB      4150       lda     egocnt      ; Load accumulator with value in "egocnt"
 8D8D [02] A120      4151       cmp     #$20        ; Compare value in "battcnt" to decimal 32
 8D8F [03] 2702      4152       beq     EGO_AV;     ; If Z bit of CCR is set (operands equal) branch to EGO_AV:
 8D91 [03] 201E      4153       bra     AV_DONE     ; Branch to AV_DONE:
                     4154  
                     4155  EGO_AV:
                     4156  ;***********************************************************************************************
                     4157  ; - First divide by 2
                     4158  ;***********************************************************************************************
                     4159  
 8D93 [04] 34D9      4160       lsr     egoTH     ; Logical shift right "egoTH" (divide by 2 Hi Byte)
 8D95 [04] 36DA      4161       ror     egoTL     ; Rotate right throught carry "egoTL" (divide by 2 Lo Byte)
                     4162  
                     4163  ;***********************************************************************************************
                     4164  ; - Second divide by 2 (2x2=4 divide)
                     4165  ;***********************************************************************************************
                     4166  
 8D97 [04] 34D9      4167       lsr     egoTH     ; Logical shift right "egoTH" (divide by 2 Hi Byte)
 8D99 [04] 36DA      4168       ror     egoTL     ; Rotate right throught carry "egoTL" (divide by 2 Lo Byte)
                     4169  
                     4170  ;***********************************************************************************************
                     4171  ; - Third divide by 2 (2x2x2=8 divide)
                     4172  ;***********************************************************************************************
                     4173  
 8D9B [04] 34D9      4174       lsr     egoTH     ; Logical shift right "egoTH" (divide by 2 Hi Byte)
 8D9D [04] 36DA      4175       ror     egoTL     ; Rotate right throught carry "egoTL" (divide by 2 Lo Byte)
                     4176  
                     4177  ;***********************************************************************************************
                     4178  ; - Fourth divide by 2 (2x2x2x2=16 divide)
                     4179  ;***********************************************************************************************
                     4180  
 8D9F [04] 34D9      4181       lsr     egoTH     ; Logical shift right "egoTH" (divide by 2 Hi Byte)
 8DA1 [04] 36DA      4182       ror     egoTL     ; Rotate right throught carry "egoTL" (divide by 2 Lo Byte)
                     4183  
                     4184  ;***********************************************************************************************
                     4185  ; - Fifth divide by 2 (2x2x2x2x2=32 divide)
                     4186  ;***********************************************************************************************
                     4187  
 8DA3 [04] 34D9      4188       lsr     egoTH     ; Logical shift right "egoTH" (divide by 2 Hi Byte)
 8DA5 [04] 36DA      4189       ror     egoTL     ; Rotate right throught carry "egoTL" (divide by 2 Lo Byte)
 8DA7 [03] B6DA      4190       lda     egoTL     ; Load accumulator with value in "egoTL"
 8DA9 [03] B746      4191       sta     ego       ; Copy to "ego"
 8DAB [03] 3FD9      4192       clr     egoTH     ; Clear "egoTH"
 8DAD [03] 3FDA      4193       clr     egoTL     ; Clear "egoTL"
 8DAF [03] 3FDB      4194       clr     egocnt    ; Clear "egocnt"
                     4195  
                     4196  AV_DONE:
 8DB1 [03] B66E      4197       lda     adsel        ; Load accumulator with value in ADC Channel Selector
 8DB3 [01] 4C        4198       inca                 ; Increment ADC Channel Selector Variable
 8DB4 [03] B76E      4199       sta     adsel        ; Copy new value to ADC Channel Selector Variable
 8DB6 [02] 8A        4200       pulh                 ; Pull value from stack to index register Hi byte
 8DB7 [04] 126B      4201       bset    adcc,inputs  ; Set "adcc"bit of "inputs" variable
 8DB9 [07] 80        4202       rti                  ; Return from interrupt
                     4203  
                     4204  NOT_BATT_EGO:
 8DBA [03] B66E      4205       lda     adsel        ; Load accumulator with value in ADC Channel Selector
 8DBC [01] 97        4206       tax                  ; Transfer value in accumulator to index register Lo
 8DBD [03] E641      4207       lda     map,x        ; Load accumulator with value in "map,x"
 8DBF [03] B63D      4208       lda     ADR          ; Load accumulator with value in ADC Data Register(this also clears
                     4209                            ; conversion complete and interupt enable bit)
 8DC1 [03] EB41      4210       add     map,x        ; Add without Carry A<-(A)+(M)
 8DC3 [01] 46        4211       rora                 ; Rotate right accumulator (divide by two)
 8DC4 [03] E741      4212       sta     map,x        ; Copy result to address map,x
 8DC6 [03] B66E      4213       lda     adsel        ; Load accumulator with value in ADC Channel Selector
 8DC8 [01] 4C        4214       inca                 ; Increment ADC Channel Selector Variable
 8DC9 [02] A407      4215       and     #$07         ; "Logical and" accumulator with %0000111(this clears adsel when
                     4216                            ; incremented to decimal 8)
 8DCB [03] B76E      4217       sta     adsel        ; Copy new value to ADC Channel Selector Variable
 8DCD [02] 8A        4218       pulh                 ; Pull value from stack to index register Hi byte
 8DCE [04] 126B      4219       bset    adcc,inputs  ; Set "adcc"bit of "inputs" variable
 8DD0 [07] 80        4220       rti                  ; Return from interrupt
                     4221  
                     4222  
                     4223  ;***********************************************************************************************
                     4224  ; -------------- Keyboard interrupt (vehicle speed on PortA3, Ign Mon on PortA4) ---------------
                     4225  ;
                     4226  ; The Keyboard interrupts are set up as edge sensetive only. A falling edge on a Keyboard pin
                     4227  ; does not latch an interrupt request if another keyboard pin is already low. To prevent losing
                     4228  ; an interrupt request in this situation, The Keyboard interrupts are disabled, and
                     4229  ; acknowledged. The pin requesting the interrupt is identified and disabled, then the keyboard
                     4230  ; interrupts are re enabled. In the main loop, the Port is polled to see when the pin returns
                     4231  ; high and re enabled as a keyboard interrupt pin at that time.
                     4232  ;***********************************************************************************************
                     4233  
                     4234  KYBD_ISR:
 8DD1 [04] 141A      4235       bset    ACKK,INTKBSCR       ; Set the Keyboard Acknowledge bit of Keyboard Status and
                     4236                                   ; Control Register (clear interrupt)
                     4237  
                     4238  ;***********************************************************************************************
                     4239  ; - Determine which pins are enabled and identify the source of the interrupt
                     4240  ;***********************************************************************************************
                     4241  
 8DD3 [05] 066B05    4242       brset   VSen,inputs,CHK_SPD_LO    ; If "VSen" bit of "inputs" variable is set, branch to
                     4243                                         ; CHK_SPD_LO:
                     4244  
                     4245  CHK_MON_EN:
 8DD6 [05] 046B1F    4246       brset   MONen,inputs,CHK_MON_LO   ; If "MONen" bit of "inputs" variable is set, branch to
                     4247                                         ; CHK_MON_LO:
 8DD9 [03] 2039      4248       bra     KEYBD_DONE                ; Branch to KEYBD_DONE:
                     4249  
                     4250  ;***********************************************************************************************
                     4251  ; - Check if Vehicle Speed caused the interrupt
                     4252  ;***********************************************************************************************
                     4253  
                     4254  CHK_SPD_LO:
 8DDB [04] 1704      4255       bclr     Veh_Spd,DDRA             ; Clear "Veh_Spd" bit of Port A Data Direction Register
                     4256                                         ;(Make sure PTA3 is configured as an input so it can
                     4257                                         ; be read)
 8DDD [05] 0600F6    4258       brset   Veh_Spd,porta,CHK_MON_EN  ; If "Veh_Spd" bit of Port A is set, branch to
                     4259                                         ; CHK_MON_EN:(pin is Hi, check Ign Mon)
                     4260  
                     4261  
                     4262  ;***********************************************************************************************
                     4263  ; - Increment the odometer counter
                     4264  ;***********************************************************************************************
                     4265  
 8DE0 [04] 3CCF      4266       inc     odo     ; Increment "odo"
 8DE2 [03] B6CF      4267       lda     odo     ; Load accumulator with new value in "odo"
 8DE4 [03] B7CF      4268       sta     odo     ; Copy new value to "odo"
                     4269  
                     4270  ;***********************************************************************************************
                     4271  ; - Determine Vehicle Speed Period
                     4272  ;***********************************************************************************************
                     4273  
 8DE6 [04] 171B      4274       bclr    Veh_Spd,INTKBIER   ; Clear "Veh_Spd" bit Keyboard Interrupt Enable Register
                     4275                                  ;(disable keyboard interrupt for vehicle speed while pin is low)
 8DE8 [04] 176B      4276       bclr    VSen,inputs        ; Clear "VSen" bit of "inputs" variable
 8DEA [03] B6CD      4277       lda     VSch               ; Load accumulator value in VS counter Hi byte
 8DEC [03] B75E      4278       sta     VS_pH              ; Copy to VS period Hi byte


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 34
MC68HC908GP32 User Bootloader


 8DEE [03] B6CE      4279       lda     VScl               ; Load accumulator with value in VS counter Lo byte
 8DF0 [03] B75F      4280       sta     VS_pL              ; Copy to VS period Lo byte
 8DF2 [03] 3FCD      4281       clr     VSch               ; Clear VS counter Hi byte
 8DF4 [03] 3FCE      4282       clr     VScl               ; Clear VS counter Lo byte
 8DF6 [03] 20DE      4283       bra     CHK_MON_EN         ; Branch to CHK_MON_EN:
                     4284  
                     4285  ;***********************************************************************************************
                     4286  ; - Check if Ignition Monitor caused the interrupt
                     4287  ;***********************************************************************************************
                     4288  
                     4289  CHK_MON_LO:
 8DF8 [04] 1904      4290       bclr     Ign_Mon,DDRA             ; Clear "Ign_Mon" bit of Port A Data Direction Register
                     4291                                         ;(Make sure PTA4 is configured as an input so it can
                     4292                                         ; be read)
 8DFA [05] 080017    4293       brset   Ign_Mon,porta,KEYBD_DONE  ; If "Ign Mon" bit of Port A is set, branch to
                     4294                                         ; KEYBD_DONE:
                     4295  
                     4296  
                     4297  ;***********************************************************************************************
                     4298  ; - Calculate actual Ignition Timing Period
                     4299  ;***********************************************************************************************
                     4300  
                     4301  DO_MON:
 8DFD [04] 191B      4302       bclr    Ign_Mon,INTKBIER   ; Clear "Ign_Mon" bit Keyboard Interrupt Enable Register
                     4303                                  ;(disable keyboard interrupt for ignition monitor while pin
                     4304                                  ; is low)
 8DFF [04] 156B      4305       bclr    MONen,inputs       ; Clear "MONen" bit of "inputs" variable
 8E01 [03] B62D      4306       lda     T2CNTL             ; Load accumulator with value in TIM2 counter register Lo
                     4307                                  ; (Unlatch any previous reads)
 8E03 [03] BE2C      4308       ldx     T2CNTH             ; Load index register Lo byte with value in TIM2 counter
                     4309                                  ; register Hi byte(also latches Lo byte)
 8E05 [03] BFBE      4310       stx     MON_tsH            ; Copy to "MON_tsH" variable
 8E07 [03] B62D      4311       lda     T2CNTL             ; Load accumulator with value in TIM2 counter register Lo byte
 8E09 [03] B7BF      4312       sta     MON_tsL            ; Copy to "MON_tsL: variable
 8E0B [03] B0A7      4313       sub     PIP_tsL            ; Subtract A<-(A)-(M)(Calculate cycle time)
                     4314                                  ; (MON_tsL - PIP_tsL = MON_pL)
 8E0D [03] B761      4315       sta     MON_pL             ; Copy result to "MON_pL" variable
 8E0F [01] 9F        4316       txa                        ; Transfer value in index register Lo byte to accumulator
                     4317                                  ; (MON_tsH)
 8E10 [03] B2A6      4318       sbc     PIP_tsH            ; Subtract with carry A<-(A)-(M)-(C)
                     4319                                  ; (MON_tsH - PIP_tsH = MON_pH)
 8E12 [03] B760      4320       sta     MON_pH             ; Copy result to "MON_pH" variable
                     4321  
                     4322  KEYBD_DONE:
 8E14 [07] 80        4323       rti                        ; Return from interrupt
                     4324  
                     4325  
                     4326  ;***********************************************************************************************
                     4327  ; ----- Dummy ISR vector - there just to keep the assembler happy -----
                     4328  ;***********************************************************************************************
                     4329  
                     4330  Dummy:
 8E15 [07] 80        4331       rti     ; Return from interrupt
                     4332  
                     4333  ;***********************************************************************************************
                     4334  ;
                     4335  ; ---------------------------- SUBROUTINES --------------------------------
                     4336  ;
                     4337  ;  - Ordered Table Search
                     4338  ;  - Linear Interpolation
                     4339  ;  - 32 x 16 divide
                     4340  ;  - Round after division
                     4341  ;  - Computation of Normalized Variables
                     4342  ;  - Pulse Width Totals
                     4343  ;  - VE table lookup
                     4344  ;  - ST table lookup
                     4345  ;
                     4346  ;***********************************************************************************************
                     4347  
                     4348  
                     4349  ;***********************************************************************************************
                     4350  ;
                     4351  ; --------------------------Ordered Table Search ---------------------------
                     4352  ;
                     4353  ;  X is pointing to the start of the first value in the table
                     4354  ;  tmp1:2 initially hold the start of table address,
                     4355  ;  then they hold the bound values
                     4356  ;  tmp3 is the end of the table ("n" elements - 1)
                     4357  ;  tmp4 is the comparison value
                     4358  ;  tmp5 is the index result - if zero then comp value is less
                     4359  ;  than beginning of table, and if equal to "n" elements then it is
                     4360  ;  rail-ed at upper end
                     4361  ;
                     4362  ;***********************************************************************************************
                     4363  
                     4364  ORD_TABLE_FIND:
 8E16 [03] 3F94      4365       clr     tmp5     ; Clear tmp5 variable
 8E18 [04] 5590      4366       ldhx    tmp1     ; Load high part of index register with value in tmp1
 8E1A [02] F6        4367       lda     ,x       ; Load accumulator with low part of index register???
 8E1B [03] B791      4368       sta     tmp2     ; Copy to tmp2 variable
                     4369  
                     4370  REENT:
 8E1D [01] 5C        4371       incx                    ; Increment low part of index register
 8E1E [04] 3C94      4372       inc     tmp5            ; Increment tmp5 variable
 8E20 [05] 4E9190    4373       mov     tmp2,tmp1       ; Move value in tmp2 variable to tmp1 variable
 8E23 [02] F6        4374       lda     ,x              ; Load accumulator with value in index reg Lo??
 8E24 [03] B791      4375       sta     tmp2            ; Copy to tmp2 variable
 8E26 [03] B193      4376       cmp     tmp4            ; Compare it with tmp4 variable
 8E28 [03] 2206      4377       bhi     GOT_ORD_NUM     ; If higher, branch to GOT_ORD_NUM lable
 8E2A [03] B694      4378       lda     tmp5            ; Load accumulator with value in tmp5 variable
 8E2C [03] B192      4379       cmp     tmp3            ; Compare it with value in tmp3 variable
 8E2E [03] 26ED      4380       bne     REENT           ; If the Z bit of CCR is clesr, branch to REENT:
                     4381  
                     4382  GOT_ORD_NUM:
 8E30 [04] 81        4383       rts                     ; Return from subroutine
                     4384  
                     4385  
                     4386  ;***********************************************************************************************
                     4387  ;
                     4388  ; ---------------------------------- Linear Interpolation - 2D ---------------------------------
                     4389  ;
                     4390  ; Graph Plot        X2
                     4391  ;                   Y2
                     4392  ;               X
                     4393  ;               Y
                     4394  ;         X1
                     4395  ;         Y1
                     4396  ;            (y2 - y1)
                     4397  ;  Y = Y1 +  --------- * (x - x1)
                     4398  ;            (x2 - x1)
                     4399  ;
                     4400  ;   tmp1 = x1
                     4401  ;   tmp2 = x2
                     4402  ;   tmp3 = y1
                     4403  ;   tmp4 = y2
                     4404  ;   tmp5 = x
                     4405  ;   tmp6 = y
                     4406  ;***********************************************************************************************
                     4407  
                     4408  LININTERP:
 8E31 [03] 3F96      4409       clr     tmp7          ; Clear tmp7 variable (This is the negative slope
                     4410                             ; detection bit) (tmp7 = 0)
 8E33 [05] 4E9295    4411       mov     tmp3,tmp6     ; Move value in tmp3 variable to tmp6 variable
                     4412                             ; (Y1 to tmp6)
                     4413  
                     4414  CHECK_LESS_THAN:


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 35
MC68HC908GP32 User Bootloader


 8E36 [03] B694      4415       lda     tmp5               ; Load accumulator with value in tmp5 variable
                     4416                                  ; (x)
 8E38 [03] B190      4417       cmp     tmp1               ; Compare it with value in tmp1 variable
                     4418                                  ; (x1)
 8E3A [03] 2202      4419       bhi     CHECK_GREATER_THAN ; If higher, branch to CHECK_GREATER_THAN:
                     4420                                  ; (X>X1)
 8E3C [03] 2047      4421       bra     DONE_WITH_INTERP        ; Branch to DONE_WITH_INTERP: (else (Y=Y1))
                     4422  
                     4423  CHECK_GREATER_THAN:
 8E3E [03] B694      4424       lda     tmp5             ; Load accumulator with value in tmp5 variable
                     4425                                ; (x)
 8E40 [03] B191      4426       cmp     tmp2             ; Compare it with value in tmp2 variable
                     4427                                ; (X2)
 8E42 [03] 2505      4428       blo     DO_INTERP        ; If lower, branch to DO_INTERP lable
                     4429                                ; (X<X2)
 8E44 [05] 4E9395    4430       mov     tmp4,tmp6        ; Move value in tmp4 variable to tmp6 variable
                     4431                                ; (Y2 to tmp6)
 8E47 [03] 203C      4432       bra     DONE_WITH_INTERP ; Branch to DONE_WITH_INTERP lable (else (Y=Y2))
                     4433  
                     4434  DO_INTERP:
 8E49 [05] 4E9295    4435       mov     tmp3,tmp6        ; Move value in tmp3 variable to tmp6 variable
                     4436                                ; (Y1 to tmp6)
 8E4C [03] B691      4437       lda     tmp2             ; Load accumulator with value in tmp2 variable
                     4438                                ; (X2)
 8E4E [03] B090      4439       sub     tmp1             ; Subtract tmp1 from tmp2 (A=X2-X1)
 8E50 [03] 2733      4440       beq     DONE_WITH_INTERP ; If the Z bit of CCR is set, branch to
                     4441                                ;DONE_WITH_INTERP:  else (Y=Y1)
 8E52 [02] 87        4442       psha                     ; Push value in accumulator to stack
                     4443                                ; (X2-X1)(stack 1)
 8E53 [03] B693      4444       lda     tmp4             ; Load accumulator with value in tmp4 variable
                     4445                                ; (Y2)
 8E55 [03] B092      4446       sub     tmp3             ; Subtract tmp3 from tmp4 (A=Y2-Y1)
 8E57 [03] 2403      4447       bcc     POSINTERP        ; If C bit of CCR is clear, branch to POSINTERP:
 8E59 [01] 40        4448       nega                     ; Negate accumulator      ??????????
 8E5A [04] 3C96      4449       inc     tmp7             ; Increment tmp7 variable (tmp7 = 1)
                     4450  
                     4451  POSINTERP:
 8E5C [02] 87        4452       psha                     ; Push value in accumulator to stack
                     4453                                ; (negated Y2-Y1) (stack 2)
 8E5D [03] B694      4454       lda     tmp5             ; Load accumulator with value in tmp5 variable
                     4455                                ; (X)
 8E5F [03] B090      4456       sub     tmp1             ; Subtract tmp1 from tmp5 (A=X-X1)
 8E61 [03] 2720      4457       beq     ZERO_SLOPE            ; If the Z bit of CCR is set,
                     4458                                ; branch to ZERO_SLOPE lable  (Y=Y1)
 8E63 [02] 88        4459       pulx                     ; Pull value from stack to index register Lo
                     4460                                ;(negated Y2-Y1) (stack 2)
 8E64 [05] 42        4461       mul                      ; Multiply it by the value in the accumulator
                     4462                                ; A=(negated Y2-Y1)*(X-X1)
 8E65 [02] 89        4463       pshx                     ; Push the index register L to the stack
                     4464                                ; (stack 2)
 8E66 [02] 8A        4465       pulh                     ; Pull this value to index register Hi(stack 2)
 8E67 [02] 88        4466       pulx                     ; Pull the next value to index register Lo
                     4467                                ;(stack 1)
 8E68 [07] 52        4468       div                      ; Divide A<-(H:A)/(X);H<-Remainder
 8E69 [05] CD8F12    4469       jsr     DIVROUND         ; Jump to "DIVROUND" subroutine,(round result)
 8E6C [02] 87        4470       psha                     ; Push the value in the accumulator onto stack
                     4471                                ; (stack 1)
 8E6D [03] B696      4472       lda     tmp7             ; Load accumulator with value in tmp7 variable
 8E6F [03] 2607      4473       bne     NEG_SLOPE        ; If the Z bit of CCR is clear,
                     4474                                ; branch to NEG_SLOPE: (Y=Y1)
 8E71 [02] 86        4475       pula                     ; Pull value from stack to accumulator (stack 1)
 8E72 [03] BB92      4476       add     tmp3             ; Add it with value in tmp3 variable
 8E74 [03] B795      4477       sta     tmp6             ; Copy it to tmp6 variable
 8E76 [03] 200D      4478       bra     DONE_WITH_INTERP ; Branch to  DONE_WITH_INTERP:
                     4479  
                     4480  NEG_SLOPE:
 8E78 [02] 86        4481       pula                     ; Pull value from stack to accumulator(stack 1)
 8E79 [03] B796      4482       sta     tmp7             ; Copy to tmp7 variable
 8E7B [03] B692      4483       lda     tmp3             ; Load accumulator with value in tmp3  Y1)
 8E7D [03] B096      4484       sub     tmp7             ; Subtract tmp7 from tmp3
 8E7F [03] B795      4485       sta     tmp6             ; Copy result to tmp6 variable
 8E81 [03] 2002      4486       bra     DONE_WITH_INTERP ; Branch to  DONE_WITH_INTERP:
                     4487  
                     4488  ZERO_SLOPE:
 8E83 [02] 86        4489          pula    ; Pull value from stack to accumulator (clean stack)(stack 2)
 8E84 [02] 86        4490          pula    ; Pull value from stack to accumulator (clean stack)(stack 1)
                     4491  
                     4492  DONE_WITH_INTERP:
 8E85 [04] 81        4493          rts      ; Return from subroutine
                     4494  
                     4495  ;***********************************************************************************************
                     4496  ;
                     4497  ; ---------------------- 32 x 16 Unsigned Divide ---------------------------
                     4498  ;
                     4499  ; This routine takes the 32-bit dividend stored in INTACC1.....INTACC1+3
                     4500  ; and divides it by the 16-bit divisor stored in INTACC2:INTACC2+1.
                     4501  ; The quotient replaces the dividend and the remainder replaces the divisor.
                     4502  ;
                     4503  ;***********************************************************************************************
                     4504  
 8E86                4505  UDVD32    EQU     *
                     4506  *
 8E86                4507  DIVIDEND  EQU     INTACC1+2
 8E86                4508  DIVISOR   EQU     INTACC2
 8E86                4509  QUOTIENT  EQU     INTACC1
 8E86                4510  REMAINDER EQU     INTACC1
                     4511  *
 8E86 [02] 8B        4512          PSHH                            ;save h-reg value
 8E87 [02] 87        4513          PSHA                            ;save accumulator
 8E88 [02] 89        4514          PSHX                            ;save x-reg value
 8E89 [02] A7FD      4515          AIS     #-3                     ;reserve three bytes of temp storage
 8E8B [02] A620      4516          LDA     #!32                    ;
 8E8D [04] 9EE703    4517          STA     3,SP                    ;loop counter for number of shifts
 8E90 [03] B68C      4518          LDA     DIVISOR                 ;get divisor msb
 8E92 [04] 9EE701    4519          STA     1,SP                    ;put divisor msb in working storage
 8E95 [03] B68D      4520          LDA     DIVISOR+1               ;get divisor lsb
 8E97 [04] 9EE702    4521          STA     2,SP                    ;put divisor lsb in working storage
                     4522  
                     4523  ;***********************************************************************************************
                     4524  *     Shift all four bytes of dividend 16 bits to the right and clear
                     4525  *     both bytes of the temporary remainder location
                     4526  ;***********************************************************************************************
                     4527  
 8E9A [05] 4E8B8D    4528          MOV     DIVIDEND+1,DIVIDEND+3   ;shift dividend lsb
 8E9D [05] 4E8A8C    4529          MOV     DIVIDEND,DIVIDEND+2     ;shift 2nd byte of dividend
 8EA0 [05] 4E898B    4530          MOV     DIVIDEND-1,DIVIDEND+1   ;shift 3rd byte of dividend
 8EA3 [05] 4E888A    4531          MOV     DIVIDEND-2,DIVIDEND     ;shift dividend msb
 8EA6 [03] 3F88      4532          CLR     REMAINDER               ;zero remainder msb
 8EA8 [03] 3F89      4533          CLR     REMAINDER+1             ;zero remainder lsb
                     4534  
                     4535  ;***********************************************************************************************
                     4536  *     Shift each byte of dividend and remainder one bit to the left
                     4537  ;***********************************************************************************************
                     4538  
 8EAA [03] B688      4539  SHFTLP  LDA     REMAINDER               ;get remainder msb
 8EAC [01] 49        4540          ROLA                            ;shift remainder msb into carry
 8EAD [04] 398D      4541          ROL     DIVIDEND+3              ;shift dividend lsb
 8EAF [04] 398C      4542          ROL     DIVIDEND+2              ;shift 2nd byte of dividend
 8EB1 [04] 398B      4543          ROL     DIVIDEND+1              ;shift 3rd byte of dividend
 8EB3 [04] 398A      4544          ROL     DIVIDEND                ;shift dividend msb
 8EB5 [04] 3989      4545          ROL     REMAINDER+1             ;shift remainder lsb
 8EB7 [04] 3988      4546          ROL     REMAINDER               ;shift remainder msb
                     4547  
                     4548  ;***********************************************************************************************
                     4549  *     Subtract both bytes of the divisor from the remainder
                     4550  ;***********************************************************************************************


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 36
MC68HC908GP32 User Bootloader


                     4551  
 8EB9 [03] B689      4552          LDA     REMAINDER+1          ;get remainder lsb
 8EBB [04] 9EE002    4553          SUB     2,SP                 ;subtract divisor lsb from remainder lsb
 8EBE [03] B789      4554          STA     REMAINDER+1          ;store new remainder lsb
 8EC0 [03] B688      4555          LDA     REMAINDER            ;get remainder msb
 8EC2 [04] 9EE201    4556          SBC     1,SP                 ;subtract divisor msb from remainder msb
 8EC5 [03] B788      4557          STA     REMAINDER            ;store new remainder msb
 8EC7 [03] B68D      4558          LDA     DIVIDEND+3           ;get low byte of dividend/quotient
 8EC9 [02] A200      4559          SBC     #0                   ;dividend low bit holds subtract carry
 8ECB [03] B78D      4560          STA     DIVIDEND+3           ;store low byte of dividend/quotient
                     4561  
                     4562  ;***********************************************************************************************
                     4563  *     Check dividend/quotient lsb. If clear, set lsb of quotient to indicate
                     4564  *     successful subraction, else add both bytes of divisor back to remainder
                     4565  ;***********************************************************************************************
                     4566  
 8ECD [05] 018D16    4567          BRCLR   0,DIVIDEND+3,SETLSB     ;check for a carry from subtraction
                     4568                                          ;and add divisor to remainder if set
 8ED0 [03] B689      4569          LDA     REMAINDER+1             ;get remainder lsb
 8ED2 [04] 9EEB02    4570          ADD     2,SP                    ;add divisor lsb to remainder lsb
 8ED5 [03] B789      4571          STA     REMAINDER+1             ;store remainder lsb
 8ED7 [03] B688      4572          LDA     REMAINDER               ;get remainder msb
 8ED9 [04] 9EE901    4573          ADC     1,SP                    ;add divisor msb to remainder msb
 8EDC [03] B788      4574          STA     REMAINDER               ;store remainder msb
 8EDE [03] B68D      4575          LDA     DIVIDEND+3              ;get low byte of dividend
 8EE0 [02] A900      4576          ADC     #0                      ;add carry to low bit of dividend
 8EE2 [03] B78D      4577          STA     DIVIDEND+3              ;store low byte of dividend
 8EE4 [03] 2002      4578          BRA     DECRMT                  ;do next shift and subtract
                     4579  
 8EE6 [04] 108D      4580  SETLSB  BSET    0,DIVIDEND+3            ;set lsb of quotient to indicate
                     4581                                          ;successive subtraction
 8EE8 [06] 9E6B03BE  4582  DECRMT  DBNZ    3,SP,SHFTLP             ;decrement loop counter and do next
                     4583                                          ;shift
                     4584  
                     4585  ;***********************************************************************************************
                     4586  *     Move 32-bit dividend into INTACC1.....INTACC1+3 and put 16-bit
                     4587  *     remainder in INTACC2:INTACC2+1
                     4588  ;***********************************************************************************************
                     4589  
 8EEC [03] B688      4590          LDA     REMAINDER               ;get remainder msb
 8EEE [04] 9EE701    4591          STA     1,SP                    ;temporarily store remainder msb
 8EF1 [03] B689      4592          LDA     REMAINDER+1             ;get remainder lsb
 8EF3 [04] 9EE702    4593          STA     2,SP                    ;temporarily store remainder lsb
 8EF6 [05] 4E8A88    4594          MOV     DIVIDEND,QUOTIENT       ;
 8EF9 [05] 4E8B89    4595          MOV     DIVIDEND+1,QUOTIENT+1   ;shift all four bytes of quotient
 8EFC [05] 4E8C8A    4596          MOV     DIVIDEND+2,QUOTIENT+2   ; 16 bits to the left
 8EFF [05] 4E8D8B    4597          MOV     DIVIDEND+3,QUOTIENT+3   ;
 8F02 [04] 9EE601    4598          LDA     1,SP                    ;get final remainder msb
 8F05 [03] B78C      4599          STA     INTACC2                 ;store final remainder msb
 8F07 [04] 9EE602    4600          LDA     2,SP                    ;get final remainder lsb
 8F0A [03] B78D      4601          STA     INTACC2+1               ;store final remainder lsb
                     4602  
                     4603  ;***********************************************************************************************
                     4604  *     Deallocate local storage, restore register values, and return from
                     4605  *     subroutine
                     4606  ;***********************************************************************************************
                     4607  
 8F0C [02] A703      4608          AIS     #3                      ;deallocate temporary storage
 8F0E [02] 88        4609          PULX                            ;restore x-reg value
 8F0F [02] 86        4610          PULA                            ;restore accumulator value
 8F10 [02] 8A        4611          PULH                            ;restore h-reg value
 8F11 [04] 81        4612          RTS                             ;return
                     4613  
                     4614  ;***********************************************************************************************
                     4615  
                     4616  ;***********************************************************************************************
                     4617  **
                     4618  ** ROUND after div (unsigned)
                     4619  ** 1)  check for div overflow (carry set), rail result if detected
                     4620  ** 2)  if (remainder * 2) > divisor then     ; was remainder > (divisor / 2)
                     4621  ** 2a)    increment result, rail if over-flow
                     4622  **
                     4623  ;***********************************************************************************************
                     4624  
                     4625  DIVROUND:
 8F12 [03] 250E      4626       bcs     DIVROUND0     ; If C bit of CCR is set, branch to DIVROUND0:
                     4627                             ; (div overflow? yes, branch)
 8F14 [03] BFA5      4628       stx     tmp22         ; Copy value in index register Lo byte to
                     4629                             ; tmp22 variable (divisor)
 8F16 [02] 8B        4630       pshh                  ; Push value in index register Hi byte onto
                     4631                             ; stack (retrieve remainder)
 8F17 [02] 88        4632       pulx                  ; Pull value on stack to index register Lo byte
 8F18 [01] 58        4633       lslx                  ; Logical shift left index register lo byte (* 2)
 8F19 [03] 2504      4634       bcs     DIVROUND2     ; If C bit of CCR is set, branch to DIVROUND2:
                     4635                             ;(over-flow on left-shift, (remainder * 2) > $FF)
 8F1B [03] B3A5      4636       cpx     tmp22         ; Compare value in tmp22 variable with value
                     4637                             ; in index register Lo byte
                     4638                             ;(compare (remainder * 2) to divisor)
 8F1D [03] 2505      4639       blo     DIVROUND1     ; If lower, branch to DIVROUND1:
                     4640  
                     4641  
                     4642  DIVROUND2:
 8F1F [01] 4C        4643       inca                   ; Increment accumulator (round-up result)
 8F20 [03] 2602      4644       bne      DIVROUND1     ; If Z bit of CCR is clear, branch to DIVROUND1:
                     4645                              ; (result roll over? no, branch)
                     4646  
                     4647  
                     4648  DIVROUND0:
 8F22 [02] A6FF      4649       lda     #$FF     ; Load accumulator with decimal 255 (rail result)
                     4650  
                     4651  
                     4652  DIVROUND1:
 8F24 [04] 81        4653       rts              ; return from subroutine
                     4654  
                     4655  
                     4656  ;***********************************************************************************************
                     4657  ;
                     4658  ; ---------------- Computation of Normalized Variables ----------------------
                     4659  ;
                     4660  ;  The following is the form of the evaluation for the normalized variables:
                     4661  ;
                     4662  ;  (A rem A * B)
                     4663  ;  -------------  = C rem C
                     4664  ;      100
                     4665  ;
                     4666  ;  Where A = Whole part of the percentage,
                     4667  ;        rem A = Remainder of A from previous calculation (range 0 to 99)
                     4668  ;        B = Percentage multiplied (this always has a zero remainder)
                     4669  ;        C = Whole part of result
                     4670  ;        rem C = remainder of result
                     4671  ;
                     4672  ;
                     4673  ;  Calculation is performed by the following method:
                     4674  ;
                     4675  ;     |(A * B) + (rem A * B)|
                     4676  ;     |          -----------|
                     4677  ;     |              100    |
                     4678  ;     ----------------------- = C rem C
                     4679  ;             100
                     4680  ;
                     4681  ;
                     4682  ;   Inputs:  tmp10 = A
                     4683  ;            tmp11 = rem A
                     4684  ;            tmp12 = B
                     4685  ;            tmp13 = rem B
                     4686  ;


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 37
MC68HC908GP32 User Bootloader


                     4687  ;
                     4688  ;   Outputs: tmp10 = C
                     4689  ;            tmp11 = rem C
                     4690  ;            tmp13 = high order part of (A rem A) * B
                     4691  ;            tmp14 = low order part of (A rem A) * B
                     4692  ;
                     4693  ;***********************************************************************************************
                     4694  
                     4695  Supernorm:
 8F25 [03] B699      4696       lda     tmp10        ; Load accumulator with value in tmp10 (A)
 8F27 [01] 97        4697       tax                  ; Transfer value in accumulator to index register Lo
 8F28 [03] B69B      4698       lda     tmp12        ; Load accumulator with value in tmp12 (B)
 8F2A [05] 42        4699       mul                  ; Multiply ( X:A<-(X)x(A) )
 8F2B [03] BF9C      4700       stx     tmp13        ; Copy value in index register Lo byte to tmp13
                     4701                            ;(High order of A * B)
 8F2D [03] B79D      4702       sta     tmp14        ; Copy value in accumulator to tmp14
                     4703                            ;(Low order of A * B)
 8F2F [03] B69A      4704       lda     tmp11        ; Load accumulator with value in tmp11 (rem A)
 8F31 [01] 97        4705       tax                  ; Transfer value in accumulator to index reg Lo
 8F32 [03] B69B      4706       lda     tmp12        ; Load accumulator with value in tmp12 (B)
 8F34 [05] 42        4707       mul                  ; Multiply ( X:A<-(X)x(A) )
 8F35 [02] 89        4708       pshx                 ; Push value in index register to stack
 8F36 [02] 8A        4709       pulh                 ; Pull value in stack to index register Hi byte
                     4710                            ; (X)->(H)
 8F37 [02] AE64      4711       ldx     #$64         ; Load accumulator with decimal 100
 8F39 [07] 52        4712       div                  ; Divide ( A<-(H:A)/(X);H<-Remainder )
 8F3A [03] B99D      4713       adc     tmp14        ; Add with carry ( A<-(A)+(M)+(C) )
                     4714                            ;(Add to lower part)
 8F3C [03] B79D      4715       sta     tmp14        ; Copy to tmp14 (Store back)
 8F3E [03] 2402      4716       bcc     Roundrem     ;If the C bit of CCR is clear, branch to Roundrem:
                     4717                            ;(Branch if no carry occurred)
 8F40 [04] 3C9C      4718       inc     tmp13        ; Increment value in tmp13
                     4719                            ;(Increment high-order part because an overflow
                     4720                            ; occurred in adc)
                     4721  
                     4722  Roundrem:
 8F42 [02] 8B        4723       pshh                  ; Push value in index register Hi byte to stack
 8F43 [02] 86        4724       pula                  ; Pull value from stack to accumulator
 8F44 [02] A132      4725       cmp     #$32          ; Compare it to decimal 50
                     4726                             ;(Round if division remainder is greater than 50)
 8F46 [03] 930A      4727       ble     FinalNorm     ; If lesws than or equal to, branch to FinalNorm:
 8F48 [03] B69D      4728       lda     tmp14         ; Load accumulator with value in tmp14
 8F4A [02] A901      4729       adc     #$01          ; Add with carry decimal 1
 8F4C [03] B79D      4730       sta     tmp14         ; Copy result to tmp13
 8F4E [03] 2402      4731       bcc     FinalNorm     ; If C bit of CCR is clear, branch to FinalNorm:
 8F50 [04] 3C9C      4732       inc     tmp13         ; Increment value in tmp13
                     4733  
                     4734  FinalNorm:
 8F52 [03] B69C      4735       lda     tmp13        ; Load accumulator with value in tmp13
 8F54 [02] 87        4736       psha                 ; Push value in accumulator to stack
 8F55 [02] 8A        4737       pulh                 ; Pull value in stack to index register Hi byte
 8F56 [03] B69D      4738       lda     tmp14        ; Load accumulator with value in tmp14
 8F58 [02] AE64      4739       ldx     #$64         ; Load index register Hi byte with decimal 100
 8F5A [07] 52        4740       div                  ; Divide ( A<-(H:A)/(X);H<-Remainder )
 8F5B [03] 251A      4741       bcs     RailCalc     ; If C bit of CCR is set, branch to RailCalc:
 8F5D [03] B799      4742       sta     tmp10        ; Copy result to tmp10
 8F5F [02] 8B        4743       pshh                 ; Push value in index register Hi byte to stack
 8F60 [02] 86        4744       pula                 ; Pull value in stack to accumulator
 8F61 [03] B79A      4745       sta     tmp11        ; copy to tmp11
 8F63 [02] A132      4746       cmp     #$32         ; Compare with decimal 50
                     4747                            ;(Round if division remainder is greater than 50)
 8F65 [03] 9313      4748       ble     ExitSN       ; If lower than or equal to, branch to ExitSN:
 8F67 [03] B69A      4749       lda     tmp11        ; Load accumulator with value in tmp11
 8F69 [02] A901      4750       adc     #$01         ; Add with carry decimal 1
 8F6B [03] B79A      4751       sta     tmp11        ; Copy result to tmp11
 8F6D [03] 240B      4752       bcc     ExitSN       ; If C bit of CCR is set, branch to ExitSN:
 8F6F [03] B699      4753       lda     tmp10        ; Load accumulator with value in tmp10
 8F71 [02] AB01      4754       add     #$01         ; Add it with decimal 1
 8F73 [03] B799      4755       sta     tmp10        ; Copy result to tmp10
 8F75 [03] 2603      4756       bne     ExitSN       ; If Z bit of CCR is clear, branch to ExitSN:
                     4757  
                     4758  RailCalc:
 8F77 [04] 6EFF99    4759       mov     #$FF,tmp10      ; Move decimal 255 to tmp10 variable
                     4760                               ;(Rail value if rollover)
                     4761  
                     4762  ExitSN:
 8F7A [04] 81        4763       rts                     ; Return from subroutine
                     4764  
                     4765  ;***********************************************************************************************
                     4766  
                     4767  ;***********************************************************************************************
                     4768  ; Paging subroutines. ("page" stores which table is paged into RAM, the value is sent by
                     4769  ; Tuner Studio depending on the mode, default is zero)
                     4770  ;***********************************************************************************************
                     4771  ;***********************************************************************************************
                     4772  ; VE Table and Ranges. If page value is 1, get value from RAM, otherwise, use Flash
                     4773  ;***********************************************************************************************
                     4774  
                     4775  VE1X:
 8F7B [03] B6C4      4776       lda     page       ; Load accumulator with value in "page"
 8F7D [02] A101      4777       cmp     #01T       ; Compare with decimal 1
 8F7F [03] 2604      4778       bne     VE1XF      ; If not (A)not=(M) branch to VE1XF:
 8F81 [03] E6E0      4779       lda     VE_r,x     ; Load accumulator with value in "VE_r", offset in index register Lo
 8F83 [03] 2003      4780       bra     VE1XC      ; Branch to VE1XC:
                     4781  
                     4782  VE1XF:
 8F85 [04] D6E000    4783       lda     VE_f,x     ; Load accumulator with value in "VE_f" offset in index register Lo
                     4784  
                     4785  VE1XC:
 8F88 [04] 81        4786       rts                ; Return from subroutine
                     4787  
                     4788  ;***********************************************************************************************
                     4789  ; ST Table and Ranges, If page value is 2, get value from RAM, otherwise, use Flash
                     4790  ;***********************************************************************************************
                     4791  
                     4792  VE2X:
 8F89 [03] B6C4      4793       lda     page       ; Load accumulator with value in "page"
 8F8B [02] A102      4794       cmp     #02T       ; Compare with decimal 2
 8F8D [03] 2604      4795       bne     VE2XF      ; If not (A)not=(M) branch to VE2XF:
 8F8F [03] E6E0      4796       lda     ST_r,x     ; Load accumulator with value in "ST_r", offset in index register Lo
 8F91 [03] 2003      4797       bra     VE2XC      ; Branch to VE2XC:
                     4798  
                     4799  VE2XF:
 8F93 [04] D6E100    4800       lda     ST_f,x     ; Load accumulator with value in "ST_f" offset in index register Lo
                     4801  
                     4802  VE2XC:
 8F96 [04] 81        4803       rts                ; Return from subroutine
                     4804  
                     4805  ;***********************************************************************************************
                     4806  ; REVNUM is not used with this format, but is retained to keep MT and TS happy.
                     4807  ; textversion_f is the specific code that this works with. (32 char)
                     4808  ; Signature is the data format that the code uses to communicate with MT and TS. (32 char)
                     4809  ;***********************************************************************************************
                     4810  
 8F97      00        4811  REVNUM:          db     00T
 8F98      4D536E53  4812  textversion_f:   db     'MSnS300 by Robert Hiebert ******'
           33303020 
           62792052 
           6F626572 
           74204869 
           65626572 
           74202A2A 
           2A2A2A2A 
 8FB8      4D53312F  4813  Signature:       db     'MS1/Extra format 029y3 *********'
           45787472 
           6120666F 


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 38
MC68HC908GP32 User Bootloader


           726D6174 
           20303239 
           7933202A 
           2A2A2A2A 
           2A2A2A2A 
                     4814  
                     4815  
                     4816  ;***********************************************************************************************
                     4817  ;
                     4818  ;------------------ Boot Loader-defined jump table/vector -------------------
                     4819  ;
                     4820  ;***********************************************************************************************
                     4821  
 8FD8                4822       include "burnerHP.asm"
                     4823  ;****************************************************************************************
                     4824  ; Megasquirt Flash page erase and programming routines. Heavily based on the routines
                     4825  ; from boot_r12.asm
                     4826  ;
                     4827  ; JSM - revised timing for 8MHz
                     4828  ; RJH - revised for MS_ECU_HP 10/28/10
                     4829  ;****************************************************************************************
                     4830  ;****************************************************************************************
                     4831  ; - Variables
                     4832  ;
                     4833  ; page      - Page address pointer when added to $E000(MS_ECU_HP.h)
                     4834  ; burnDst   - Burn destination address(MS_ECU_HP.h)
                     4835  ; burnSrc   - Burn source address(MS_ECU_HP.h)
                     4836  ; burncount - Number of bytes to burn(MS_ECU_HP.h)
                     4837  ; ram_exec  - Start of execurable RAM space($01ED)(493)(boot_r12)
                     4838  ; flcr      - HC908 Flash Control Register
                     4839  ; HVEN      = High Voltage Enable Bit of flcr
                     4840  ; ERASE     = Erase Control bit of flcr
                     4841  ; PGM       = Program Control bit of flcr
                     4842  ; flbpr     - HC908 Flash Block Protect Register
                     4843  ;
                     4844  ;****************************************************************************************
                     4845  ;****************************************************************************************
                     4846  ; - Erase 256 bytes in Flash starting at the selected page address
                     4847  ;****************************************************************************************
                     4848  
                     4849  burnConst:
 8FD8 [03] B6C5      4850       lda     flocker
 8FDA [02] A1CC      4851       cmp     #$CC
 8FDC [03] 2701      4852       beq     BURN_CONT
 8FDE [04] 81        4853       rts
                     4854  
                     4855  BURN_CONT:
 8FDF [03] B6C4      4856       lda     page     ; Load accumulaotr with value in "page"
 8FE1 [02] ABDF      4857       add     #$DF
                     4858  ;*     add     #$E0     ; A<-(A)+(M) Add value in accumulator with with $E0
 8FE3 [02] 87        4859       psha             ; Push result to Stack
 8FE4 [02] 8A        4860       pulh             ; Pull result from stack and copy 
 8FE5 [01] 5F        4861       clrx             ; Clear index register Lo byte(now a 16 bit value)
 8FE6 [04] 35C6      4862       sthx    burnDst  ; Copy to "burnDst"
                     4863  
                     4864  ;****************************************************************************************
                     4865  ; - Erase the first block of 128 bytes
                     4866  ;****************************************************************************************
                     4867  
 8FE8 [05] CD900D    4868       jsr     ms_EraseFlash     ; Jump to subroutine at ms_EraseFlash:
                     4869  
                     4870  ;****************************************************************************************
                     4871  ; - Load the address of the second 128 bytes of the page to be erased
                     4872  ;****************************************************************************************
                     4873  
 8FEB [04] 55C6      4874       ldhx    burnDst     ; Load index register with value in "burnDst"
 8FED [02] AF40      4875       aix     #64T        ; Add decimal 64 to index register Lo byte
 8FEF [02] AF40      4876       aix     #64T        ; Add decimal 64 to index register Lo byte (total of 128)
 8FF1 [04] 35C6      4877       sthx    burnDst     ; Copy result to "burnDst"
                     4878  
                     4879  ;****************************************************************************************
                     4880  ; - Erase the second block of 128 bytes
                     4881  ;****************************************************************************************
                     4882  
 8FF3 [05] CD900D    4883       jsr     ms_EraseFlash     ; Jump to subroutine at ms_EraseFlash:
                     4884  
                     4885  ;****************************************************************************************
                     4886  ; - Load the address of the destination page to be burnt. (pages start at $E000)
                     4887  ;****************************************************************************************
                     4888  
 8FF6 [03] B6C4      4889       lda     page     ; Load accumulaotr with value in "page"
 8FF8 [02] ABDF      4890       add     #$DF
                     4891  ;*     add     #$E0     ; A<-(A)+(M) Add value in accumulator with with $E0
 8FFA [02] 87        4892       psha             ; Push result to Stack
 8FFB [02] 8A        4893       pulh             ; Pull result from stack and copy to index register Hi byte
 8FFC [01] 5F        4894       clrx             ; Clear index register Lo byte(now a 16 bit value)
 8FFD [04] 35C6      4895       sthx    burnDst  ; Copy to "burnDst"
                     4896  
                     4897  ;****************************************************************************************
                     4898  ; - Load the address of the source page to be burnt.
                     4899  ;****************************************************************************************
                     4900  
 8FFF [03] 4500E0    4901       ldhx     #VE_r     ; Load index register with address at "VE_r"
 9002 [04] 35C2      4902       sthx    burnSrc    ; Copy to "burnSrc"
                     4903  
                     4904  ;****************************************************************************************
                     4905  ; - Burn 189 bytes per page
                     4906  ;****************************************************************************************
                     4907  
 9004 [02] A6BD      4908       lda     #189T               ; Load accumulator with decimal 189
 9006 [03] B7C8      4909       sta     burncount           ; Copy to "burncount"
 9008 [01] 8C        4910       clrh                        ; Clear index register Hi byte
 9009 [01] 5F        4911       clrx                        ; Clear index register Lo byte
 900A [03] CC901C    4912       jmp     ms_ProgramFlash     ; Jump to subroutine at ms_ProgramFlash:
                     4913  
                     4914  
                     4915  ;****************************************************************************************
                     4916  ;
                     4917  ;======================  Single Flash Page Erase Subroutine  ============================
                     4918  ;
                     4919  ; This subroutine will copy the Flash Erase algorithm into RAM and execute
                     4920  ; it to erase the page starting at address pointers "burnDst"
                     4921  ;
                     4922  ;****************************************************************************************
                     4923  ;****************************************************************************************
                     4924  ; - Initialize pointer
                     4925  ;****************************************************************************************
                     4926  
                     4927  ms_EraseFlash:
 900D [03] 450031    4928       ldhx    #ms_EraseRamSize     ; Load index register with address of "ms_EraseRamSize"
                     4929  
                     4930  ;****************************************************************************************
                     4931  ; - Get program from Flash, copy to RAM, decrement pointer and loop back until done.
                     4932  ;****************************************************************************************
                     4933  
                     4934  ms_EraseFlash1:
 9010 [04] D6902A    4935       lda     ms_MassErase-1,x     ; Load accumulator with value at "ms_MAssErase-1,
                     4936                                    ; offset in index register Lo byte
 9013 [04] D701EC    4937       sta     ram_exec-1,x         ; Copy to location "ram_exec-1", offset in index
                     4938                                    ; register Lo byte
 9016 [03] 5BF8      4939       dbnzx   ms_EraseFlash1       ; Decrement index register Lo byte and branch to lable
                     4940                                    ; at "ms_EraseFlash1:" if not zero
 9018 [02] 9B        4941       sei                          ; Set interrupt mask bit of CCR(prohibit interrrupts)
                     4942  
                     4943  ;****************************************************************************************
                     4944  ; - Execute Flash Mass Erase algorithm from RAM


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 39
MC68HC908GP32 User Bootloader


                     4945  ;****************************************************************************************
                     4946  
 9019 [03] CC01ED    4947       jmp     ram_exec     ; Jump to subroutine at lable "ram_exec:"(start of executable
                     4948                            ; RAM space from "boot_r12"
                     4949  
                     4950  ;****************************************************************************************
                     4951  ;
                     4952  ;==========================  Flash Program Subroutine  ==================================
                     4953  ;
                     4954  ; This subroutine will copy the Flash Program algorithm into RAM and execute it to
                     4955  ; program  "burncount" bytes from the address pointed to by 'burnSrc' to the address
                     4956  ; pointed to by "burnDst"
                     4957  ;
                     4958  ;****************************************************************************************
                     4959  ;****************************************************************************************
                     4960  ; - Initialize pointer
                     4961  ;****************************************************************************************
                     4962  
                     4963  ms_ProgramFlash:
 901C [03] 45004A    4964       ldhx    #ms_ProgramRamSize     ; Load index register with address at
                     4965                                      ; "ms_ProgramRamSize"
                     4966  
                     4967  ;****************************************************************************************
                     4968  ; - Get program from Flash, copy to RAM, decrement pointer and loop back until done.
                     4969  ;****************************************************************************************
                     4970  
                     4971  ms_ProgramFlash1:
 901F [04] D69050    4972       lda     ms_Delay-1,x             ; Load accumulator withe value in address
                     4973                                        ;  "ms_Delay-1, offset in index register Lo byte
 9022 [04] D701EC    4974       sta     ram_exec-1,x             ; Copy to address at "ram_exec-1, offset in index
                     4975                                        ; register Lo byte
 9025 [03] 5BF8      4976       dbnzx   ms_ProgramFlash1         ; Decrement index register Lo byte and branch to
                     4977                                        ; lable at "ms_EraseFlash1:" if not zero
 9027 [02] 9B        4978       sei                              ; Set interrupt mask bit of CCR
                     4979                                        ; (prohibit ineterrupts)
 9028 [03] CC01F8    4980       jmp     {ram_exec+ms_ProgramRam} ; Jump to location at "ram_exec+ms_ProgramRam"
                     4981  
                     4982  ;****************************************************************************************
                     4983  ;
                     4984  ;==============================  Flash Erase Subroutine  ================================
                     4985  ;
                     4986  ;  This subroutine performs a single Page Erase @ BurnDst
                     4987  ;  This subroutine has been tuned for a bus speed of 7.3728 MHz. Constants revised for
                     4988  ;  8MHz
                     4989  ;  This subroutine is copied into and executed from RAM.
                     4990  ;
                     4991  ;****************************************************************************************
                     4992  ;****************************************************************************************
                     4993  ; - Initialize pointer to Flash Memory Address
                     4994  ;****************************************************************************************
                     4995  
                     4996  ms_MassErase:
 902B [04] 55C6      4997       ldhx    burnDst     ;Load accumulator with value in "burnDst"
                     4998  
                     4999  ;****************************************************************************************
                     5000  ;   Set ERASE, read the Flash Block Protect Register and write any data into Flash page.
                     5001  ;****************************************************************************************
                     5002  
 902D [02] A602      5003       lda     #{ERASE}     ; Load accumulaotr with value in "{ERASE}"
 902F [04] C7FE08    5004       sta     flcr         ; Copy to Flash Control Register(set erase bit)
 9032 [04] C6FF7E    5005       lda     flbpr        ; Load accumulator with value in Flash Block Protest Register
 9035 [02] F7        5006       sta     ,x           ; Copy to index register Lo byte
                     5007  
                     5008  ;****************************************************************************************
                     5009  ;   Wait for >10us(11.1uS), then set HVEN in Flash Control Register.
                     5010  ;****************************************************************************************
                     5011  
 9036 [02] A601      5012       lda     #1                 ; Load accumulator with decimal 1
 9038 [04] AD17      5013       bsr     ms_delay           ; Branch to subroutine at lable "ms_delay:"
 903A [02] A60A      5014       lda     #{ERASE | HVEN}    ; Load accumulator with value in "ERASE" bit wise Or
                     5015                                  ; "HVEN"
 903C [04] C7FE08    5016       sta     flcr               ; Copy to Flash Control Register
                     5017  
                     5018  ;****************************************************************************************
                     5019  ;   Wait for >1ms(1.012mS), then clear ERASE.
                     5020  ;****************************************************************************************
                     5021  
 903F [02] A669      5022       lda     #105T        ; Load accumulator with decimal 105
 9041 [04] AD0E      5023       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 9043 [02] A608      5024       lda     #{HVEN}      ; Load accumulaotr with value in "HVEN"(clears ERASE)
 9045 [04] C7FE08    5025       sta     flcr         ; Copy to Flash Control Register
                     5026  
                     5027  ;****************************************************************************************
                     5028  ;   Wait for >5us(11.1uS), then clear HVEN.
                     5029  ;****************************************************************************************
                     5030  
 9048 [02] A601      5031       lda     #1           ; Load accumulator with decimal 1
 904A [04] AD05      5032       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 904C [01] 4F        5033       clra                 ; Clear accumulator
 904D [04] C7FE08    5034       sta     flcr         ; Copy to Flash Control Register
 9050 [04] 81        5035       rts                  ; Return from subroutine
                     5036  
                     5037  
                     5038  ;****************************************************************************************
                     5039  ;
                     5040  ;==================================  Delay Subroutine  ==================================
                     5041  ;
                     5042  ;  This subroutine performs a simple software delay loop based upon the value passed in
                     5043  ;  ACC.
                     5044  ;  The following timing calculation applies:
                     5045  ;
                     5046  ;   was supposed to be  delay = ((ACC * 74) + 12) (tcyc)
                     5047  ;   actually            delay = ((ACC * 108) + 12) (tcyc) i.e. longer/safer? delays
                     5048  ;   now                 delay = ((ACC * 77) + 12) (tcyc)
                     5049  ;
                     5050  ;  Calling convention:
                     5051  ;
                     5052  ;      lda     data
                     5053  ;      jsr     delay
                     5054  ;
                     5055  ;  Returns:    nothing
                     5056  ;
                     5057  ;  Changes:    ACC
                     5058  ;
                     5059  ;****************************************************************************************
                     5060  ;****************************************************************************************
                     5061  ; - Save outer delay loop parameter
                     5062  ;****************************************************************************************
                     5063  
                     5064  ms_Delay:
 9051 [02] 87        5065       psha     ; Push value in accumulator to Stack
                     5066  
                     5067  ;****************************************************************************************
                     5068  ; - Initialize inner delay loop counter
                     5069  ;****************************************************************************************
                     5070  
                     5071  ms_Delay1:
 9052 [02] A617      5072       lda     #23T     ; Load accumulator with decimal 23
                     5073  
                     5074  ;****************************************************************************************
                     5075  ; - Decrement inner delay loop counter, decrement outer delay loop counter, dealocate
                     5076  ;   local variable, return from subroutine
                     5077  ;****************************************************************************************
                     5078  
                     5079  ms_Delay2:
 9054 [03] 4BFE      5080       dbnza   ms_Delay2          ; Decrement accumulator and branch to lable at


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 40
MC68HC908GP32 User Bootloader


                     5081                                  ; "ms_Delay2" if not zero
 9056 [06] 9E6B01F8  5082       dbnz    1,sp,ms_Delay1     ; Decrement Stack Pointer and return to lable at
                     5083                                  ; "ms_Delay1  if not zero
 905A [02] 86        5084       pula                       ; Pull value from stack and copy to accumulator
 905B [04] 81        5085       rts                        ; Return from subroutine
                     5086  
                     5087  ;****************************************************************************************
                     5088  ;
                     5089  ;============================  Flash Program Subroutine  ================================
                     5090  ;
                     5091  ;  This subroutine controls the Flash programming sequence.
                     5092  ;
                     5093  ;****************************************************************************************
                     5094  ;****************************************************************************************
                     5095  ; - Equates
                     5096  ;****************************************************************************************
                     5097  
 905C                5098  ms_EraseRamSize:   equ     {*-ms_MassErase}
 905C                5099  ms_ProgramRam:     equ     {*-ms_Delay}
                     5100  
                     5101  ;****************************************************************************************
                     5102  
                     5103  ms_FlashProgram:
                     5104  ms_FlashProgram1:
                     5105  
                     5106  ;****************************************************************************************
                     5107  ; - Set PGM, read the Flash Block Protect Register and write anywhere in desired Flash
                     5108  ;   row.
                     5109  ;****************************************************************************************
                     5110  
 905C [02] A601      5111       lda     #{PGM}      ; Load accumulator with value in "{PGM}"
 905E [04] C7FE08    5112       sta     flcr        ; Copy to Flash Control Register
 9061 [04] C6FF7E    5113       lda     flbpr       ; Load accumulaotr with value in  Flash Block Protect Register
 9064 [04] 55C6      5114       ldhx    burnDst     ; Load index register with value in "burnDst"
 9066 [02] F7        5115       sta     ,x          ; Copy to address in "burnDst, offset in index register Lo byte
                     5116  
                     5117  ;****************************************************************************************
                     5118  ; - Wait for >10us, then set HVEN.
                     5119  ;****************************************************************************************
                     5120  
 9067 [02] A601      5121       lda     #1                ; Load accumulator with decimal 1
 9069 [04] ADE6      5122       bsr     ms_delay          ; Branch to subroutine at lable "ms_delay:"
 906B [02] A609      5123       lda     #{PGM | HVEN}     ; Load accumulator with value in "ERASE" bit wise Or
                     5124                                 ; "HVEN"
 906D [04] C7FE08    5125       sta     flcr              ; Copy to Flash Control Register
                     5126  
                     5127  ;****************************************************************************************
                     5128  ; - Wait for >5us.
                     5129  ;****************************************************************************************
                     5130  
 9070 [02] A601      5131       lda     #1           ; Load accumulator with decimal 1
 9072 [04] ADDD      5132       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
                     5133  
                     5134  ;****************************************************************************************
                     5135  ; - Write data to Flash and wait for 30 - 40us.
                     5136  ;****************************************************************************************
                     5137  
 9074 [04] 55C2      5138       ldhx    burnsrc     ; Load index register with address at "burnsrc"
 9076 [02] F6        5139       lda     ,x          ; Load accumulator with value in "burnsrc, offset in index
                     5140                           ; register Lo byte
 9077 [04] 55C6      5141       ldhx    burndst     ; Load index register with address at "burndst"
 9079 [02] F7        5142       sta     ,x          ; Copy to address at "burndst", offset in index register Lo byte
 907A [02] A603      5143       lda     #3          ; Load accumulator with decimal 3(30.3uS)
 907C [04] ADD3      5144       bsr     ms_delay    ; Jump to subroutine at "ms_delay:)
                     5145  
                     5146  ;****************************************************************************************
                     5147  ; - Clear PGM.
                     5148  ;****************************************************************************************
                     5149  
 907E [02] A608      5150       lda     #{HVEN}     ; Load accumulator with value in {HVEN}
 9080 [04] C7FE08    5151       sta     flcr        ; Copy to Flash Control Register
                     5152  
                     5153  ;****************************************************************************************
                     5154  ; - Wait for >5us, then clear HVEN.
                     5155  ;****************************************************************************************
                     5156  
 9083 [02] A601      5157       lda     #1           ; Load accumulator with decimal 1
 9085 [04] ADCA      5158       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 9087 [01] 4F        5159       clra                 ; Clear accumulator
 9088 [04] C7FE08    5160       sta     flcr         ; Copy to Flash Control Register
                     5161  
                     5162  ;****************************************************************************************
                     5163  ; - Advance source pointer, advance destination pointer, decrement data counter,
                     5164  ;   return from subroutine
                     5165  ;****************************************************************************************
                     5166  
                     5167  ms_FlashProgram2:
 908B [04] 55C2      5168       ldhx    burnsrc                     ; Load index register with address at "burnscr"
 908D [02] AF01      5169       aix     #1                          ; Add decimal 1 to index register Lo byte
 908F [04] 35C2      5170       sthx    BurnSrc                     ; Copy result to "burnSrc"
 9091 [04] 55C6      5171       ldhx    burndst                     ; Load index register with address at "burnDst"
 9093 [02] AF01      5172       aix     #1                          ; Add decimal 1 to index register Lo byte
 9095 [04] 35C6      5173       sthx    BurnDst                     ; Copy result to "burnDst"
 9097 [05] 3BC8C2    5174       dbnz    burncount,ms_FlashProgram1  ; Decrement "burnount" and branch to
                     5175                                           ;  "ms_FlashProgram1" back if not zero.
 909A [04] 81        5176       rts                                 ; Return from subroutine
                     5177  
                     5178  ;****************************************************************************************
                     5179  ; - Equates
                     5180  ;****************************************************************************************
                     5181  
 909B                5182  ms_ProgramRamSize: equ     {*-ms_Delay}
                     5183  
                     5184  
                     5185  
                     5186  
                     5187  
 FAC3                5188       org     $FAC3              ; start bootloader-defined jump table/vector
                     5189                                  ;(64,195)
 FAC3      12        5190       db      $12                ; scbr regi init value
 FAC4      01        5191       db      %00000001          ; config1
 FAC5      01        5192       db      %00000001          ; config2
 FAC6      8128      5193       dw      start              ; Megasquirt code start
 FAC8      FB00      5194       dw      $FB00              ; bootloader start(64,256)
                     5195  
                     5196  ;***********************************************************************************************
                     5197  ;
                     5198  ; ----------------- Vector table origin vec_timebase -----------------------
                     5199  ;
                     5200  ;***********************************************************************************************
                     5201  
                     5202  
                     5203  
 FACA      CC        5204          db      $CC
 FACB      8E15      5205       dw      Dummy        ;Timebase
 FACD      CC        5206          db      $CC
 FACE      8D39      5207       dw      ADC_ISR      ;ADC Conversion Complete
 FAD0      CC        5208          db      $CC
 FAD1      8DD1      5209       dw      KYBD_ISR     ;Keyboard pin
 FAD3      CC        5210          db      $CC
 FAD4      8CC7      5211       dw      SCITX_ISR    ;SCI transmission complete/transmitter empty
 FAD6      CC        5212          db      $CC
 FAD7      8BD9      5213       dw      SCIRCV_ISR   ;SCI input idle/receiver full
 FAD9      CC        5214          db      $CC
 FADA      8E15      5215       dw      Dummy        ;SCI parity/framing/noise/receiver_overrun error
 FADC      CC        5216          db      $CC


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 41
MC68HC908GP32 User Bootloader


 FADD      8E15      5217       dw      Dummy        ;SPI Transmitter empty
 FADF      CC        5218          db      $CC
 FAE0      8E15      5219       dw      Dummy        ;SPI mode/overflow/receiver full
 FAE2      CC        5220          db      $CC
 FAE3      8E15      5221       dw      Dummy      ;TIM2 overflow
 FAE5      CC        5222          db      $CC
 FAE6      8BA3      5223       dw      TIM2CH1_ISR  ;TIM2 Ch1
 FAE8      CC        5224          db      $CC
 FAE9      8A1C      5225       dw      TIM2CH0_ISR  ;TIM2 Ch0
 FAEB      CC        5226          db      $CC
 FAEC      8E15      5227       dw      Dummy        ;TIM1 overflow
 FAEE      CC        5228          db      $CC
 FAEF      8E15      5229       dw      Dummy        ;TIM1 Ch1
 FAF1      CC        5230          db      $CC
 FAF2      8E15      5231       dw      Dummy        ;TIM1 Ch0
 FAF4      CC        5232          db      $CC
 FAF5      8E15      5233       dw      Dummy        ;CGM
 FAF7      CC        5234          db      $CC
 FAF8      89AB      5235       dw      IRQ_ISR      ;IRQ
 FAFA      CC        5236          db      $CC
 FAFB      8E15      5237       dw      Dummy        ;SWI
 FAFD      CC        5238          db      $CC
 FAFE      8128      5239       dw      Start        ;Reset
                     5240  
                     5241  
                     5242  ;***********************************************************************************************
                     5243  ;
                     5244  ; ------------------------------------- Lookup Tables ------------------------------------------
                     5245  ;
                     5246  ;***********************************************************************************************
                     5247  
 F000                5248       org     $F000     ; Origin at Memory Location $F000=61440
                     5249  
 F000                5250       include "barofactor4250rjh.inc"  ; Converts Barometer ADC Raw Reading to baro correction
                     5251  BAROFAC4250rjh: ;% correction
 F000      64        5252          DB      100T     ; x=000;=0.000v;=100KPA;=sensor failure
 F001      8E        5253          DB      142T     ; x=001;=0.020v;=11KPA
 F002      8E        5254          DB      142T     ; x=002;=0.039v;=12KPA
 F003      8E        5255          DB      142T     ; x=003;=0.059v;=13KPA
 F004      8D        5256          DB      141T     ; x=004;=0.078v;=14KPA
 F005      8D        5257          DB      141T     ; x=005;=0.098v;=15KPA
 F006      8C        5258          DB      140T     ; x=006;=0.118v;=16KPA
 F007      8C        5259          DB      140T     ; x=007;=0.137v;=17KPA
 F008      8B        5260          DB      139T     ; x=008;=0.157v;=18KPA
 F009      8B        5261          DB      139T     ; x=009;=0.176v;=19KPA
 F00A      8A        5262          DB      138T     ; x=010;=0.196v;=20KPA
 F00B      8A        5263          DB      138T     ; x=011;=0.216v;=21KPA
 F00C      89        5264          DB      137T     ; x=012;=0.235v;=22KPA
 F00D      89        5265          DB      137T     ; x=013;=0.255v;=23KPA
 F00E      88        5266          DB      136T     ; x=014;=0.275v;=24KPA
 F00F      88        5267          DB      136T     ; x=015;=0.294v;=25KPA
 F010      88        5268          DB      136T     ; x=016;=0.314v;=26KPA
 F011      87        5269          DB      135T     ; x=017;=0.333v;=27KPA
 F012      87        5270          DB      135T     ; x=018;=0.353v;=28KPA
 F013      86        5271          DB      134T     ; x=019;=0.373v;=29KPA
 F014      86        5272          DB      134T     ; x=020;=0.392v;=30KPA
 F015      85        5273          DB      133T     ; x=021;=0.412v;=31KPA
 F016      85        5274          DB      133T     ; x=022;=0.431v;=32KPA
 F017      84        5275          DB      132T     ; x=023;=0.451v;=33KPA
 F018      84        5276          DB      132T     ; x=024;=0.471v;=34KPA
 F019      83        5277          DB      131T     ; x=025;=0.490v;=35KPA
 F01A      83        5278          DB      131T     ; x=026;=0.510v;=35KPA
 F01B      82        5279          DB      130T     ; x=027;=0.529v;=36KPA
 F01C      82        5280          DB      130T     ; x=028;=0.549v;=37KPA
 F01D      82        5281          DB      130T     ; x=029;=0.569v;=38KPA
 F01E      81        5282          DB      129T     ; x=030;=0.588v;=39KPA
 F01F      81        5283          DB      129T     ; x=031;=0.608v;=40KPA
 F020      80        5284          DB      128T     ; x=032;=0.627v;=41KPA
 F021      80        5285          DB      128T     ; x=033;=0.647v;=42KPA
 F022      7F        5286          DB      127T     ; x=034;=0.667v;=43KPA
 F023      7F        5287          DB      127T     ; x=035;=0.686v;=44KPA
 F024      7E        5288          DB      126T     ; x=036;=0.706v;=45KPA
 F025      7E        5289          DB      126T     ; x=037;=0.725v;=46KPA
 F026      7D        5290          DB      125T     ; x=038;=0.745v;=47KPA
 F027      7D        5291          DB      125T     ; x=039;=0.765v;=48KPA
 F028      7C        5292          DB      124T     ; x=040;=0.784v;=49KPA
 F029      7C        5293          DB      124T     ; x=041;=0.804v;=50KPA
 F02A      7C        5294          DB      124T     ; x=042;=0.824v;=51KPA
 F02B      7B        5295          DB      123T     ; x=043;=0.843v;=52KPA
 F02C      7B        5296          DB      123T     ; x=044;=0.863v;=53KPA
 F02D      7A        5297          DB      122T     ; x=045;=0.882v;=54KPA
 F02E      7A        5298          DB      122T     ; x=046;=0.902v;=55KPA
 F02F      79        5299          DB      121T     ; x=047;=0.922v;=56KPA
 F030      79        5300          DB      121T     ; x=048;=0.941v;=57KPA
 F031      78        5301          DB      120T     ; x=049;=0.961v;=58KPA
 F032      78        5302          DB      120T     ; x=050;=0.980v;=59KPA
 F033      77        5303          DB      119T     ; x=051;=1.000v;=60KPA
 F034      77        5304          DB      119T     ; x=052;=1.020v;=61KPA
 F035      76        5305          DB      118T     ; x=053;=1.039v;=62KPA
 F036      76        5306          DB      118T     ; x=054;=1.059v;=63KPA
 F037      76        5307          DB      118T     ; x=055;=1.078v;=64KPA
 F038      75        5308          DB      117T     ; x=056;=1.096v;=65KPA
 F039      75        5309          DB      117T     ; x=057;=1.118v;=66KPA
 F03A      74        5310          DB      116T     ; x=058;=1.137v;=67KPA
 F03B      74        5311          DB      116T     ; x=059;=1.157v;=68KPA
 F03C      73        5312          DB      115T     ; x=060;=1.176v;=69KPA
 F03D      73        5313          DB      115T     ; x=061;=1,196v;=70KPA
 F03E      72        5314          DB      114T     ; x=062;=1,216v;=71KPA
 F03F      72        5315          DB      114T     ; x=063;=1.235v;=72KPA
 F040      71        5316          DB      113T     ; x=064;=1.255v;=73KPA
 F041      71        5317          DB      113T     ; x=065;=1.275v;=74KPA
 F042      70        5318          DB      112T     ; x=066;=1.294v;=75KPA
 F043      70        5319          DB      112T     ; x=067;=1.314v;=76KPA
 F044      70        5320          DB      112T     ; x=068;=1.333v;=77KPA
 F045      6F        5321          DB      111T     ; x=069;=1.353v;=78KPA
 F046      6F        5322          DB      111T     ; x=070;=1.373v;=79KPA
 F047      6E        5323          DB      110T     ; x=071;=1.392v;=80KPA
 F048      6E        5324          DB      110T     ; x=072;=1.412v;=81KPA
 F049      6D        5325          DB      109T     ; x=073;=1.431v;=82KPA
 F04A      6D        5326          DB      109T     ; x=074;=1.451v;=83KPA
 F04B      6C        5327          DB      108T     ; x=075;=1.471v;=84KPA
 F04C      6C        5328          DB      108T     ; x=076;=1.490v;=85KPA
 F04D      6B        5329          DB      107T     ; x=077;=1.510v;=85KPA
 F04E      6B        5330          DB      107T     ; x=078;=1.529v;=86KPA
 F04F      6A        5331          DB      106T     ; x=079;=1.549v;=87KPA
 F050      6A        5332          DB      106T     ; x=080;=1.569v;=88KPA
 F051      6A        5333          DB      106T     ; x=081;=1.588v;=89KPA
 F052      69        5334          DB      105T     ; x=082;=1.608v;=90KPA
 F053      69        5335          DB      105T     ; x=083;=1.627v;=91KPA
 F054      68        5336          DB      104T     ; x=084;=1.647v;=92KPA
 F055      68        5337          DB      104T     ; x=085;=1.667v;=93KPA
 F056      67        5338          DB      103T     ; x=086;=1.686v;=94KPA
 F057      67        5339          DB      103T     ; x=087;=1.706v;=95KPA
 F058      66        5340          DB      102T     ; x=088;=1.725v;=96KPA
 F059      66        5341          DB      102T     ; x=089;=1.745v;=97KPA
 F05A      65        5342          DB      101T     ; x=090;=1.765v;=98KPA
 F05B      65        5343          DB      101T     ; x=091;=1.784v;=99KPA
 F05C      64        5344          DB      100T     ; x=092;=1.804v;=100KPA
 F05D      64        5345          DB      100T     ; x=093;=1.824v;=101KPA
 F05E      64        5346          DB      100T     ; x=094;=1.843v;=102KPA
 F05F      63        5347          DB      99T      ; x=095;=1.863v;=103KPA
 F060      63        5348          DB      99T      ; x=096;=1.882v;=104KPA
 F061      62        5349          DB      98T      ; x=097;=1.902v;=105KPA
 F062      62        5350          DB      98T      ; x=098;=1.922v;=106KPA
 F063      61        5351          DB      97T      ; x=099;=1.941v;=107KPA
 F064      61        5352          DB      97T      ; x=100;=1.961v;=108KPA


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 42
MC68HC908GP32 User Bootloader


 F065      60        5353          DB      96T      ; x=101;=1.980v;=109KPA
 F066      60        5354          DB      96T      ; x=102;=2.000v;=110KPA
 F067      5F        5355          DB      95T      ; x=103;=2.020v;=111KPA
 F068      5F        5356          DB      95T      ; x=104;=2.039v;=112KPA
 F069      5E        5357          DB      94T      ; x=105;=2.059v;=113KPA
 F06A      5E        5358          DB      94T      ; x=106;=2.078v;=114KPA
 F06B      5E        5359          DB      94T      ; x=107;=2.098v;=115KPA
 F06C      5D        5360          DB      93T      ; x=108;=2.118v;=116KPA
 F06D      5D        5361          DB      93T      ; x=109;=2.137v;=117KPA
 F06E      5C        5362          DB      92T      ; x=110;=2.157v;=118KPA
 F06F      5C        5363          DB      92T      ; x=111;=2.176v;=119KPA
 F070      5B        5364          DB      91T      ; x=112;=2.196v;=120KPA
 F071      5B        5365          DB      91T      ; x=113;=2.216v;=121KPA
 F072      5A        5366          DB      90T      ; x=114;=2.235v;=122KPA
 F073      5A        5367          DB      90T      ; x=115;=2.255v;=123KPA
 F074      59        5368          DB      89T      ; x=116;=2.275v;=124KPA
 F075      59        5369          DB      89T      ; x=117;=2.294v;=125KPA
 F076      58        5370          DB      88T      ; x=118;=2.314v;=126KPA
 F077      58        5371          DB      88T      ; x=119;=2.333v;=127KPA
 F078      58        5372          DB      88T      ; x=120;=2.353v;=128KPA
 F079      57        5373          DB      87T      ; x=121;=2.373v;=129KPA
 F07A      57        5374          DB      87T      ; x=122;=2.392v;=130KPA
 F07B      56        5375          DB      86T      ; x=123;=2.412v;=131KPA
 F07C      56        5376          DB      86T      ; x=124;=2.431v;=132KPA
 F07D      55        5377          DB      85T      ; x=125;=2.451v;=133KPA
 F07E      55        5378          DB      85T      ; x=126;=2.471v;=134KPA
 F07F      54        5379          DB      84T      ; x=127;=2.490v;=135KPA
 F080      54        5380          DB      84T      ; x=128;=2.510v;=135KPA
 F081      53        5381          DB      83T      ; x=129;=2.529v;=136KPA
 F082      53        5382          DB      83T      ; x=130;=2.549v;=137KPA
 F083      52        5383          DB      82T      ; x=131;=2.569v;=138KPA
 F084      52        5384          DB      82T      ; x=132;=2.588v;=139KPA
 F085      52        5385          DB      82T      ; x=133;=2.608v;=140KPA
 F086      51        5386          DB      81T      ; x=134;=2.627v;=141KPA
 F087      51        5387          DB      81T      ; x=135;=2.647v;=142KPA
 F088      50        5388          DB      80T      ; x=136;=2.667v;=143KPA
 F089      50        5389          DB      80T      ; x=137;=2.686v;=144KPA
 F08A      4F        5390          DB      79T      ; x=138;=2.706v;=145KPA
 F08B      4F        5391          DB      79T      ; x=139;=2.725v;=146KPA
 F08C      4E        5392          DB      78T      ; x=140;=2.745v;=147KPA
 F08D      4E        5393          DB      78T      ; x=141;=2.765v;=148KPA
 F08E      4D        5394          DB      77T      ; x=142;=2.784v;=149KPA
 F08F      4D        5395          DB      77T      ; x=143;=2.804v;=150KPA
 F090      4C        5396          DB      76T      ; x=144;=0.824v;=151KPA
 F091      4C        5397          DB      76T      ; x=145;=2.843v;=152KPA
 F092      4C        5398          DB      76T      ; x=146;=2.863v;=153KPA
 F093      4B        5399          DB      75T      ; x=147;=2.882v;=154KPA
 F094      4B        5400          DB      75T      ; x=148;=2.902v;=155KPA
 F095      4A        5401          DB      74T      ; x=149;=2.922v;=156KPA
 F096      4A        5402          DB      74T      ; x=150;=2.941v;=157KPA
 F097      49        5403          DB      73T      ; x=151;=2.961v;=158KPA
 F098      49        5404          DB      73T      ; x=152;=2.980v;=159KPA
 F099      48        5405          DB      72T      ; x=153;=3.000v;=160KPA
 F09A      48        5406          DB      72T      ; x=154;=3.020v;=161KPA
 F09B      47        5407          DB      71T      ; x=155;=3.039v;=162KPA
 F09C      47        5408          DB      71T      ; x=156;=3.059v;=163KPA
 F09D      46        5409          DB      70T      ; x=157;=3.078v;=164KPA
 F09E      46        5410          DB      70T      ; x=158;=3.098v;=165KPA
 F09F      46        5411          DB      70T      ; x=159;=3.118v;=166KPA
 F0A0      45        5412          DB      69T      ; x=160;=3.137v;=167KPA
 F0A1      45        5413          DB      69T      ; x=161;=3.157v;=168KPA
 F0A2      44        5414          DB      68T      ; x=162;=3.176v;=169KPA
 F0A3      44        5415          DB      68T      ; x=163;=3.196v;=170KPA
 F0A4      43        5416          DB      67T      ; x=164;=3.216v;=171KPA
 F0A5      43        5417          DB      67T      ; x=165;=3.235v;=172KPA
 F0A6      42        5418          DB      66T      ; x=166;=3.255v;=173KPA
 F0A7      42        5419          DB      66T      ; x=167;=3.275v;=174KPA
 F0A8      41        5420          DB      65T      ; x=168;=3.294v;=175KPA
 F0A9      41        5421          DB      65T      ; x=169;=3.314v;=176KPA
 F0AA      40        5422          DB      64T      ; x=170;=3.333v;=177KPA
 F0AB      40        5423          DB      64T      ; x=171;=3.353v;=178KPA
 F0AC      40        5424          DB      64T      ; x=172;=3.373v;=179KPA
 F0AD      3F        5425          DB      63T      ; x=173;=3.392v;=180KPA
 F0AE      3F        5426          DB      63T      ; x=174;=3.412v;=181KPA
 F0AF      3E        5427          DB      62T      ; x=175;=3.431v;=1823KPA
 F0B0      3E        5428          DB      62T      ; x=176;=3.451v;=183KPA
 F0B1      3D        5429          DB      61T      ; x=177;=3.471v;=184KPA
 F0B2      3D        5430          DB      61T      ; x=178;=3.490v;=185KPA
 F0B3      3C        5431          DB      60T      ; x=179;=3.510v;=185KPA
 F0B4      3C        5432          DB      60T      ; x=180;=3.529v;=186KPA
 F0B5      3B        5433          DB      59T      ; x=181;=3.549v;=187KPa
 F0B6      3B        5434          DB      59T      ; x=182;=3.569v;=188KPA
 F0B7      3A        5435          DB      58T      ; x=183;=3.588v;=189KPA
 F0B8      3A        5436          DB      58T      ; x=184;=3.608v;=190KPA
 F0B9      3A        5437          DB      58T      ; x=185;=3.627v;=191KPA
 F0BA      39        5438          DB      57T      ; x=186;=3.647v;=192KPA
 F0BB      39        5439          DB      57T      ; x=187;=3.667v;=193KPA
 F0BC      38        5440          DB      56T      ; x=188;=3.686v;=194KPA
 F0BD      38        5441          DB      56T      ; x=189;=3.706v;=195KPA
 F0BE      37        5442          DB      55T      ; x=190;=3.725v;=196KPA
 F0BF      37        5443          DB      55T      ; x=191;=3.745v;=197KPA
 F0C0      36        5444          DB      54T      ; x=192;=3.765v;=198KPA
 F0C1      36        5445          DB      54T      ; x=193;=3.784v;=199KPA
 F0C2      35        5446          DB      53T      ; x=194;=3.804v;=200KPA
 F0C3      35        5447          DB      53T      ; x=195;=3.824v;=201KPA
 F0C4      34        5448          DB      52T      ; x=196;=3.843v;=202KPA
 F0C5      34        5449          DB      52T      ; x=197;=3.863v;=203KPA
 F0C6      34        5450          DB      52T      ; x=198;=3.882v;=204KPA
 F0C7      33        5451          DB      51T      ; x=199;=3.902v;=205KPA
 F0C8      33        5452          DB      51T      ; x=200;=3.922v;=206KPA
 F0C9      32        5453          DB      50T      ; x=201;=3.941v;=207KPA
 F0CA      32        5454          DB      50T      ; x=202;=3.961v;=208KPA
 F0CB      31        5455          DB      49T      ; x=203;=3.980v;=209KPA
 F0CC      31        5456          DB      49T      ; x=204;=4.000v;=210KPA
 F0CD      30        5457          DB      48T      ; x=205;=4.020v;=211KPA
 F0CE      30        5458          DB      48T      ; x=206;=4.039v;=212KPA
 F0CF      2F        5459          DB      47T      ; x=207;=4.059v;=213KPA
 F0D0      2F        5460          DB      47T      ; x=208;=4.078v;=214KPA
 F0D1      2E        5461          DB      46T      ; x=209;=4.098v;=215KPA
 F0D2      2E        5462          DB      46T      ; x=210;=4.118v;=216KPA
 F0D3      2E        5463          DB      46T      ; x=211;=4.137v;=217KPA
 F0D4      2D        5464          DB      45T      ; x=212;=4.157v;=218KPA
 F0D5      2D        5465          DB      45T      ; x=213;=4.176v;=219KPA
 F0D6      2C        5466          DB      44T      ; x=214;=4.196v;=220KPA
 F0D7      2C        5467          DB      44T      ; x=215;=4.216v;=221KPA
 F0D8      2B        5468          DB      43T      ; x=216;=4.235v;=222KPA
 F0D9      2B        5469          DB      43T      ; x=217;=4.255v;=223KPA
 F0DA      2A        5470          DB      42T      ; x=218;=4.275v;=224KPA
 F0DB      2A        5471          DB      42T      ; x=219;=4.294v;=225KPA
 F0DC      29        5472          DB      41T      ; x=220;=4.314v;=226KPA
 F0DD      29        5473          DB      41T      ; x=221;=4.333v;=227KPA
 F0DE      28        5474          DB      40T      ; x=222;=4.353v;=228KPA
 F0DF      28        5475          DB      40T      ; x=223;=4.373v;=229KPA
 F0E0      28        5476          DB      40T      ; x=224;=4.392v;=230KPA
 F0E1      27        5477          DB      39T      ; x=225;=4.412v;=231KPA
 F0E2      27        5478          DB      39T      ; x=226;=4.431v;=232KPA
 F0E3      26        5479          DB      38T      ; x=227;=4.451v;=233KPA
 F0E4      26        5480          DB      38T      ; x=228;=4.471v;=234KPA
 F0E5      25        5481          DB      37T      ; x=229;=4.490v;=235KPA
 F0E6      25        5482          DB      37T      ; x=230;=4.510v;=235KPA
 F0E7      24        5483          DB      36T      ; x=231;=4.529v;=236KPA
 F0E8      24        5484          DB      36T      ; x=232;=4.549v;=237KPA
 F0E9      23        5485          DB      35T      ; x=233;=4.569v;=238KPA
 F0EA      23        5486          DB      35T      ; x=234;=4.588v;=239KPA
 F0EB      22        5487          DB      34T      ; x=235;=4.608v;=240KPA
 F0EC      22        5488          DB      34T      ; x=236;=4.627v;=241KPA


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 43
MC68HC908GP32 User Bootloader


 F0ED      22        5489          DB      34T      ; x=237;=4.647v;=242KPA
 F0EE      21        5490          DB      33T      ; x=238;=4.667v;=243KPA
 F0EF      21        5491          DB      33T      ; x=239;=4.686v;=244KPA
 F0F0      20        5492          DB      32T      ; x=240;=4.706v;=245KPA
 F0F1      20        5493          DB      32T      ; x=241;=4.725v;=246KPA
 F0F2      1F        5494          DB      31T      ; x=242;=4.745v;=247KPA
 F0F3      1F        5495          DB      31T      ; x=243;=4.765v;=248KPA
 F0F4      1E        5496          DB      30T      ; x=244;=4.784v;=249KPA
 F0F5      1E        5497          DB      30T      ; x=245;=4.804v;=250KPA
 F0F6      1D        5498          DB      29T      ; x=246;=4.824v;=251KPA
 F0F7      1D        5499          DB      29T      ; x=247;=4.843v;=252KPA
 F0F8      1C        5500          DB      28T      ; x=248;=4.863v;=253KPA
 F0F9      1C        5501          DB      28T      ; x=249;=4.882v;=254KPA
 F0FA      1C        5502          DB      28T      ; x=250;=4.902v;=255KPA
 F0FB      1B        5503          DB      27T      ; x=251;=4.922v;=256KPA
 F0FC      1B        5504          DB      27T      ; x=252;=4.941v;=257KPA
 F0FD      1A        5505          DB      26T      ; x=253;=4.961v;=258KPA
 F0FE      1A        5506          DB      26T      ; x=254;=4.980v;=259KPA
 F0FF      64        5507          DB      100T     ; x=255;=5.000v;=100KPA;=sensor fail
                     5508                                        ; factor in %
                     5509  
 F100                5510       include "kpafactor4250rjh.inc"   ; Converts Manifold Absolute Pressure ADC and Barometric
                     5511  KPAFACTOR4250rjh:
 F100      64        5512          DB      100T     ; x=000;=0.000v;sensor failure
 F101      0B        5513          DB      11T      ; x=001;=0.020v
 F102      0C        5514          DB      12T      ; x=002;=0.039v
 F103      0D        5515          DB      13T      ; x=003;=0.059v
 F104      0E        5516          DB      14T      ; x=004;=0.078v
 F105      0F        5517          DB      15T      ; x=005;=0.098v
 F106      10        5518          DB      16T      ; x=006;=0.118v
 F107      11        5519          DB      17T      ; x=007;=0.137v
 F108      12        5520          DB      18T      ; x=008;=0.157v
 F109      13        5521          DB      19T      ; x=009;=0.176v
 F10A      14        5522          DB      20T      ; x=010;=0.196v
 F10B      15        5523          DB      21T      ; x=011;=0.216v
 F10C      16        5524          DB      22T      ; x=012;=0.235v
 F10D      17        5525          DB      23T      ; x=013;=0.255v
 F10E      18        5526          DB      24T      ; x=014;=0.275v
 F10F      19        5527          DB      25T      ; x=015;=0.294v
 F110      1A        5528          DB      26T      ; x=016;=0.314v
 F111      1B        5529          DB      27T      ; x=017;=0.333v
 F112      1C        5530          DB      28T      ; x=018;=0.353v
 F113      1D        5531          DB      29T      ; x=019;=0.373v
 F114      1E        5532          DB      30T      ; x=020;=0.392v
 F115      1F        5533          DB      31T      ; x=021;=0.412v
 F116      20        5534          DB      32T      ; x=022;=0.431v
 F117      21        5535          DB      33T      ; x=023;=0.451v
 F118      22        5536          DB      34T      ; x=024;=0.471v
 F119      23        5537          DB      35T      ; x=025;=0.490v
 F11A      23        5538          DB      35T      ; x=026;=0.510v
 F11B      24        5539          DB      36T      ; x=027;=0.529v
 F11C      25        5540          DB      37T      ; x=028;=0.549v
 F11D      26        5541          DB      38T      ; x=029;=0.569v
 F11E      27        5542          DB      39T      ; x=030;=0.588v
 F11F      28        5543          DB      40T      ; x=031;=0.608v
 F120      29        5544          DB      41T      ; x=032;=0.627v
 F121      2A        5545          DB      42T      ; x=033;=0.647v
 F122      2B        5546          DB      43T      ; x=034;=0.667v
 F123      2C        5547          DB      44T      ; x=035;=0.686v
 F124      2D        5548          DB      45T      ; x=036;=0.706v
 F125      2E        5549          DB      46T      ; x=037;=0.725v
 F126      2F        5550          DB      47T      ; x=038;=0.745v
 F127      30        5551          DB      48T      ; x=039;=0.765v
 F128      31        5552          DB      49T      ; x=040;=0.784v
 F129      32        5553          DB      50T      ; x=041;=0.804v
 F12A      33        5554          DB      51T      ; x=042;=0.824v
 F12B      34        5555          DB      52T      ; x=043;=0.843v
 F12C      35        5556          DB      53T      ; x=044;=0.863v
 F12D      36        5557          DB      54T      ; x=045;=0.882v
 F12E      37        5558          DB      55T      ; x=046;=0.902v
 F12F      38        5559          DB      56T      ; x=047;=0.922v
 F130      39        5560          DB      57T      ; x=048;=0.941v
 F131      3A        5561          DB      58T      ; x=049;=0.961v
 F132      3B        5562          DB      59T      ; x=050;=0.980v
 F133      3C        5563          DB      60T      ; x=051;=1.000v
 F134      3D        5564          DB      61T      ; x=052;=1.020v
 F135      3E        5565          DB      62T      ; x=053;=1.039v
 F136      3F        5566          DB      63T      ; x=054;=1.059v
 F137      40        5567          DB      64T      ; x=055;=1.078v
 F138      41        5568          DB      65T      ; x=056;=1.096v
 F139      42        5569          DB      66T      ; x=057;=1.118v
 F13A      43        5570          DB      67T      ; x=058;=1.137v
 F13B      44        5571          DB      68T      ; x=059;=1.157v
 F13C      45        5572          DB      69T      ; x=060;=1.176v
 F13D      46        5573          DB      70T      ; x=061;=1,196v
 F13E      47        5574          DB      71T      ; x=062;=1,216v
 F13F      48        5575          DB      72T      ; x=063;=1.235v
 F140      49        5576          DB      73T      ; x=064;=1.255v
 F141      4A        5577          DB      74T      ; x=065;=1.275v
 F142      4B        5578          DB      75T      ; x=066;=1.294v
 F143      4C        5579          DB      76T      ; x=067;=1.314v
 F144      4D        5580          DB      77T      ; x=068;=1.333v
 F145      4E        5581          DB      78T      ; x=069;=1.353v
 F146      4F        5582          DB      79T      ; x=070;=1.373v
 F147      50        5583          DB      80T      ; x=071;=1.392v
 F148      51        5584          DB      81T      ; x=072;=1.412v
 F149      52        5585          DB      82T      ; x=073;=1.431v
 F14A      53        5586          DB      83T      ; x=074;=1.451v
 F14B      54        5587          DB      84T      ; x=075;=1.471v
 F14C      55        5588          DB      85T      ; x=076;=1.490v
 F14D      55        5589          DB      85T      ; x=077;=1.510v
 F14E      56        5590          DB      86T      ; x=078;=1.529v
 F14F      57        5591          DB      87T      ; x=079;=1.549v
 F150      58        5592          DB      88T      ; x=080;=1.569v
 F151      59        5593          DB      89T      ; x=081;=1.588v
 F152      5A        5594          DB      90T      ; x=082;=1.608v
 F153      5B        5595          DB      91T      ; x=083;=1.627v
 F154      5C        5596          DB      92T      ; x=084;=1.647v
 F155      5D        5597          DB      93T      ; x=085;=1.667v
 F156      5E        5598          DB      94T      ; x=086;=1.686v
 F157      5F        5599          DB      95T      ; x=087;=1.706v
 F158      60        5600          DB      96T      ; x=088;=1.725v
 F159      61        5601          DB      97T      ; x=089;=1.745v
 F15A      62        5602          DB      98T      ; x=090;=1.765v
 F15B      63        5603          DB      99T      ; x=091;=1.784v
 F15C      64        5604          DB      100T     ; x=092;=1.804v
 F15D      65        5605          DB      101T     ; x=093;=1.824v
 F15E      66        5606          DB      102T     ; x=094;=1.843v
 F15F      67        5607          DB      103T     ; x=095;=1.863v
 F160      68        5608          DB      104T     ; x=096;=1.882v
 F161      69        5609          DB      105T     ; x=097;=1.902v
 F162      6A        5610          DB      106T     ; x=098;=1.922v
 F163      6B        5611          DB      107T     ; x=099;=1.941v
 F164      6C        5612          DB      108T     ; x=100;=1.961v
 F165      6D        5613          DB      109T     ; x=101;=1.980v
 F166      6E        5614          DB      110T     ; x=102;=2.000v
 F167      6F        5615          DB      111T     ; x=103;=2.020v
 F168      70        5616          DB      112T     ; x=104;=2.039v
 F169      71        5617          DB      113T     ; x=105;=2.059v
 F16A      72        5618          DB      114T     ; x=106;=2.078v
 F16B      73        5619          DB      115T     ; x=107;=2.098v
 F16C      74        5620          DB      116T     ; x=108;=2.118v
 F16D      75        5621          DB      117T     ; x=109;=2.137v
 F16E      76        5622          DB      118T     ; x=110;=2.157v
 F16F      77        5623          DB      119T     ; x=111;=2.176v
 F170      78        5624          DB      120T     ; x=112;=2.196v


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 44
MC68HC908GP32 User Bootloader


 F171      79        5625          DB      121T     ; x=113;=2.216v
 F172      7A        5626          DB      122T     ; x=114;=2.235v
 F173      7B        5627          DB      123T     ; x=115;=2.255v
 F174      7C        5628          DB      124T     ; x=116;=2.275v
 F175      7D        5629          DB      125T     ; x=117;=2.294v
 F176      7E        5630          DB      126T     ; x=118;=2.314v
 F177      7F        5631          DB      127T     ; x=119;=2.333v
 F178      80        5632          DB      128T     ; x=120;=2.353v
 F179      81        5633          DB      129T     ; x=121;=2.373v
 F17A      82        5634          DB      130T     ; x=122;=2.392v
 F17B      83        5635          DB      131T     ; x=123;=2.412v
 F17C      84        5636          DB      132T     ; x=124;=2.431v
 F17D      85        5637          DB      133T     ; x=125;=2.451v
 F17E      86        5638          DB      134T     ; x=126;=2.471v
 F17F      87        5639          DB      135T     ; x=127;=2.490v
 F180      87        5640          DB      135T     ; x=128;=2.510v
 F181      88        5641          DB      136T     ; x=129;=2.529v
 F182      89        5642          DB      137T     ; x=130,=2.549v
 F183      8A        5643          DB      138T     ; x=131;=2.569v
 F184      8B        5644          DB      139T     ; x=132;=2.588v
 F185      8C        5645          DB      140T     ; x=133;=2.608v
 F186      8D        5646          DB      141T     ; x=134;=2.627v
 F187      8E        5647          DB      142T     ; x=135;=2.647v
 F188      8F        5648          DB      143T     ; x=136;=2.667v
 F189      90        5649          DB      144T     ; x=137;=2.686v
 F18A      91        5650          DB      145T     ; x=138;=2.706v
 F18B      92        5651          DB      146T     ; x=139;=2.725v
 F18C      93        5652          DB      147T     ; x=140;=2.745v
 F18D      94        5653          DB      148T     ; x=141;=2.765v
 F18E      95        5654          DB      149T     ; x=142;=2.784v
 F18F      96        5655          DB      150T     ; x=143;=2.804v
 F190      97        5656          DB      151T     ; x=144;=0.824v
 F191      98        5657          DB      152T     ; x=145;=2.843v
 F192      99        5658          DB      153T     ; x=146;=2.863v
 F193      9A        5659          DB      154T     ; x=147;=2.882v
 F194      9B        5660          DB      155T     ; x=148;=2.902v
 F195      9C        5661          DB      156T     ; x=149;=2.922v
 F196      9D        5662          DB      157T     ; x=150;=2.941v
 F197      9E        5663          DB      158T     ; x=151;=2.961v
 F198      9F        5664          DB      159T     ; x=152;=2.980v
 F199      A0        5665          DB      160T     ; x=153;=3.000v
 F19A      A1        5666          DB      161T     ; x=154;=3.020v
 F19B      A2        5667          DB      162T     ; x=155;=3.039v
 F19C      A3        5668          DB      163T     ; x=156;=3.059v
 F19D      A4        5669          DB      164T     ; x=157;=3.078v
 F19E      A5        5670          DB      165T     ; x=158;=3.098v
 F19F      A6        5671          DB      166T     ; x=159;=3.118v
 F1A0      A7        5672          DB      167T     ; x=160;=3.137v
 F1A1      A8        5673          DB      168T     ; x=161;=3.157v
 F1A2      A9        5674          DB      169T     ; x=162;=3.176v
 F1A3      AA        5675          DB      170T     ; x=163;=3.196v
 F1A4      AB        5676          DB      171T     ; x=164;=3.216v
 F1A5      AC        5677          DB      172T     ; x=165;=3.235v
 F1A6      AD        5678          DB      173T     ; x=166;=3.255v
 F1A7      AE        5679          DB      174T     ; x=167;=3.275v
 F1A8      AF        5680          DB      175T     ; x=168;=3.294v
 F1A9      B0        5681          DB      176T     ; x=169;=3.314v
 F1AA      B1        5682          DB      177T     ; x=170;=3.333v
 F1AB      B2        5683          DB      178T     ; x=171;=3.353v
 F1AC      B3        5684          DB      179T     ; x=172;=3.373v
 F1AD      B4        5685          DB      180T     ; x=173;=3.392v
 F1AE      B5        5686          DB      181T     ; x=174;=3.412v
 F1AF      B6        5687          DB      182T     ; x=175;=3.431v
 F1B0      B7        5688          DB      183T     ; x=176;=3.451v
 F1B1      B8        5689          DB      184T     ; x=177;=3.471v
 F1B2      B9        5690          DB      185T     ; x=178;=3.490v
 F1B3      B9        5691          DB      185T     ; x=179;=3.510v
 F1B4      BA        5692          DB      186T     ; x=180;=3.529v
 F1B5      BB        5693          DB      187T     ; x=181;=3.549v
 F1B6      BC        5694          DB      188T     ; x=182;=3.569v
 F1B7      BD        5695          DB      189T     ; x=183;=3.588v
 F1B8      BE        5696          DB      190T     ; x=184;=3.608v
 F1B9      BF        5697          DB      191T     ; x=185;=3.627v
 F1BA      C0        5698          DB      192T     ; x=186;=3.647v
 F1BB      C1        5699          DB      193T     ; x=187;=3.667v
 F1BC      C2        5700          DB      194T     ; x=188;=3.686v
 F1BD      C3        5701          DB      195T     ; x=189;=3.706v
 F1BE      C4        5702          DB      196T     ; x=190;=3.725v
 F1BF      C5        5703          DB      197T     ; x=191;=3.745v
 F1C0      C6        5704          DB      198T     ; x=192;=3.765v
 F1C1      C7        5705          DB      199T     ; x=193;=3.784v
 F1C2      C8        5706          DB      200T     ; x=194;=3.804v
 F1C3      C9        5707          DB      201T     ; x=195;=3.824v
 F1C4      CA        5708          DB      202T     ; x=196;=3.843v
 F1C5      CB        5709          DB      203T     ; x=197;=3.863v
 F1C6      CC        5710          DB      204T     ; x=198;=3.882v
 F1C7      CD        5711          DB      205T     ; x=199;=3.902v
 F1C8      CE        5712          DB      206T     ; x=200;=3.922v
 F1C9      CF        5713          DB      207T     ; x=201;=3.941v
 F1CA      D0        5714          DB      208T     ; x=202;=3.961v
 F1CB      D1        5715          DB      209T     ; x=203;=3.980v
 F1CC      D2        5716          DB      210T     ; x=204;=4.000v
 F1CD      D3        5717          DB      211T     ; x=205;=4.020v
 F1CE      D4        5718          DB      212T     ; x=206;=4.039v
 F1CF      D5        5719          DB      213T     ; x=207;=4.059v
 F1D0      D6        5720          DB      214T     ; x=208;=4.078v
 F1D1      D7        5721          DB      215T     ; x=209;=4.098v
 F1D2      D8        5722          DB      216T     ; x=210;=4.118v
 F1D3      D9        5723          DB      217T     ; x=211;=4.137v
 F1D4      DA        5724          DB      218T     ; x=212;=4.157v
 F1D5      DB        5725          DB      219T     ; x=213;=4.176v
 F1D6      DC        5726          DB      220T     ; x=214;=4.196v
 F1D7      DD        5727          DB      221T     ; x=215;=4.216v
 F1D8      DE        5728          DB      222T     ; x=216;=4.235v
 F1D9      DF        5729          DB      223T     ; x=217;=4.255v
 F1DA      E0        5730          DB      224T     ; x=218;=4.275v
 F1DB      E1        5731          DB      225T     ; x=219;=4.294v
 F1DC      E2        5732          DB      226T     ; x=220;=4.314v
 F1DD      E3        5733          DB      227T     ; x=221;=4.333v
 F1DE      E4        5734          DB      228T     ; x=222;=4.353v
 F1DF      E5        5735          DB      229T     ; x=223;=4.373v
 F1E0      E6        5736          DB      230T     ; x=224;=4.392v
 F1E1      E7        5737          DB      231T     ; x=225;=4.412v
 F1E2      E8        5738          DB      232T     ; x=226;=4.431v
 F1E3      E9        5739          DB      233T     ; x=227;=4.451v
 F1E4      EA        5740          DB      234T     ; x=228;=4.471v
 F1E5      EB        5741          DB      235T     ; x=229;=4.490v
 F1E6      EB        5742          DB      235T     ; x=230;=4.510v
 F1E7      EC        5743          DB      236T     ; x=231;=4.529v
 F1E8      ED        5744          DB      237T     ; x=232;=4.549v
 F1E9      EE        5745          DB      238T     ; x=233;=4.569v
 F1EA      EF        5746          DB      239T     ; x=234;=4.588v
 F1EB      F0        5747          DB      240T     ; x=235;=4.608v
 F1EC      F1        5748          DB      241T     ; x=236;=4.627v
 F1ED      F2        5749          DB      242T     ; x=237;=4.647v
 F1EE      F3        5750          DB      243T     ; x=238;=4.667v
 F1EF      F4        5751          DB      244T     ; x=239;=4.686v
 F1F0      F5        5752          DB      245T     ; x=240;=4.706v
 F1F1      F6        5753          DB      246T     ; x=241;=4.725v
 F1F2      F7        5754          DB      247T     ; x=242;=4.745v
 F1F3      F8        5755          DB      248T     ; x=243;=4.765v
 F1F4      F9        5756          DB      249T     ; x=244;=4.784v
 F1F5      FA        5757          DB      250T     ; x=245;=4.804v
 F1F6      FB        5758          DB      251T     ; x=246;=4.824v
 F1F7      FC        5759          DB      252T     ; x=247;=4.843v
 F1F8      FD        5760          DB      253T     ; x=248;=4.863v


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 45
MC68HC908GP32 User Bootloader


 F1F9      FE        5761          DB      254T     ; x=249;=4.882v
 F1FA      FF        5762          DB      255T     ; x=250;=4.902v
 F1FB      FF        5763          DB      255T     ; x=251;=4.922v
 F1FC      FF        5764          DB      255T     ; x=252;=4.941v
 F1FD      FF        5765          DB      255T     ; x=253;=4.961v
 F1FE      FF        5766          DB      255T     ; x=254;=4.980v
 F1FF      64        5767          DB      100T     ; x=255;=5.000v;sensor failure
                     5768                                        ; Pressure ADC Raw Reading to Pressure in KPA
                     5769  
 F200                5770       include "thermfactor.inc"     ; Converts Coolant Temperature ADC Raw Reading and Manifold
                     5771  ; Generated using EasyTherm4.exe
                     5772  ;
                     5773  ; Ford ECT
                     5774  ;
                     5775  ; ***** CAUTION - NON STD BIAS RESISTOR REQUIRED *****
                     5776  ; File generated for use with 22000 ohm resistor at R7
                     5777  ;
                     5778  ; Steinhart-Hart coefficients:  A= 9.34735E-04   B=2.2114E-04   C= 1.273387E-07
                     5779  ;
                     5780  ; Input Data:        Temp, degF      Resistance
                     5781  ;                50             58750
                     5782  ;               104             16150
                     5783  ;               212              2070
                     5784  ;
                     5785  
                     5786  THERMFACTOR:
                     5787                       ;    ADC  Temp, degF
 F200      D2        5788       DB      210T    ;     0    Sensor Failure - use 170 degF as default
 F201      FF        5789       DB      255T    ;     1    472.13
 F202      FF        5790       DB      255T    ;     2    400.72
 F203      FF        5791       DB      255T    ;     3    363.34
 F204      FF        5792       DB      255T    ;     4    338.48
 F205      FF        5793       DB      255T    ;     5    320.04
 F206      FF        5794       DB      255T    ;     6    305.49
 F207      FF        5795       DB      255T    ;     7    293.51
 F208      FF        5796       DB      255T    ;     8    283.36
 F209      FF        5797       DB      255T    ;     9    274.58
 F20A      FF        5798       DB      255T    ;    10    266.84
 F20B      FF        5799       DB      255T    ;    11    259.94
 F20C      FF        5800       DB      255T    ;    12    253.72
 F20D      FF        5801       DB      255T    ;    13    248.06
 F20E      FF        5802       DB      255T    ;    14    242.86
 F20F      FF        5803       DB      255T    ;    15    238.06
 F210      FF        5804       DB      255T    ;    16    233.61
 F211      FF        5805       DB      255T    ;    17    229.45
 F212      FF        5806       DB      255T    ;    18    225.56
 F213      FF        5807       DB      255T    ;    19    221.89
 F214      FF        5808       DB      255T    ;    20    218.43
 F215      FF        5809       DB      255T    ;    21    215.16
 F216      FC        5810       DB      252T    ;    22    212.05
 F217      F9        5811       DB      249T    ;    23    209.09
 F218      F6        5812       DB      246T    ;    24    206.26
 F219      F4        5813       DB      244T    ;    25    203.56
 F21A      F1        5814       DB      241T    ;    26    200.96
 F21B      EE        5815       DB      238T    ;    27    198.48
 F21C      EC        5816       DB      236T    ;    28    196.08
 F21D      EA        5817       DB      234T    ;    29    193.78
 F21E      E8        5818       DB      232T    ;    30    191.56
 F21F      E5        5819       DB      229T    ;    31    189.41
 F220      E3        5820       DB      227T    ;    32    187.33
 F221      E1        5821       DB      225T    ;    33    185.32
 F222      DF        5822       DB      223T    ;    34    183.38
 F223      DD        5823       DB      221T    ;    35    181.48
 F224      DC        5824       DB      220T    ;    36    179.65
 F225      DA        5825       DB      218T    ;    37    177.86
 F226      D8        5826       DB      216T    ;    38    176.12
 F227      D6        5827       DB      214T    ;    39    174.43
 F228      D5        5828       DB      213T    ;    40    172.78
 F229      D3        5829       DB      211T    ;    41    171.17
 F22A      D2        5830       DB      210T    ;    42    169.60
 F22B      D0        5831       DB      208T    ;    43    168.06
 F22C      CF        5832       DB      207T    ;    44    166.56
 F22D      CD        5833       DB      205T    ;    45    165.09
 F22E      CC        5834       DB      204T    ;    46    163.66
 F22F      CA        5835       DB      202T    ;    47    162.25
 F230      C9        5836       DB      201T    ;    48    160.87
 F231      C8        5837       DB      200T    ;    49    159.52
 F232      C6        5838       DB      198T    ;    50    158.19
 F233      C5        5839       DB      197T    ;    51    156.89
 F234      C4        5840       DB      196T    ;    52    155.61
 F235      C2        5841       DB      194T    ;    53    154.35
 F236      C1        5842       DB      193T    ;    54    153.12
 F237      C0        5843       DB      192T    ;    55    151.91
 F238      BF        5844       DB      191T    ;    56    150.71
 F239      BE        5845       DB      190T    ;    57    149.54
 F23A      BC        5846       DB      188T    ;    58    148.38
 F23B      BB        5847       DB      187T    ;    59    147.24
 F23C      BA        5848       DB      186T    ;    60    146.12
 F23D      B9        5849       DB      185T    ;    61    145.02
 F23E      B8        5850       DB      184T    ;    62    143.93
 F23F      B7        5851       DB      183T    ;    63    142.85
 F240      B6        5852       DB      182T    ;    64    141.79
 F241      B5        5853       DB      181T    ;    65    140.75
 F242      B4        5854       DB      180T    ;    66    139.72
 F243      B3        5855       DB      179T    ;    67    138.70
 F244      B2        5856       DB      178T    ;    68    137.69
 F245      B1        5857       DB      177T    ;    69    136.70
 F246      B0        5858       DB      176T    ;    70    135.71
 F247      AF        5859       DB      175T    ;    71    134.74
 F248      AE        5860       DB      174T    ;    72    133.78
 F249      AD        5861       DB      173T    ;    73    132.83
 F24A      AC        5862       DB      172T    ;    74    131.89
 F24B      AB        5863       DB      171T    ;    75    130.97
 F24C      AA        5864       DB      170T    ;    76    130.05
 F24D      A9        5865       DB      169T    ;    77    129.14
 F24E      A8        5866       DB      168T    ;    78    128.23
 F24F      A7        5867       DB      167T    ;    79    127.34
 F250      A6        5868       DB      166T    ;    80    126.46
 F251      A6        5869       DB      166T    ;    81    125.58
 F252      A5        5870       DB      165T    ;    82    124.71
 F253      A4        5871       DB      164T    ;    83    123.85
 F254      A3        5872       DB      163T    ;    84    123.00
 F255      A2        5873       DB      162T    ;    85    122.16
 F256      A1        5874       DB      161T    ;    86    121.32
 F257      A0        5875       DB      160T    ;    87    120.49
 F258      A0        5876       DB      160T    ;    88    119.66
 F259      9F        5877       DB      159T    ;    89    118.84
 F25A      9E        5878       DB      158T    ;    90    118.03
 F25B      9D        5879       DB      157T    ;    91    117.22
 F25C      9C        5880       DB      156T    ;    92    116.42
 F25D      9C        5881       DB      156T    ;    93    115.63
 F25E      9B        5882       DB      155T    ;    94    114.84
 F25F      9A        5883       DB      154T    ;    95    114.05
 F260      99        5884       DB      153T    ;    96    113.27
 F261      98        5885       DB      152T    ;    97    112.50
 F262      98        5886       DB      152T    ;    98    111.73
 F263      97        5887       DB      151T    ;    99    110.97
 F264      96        5888       DB      150T    ;   100    110.21
 F265      95        5889       DB      149T    ;   101    109.45
 F266      95        5890       DB      149T    ;   102    108.70
 F267      94        5891       DB      148T    ;   103    107.95
 F268      93        5892       DB      147T    ;   104    107.21
 F269      92        5893       DB      146T    ;   105    106.47
 F26A      92        5894       DB      146T    ;   106    105.73
 F26B      91        5895       DB      145T    ;   107    105.00
 F26C      90        5896       DB      144T    ;   108    104.27


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 46
MC68HC908GP32 User Bootloader


 F26D      90        5897       DB      144T    ;   109    103.54
 F26E      8F        5898       DB      143T    ;   110    102.82
 F26F      8E        5899       DB      142T    ;   111    102.10
 F270      8D        5900       DB      141T    ;   112    101.39
 F271      8D        5901       DB      141T    ;   113    100.67
 F272      8C        5902       DB      140T    ;   114     99.96
 F273      8B        5903       DB      139T    ;   115     99.26
 F274      8B        5904       DB      139T    ;   116     98.55
 F275      8A        5905       DB      138T    ;   117     97.85
 F276      89        5906       DB      137T    ;   118     97.15
 F277      88        5907       DB      136T    ;   119     96.45
 F278      88        5908       DB      136T    ;   120     95.75
 F279      87        5909       DB      135T    ;   121     95.06
 F27A      86        5910       DB      134T    ;   122     94.37
 F27B      86        5911       DB      134T    ;   123     93.68
 F27C      85        5912       DB      133T    ;   124     92.99
 F27D      84        5913       DB      132T    ;   125     92.31
 F27E      84        5914       DB      132T    ;   126     91.62
 F27F      83        5915       DB      131T    ;   127     90.94
 F280      82        5916       DB      130T    ;   128     90.26
 F281      82        5917       DB      130T    ;   129     89.58
 F282      81        5918       DB      129T    ;   130     88.90
 F283      80        5919       DB      128T    ;   131     88.22
 F284      80        5920       DB      128T    ;   132     87.54
 F285      7F        5921       DB      127T    ;   133     86.87
 F286      7E        5922       DB      126T    ;   134     86.19
 F287      7E        5923       DB      126T    ;   135     85.52
 F288      7D        5924       DB      125T    ;   136     84.85
 F289      7C        5925       DB      124T    ;   137     84.17
 F28A      7C        5926       DB      124T    ;   138     83.50
 F28B      7B        5927       DB      123T    ;   139     82.83
 F28C      7A        5928       DB      122T    ;   140     82.16
 F28D      79        5929       DB      121T    ;   141     81.49
 F28E      79        5930       DB      121T    ;   142     80.82
 F28F      78        5931       DB      120T    ;   143     80.15
 F290      77        5932       DB      119T    ;   144     79.48
 F291      77        5933       DB      119T    ;   145     78.81
 F292      76        5934       DB      118T    ;   146     78.14
 F293      75        5935       DB      117T    ;   147     77.47
 F294      75        5936       DB      117T    ;   148     76.80
 F295      74        5937       DB      116T    ;   149     76.13
 F296      73        5938       DB      115T    ;   150     75.46
 F297      73        5939       DB      115T    ;   151     74.79
 F298      72        5940       DB      114T    ;   152     74.12
 F299      71        5941       DB      113T    ;   153     73.44
 F29A      71        5942       DB      113T    ;   154     72.77
 F29B      70        5943       DB      112T    ;   155     72.10
 F29C      6F        5944       DB      111T    ;   156     71.42
 F29D      6F        5945       DB      111T    ;   157     70.74
 F29E      6E        5946       DB      110T    ;   158     70.07
 F29F      6D        5947       DB      109T    ;   159     69.39
 F2A0      6D        5948       DB      109T    ;   160     68.71
 F2A1      6C        5949       DB      108T    ;   161     68.03
 F2A2      6B        5950       DB      107T    ;   162     67.34
 F2A3      6B        5951       DB      107T    ;   163     66.66
 F2A4      6A        5952       DB      106T    ;   164     65.97
 F2A5      69        5953       DB      105T    ;   165     65.28
 F2A6      69        5954       DB      105T    ;   166     64.59
 F2A7      68        5955       DB      104T    ;   167     63.90
 F2A8      67        5956       DB      103T    ;   168     63.21
 F2A9      67        5957       DB      103T    ;   169     62.51
 F2AA      66        5958       DB      102T    ;   170     61.81
 F2AB      65        5959       DB      101T    ;   171     61.11
 F2AC      64        5960       DB      100T    ;   172     60.41
 F2AD      64        5961       DB      100T    ;   173     59.70
 F2AE      63        5962       DB       99T    ;   174     58.99
 F2AF      62        5963       DB       98T    ;   175     58.28
 F2B0      62        5964       DB       98T    ;   176     57.56
 F2B1      61        5965       DB       97T    ;   177     56.84
 F2B2      60        5966       DB       96T    ;   178     56.12
 F2B3      5F        5967       DB       95T    ;   179     55.39
 F2B4      5F        5968       DB       95T    ;   180     54.66
 F2B5      5E        5969       DB       94T    ;   181     53.93
 F2B6      5D        5970       DB       93T    ;   182     53.19
 F2B7      5C        5971       DB       92T    ;   183     52.45
 F2B8      5C        5972       DB       92T    ;   184     51.70
 F2B9      5B        5973       DB       91T    ;   185     50.95
 F2BA      5A        5974       DB       90T    ;   186     50.19
 F2BB      59        5975       DB       89T    ;   187     49.43
 F2BC      59        5976       DB       89T    ;   188     48.67
 F2BD      58        5977       DB       88T    ;   189     47.89
 F2BE      57        5978       DB       87T    ;   190     47.12
 F2BF      56        5979       DB       86T    ;   191     46.33
 F2C0      56        5980       DB       86T    ;   192     45.54
 F2C1      55        5981       DB       85T    ;   193     44.75
 F2C2      54        5982       DB       84T    ;   194     43.95
 F2C3      53        5983       DB       83T    ;   195     43.14
 F2C4      52        5984       DB       82T    ;   196     42.32
 F2C5      51        5985       DB       81T    ;   197     41.50
 F2C6      51        5986       DB       81T    ;   198     40.67
 F2C7      50        5987       DB       80T    ;   199     39.83
 F2C8      4F        5988       DB       79T    ;   200     38.98
 F2C9      4E        5989       DB       78T    ;   201     38.13
 F2CA      4D        5990       DB       77T    ;   202     37.26
 F2CB      4C        5991       DB       76T    ;   203     36.39
 F2CC      4C        5992       DB       76T    ;   204     35.50
 F2CD      4B        5993       DB       75T    ;   205     34.61
 F2CE      4A        5994       DB       74T    ;   206     33.70
 F2CF      49        5995       DB       73T    ;   207     32.79
 F2D0      48        5996       DB       72T    ;   208     31.86
 F2D1      47        5997       DB       71T    ;   209     30.92
 F2D2      46        5998       DB       70T    ;   210     29.97
 F2D3      45        5999       DB       69T    ;   211     29.00
 F2D4      44        6000       DB       68T    ;   212     28.02
 F2D5      43        6001       DB       67T    ;   213     27.02
 F2D6      42        6002       DB       66T    ;   214     26.01
 F2D7      41        6003       DB       65T    ;   215     24.99
 F2D8      40        6004       DB       64T    ;   216     23.94
 F2D9      3F        6005       DB       63T    ;   217     22.88
 F2DA      3E        6006       DB       62T    ;   218     21.80
 F2DB      3D        6007       DB       61T    ;   219     20.70
 F2DC      3C        6008       DB       60T    ;   220     19.58
 F2DD      3A        6009       DB       58T    ;   221     18.44
 F2DE      39        6010       DB       57T    ;   222     17.27
 F2DF      38        6011       DB       56T    ;   223     16.08
 F2E0      37        6012       DB       55T    ;   224     14.86
 F2E1      36        6013       DB       54T    ;   225     13.62
 F2E2      34        6014       DB       52T    ;   226     12.34
 F2E3      33        6015       DB       51T    ;   227     11.03
 F2E4      32        6016       DB       50T    ;   228      9.69
 F2E5      30        6017       DB       48T    ;   229      8.31
 F2E6      2F        6018       DB       47T    ;   230      6.90
 F2E7      2D        6019       DB       45T    ;   231      5.44
 F2E8      2C        6020       DB       44T    ;   232      3.93
 F2E9      2A        6021       DB       42T    ;   233      2.38
 F2EA      29        6022       DB       41T    ;   234       .77
 F2EB      27        6023       DB       39T    ;   235      -.90
 F2EC      25        6024       DB       37T    ;   236     -2.63
 F2ED      24        6025       DB       36T    ;   237     -4.43
 F2EE      22        6026       DB       34T    ;   238     -6.31
 F2EF      20        6027       DB       32T    ;   239     -8.28
 F2F0      1E        6028       DB       30T    ;   240    -10.34
 F2F1      1B        6029       DB       27T    ;   241    -12.51
 F2F2      19        6030       DB       25T    ;   242    -14.81
 F2F3      17        6031       DB       23T    ;   243    -17.24
 F2F4      14        6032       DB       20T    ;   244    -19.84


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 47
MC68HC908GP32 User Bootloader


 F2F5      11        6033       DB       17T    ;   245    -22.62
 F2F6      0E        6034       DB       14T    ;   246    -25.63
 F2F7      0B        6035       DB       11T    ;   247    -28.91
 F2F8      07        6036       DB        7T    ;   248    -32.51
 F2F9      03        6037       DB        3T    ;   249    -36.53
 F2FA      00        6038       DB        0T    ;   250    -41.08
 F2FB      00        6039       DB        0T    ;   251    -46.35
 F2FC      00        6040       DB        0T    ;   252    -52.64
 F2FD      00        6041       DB        0T    ;   253    -60.51
 F2FE      00        6042       DB        0T    ;   254    -71.20
 F2FF      D2        6043       DB      210T    ;   255    Sensor Failure - use 170 degF as default
                     6044                                     ; Air TemperatureRaw Reading to temp in degrees F +40
                     6045  
 F300                6046       include "airdenfactor.inc"    ; Converts Manifold Air Temp ADC Raw to air density
                     6047  ; Generated using EasyTherm4.exe,
                     6048  ;
                     6049  ; Ford IAT
                     6050  ;
                     6051  ; ***** CAUTION - NON STD BIAS RESISTOR REQUIRED *****
                     6052  ; File generated for use with 22000 ohm resistor at R4
                     6053  ;
                     6054  ; Steinhart-Hart coefficients:  A= 9.34735E-04   B=2.2114E-04   C= 1.273387E-07
                     6055  ;
                     6056  ; Input Data:        Temp, degF      Resistance
                     6057  ;                50             58750
                     6058  ;               104             16150
                     6059  ;               212              2070
                     6060  ;
                     6061  
                     6062  AIRDENFACTOR:
                     6063                       ;    ADC  Temp, degF
 F300      64        6064       DB      100T    ;     0    Sensor Failure - 100% applied
 F301      39        6065       DB       57T    ;     1    471.69
 F302      3D        6066       DB       61T    ;     2    400.35
 F303      40        6067       DB       64T    ;     3    362.99
 F304      42        6068       DB       66T    ;     4    338.15
 F305      44        6069       DB       68T    ;     5    319.73
 F306      45        6070       DB       69T    ;     6    305.18
 F307      46        6071       DB       70T    ;     7    293.21
 F308      47        6072       DB       71T    ;     8    283.07
 F309      48        6073       DB       72T    ;     9    274.29
 F30A      49        6074       DB       73T    ;    10    266.56
 F30B      49        6075       DB       73T    ;    11    259.66
 F30C      4A        6076       DB       74T    ;    12    253.44
 F30D      4B        6077       DB       75T    ;    13    247.78
 F30E      4B        6078       DB       75T    ;    14    242.59
 F30F      4C        6079       DB       76T    ;    15    237.79
 F310      4C        6080       DB       76T    ;    16    233.34
 F311      4D        6081       DB       77T    ;    17    229.19
 F312      4D        6082       DB       77T    ;    18    225.29
 F313      4E        6083       DB       78T    ;    19    221.63
 F314      4E        6084       DB       78T    ;    20    218.17
 F315      4E        6085       DB       78T    ;    21    214.90
 F316      4F        6086       DB       79T    ;    22    211.79
 F317      4F        6087       DB       79T    ;    23    208.83
 F318      4F        6088       DB       79T    ;    24    206.00
 F319      50        6089       DB       80T    ;    25    203.30
 F31A      50        6090       DB       80T    ;    26    200.71
 F31B      50        6091       DB       80T    ;    27    198.22
 F31C      51        6092       DB       81T    ;    28    195.83
 F31D      51        6093       DB       81T    ;    29    193.52
 F31E      51        6094       DB       81T    ;    30    191.30
 F31F      51        6095       DB       81T    ;    31    189.16
 F320      52        6096       DB       82T    ;    32    187.08
 F321      52        6097       DB       82T    ;    33    185.07
 F322      52        6098       DB       82T    ;    34    183.12
 F323      52        6099       DB       82T    ;    35    181.23
 F324      53        6100       DB       83T    ;    36    179.39
 F325      53        6101       DB       83T    ;    37    177.61
 F326      53        6102       DB       83T    ;    38    175.87
 F327      53        6103       DB       83T    ;    39    174.17
 F328      54        6104       DB       84T    ;    40    172.52
 F329      54        6105       DB       84T    ;    41    170.91
 F32A      54        6106       DB       84T    ;    42    169.34
 F32B      54        6107       DB       84T    ;    43    167.81
 F32C      54        6108       DB       84T    ;    44    166.31
 F32D      55        6109       DB       85T    ;    45    164.84
 F32E      55        6110       DB       85T    ;    46    163.40
 F32F      55        6111       DB       85T    ;    47    161.99
 F330      55        6112       DB       85T    ;    48    160.61
 F331      55        6113       DB       85T    ;    49    159.26
 F332      56        6114       DB       86T    ;    50    157.93
 F333      56        6115       DB       86T    ;    51    156.63
 F334      56        6116       DB       86T    ;    52    155.35
 F335      56        6117       DB       86T    ;    53    154.10
 F336      56        6118       DB       86T    ;    54    152.86
 F337      56        6119       DB       86T    ;    55    151.65
 F338      57        6120       DB       87T    ;    56    150.45
 F339      57        6121       DB       87T    ;    57    149.28
 F33A      57        6122       DB       87T    ;    58    148.12
 F33B      57        6123       DB       87T    ;    59    146.98
 F33C      57        6124       DB       87T    ;    60    145.86
 F33D      57        6125       DB       87T    ;    61    144.76
 F33E      58        6126       DB       88T    ;    62    143.67
 F33F      58        6127       DB       88T    ;    63    142.59
 F340      58        6128       DB       88T    ;    64    141.53
 F341      58        6129       DB       88T    ;    65    140.48
 F342      58        6130       DB       88T    ;    66    139.45
 F343      58        6131       DB       88T    ;    67    138.43
 F344      58        6132       DB       88T    ;    68    137.42
 F345      59        6133       DB       89T    ;    69    136.43
 F346      59        6134       DB       89T    ;    70    135.45
 F347      59        6135       DB       89T    ;    71    134.47
 F348      59        6136       DB       89T    ;    72    133.51
 F349      59        6137       DB       89T    ;    73    132.56
 F34A      59        6138       DB       89T    ;    74    131.62
 F34B      59        6139       DB       89T    ;    75    130.69
 F34C      5A        6140       DB       90T    ;    76    129.77
 F34D      5A        6141       DB       90T    ;    77    128.86
 F34E      5A        6142       DB       90T    ;    78    127.96
 F34F      5A        6143       DB       90T    ;    79    127.07
 F350      5A        6144       DB       90T    ;    80    126.18
 F351      5A        6145       DB       90T    ;    81    125.31
 F352      5A        6146       DB       90T    ;    82    124.44
 F353      5B        6147       DB       91T    ;    83    123.58
 F354      5B        6148       DB       91T    ;    84    122.72
 F355      5B        6149       DB       91T    ;    85    121.88
 F356      5B        6150       DB       91T    ;    86    121.04
 F357      5B        6151       DB       91T    ;    87    120.20
 F358      5B        6152       DB       91T    ;    88    119.38
 F359      5B        6153       DB       91T    ;    89    118.56
 F35A      5B        6154       DB       91T    ;    90    117.74
 F35B      5C        6155       DB       92T    ;    91    116.94
 F35C      5C        6156       DB       92T    ;    92    116.13
 F35D      5C        6157       DB       92T    ;    93    115.34
 F35E      5C        6158       DB       92T    ;    94    114.55
 F35F      5C        6159       DB       92T    ;    95    113.76
 F360      5C        6160       DB       92T    ;    96    112.98
 F361      5C        6161       DB       92T    ;    97    112.21
 F362      5C        6162       DB       92T    ;    98    111.44
 F363      5D        6163       DB       93T    ;    99    110.67
 F364      5D        6164       DB       93T    ;   100    109.91
 F365      5D        6165       DB       93T    ;   101    109.15
 F366      5D        6166       DB       93T    ;   102    108.40
 F367      5D        6167       DB       93T    ;   103    107.65
 F368      5D        6168       DB       93T    ;   104    106.91


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 48
MC68HC908GP32 User Bootloader


 F369      5D        6169       DB       93T    ;   105    106.16
 F36A      5D        6170       DB       93T    ;   106    105.43
 F36B      5E        6171       DB       94T    ;   107    104.69
 F36C      5E        6172       DB       94T    ;   108    103.96
 F36D      5E        6173       DB       94T    ;   109    103.24
 F36E      5E        6174       DB       94T    ;   110    102.51
 F36F      5E        6175       DB       94T    ;   111    101.79
 F370      5E        6176       DB       94T    ;   112    101.07
 F371      5E        6177       DB       94T    ;   113    100.36
 F372      5E        6178       DB       94T    ;   114     99.65
 F373      5F        6179       DB       95T    ;   115     98.94
 F374      5F        6180       DB       95T    ;   116     98.23
 F375      5F        6181       DB       95T    ;   117     97.53
 F376      5F        6182       DB       95T    ;   118     96.83
 F377      5F        6183       DB       95T    ;   119     96.13
 F378      5F        6184       DB       95T    ;   120     95.43
 F379      5F        6185       DB       95T    ;   121     94.73
 F37A      5F        6186       DB       95T    ;   122     94.04
 F37B      60        6187       DB       96T    ;   123     93.35
 F37C      60        6188       DB       96T    ;   124     92.66
 F37D      60        6189       DB       96T    ;   125     91.97
 F37E      60        6190       DB       96T    ;   126     91.28
 F37F      60        6191       DB       96T    ;   127     90.60
 F380      60        6192       DB       96T    ;   128     89.92
 F381      60        6193       DB       96T    ;   129     89.23
 F382      60        6194       DB       96T    ;   130     88.55
 F383      60        6195       DB       96T    ;   131     87.87
 F384      61        6196       DB       97T    ;   132     87.19
 F385      61        6197       DB       97T    ;   133     86.52
 F386      61        6198       DB       97T    ;   134     85.84
 F387      61        6199       DB       97T    ;   135     85.16
 F388      61        6200       DB       97T    ;   136     84.49
 F389      61        6201       DB       97T    ;   137     83.81
 F38A      61        6202       DB       97T    ;   138     83.14
 F38B      61        6203       DB       97T    ;   139     82.47
 F38C      62        6204       DB       98T    ;   140     81.79
 F38D      62        6205       DB       98T    ;   141     81.12
 F38E      62        6206       DB       98T    ;   142     80.45
 F38F      62        6207       DB       98T    ;   143     79.78
 F390      62        6208       DB       98T    ;   144     79.10
 F391      62        6209       DB       98T    ;   145     78.43
 F392      62        6210       DB       98T    ;   146     77.76
 F393      62        6211       DB       98T    ;   147     77.09
 F394      63        6212       DB       99T    ;   148     76.41
 F395      63        6213       DB       99T    ;   149     75.74
 F396      63        6214       DB       99T    ;   150     75.07
 F397      63        6215       DB       99T    ;   151     74.39
 F398      63        6216       DB       99T    ;   152     73.72
 F399      63        6217       DB       99T    ;   153     73.04
 F39A      63        6218       DB       99T    ;   154     72.36
 F39B      63        6219       DB       99T    ;   155     71.69
 F39C      64        6220       DB      100T    ;   156     71.01
 F39D      64        6221       DB      100T    ;   157     70.33
 F39E      64        6222       DB      100T    ;   158     69.65
 F39F      64        6223       DB      100T    ;   159     68.96
 F3A0      64        6224       DB      100T    ;   160     68.28
 F3A1      64        6225       DB      100T    ;   161     67.60
 F3A2      64        6226       DB      100T    ;   162     66.91
 F3A3      64        6227       DB      100T    ;   163     66.22
 F3A4      65        6228       DB      101T    ;   164     65.53
 F3A5      65        6229       DB      101T    ;   165     64.84
 F3A6      65        6230       DB      101T    ;   166     64.14
 F3A7      65        6231       DB      101T    ;   167     63.45
 F3A8      65        6232       DB      101T    ;   168     62.75
 F3A9      65        6233       DB      101T    ;   169     62.05
 F3AA      65        6234       DB      101T    ;   170     61.34
 F3AB      66        6235       DB      102T    ;   171     60.64
 F3AC      66        6236       DB      102T    ;   172     59.93
 F3AD      66        6237       DB      102T    ;   173     59.22
 F3AE      66        6238       DB      102T    ;   174     58.50
 F3AF      66        6239       DB      102T    ;   175     57.79
 F3B0      66        6240       DB      102T    ;   176     57.06
 F3B1      66        6241       DB      102T    ;   177     56.34
 F3B2      67        6242       DB      103T    ;   178     55.61
 F3B3      67        6243       DB      103T    ;   179     54.88
 F3B4      67        6244       DB      103T    ;   180     54.14
 F3B5      67        6245       DB      103T    ;   181     53.40
 F3B6      67        6246       DB      103T    ;   182     52.66
 F3B7      67        6247       DB      103T    ;   183     51.91
 F3B8      67        6248       DB      103T    ;   184     51.16
 F3B9      68        6249       DB      104T    ;   185     50.40
 F3BA      68        6250       DB      104T    ;   186     49.64
 F3BB      68        6251       DB      104T    ;   187     48.87
 F3BC      68        6252       DB      104T    ;   188     48.10
 F3BD      68        6253       DB      104T    ;   189     47.32
 F3BE      68        6254       DB      104T    ;   190     46.53
 F3BF      69        6255       DB      105T    ;   191     45.74
 F3C0      69        6256       DB      105T    ;   192     44.95
 F3C1      69        6257       DB      105T    ;   193     44.14
 F3C2      69        6258       DB      105T    ;   194     43.33
 F3C3      69        6259       DB      105T    ;   195     42.51
 F3C4      69        6260       DB      105T    ;   196     41.69
 F3C5      6A        6261       DB      106T    ;   197     40.86
 F3C6      6A        6262       DB      106T    ;   198     40.02
 F3C7      6A        6263       DB      106T    ;   199     39.17
 F3C8      6A        6264       DB      106T    ;   200     38.31
 F3C9      6A        6265       DB      106T    ;   201     37.44
 F3CA      6A        6266       DB      106T    ;   202     36.57
 F3CB      6B        6267       DB      107T    ;   203     35.68
 F3CC      6B        6268       DB      107T    ;   204     34.79
 F3CD      6B        6269       DB      107T    ;   205     33.88
 F3CE      6B        6270       DB      107T    ;   206     32.96
 F3CF      6B        6271       DB      107T    ;   207     32.03
 F3D0      6C        6272       DB      108T    ;   208     31.09
 F3D1      6C        6273       DB      108T    ;   209     30.14
 F3D2      6C        6274       DB      108T    ;   210     29.17
 F3D3      6C        6275       DB      108T    ;   211     28.19
 F3D4      6C        6276       DB      108T    ;   212     27.19
 F3D5      6D        6277       DB      109T    ;   213     26.18
 F3D6      6D        6278       DB      109T    ;   214     25.15
 F3D7      6D        6279       DB      109T    ;   215     24.11
 F3D8      6D        6280       DB      109T    ;   216     23.05
 F3D9      6E        6281       DB      110T    ;   217     21.97
 F3DA      6E        6282       DB      110T    ;   218     20.86
 F3DB      6E        6283       DB      110T    ;   219     19.74
 F3DC      6E        6284       DB      110T    ;   220     18.60
 F3DD      6F        6285       DB      111T    ;   221     17.43
 F3DE      6F        6286       DB      111T    ;   222     16.24
 F3DF      6F        6287       DB      111T    ;   223     15.02
 F3E0      70        6288       DB      112T    ;   224     13.77
 F3E1      70        6289       DB      112T    ;   225     12.49
 F3E2      70        6290       DB      112T    ;   226     11.18
 F3E3      70        6291       DB      112T    ;   227      9.84
 F3E4      71        6292       DB      113T    ;   228      8.46
 F3E5      71        6293       DB      113T    ;   229      7.04
 F3E6      72        6294       DB      114T    ;   230      5.58
 F3E7      72        6295       DB      114T    ;   231      4.07
 F3E8      72        6296       DB      114T    ;   232      2.52
 F3E9      73        6297       DB      115T    ;   233       .91
 F3EA      73        6298       DB      115T    ;   234      -.76
 F3EB      74        6299       DB      116T    ;   235     -2.49
 F3EC      74        6300       DB      116T    ;   236     -4.30
 F3ED      74        6301       DB      116T    ;   237     -6.18
 F3EE      75        6302       DB      117T    ;   238     -8.15
 F3EF      76        6303       DB      118T    ;   239    -10.21
 F3F0      76        6304       DB      118T    ;   240    -12.38


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 49
MC68HC908GP32 User Bootloader


 F3F1      77        6305       DB      119T    ;   241    -14.68
 F3F2      77        6306       DB      119T    ;   242    -17.11
 F3F3      78        6307       DB      120T    ;   243    -19.71
 F3F4      79        6308       DB      121T    ;   244    -22.50
 F3F5      7A        6309       DB      122T    ;   245    -25.51
 F3F6      7B        6310       DB      123T    ;   246    -28.79
 F3F7      7C        6311       DB      124T    ;   247    -32.39
 F3F8      7D        6312       DB      125T    ;   248    -36.41
 F3F9      7E        6313       DB      126T    ;   249    -40.96
 F3FA      80        6314       DB      128T    ;   250    -46.23
 F3FB      82        6315       DB      130T    ;   251    -52.53
 F3FC      84        6316       DB      132T    ;   252    -60.40
 F3FD      88        6317       DB      136T    ;   253    -71.10
 F3FE      8E        6318       DB      142T    ;   254    -88.38
 F3FF      64        6319       DB      100T    ;   255    Sensor Failure - 100% applied
                     6320                                     ; corrrection factor in %
                     6321  
                     6322  ;**********************************************************************************************
                     6323  ; VE table and Ranges (copied into RAM on demand for tuning. page = 1)(all pages 168 bytes)
                     6324  ; VE values are percent, KPARANGEVE values are KPA, RPMRANGEVE values are RPM/20
                     6325  ;**********************************************************************************************
                     6326  
 E000                6327       org     $E000    ;(57,344)
                     6328  
                     6329  flash_table1:
                     6330  
                     6331  VE_f:
 E000      2B2A2926  6332       db      43T,42T,41T,38T,36T,34T,33T,33T,33T,33T,33T,33T ; VE (0,0-11)(Bottom Row)
           24222121 
           21212121 
 E00C      38373435  6333       db      56T,55T,52T,53T,54T,54T,54T,54T,55T,56T,57T,57T ; VE (1,0-11)
           36363636 
           37383939 
 E018      4443403F  6334       db      68T,67T,64T,63T,65T,65T,65T,66T,67T,68T,69T,69T ; VE (2,0-11)
           41414142 
           43444545 
 E024      45454546  6335       db      69T,69T,69T,70T,71T,72T,73T,74T,75T,76T,77T,78T ; VE (3,0-11)
           4748494A 
           4B4C4D4E 
 E030      46464748  6336       db      70T,70T,71T,72T,73T,73T,74T,74T,75T,76T,77T,78T ; VE (4,0-11)
           49494A4A 
           4B4C4D4E 
 E03C      47474849  6337       db      71T,71T,72T,73T,74T,75T,75T,76T,77T,78T,78T,79T ; VE (5,0-11)
           4A4B4B4C 
           4D4E4E4F 
 E048      4848494B  6338       db      72T,72T,73T,75T,76T,76T,76T,77T,78T,78T,79T,80T ; VE (6,0-11)
           4C4C4C4D 
           4E4E4F50 
 E054      49494A4B  6339       db      73T,73T,74T,75T,77T,78T,78T,78T,79T,80T,81T,82T ; VE (7,0-11)
           4D4E4E4E 
           4F505152 
 E060      4A4A4B4C  6340       db      74T,74T,75T,76T,78T,78T,78T,78T,79T,80T,81T,82T ; VE (8,0-11)
           4E4E4E4E 
           4F505152 
 E06C      55555657  6341       db      85T,85T,86T,87T,88T,89T,90T,91T,91T,91T,91T,91T ; VE (9,0-11)
           58595A5B 
           5B5B5B5B 
 E078      65656667  6342       db      101T,101T,102T,103T,105T,107T,109T,110T,110T,110T,109T,109T; VE (10,0-11)
           696B6D6E 
           6E6E6D6D 
 E084      6868696B  6343       db      104T,104T,105T,107T,109T,111T,112T,113T,113T,113T,113T,113T; VE (11,0-11)(Top Row)
           6D6F7071 
           71717171 
                     6344  
                     6345  RPMRANGEVE_f:        ; RPMRANGEVE[0-11](Left to Right)
 E090      1423323C  6346       db      20T,35T,50T,60T,70T,80T,90T,100T,120T,140T,160T,180T
           46505A64 
           788CA0B4 
                     6347               ; 400,700,1000,1200,1400,1600,1800,2000,2400,2800,3200,3600
                     6348  
                     6349  KPARANGEVE_f:        ; KPARANGEVE[0-b](Bottom to Top)
 E09C      111E2D32  6350       db      17T,30T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6351  
                     6352  flash_table1_end:
                     6353  
                     6354  ;**********************************************************************************************
                     6355  ; ST table and Ranges (copied into RAM on demand for tuning. page = 2)(all pages 168 bytes)
                     6356  ; ST values are delay from PIP scaled to 255. MT table displays degrees advance including
                     6357  ; initial timing which is always 10 degrees BTDC
                     6358  ; KPARANGEST values are KPA, RPMRANGEST values are RPM/20
                     6359  ;**********************************************************************************************
                     6360  
 E100                6361       org     $E100    ;(57600)
                     6362  
                     6363  flash_table2:
                     6364  
                     6365  ST_f:
 E100      DBDFCABF  6366       db    219T,223T,202T,191T,191T,191T,191T,191T,191T,191T,191T,191T ;(0,0-11)(Bottom Row)
           BFBFBFBF 
           BFBFBFBF 
 E10C      DBDFCABF  6367       db    219T,223T,202T,191T,191T,191T,191T,191T,191T,191T,191T,191T ;(1,0-11)
           BFBFBFBF 
           BFBFBFBF 
 E118      CECEC4C1  6368       db    206T,206T,196T,193T,191T,191T,191T,191T,191T,191T,191T,191T ;(2,0-11)
           BFBFBFBF 
           BFBFBFBF 
 E124      C4C4C4C4  6369       db    196T,196T,196T,196T,193T,191T,191T,191T,191T,191T,191T,191T ;(3,0-11)
           C1BFBFBF 
           BFBFBFBF 
 E130      C8C8C6C6  6370       db    200T,200T,198T,198T,196T,193T,191T,191T,191T,191T,191T,191T ;(4,0-11)
           C4C1BFBF 
           BFBFBFBF 
 E13C      CCCCCAC8  6371       db    204T,204T,202T,200T,198T,196T,193T,191T,191T,191T,191T,191T ;(5,0-11)
           C6C4C1BF 
           BFBFBFBF 
 E148      D0D0CECC  6372       db    208T,208T,206T,204T,202T,200T,198T,196T,193T,191T,191T,191T ;(6,0-11)
           CAC8C6C4 
           C1BFBFBF 
 E154      D9D9D5D2  6373       db    217T,217T,213T,210T,208T,206T,204T,202T,200T,198T,196T,196T ;(7,0-11)
           D0CECCCA 
           C8C6C4C4 
 E160      DDDDD9D7  6374       db    221T,221T,217T,215T,213T,210T,208T,206T,204T,202T,200T,200T ;(8,0-11)
           D5D2D0CE 
           CCCAC8C8 
 E16C      E1E1DDDB  6375       db    225T,225T,221T,219T,217T,215T,213T,210T,208T,206T,204T,204T ;(9,0-11)
           D9D7D5D2 
           D0CECCCC 
 E178      E6E6E3E1  6376       db    230T,230T,227T,225T,223T,221T,219T,217T,215T,213T,208T,208T ;(10,0-11)
           DFDDDBD9 
           D7D5D0D0 
 E184      E8E8E6E3  6377       db    232T,232T,230T,227T,225T,223T,223T,221T,219T,217T,213T,213T ;(11,0-11)(Top Row)
           E1DFDFDD 
           DBD9D5D5 
                     6378  
                     6379  RPMRANGEST_f:        ; RPMRANGEST[0-11](Left to Right)
 E190      1423323C  6380       db      20T,35T,50T,60T,70T,80T,90T,100T,120T,140T,160T,180T
           46505A64 
           788CA0B4 
                     6381               ; 400,700,1000,1200,1400,1600,1800,2000,2400,2800,3200,3600
                     6382  
                     6383  KPARANGEST_f:        ; KPARANGEST[0-b](Bottom to Top)
 E19C      111E2D32  6384       db      17T,30T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 50
MC68HC908GP32 User Bootloader


                     6385  
                     6386  flash_table2_end:
                     6387  
                     6388  ;**********************************************************************************************
                     6389  ; AFR1 table and Ranges (copied into RAM on demand for tuning. (page = 3)(all pages 168 bytes)
                     6390  ; AFR1 values are AFRx10(Used for MLV VE Analyze only)
                     6391  ; KPARANGEAFR1 values are KPA, RPMRANGEAFR1 values are RPM/20
                     6392  ;
                     6393  ; Converted to Lambda 4/10/11
                     6394  ;
                     6395  ;**********************************************************************************************
                     6396  
 E200                6397       org     $E200    ;(57856)
                     6398  
                     6399  flash_table3:
                     6400  
                     6401  AFR1_f:
 E200      58585858  6402       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(0,0-11)(Bottom Row)
           58585858 
           58585858 
 E20C      58585858  6403       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(1,0-11)
           58585858 
           58585858 
 E218      58585858  6404       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(2,0-11)
           58585858 
           58585858 
 E224      58585858  6405       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(3,0-11)
           58585858 
           58585858 
 E230      58585858  6406       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(4,0-11)
           58585858 
           58585858 
 E23C      58585858  6407       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(5,0-11)
           58585858 
           58585858 
 E248      58585858  6408       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(6,0-11)
           58585858 
           58585858 
 E254      58585858  6409       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(7,0-11)
           58585858 
           58585858 
 E260      58585858  6410       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(8,0-11)
           58585858 
           58585858 
 E26C      58585858  6411       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(9,0-11)
           58585858 
           58585858 
 E278      58585858  6412       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(10,0-11)
           58585858 
           58585858 
 E284      58585858  6413       db    88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T,88T ;(11,0-11)(Top Row)
           58585858 
           58585858 
                     6414  
                     6415  RPMRANGEAFR1_f:        ; RPMRANGEAFR1[0-11](Left to Right)
 E290      1423323C  6416       db      20T,35T,50T,60T,70T,80T,90T,100T,120T,140T,160T,180T
           46505A64 
           788CA0B4 
                     6417               ; 400,700,1000,1200,1400,1600,1800,2000,2400,2800,3200,3600
                     6418  
                     6419  KPARANGEAFR1_f:        ; KPARANGEAFR1[0-b](Bottom to Top)
 E29C      111E2D32  6420       db      17T,30T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6421  
                     6422  flash_table3_end:
                     6423  
                     6424  ;**********************************************************************************************
                     6425  ; AFR2 table and Ranges (copied into RAM on demand for tuning. (page = 4)(all pages 168 bytes)
                     6426  ; AFR2 values are AFRx10(Used for MLV VE Analyze only)
                     6427  ; KPARANGEAFR2 values are KPA, RPMRANGEAFR2 values are RPM/20
                     6428  ;
                     6429  ; Converted to Lambda 4/10/11
                     6430  ;
                     6431  ;**********************************************************************************************
                     6432  
 E300                6433       org     $E300    ;(58112)
                     6434  
                     6435  flash_table4:
                     6436  
                     6437  AFR2_f:
 E300      58585864  6438       db    88T,88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T ;(0,0-11)(Bottom Row)
           74747474 
           74747474 
 E30C      58585864  6439       db    88T,88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T ;(1,0-11)
           74747474 
           74747474 
 E318      58586474  6440       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(2,0-11)
           74747474 
           74747474 
 E324      58586474  6441       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(3,0-11)
           74747474 
           74747474 
 E330      58586474  6442       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(4,0-11)
           74747474 
           74747474 
 E33C      58586474  6443       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(5,0-11)
           74747474 
           74747474 
 E348      58586474  6444       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(6,0-11)
           74747474 
           74747474 
 E354      58586474  6445       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(7,0-11)
           74747474 
           74747474 
 E360      58586474  6446       db    88T,88T,100T,116T,116T,116T,116T,116T,116T,116T,116T,116T ;(8,0-11)
           74747474 
           74747474 
 E36C      58586464  6447       db    88T,88T,100T,100T,100T,100T,100T,100T,100T,100T,100T,100T ;(9,0-11)
           64646464 
           64646464 
 E378      58585858  6448       db    88T,88T,88T,88T,86T,86T,86T,86T,86T,86T,86T,86T ;(10,0-11)
           56565656 
           56565656 
 E384      58585855  6449       db    88T,88T,88T,85T,82T,82T,82T,82T,82T,82T,82T,82T ;(11,0-11)(Top Row)
           52525252 
           52525252 
                     6450  
                     6451  RPMRANGEAFR2_f:        ; RPMRANGEAFR2[0-11](Left to Right)
 E390      1423323C  6452       db      20T,35T,50T,60T,70T,80T,90T,100T,120T,140T,160T,180T
           46505A64 
           788CA0B4 
                     6453               ; 400,700,1000,1200,1400,1600,1800,2000,2400,2800,3200,3600
                     6454  
                     6455  KPARANGEAFR2_f:        ; KPARANGEAFR2[0-b](Bottom to Top)
 E39C      111E2D32  6456       db      17T,30T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6457  
                     6458  flash_table4_end:
                     6459  
                     6460  ;**********************************************************************************************
                     6461  ; Configuration constants and tables (copied into RAM on demand for tuning. page = 5)
                     6462  ; (all pages 168 bytes)
                     6463  ;**********************************************************************************************
                     6464  


MSnS300.asm            Assembled with CASM08Z  7/22/12  11:02:41 PM  PAGE 51
MC68HC908GP32 User Bootloader


 E400                6465       org     $E400    ;(58368)
                     6466  
                     6467  flash_table5:
                     6468  
 E400      00        6469  WWURANGE:   db      0T       ; WWURANGE[0] -40 F
 E401      14        6470              db      20T      ; WWURANGE[1] -20 F
 E402      28        6471              db      40T      ; WWURANGE[2]   0 F
 E403      3C        6472              db      60T      ; WWURANGE[3] +20 F
 E404      50        6473              db      80T      ; WWURANGE[4] +40 F
 E405      64        6474              db      100T     ; WWURANGE[5] +60 F
 E406      78        6475              db      120T     ; WWURANGE[6] +80 F
 E407      8C        6476              db      140T     ; WWURANGE[7] +100 F
 E408      AA        6477              db      170T     ; WWURANGE[8] +130 F
 E409      C8        6478              db      200T     ; WWURANGE[9] +160 F
                     6479  
                     6480  
 E40A      BE        6481  WWU:        db      190T    ; WWU   Warmup bin @ -40 F
 E40B      BE        6482              db      190T    ; WWU   Warmup bin @ -20 F
 E40C      B4        6483              db      180T    ; WWU   Warmup bin @   0 F
 E40D      AA        6484              db      170T    ; WWU   Warmup bin @ +20 F
 E40E      A0        6485              db      160T    ; WWU   Warmup bin @ +40 F
 E40F      96        6486              db      150T    ; WWU   Warmup bin @ +60 F
 E410      8C        6487              db      140T    ; WWU   Warmup bin @ +80 F
 E411      82        6488              db      130T    ; WWU   Warmup bin @ +100 F
 E412      73        6489              db      115T    ; WWU   Warmup bin @ +130 F
 E413      64        6490              db      100T    ; WWU   Warmup bin @ +160 F
                     6491  
                     6492  
 E414      05        6493  TPSDOTRATE: db      05T     ; TPSDOTRATE[0] (TPS ADC counts 0.1 volts)
 E415      14        6494              db      20T     ; TPSDOTRATE[1] (TPS ADC counts 0.4 volts)
 E416      28        6495              db      40T     ; TPSDOTRATE[2] (TPS ADC counts 0.8 volts)
 E417      4D        6496              db      77T     ; TPSDOTRATE[3] (TPS ADC counts 1.5 volts)
                     6497  
 E418      14        6498  TPSAQ:      db      20T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.1mS)
 E419      1E        6499              db      30T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.4mS)
 E41A      28        6500              db      40T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.8mS)
 E41B      32        6501              db      50T     ; TPSAQ   Accel amount in 1ms units (tpsdot=1.5mS)
 E41C      FE        6502  cwu:        db      254T    ; CWU          Crank Enrichment at - 40 F
 E41D      3F        6503  cwh:        db      63T     ; CWH          Crank Enrichment at +165 F
 E41E      28        6504  awev:       db      40T     ; AWEV         Afterstart Warmup % enrich add on value
 E41F      FA        6505  awc:        db      250T    ; AWC          Afterstart number of ignition cycles
 E420      5A        6506  tpsacold:   db      90T     ; TPSACOLD     Accel amount at - 40 F in .1 mS units
 E421      05        6507  tpsthresh:  db      5T      ; TPSTHRESH    Accel difference over time threshold
 E422      02        6508  tpsasync:   db      2T      ; TPSASYNC     Accel enrich time in .1 sec increments
 E423      5C        6509  req_fuel:   db      92T     ; REQFUEL      Required fuel constant
 E424      01        6510  divider:    db      1T      ; DIVIDER      IRQ divide factor for fuel pulse
 E425      01        6511  Alternate:  db      1T      ; ALTERNATE    Alternate injector firing
 E426      09        6512  InjOpen:    db      9T      ; INJOPEN      Injector open time .1ms units
 E427      0C        6513  battfac:    db      12T     ; BATTFAC      Injector voltage compensation (mms/V)
 E428      C8        6514  floodClear: db      200T    ; floodClear   tpsADC value for flood clear
 E429      64        6515  acmult:     db      100T    ; ACCELMULT    Accel cold mult factor (%/100)
 E42A      28        6516  pru:        db      40T     ; PRU          Primer PW @ -40 F)(0.1mS res)
 E42B      14        6517  prh:        db      20T     ; PRH          Primer PW @ 165 F)(0.1mS res)
 E42C      78        6518  PIP_Angle:  db      120T    ; PIP_Angle    PIP angle in crank degrees (6cyl=120, 8cyl=90)
 E42D      34        6519  CT_cnt:     db      52T     ; CT_cnt       Closed throttle position ADC count
 E42E      E4        6520  WOT_cnt:    db      228T    ; WOT_cnt      Wide Open throttle position ADC count
 E42F      FA        6521  ASEhi:      db      250T    ; ASEhi        Set point above which ASE is active (F+40)
 E430      BE        6522  ASElo:      db      190T    ; ASElo        Set point below which ASE is active (F+40)
 E431      01        6523  tpsdq:      db      1T      ; TPSDQ        Deceleration fuel cut %
 E432      3C        6524  DFC_RPM:    db      60T     ; DFC_RPM      Decel Fuel Cut min RPM (RPM/20)
 E433      37        6525  DFC_TPS:    db      55T     ; DFC_TPS      Decel Fuel Cut min TPS (ADC)
 E434      00        6526  dbCor:      db      0T      ; dbCor        Deadband correction added to "fd"
 E435      01        6527  BnkflowH:   db      1T      ; BnkflowH     Injector bank flow rate L/hr x 10 Hi byte
                     6528                              ;              configuration variable
 E436      74        6529  BnkflowL:   db      116T    ; BnkflowL     Injector bank flow rate L/hr x 10 Lo byte
                     6530                              ;              configuration variable
 E437      00        6531  ASEtype:    db      0T      ; ASEtype      Configuration variable for ASE counter type
                     6532                              ;              0 = ignition cycles, 1 = 100 ms counter,
                     6533                              ;              2 = 250 ms counter, 3 = 500 ms counter
                     6534                              ;              4 = 1 second counter
                     6535  
                     6536  
                     6537  flash_table5_end:
                     6538  
                     6539  
 E438                6540       include "boot_r12.asm"
                     6541  ;=====================================
                     6542  ; MEGASQUIRT BOOTLOADER VERSION - Dec 2001
                     6543  ;
                     6544  ; Mods by Bruce Bowling
                     6545  ;
                     6546  ; Corrected bug in BootReset 5
                     6547  ;
                     6548  ;=====================================
                     6549  
                     6550  ;********************************************************************************************
                     6551  ;*                                                                                          *
                     6552  ;*  Bootloader - MC68HC908GP32                                                              *
                     6553  ;*                                                          Copyright (c) Motorola, 2001    *
                     6554  ;*                                                                                          *
                     6555  ;********************************************************************************************
                     6556  ;*                                                                                          *
                     6557  ;*  This file provides the low level assembly bootloader routine.                           *
                     6558  ;*  This program has been specially tailored towards the MC68HC908GP32.                     *
                     6559  ;*                                                                                          *
                     6560  ;********************************************************************************************
                     6561  ;*                                                                                          *
                     6562  ;*  File name:          boot.asm                        Current Release Level:      1.1     *
                     6563  ;*  Last Edit Date:     07-Jun-01                       Classification:             ES      *
                     6564  ;*                                                                                          *
                     6565  ;*  Include Files:      gp32.equ            : MC68HC908GP32 MCU definitions                 *
                     6566  ;*                                                                                          *
                     6567  ;*  Assembler:          P&E's CASM08Z                   Version:    3.16                    *
                     6568  ;*                                                                                          *
                     6569  ;*  Target:             MC68HC908GP32                                                       *
                     6570  ;*                                                                                          *
                     6571  ;*  Documentation:      MC68HC908GP32/H  Rev 3                                              *
                     6572  ;*                      Motorola Microcontroller Technical Data                             *
                     6573  ;*                                                                                          *
                     6574  ;********************************************************************************************
                     6575  ;*                                                                                          *
                     6576  ;*  Author:             DHJ Klotz                                                           *
                     6577  ;*  First Release:      26-Feb-00                                                           *
                     6578  ;*                                                                                          *
                     6579  ;*  Update History:                                                                         *
                     6580  ;*                                                                                          *
                     6581  ;*  Rev     Date       Author  Description of Change                                        *
                     6582  ;*  ------  ---------  ------  -----------------------------------------------------------  *
                     6583  ;*  ES 1.0  26-Feb-00  DHJK    Initial release for HC908 Seminar 2000.                      *
                     6584  ;*  ES 1.1  07-Jun-01  DHJK    Improved functionality for Application Note.                 *
                     6585  ;*                                                                                          *
                     6586  ;********************************************************************************************
                     6587  ;*                                                                                          *
                     6588  ;*  Notes:                                                                                  *
                     6589  ;*    - In order to minimize overall program size, subroutines are position within the      *
                     6590  ;*      core bootloader routine.  Although this can make the program somewhat difficult     *
                     6591  ;*      to read and follow, it permits the use of relative branch opcodes.  Most of         *
                     6592  ;*      these subroutines can be called from an external application program.               *
                     6593  ;*                                                                                          *
                     6594  ;********************************************************************************************
                     6595  ;*                                                                                          *
                     6596  ;*    Motorola reserves the right to make changes without further notice to any product     *
                     6597  ;*    herein to improve reliability, function, or design.  Motorola does not assume any     *
                     6598  ;*    liability arising out of the application or use of any product, circuit, or software  *
                     6599  ;*    described herein; neither does it convey any license under its patent rights nor the  *
                     6600  ;*    rights of others.  Motorola products are not designed, intended, or authorized for    *
                     6601  ;*    use as components in systems intended for surgical implant into the body, or other    *
                     6602  ;*    applications intended to support life, or for any other application in which the      *
                     6603  ;*    failure of the Motorola product could create a situation where personal injury or     *
                     6604  ;*    death may occur.  Should Buyer purchase or use Motorola products for any such         *
                     6605  ;*    intended or unauthorized application, Buyer shall indemnify and hold Motorola and     *
                     6606  ;*    its officers, employees, subsidiaries, affiliates, and distributors harmless against  *
                     6607  ;*    all claims, costs, damages, and expenses, and reasonable attorney fees arising out    *
                     6608  ;*    of, directly or indirectly, any claim of personal injury or death associated with     *
                     6609  ;*    such unintended or unauthorized use, even if such claim alleges that Motorola was     *
                     6610  ;*    negligent regarding the design or manufacture of the part.                            *
                     6611  ;*                                                                                          *
                     6612  ;*    Motorola and the Motorola logo are registered trademarks of Motorola Ltd.             *
                     6613  ;*                                                                                          *
                     6614  ;********************************************************************************************
                     6615  
                     6616  ;*  Microcontroller Peripheral Equates  *****************************************************
                     6617  ;*
                     6618  
                     6619  ; uncomment out if standalone
 E438                6620          list
                     6621  
                     6622  
                     6623  ;*  Flash Memory Specifics  =================================================================
                     6624  ;*
 E438                6625  boot_start:     equ     $FB00               ; starting address of protected Bootloader
 E438                6626  flash_protect:  equ     {boot_start>7&$FF}  ; Flash Block Protect Register value
 E438                6627  flash_page:     equ     128                 ; Flash Erase Page size
 E438                6628  flash_row:      equ     64                  ; Flash Program Row size
 E438                6629  flash_erased:   equ     $FF                 ; Flash erased state
                     6630  
                     6631  
                     6632  ;*  RAM Utilization  ========================================================================
                     6633  ;*
 0040                6634          org     ram_start                   ; begining of RAM
                     6635  
 0040                6636  count:          ds      1                   ; 0040:     => data counter
 0041                6637  temp_sp:        ds      2                   ; 0041:0042 => temporary Stack Pointer storage
 0043                6638  flash_first:    ds      2                   ; 0043:0044 => first Flash reprogram address
 0045                6639  flash_last:     ds      2                   ; 0045:0046 => last Flash reprogram address + 1
                     6640  
 0047                6641  ram_exec:       equ     $01ED               ; start of executable RAM space
                     6642  
                     6643  
                     6644  ;*  Bootloader Customization Parameters  ====================================================
                     6645  ;*
 0047                6646  user_scbr:      equ     boot_start-61       ; FAC3      => SCBR register
 0047                6647  init_scbr:      equ     $12                 ;   default set SCI for 9600 kbaud
                     6648  
 0047                6649  user_config1:   equ     boot_start-60       ; FAC4      => CONFIG1 register
 0047                6650  init_config1:   equ     %00000001           ;   default CONFIG1
                     6651  
 0047                6652  user_config2:   equ     boot_start-59       ; FAC5      => CONFIG2 register
 0047                6653  init_config2:   equ     %00000001           ;   default CONFIG2
                     6654  
 0047                6655  user_first:     equ     boot_start-58       ; FAC6:FAC7 => 1st application address
 0047                6656  init_first:     equ     rom_start           ;   default first Flash address
                     6657  
 0047                6658  user_last:      equ     boot_start-56       ; FAC8:FAC9 => last application address
 0047                6659  init_last:      equ     boot_start          ;   default last Flash address
                     6660  
                     6661  
                     6662  ;*  Application Program Jump Vector Table  ==================================================
                     6663  ;*
                     6664                                              ; FACA      => "JMP ext" instruction (opcode $CC)
 0047                6665  user_timebase:  equ     boot_start-54       ; FACB:FACC => user Timebase jump vector
                     6666  
                     6667                                              ; FACD      => "JMP ext" instruction (opcode $CC)
 0047                6668  user_ADC:       equ     boot_start-51       ; FACE:FACF => user ADC jump vector
                     6669  
                     6670                                              ; FAD0      => "JMP ext" instruction (opcode $CC)
 0047                6671  user_keyboard:  equ     boot_start-48       ; FAD1:FAD2 => user Keyboard jump vector
                     6672  
                     6673                                              ; FAD3      => "JMP ext" instruction (opcode $CC)
 0047                6674  user_SCItx:     equ     boot_start-45       ; FAD4:FAD5 => user SCI transmit jump vector
                     6675  
                     6676                                              ; FAD6      => "JMP ext" instruction (opcode $CC)
 0047                6677  user_SCIrx:     equ     boot_start-42       ; FAD7:FAD8 => user SCI receive jump vector
                     6678  
                     6679                                              ; FAD9      => "JMP ext" instruction (opcode $CC)
 0047                6680  user_SCIerr:    equ     boot_start-39       ; FADA:FADB => user SCI error jump vector
                     6681  
                     6682                                              ; FADC      => "JMP ext" instruction (opcode $CC)
 0047                6683  user_SPItx:     equ     boot_start-36       ; FADD:FADE => user SPI transmit jump vector
                     6684  
                     6685                                              ; FADF      => "JMP ext" instruction (opcode $CC)
 0047                6686  user_SPIrx:     equ     boot_start-33       ; FAE0:FAE1 => user SPI receive jump vector
                     6687  
                     6688                                              ; FAE2      => "JMP ext" instruction (opcode $CC)
 0047                6689  user_Tim2Ov:    equ     boot_start-30       ; FAE3:FAE4 => user Timer 2 overflow jump vector
                     6690  
                     6691                                              ; FAE5      => "JMP ext" instruction (opcode $CC)
 0047                6692  user_Tim2Ch1:   equ     boot_start-27       ; FAE6:FAE7 => user Timer 2 channel 1 jump vector
                     6693  
                     6694                                              ; FAE8      => "JMP ext" instruction (opcode $CC)
 0047                6695  user_Tim2Ch0:   equ     boot_start-24       ; FAE9:FAEA => user Timer 2 channel 0 jump vector
                     6696  
                     6697                                              ; FAEB      => "JMP ext" instruction (opcode $CC)
 0047                6698  user_Tim1Ov:    equ     boot_start-21       ; FAEC:FAED => user Timer 1 oveflow jump vector
                     6699  
                     6700                                              ; FAEE      => "JMP ext" instruction (opcode $CC)
 0047                6701  user_Tim1Ch1:   equ     boot_start-18       ; FAEF:FAF0 => user Timer 1 channel 1 jump vector
                     6702  
                     6703                                              ; FAF1      => "JMP ext" instruction (opcode $CC)
 0047                6704  user_Tim1Ch0:   equ     boot_start-15       ; FAF2:FAF3 => user Timer 1 channel 0 jump vector
                     6705  
                     6706                                              ; FAF4      => "JMP ext" instruction (opcode $CC)
 0047                6707  user_PLL:       equ     boot_start-12       ; FAF5:FAF6 => user PLL jump vector
                     6708  
                     6709                                              ; FAF7      => "JMP ext" instruction (opcode $CC)
 0047                6710  user_IRQ:       equ     boot_start-9        ; FAF8:FAF9 => user IRQ jump vector
                     6711  
                     6712                                              ; FAFA      => "JMP ext" instruction (opcode $CC)
 0047                6713  user_SWI:       equ     boot_start-6        ; FAFB:FAFC => user SWI jump vector
                     6714  
                     6715                                              ; FAFD      => "JMP ext" instruction (opcode $CC)
 0047                6716  user_reset:     equ     boot_start-3        ; FAFE:FAFF => user Reset interrupt jump vector
                     6717  
                     6718  
                     6719  ;*  Bootloader Program  *********************************************************************
                     6720  ;*
                     6721  
 0047                6722  init_stack:     equ     ram_exec-1          ; initialize stack pointer to before RAM routine
                     6723  ;
 0047                6724  init_scc1:      equ     %01000000           ; enable SCI, 8-bits, no parity, 1 stop
 0047                6725  init_scc2:      equ     %00001100           ; no interupts, receiver and transmitter enabled
                     6726  
 FB00                6727          org     boot_start                  ; beginning of code
                     6728  
                     6729  
                     6730  ;*  CGM Parameter Tables  ===================================================================
                     6731  ;*
                     6732  ;*  The following CGM parameter tables are placed here so that they are easy to access via
                     6733  ;*  external application programs.
                     6734  ;*
                     6735  ;*  7.3728 MHz bus frequency parameters (located at address "boot_start").
                     6736  ;*
                     6737  bus7372800:
 FB00      02        6738          db      $02                         ; P & E
 FB01      C0        6739          db      $C0                         ; L
 FB02      03        6740          db      $03                         ; N msb
 FB03      84        6741          db      $84                         ; N lsb
                     6742  
                     6743  ;*  8.003584 MHz bus frequency parameters (located at address "boot_start+4").
                     6744  ;*
                     6745  bus8003584:
 FB04      02        6746          db      $02                         ; P & E
 FB05      D0        6747          db      $D0                         ; L
 FB06      03        6748          db      $03                         ; N msb
 FB07      D1        6749          db      $D1                         ; N lsb
                     6750  
                     6751  
                     6752  ;*  Power-on Reset  =========================================================================
                     6753  ;* MODIFIED FOR MEGASQUIRT - Initialization code here
                     6754  ;*
                     6755  
                     6756  BootReset:
 FB08 [01] 4F        6757          clra
 FB09 [04] C7FFFF    6758          sta     copctl
 FB0C [04] 6E011E    6759          mov     #%00000001,config2
 FB0F [04] 6E011F    6760          mov     #%00000001,config1
 FB12 [03] 450240    6761          ldhx    #ram_last+1
 FB15 [02] 94        6762          txs
                     6763  
 FB16 [03] 45FB00    6764          ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
 FB19 [04] AD22      6765          bsr     PLLset                      ; change bus speed
                     6766  
 FB1B [02] A600      6767          lda      #%00000000
 FB1D [03] B705      6768          sta      ddrb                       ; ADC Channels - inputs
                     6769  
 FB1F [02] A670      6770          lda     #%01110000                  ; Set up ADC for divide by 8 and internal clock
 FB21 [03] B73E      6771          sta     adclk
 FB23 [02] A604      6772          lda     #%00000100                  ; No interrupt, channel AD4 selected
 FB25 [03] B73C      6773          sta     adscr
 FB27 [05] 0F3CFD    6774          brclr   coco,adscr,*                ; wait until conversion complete
                     6775  
 FB2A [03] B63D      6776          lda     adr
 FB2C [02] A105      6777          cmp     #$05                        ; Check for low voltage on divider
 FB2E [03] 2529      6778          blo     BootReset1                  ; enter bootloader if low voltage
                     6779  
                     6780  ;
                     6781  ;   Test application reset vector.
                     6782  ;
 FB30 [04] C6FAFE    6783          lda     user_reset+1                ; get the MSB of the user reset vector
 FB33 [02] A1FF      6784          cmp     #flash_erased               ; check if it's erased
 FB35 [03] 2722      6785          beq     BootReset1                  ; enter bootloader if erased
 FB37 [03] 20C4      6786          bra     user_reset                  ; else, jump to user reset jump vector
                     6787  
                     6788  
                     6789  ;*  External CGM PLL Bus Frequency Change Subroutine  =======================================
                     6790  ;*
                     6791  ;*  This subroutine will program the CGM PLL to change the bus frequency in accordance with
                     6792  ;*  the data being pointed to by X:A (which is a common implementation for pointer parameter
                     6793  ;*  passing used by HC08 C compilers).
                     6794  ;*
                     6795  ;*  C function prototype:
                     6796  ;*
                     6797  ;*      void CGMChange (char parameters*);
                     6798  ;*
                     6799  ;*  Calling convention:
                     6800  ;*
                     6801  ;*      ldx     #{parameters>8}             ; get CGM parameter table address msb
                     6802  ;*      lda     #{parameters&$FF}           ; get CGM parameter table address lsb
                     6803  ;*      jsr     CGMChange                   ; go change the bus speed
                     6804  ;*
                     6805  ;*  Returns:    nothing
                     6806  ;*
                     6807  ;*  Changes:    H:X
                     6808  ;*
                     6809  CGMChange:
 FB39 [02] 87        6810          psha                                ; save pointer lsb on stack
 FB3A [02] 89        6811          pshx                                ; save pointer msb on stack
 FB3B [02] 8A        6812          pulh                                ; initialize
 FB3C [02] 88        6813          pulx                                ;  H:X points to data array
                     6814  
                     6815  
                     6816  ;*  Internal CGM PLL Bus Frequency Change Subroutine  =======================================
                     6817  ;*
                     6818  ;*  This subroutine will program the CGM PLL to change the bus frequency in accordance with
                     6819  ;*  the data being pointed to by H:X.
                     6820  ;*
                     6821  ;*  Calling convention:
                     6822  ;*
                     6823  ;*      ldhx    #parameters                 ; point to CGM parameter table
                     6824  ;*      jsr     PLLset                      ; go change the bus speed
                     6825  ;*
                     6826  ;*  Returns:    nothing
                     6827  ;*
                     6828  ;*  Changes:    H:X
                     6829  ;*
                     6830  PLLset:
 FB3D [04] 1936      6831          bclr    BCS,pctl                    ; select external reference as base clock
 FB3F [04] 1B36      6832          bclr    PLLON,pctl                  ; turn off PLL
 FB41 [04] 7E36      6833          mov     x+,pctl                     ; program P & E
 FB43 [04] 7E3A      6834          mov     x+,pmrs                     ; program L
 FB45 [04] 7E38      6835          mov     x+,pmsh                     ; program N msb
 FB47 [04] 7E39      6836          mov     x+,pmsl                     ; program N lsb
 FB49 [04] 1E37      6837          bset    AUTO,pbwc                   ; enable automatic bandwidth control
 FB4B [04] 1A36      6838          bset    PLLON,pctl                  ; turn on PLL
                     6839  PLLwait:
 FB4D [05] 0D37FD    6840          brclr   LOCK,pbwc,PLLwait           ; wait for PLL to lock (Note: won't simulate)
 FB50 [04] 1836      6841          bset    BCS,pctl                    ; select VCO as base clock
 FB52 [04] 81        6842          rts                                 ; return
                     6843  
                     6844  
                     6845  ;*  PutChar Subroutine  =====================================================================
                     6846  ;*
                     6847  ;*  This subroutine will output the character passed in ACC to the SCI.
                     6848  ;*
                     6849  ;*  C function prototype:
                     6850  ;*
                     6851  ;*      void PutChar (char data);
                     6852  ;*
                     6853  ;*  Calling convention:
                     6854  ;*
                     6855  ;*      lda     data                        ; get character
                     6856  ;*      jsr     PutChar                     ; go output it
                     6857  ;*
                     6858  ;*  Returns:    nothing
                     6859  ;*
                     6860  ;*  Changes:    nothing
                     6861  ;*
                     6862  PutChar:
 FB53 [05] 0F16FD    6863          brclr   SCTE,scs1,PutChar           ; wait until SCI transmitter is empty
 FB56 [03] B718      6864          sta     scdr                        ; output character to the SCI
 FB58 [04] 81        6865          rts                                 ; return
                     6866  
                     6867  
                     6868  ;*  Power-on Reset Bootloader Entry  ========================================================
                     6869  ;*
                     6870  ;*  This is where the Bootloader starts from power-on reset.
                     6871  ;*
                     6872  BootReset1:
                     6873  ;
                     6874  ;   Initialize the PLL CGM for 7.3728 MHz bus speed from 32.768 kHz crystal.
                     6875  ;
                     6876  ;        ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
                     6877  ;        bsr     PLLset                      ; change bus speed
                     6878  ;
                     6879  ;   Copy user Flash parameters into RAM.
                     6880  ;
 FB59 [03] 45FAC3    6881          ldhx    #user_scbr                  ; point to first parameter
 FB5C [04] 7E40      6882          mov     x+,count                    ; copy user SCI baud rate
 FB5E [04] 7E41      6883          mov     x+,temp_sp                  ; copy user Configuration Register 1
 FB60 [04] 7E42      6884          mov     x+,temp_sp+1                ; copy user Configuration Register 2
 FB62 [04] 7E43      6885          mov     x+,flash_first              ; copy first user Flash address MSB
 FB64 [04] 7E44      6886          mov     x+,flash_first+1            ; copy first user Flash address LSB
 FB66 [04] 7E45      6887          mov     x+,flash_last               ; copy last user Flash address MSB
 FB68 [04] 7E46      6888          mov     x+,flash_last+1             ; copy last user Flash address LSB
 FB6A [03] 450040    6889          ldhx    #count                      ; point to first parameter, now saved in RAM
 FB6D [02] 94        6890          txs                                 ; use SP to point to parameter list in RAM
                     6891  ;
                     6892  ;   Test the user SCI baud rate.  The user can override the default baud rate.
                     6893  ;
 FB6E [02] 86        6894          pula                                ; get user SCBR initial data
 FB6F [02] A1FF      6895          cmp     #flash_erased               ; check if it's erased
 FB71 [03] 2602      6896          bne     BootReset2                  ; skip if not
 FB73 [02] A612      6897          lda     #init_scbr                  ; else, force default value
                     6898  BootReset2:
 FB75 [03] B740      6899          sta     count                       ; save initial SCI baud rate
                     6900  ;
                     6901  ;   Program the write-once configuration registers.  The user can override the defaults.
                     6902  ;
 FB77 [02] 86        6903          pula                                ; get user Configuration Register 1 initial data
 FB78 [02] A1FF      6904          cmp     #flash_erased               ; check if it's erased
 FB7A [03] 2602      6905          bne     BootReset3                  ; skip if not
 FB7C [02] A601      6906          lda     #init_config1               ; else, force default value
                     6907  BootReset3:
 FB7E [03] B71F      6908          sta     config1                     ; initialize Configuration Register 1
                     6909  ;
 FB80 [02] 86        6910          pula                                ; get user Configuration Register 2 initial data
 FB81 [02] A1FF      6911          cmp     #flash_erased               ; check if it's erased
 FB83 [03] 2602      6912          bne     BootReset4                  ; skip if not
 FB85 [02] A601      6913          lda     #init_config2               ; else, force default value
                     6914  BootReset4:
 FB87 [03] B71E      6915          sta     config2                     ; initialize Configuration Register 2
                     6916  ;
                     6917  ;   Program the first and last user Flash addresses.  The user can override the defaults.
                     6918  ;
 FB89 [02] 88        6919          pulx                                ; get first user Flash address LSB
 FB8A [02] 8A        6920          pulh                                ; get first user Flash address MSB
 FB8B [03] 65FFFF    6921          cphx    #$FFFF                      ; check if it's erased
 FB8E [03] 2608      6922          bne     BootReset5                  ; skip if not
 FB90 [02] A600      6923          lda     #{init_first&$FF}           ; else, get default first user address LSB
 FB92 [02] 87        6924          psha                                ;  save it
 FB93 [02] A680      6925          lda     #{init_first>8}             ;  and get default first user address MSB
 FB95 [02] 87        6926          psha                                ;  save it
 FB96 [02] A702      6927          ais     #2                          ; move stack pointer back
                     6928  ;
                     6929  BootReset5:
 FB98 [02] 88        6930          pulx                                ; get last user Flash address LSB
 FB99 [02] 8A        6931          pulh                                ; get last user Flash address MSB
 FB9A [03] 65FFFF    6932          cphx    #$FFFF                      ; check if it's erased
 FB9D [03] 2606      6933          bne     BootReset6                  ; skip if not
                     6934  ;        ldx     #{init_last&$FF}            ; else, get default last user address LSB
 FB9F [02] A600      6935          lda     #{init_last&$FF}            ; else, get default last user address LSB
 FBA1 [02] 87        6936          psha                                ;  save it
 FBA2 [02] A6FB      6937          lda     #{init_last>8}              ;  and get default last user address MSB
 FBA4 [02] 87        6938          psha                                ;  save it
                     6939  BootReset6:
                     6940  
                     6941  
                     6942  ;*  User Bootloader Entry  ==================================================================
                     6943  ;*
                     6944  ;*  The user can launch the bootloader from here.
                     6945  ;*
                     6946  BootResetUser:
 FBA5 [02] 9B        6947          sei                                 ; disable all interrupts
 FBA6 [04] C7FFFF    6948          sta     copctl                      ; clear the COP counter
 FBA9 [03] 4501ED    6949          ldhx    #init_stack+1               ; initialize
 FBAC [02] 94        6950          txs                                 ;  the stack pointer
                     6951  ;
                     6952  ;   Initialize the PLL CGM for 7.3728 MHz bus speed from 32.768 kHz crystal.
                     6953  ;
 FBAD [03] 45FB00    6954          ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
 FBB0 [04] AD8B      6955          bsr     PLLset                      ; change bus speed
                     6956  ;
                     6957  ;   Take over and initialize the SCI.  The user can override the default baud rate.
                     6958  ;
 FBB2 [05] 4E4019    6959          mov     count,scbr                  ; initialize SCI baud rate
 FBB5 [04] 6E4013    6960          mov     #init_scc1,scc1             ; initialize SCI Control Register 1
 FBB8 [04] 6E0C14    6961          mov     #init_scc2,scc2             ; initialize SCI Control Register 2
                     6962  
                     6963  
                     6964  ;*  Main Bootloader Control Loop  ==========================================================
                     6965  ;*
                     6966  ;*  Bootloader program supports the following commands:
                     6967  ;*
                     6968  ;*      'X'  = Exit and execute user program via user reset vector
                     6969  ;*      'P'  = Program Flash via S-Records
                     6970  ;*      'W'  = Erase Flash (Wipe)
                     6971  ;*      'U'  = Upgrade Flash by erasing all user space, then programming via S-Records
                     6972  ;*      'H'  = Help
                     6973  ;*      '?'  = Help
                     6974  ;*
                     6975  ;*  Note: avoid using 'A' - 'F', as these are valid S-Record characters that could get
                     6976  ;*        misinterpreted.
                     6977  ;*
 FBBB                6978  cmd_exit:       equ     'X'                 ; Exit command
 FBBB                6979  cmd_program:    equ     'P'                 ; Program Flash command
 FBBB                6980  cmd_erase:      equ     'W'                 ; Erase Flash command (Wipe)
 FBBB                6981  cmd_upgrade:    equ     'U'                 ; Upgrade Flash command
 FBBB                6982  cmd_help:       equ     'H'                 ; Help command
 FBBB                6983  cmd_help1:      equ     $1F                 ; '?' = alternate Help command
                     6984  ;
                     6985  Boot:
 FBBB [03] 45FD88    6986          ldhx    #msg_hello                  ; point to hello message
 FBBE [04] AD38      6987          bsr     PrintString                 ; output it
 FBC0 [05] CDFC6A    6988          jsr     GetChar                     ; get a character from the SCI
 FBC3 [02] A10D      6989          cmp     #ascii_CR                   ; check for ASCII carriage return
 FBC5 [03] 27F4      6990          beq     Boot                        ; just loop back if so
 FBC7 [04] AD8A      6991          bsr     PutChar                     ; else, echo character back
 FBC9 [02] A4DF      6992          and     #$DF                        ; convert to uppercase
                     6993  
                     6994  
                     6995  ;*  Execute User Program Command Check  =====================================================
                     6996  ;*
 FBCB [02] A158      6997          cmp     #cmd_exit                   ; check for Exit command
 FBCD [03] 2611      6998          bne     Boot2                       ; skip if not
 FBCF [04] C6FAFE    6999          lda     user_reset+1                ; else, get the MSB of the user reset vector
 FBD2 [02] A1FF      7000          cmp     #flash_erased               ; check if it's erased
 FBD4 [03] 2703      7001          beq     Boot1                       ; skip if not
 FBD6 [03] CCFAFD    7002          jmp     user_reset                  ; else, jump to user reset jump vector
                     7003  ;
                     7004  ;   Remain in the Bootloader if the MSB of the User Reset Jump Vector is erased.
                     7005  ;
                     7006  Boot1:
 FBD9 [03] 45FDE0    7007          ldhx    #msg_noreset                ; point to error message
 FBDC [04] AD1A      7008          bsr     PrintString                 ; output it
 FBDE [03] 20DB      7009          bra     Boot                        ; jump back to top
                     7010  
                     7011  
                     7012  ;*  Erase Flash Command Check  ==============================================================
                     7013  ;*
                     7014  Boot2:
 FBE0 [02] A157      7015          cmp     #cmd_erase                  ; check for Erase Flash command
 FBE2 [03] 2618      7016          bne     Boot3                       ; skip if not
 FBE4 [04] AD76      7017          bsr     EraseFlash                  ; else, go erase Flash
                     7018  ;
                     7019  ;   Common Bootloader command completion points.
                     7020  ;
                     7021  BootDone:
 FBE6 [03] 45FDB4    7022          ldhx    #msg_complete               ; point to operation complete message
                     7023  BootDone1:
 FBE9 [04] AD0D      7024          bsr     PrintString                 ; output it
                     7025  BootDone2:
 FBEB [03] 20CE      7026          bra     Boot                        ; jump back to top
                     7027  
                     7028  
                     7029  ;*  External PutString Subroutine  ==========================================================
                     7030  ;*
                     7031  ;*  This subroutine will output the null terminated string pointed to by X:A (which is a
                     7032  ;*  common implementation for pointer parameter passing used by HC08 C compilers) to the SCI.
                     7033  ;*
                     7034  ;*  C function prototype:
                     7035  ;*
                     7036  ;*      void PutString (char string*);
                     7037  ;*
                     7038  ;*  Calling convention:
                     7039  ;*
                     7040  ;*      ldx     #{string>8}                 ; get CGM parameter table address msb
                     7041  ;*      lda     #{string&$FF}               ; get CGM parameter table address lsb
                     7042  ;*      jsr     PutString                   ; go change the bus speed
                     7043  ;*
                     7044  ;*  Returns:    nothing
                     7045  ;*
                     7046  ;*  Changes:    H:X
                     7047  ;*
                     7048  PutString:
 FBED [02] 87        7049          psha                                ; save pointer lsb on stack
 FBEE [02] 89        7050          pshx                                ; save pointer msb on stack
 FBEF [02] 8A        7051          pulh                                ; initialize
 FBF0 [02] 88        7052          pulx                                ;  H:X points to data array
 FBF1 [03] 2005      7053          bra     PrintString                 ; go output string
                     7054  
                     7055  
                     7056  ;*  PrintString Subroutine  =================================================================
                     7057  ;*
                     7058  ;*  This subroutine will output the null teminated string pointed to by H:X to the SCI.
                     7059  ;*
                     7060  ;*  Calling convention:
                     7061  ;*
                     7062  ;*      ldhx    #string                     ; point to start of string
                     7063  ;*      jsr     PrintString                 ; go output it
                     7064  ;*
                     7065  ;*  Returns:    nothing
                     7066  ;*
                     7067  ;*  Changes:    H:X
                     7068  ;*
                     7069  PrintString1:
 FBF3 [05] 0F16FD    7070          brclr   SCTE,scs1,PrintString1      ; wait until SCI transmitter is empty
 FBF6 [04] 7E18      7071          mov     x+,scdr                     ; output character to the SCI and advance pointer
                     7072  PrintString:
 FBF8 [02] 7D        7073          tst     ,x                          ; test string character
 FBF9 [03] 26F8      7074          bne     PrintString1                ; loop back if not null
 FBFB [04] 81        7075          rts                                 ; else, return
                     7076  
                     7077  
                     7078  ;*  Program Flash Command Check  ============================================================
                     7079  ;*
                     7080  Boot3:
 FBFC [02] A150      7081          cmp     #cmd_program                ; check for Program Flash command
 FBFE [03] 264A      7082          bne     Boot4                       ; skip if not
                     7083  ;
 FC00 [04] AD02      7084          bsr     BootProg                    ; go accept S19 records and program the Flash
 FC02 [03] 20B7      7085          bra     Boot                        ; return to top of control loop
                     7086  
                     7087  
                     7088  ;*  Program Flash Subroutine  ===============================================================
                     7089  ;*
                     7090  ;*  This subroutine will copy the Flash Program algorithm into RAM and execute it in
                     7091  ;*  conjunction with the S19 record retrieval to program the required Flash pages between
                     7092  ;*  address pointers "flash_first" and "flash_last".
                     7093  ;*
                     7094  ;*  Calling convention:
                     7095  ;*
                     7096  ;*      jsr     BootProg                    ; retrieve S19 records and program Flash
                     7097  ;*
                     7098  ;*  Returns:    nothing
                     7099  ;*
                     7100  ;*  Changes:    everything
                     7101  ;*
                     7102  BootProg:
 FC04 [03] 45004F    7103          ldhx    #ProgramRamSize             ; initialize pointer
                     7104  BootProg1:
 FC07 [04] D6FD38    7105          lda     Delay-1,x                   ; get program from Flash
 FC0A [04] D701EC    7106          sta     ram_exec-1,x                ; copy into RAM
 FC0D [03] 5BF8      7107          dbnzx   BootProg1                   ; decrement pointer and loop back until done
 FC0F [03] 45FDBF    7108          ldhx    #msg_waiting                ; point to waiting message
 FC12 [04] ADE4      7109          bsr     PrintString                 ; output it
                     7110  ;
                     7111  ;   Get S-Record from host.
                     7112  ;
                     7113  BootProg2:
 FC14 [02] 95        7114          tsx                                 ; get the Stack Pointer
 FC15 [04] 3541      7115          sthx    temp_sp                     ; save it temporarily
 FC17 [02] A7DC      7116          ais     #-36                        ; allocate stack space for data
 FC19 [04] AD58      7117          bsr     GetSRec                     ; get an S-Record
 FC1B [03] 2625      7118          bne     BootProg5                   ; indicate error if S-Record is invalid
 FC1D [02] 86        7119          pula                                ; get S-Record type
 FC1E [02] A130      7120          cmp     #'0'                        ; check for text header record type
 FC20 [03] 270B      7121          beq     BootProg3                   ; ignore and get next record
 FC22 [02] A139      7122          cmp     #'9'                        ; check for end record type
 FC24 [03] 270B      7123          beq     BootProg4                   ; indicate operation complete
 FC26 [02] A131      7124          cmp     #'1'                        ; check for data record type
 FC28 [03] 2618      7125          bne     BootProg5                   ; indicate error if S-Record is invalid
                     7126  ;
                     7127  ;   Program Flash.
                     7128  ;
 FC2A [05] CD01F8    7129          jsr     {ram_exec+ProgramRam}       ; execute Program Flash algorithm from RAM
                     7130  BootProg3:
 FC2D [02] A723      7131          ais     #35                         ; deallocate stack space
 FC2F [03] 20E3      7132          bra     BootProg2                   ; loop back for next S-Record
                     7133  ;
                     7134  BootProg4:
 FC31 [02] A723      7135          ais     #35                         ; deallocate stack space
 FC33 [05] 0B16B0    7136          brclr   SCRF,scs1,BootDone          ; skip if SCI receiver is empty
 FC36 [04] AD32      7137          bsr     GetChar                     ; else, clear last ASCII carriage return from SCI
 FC38 [05] 0B16AB    7138          brclr   SCRF,scs1,BootDone          ; skip if SCI receiver is empty
 FC3B [04] AD2D      7139          bsr     GetChar                     ; else, clear last ASCII line feed from the SCI
 FC3D [03] 45FDB4    7140          ldhx    #msg_complete               ; point to operation complete message
 FC40 [03] 2005      7141          bra     BootProg6                   ; go output it
                     7142  ;
                     7143  BootProg5:
 FC42 [02] A724      7144          ais     #36                         ; deallocate stack space
 FC44 [03] 45FDCE    7145          ldhx    #msg_error                  ; point to error message
                     7146  BootProg6:
 FC47 [04] ADAF      7147          bsr     PrintString                 ; output it
 FC49 [04] 81        7148          rts                                 ; return
                     7149  
                     7150  
                     7151  ;*  Upgrade Flash Command Check  ============================================================
                     7152  ;*
                     7153  Boot4:
 FC4A [02] A155      7154          cmp     #cmd_upgrade                ; check for Upgrade Flash command
 FC4C [03] 2670      7155          bne     Boot5                       ; skip if not
                     7156  ;
 FC4E [03] 458000    7157          ldhx    #init_first                 ; force
 FC51 [04] 3543      7158          sthx    flash_first                 ;  first Flash address
 FC53 [03] 45FB00    7159          ldhx    #init_last                  ; force
 FC56 [04] 3545      7160          sthx    flash_last                  ;  last Flash address
 FC58 [04] AD02      7161          bsr     EraseFlash                  ; go erase Flash
 FC5A [03] 20A8      7162          bra     BootProg                    ; go program Flash
                     7163  
                     7164  
                     7165  ;*  Multiple Flash Page Erase Subroutine  ===================================================
                     7166  ;*
                     7167  ;*  This subroutine will copy the Flash Erase algorithm into RAM and execute it to erase
                     7168  ;*  all pages between address pointers "flash_first" and "flash_last".
                     7169  ;*
                     7170  ;*  Calling convention:
                     7171  ;*
                     7172  ;*      ldhx    #init_first                 ; initialize
                     7173  ;*      sthx    flash_first                 ;  first Flash address
                     7174  ;*      ldhx    #init_last                  ; initialize
                     7175  ;*      sthx    flash_last                  ;  last Flash address
                     7176  ;*      jsr     EraseFlash                  ; go erase flash
                     7177  ;*
                     7178  ;*  Returns:    nothing
                     7179  ;*
                     7180  ;*  Changes:    everything
                     7181  ;*
                     7182  EraseFlash:
 FC5C [03] 45003B    7183          ldhx    #EraseRamSize               ; initialize pointer
                     7184  EraseFlash1:
 FC5F [04] D6FD08    7185          lda     MassErase-1,x               ; get program from Flash
 FC62 [04] D701EC    7186          sta     ram_exec-1,x                ; copy into RAM
 FC65 [03] 5BF8      7187          dbnzx   EraseFlash1                 ; decrement pointer and loop back until done
 FC67 [03] CC01ED    7188          jmp     ram_exec                    ; execute Flash Mass Erase algorithm from RAM
                     7189  
                     7190  
                     7191  ;*  GetChar Subroutine  =====================================================================
                     7192  ;*
                     7193  ;*  This subroutine will wait forever for a character to be received by the SCI and then
                     7194  ;*  returns with that character in ACC.  No error checking is performed.  Note that this
                     7195  ;*  is the primary loop where the COP counter is cleared.
                     7196  ;*
                     7197  ;*  C function prototype:
                     7198  ;*
                     7199  ;*      char GetChar (void);
                     7200  ;*
                     7201  ;*  Calling convention:
                     7202  ;*
                     7203  ;*      jsr     GetChar                     ; get a character from the SCI
                     7204  ;*
                     7205  ;*  Returns:
                     7206  ;*      ACC= data
                     7207  ;*
                     7208  GetChar:
 FC6A [04] C7FFFF    7209          sta     copctl                      ; clear the COP counter
 FC6D [05] 0B16FA    7210          brclr   SCRF,scs1,GetChar           ; wait forever until SCI receiver is full
 FC70 [03] B618      7211          lda     scdr                        ; get data
 FC72 [04] 81        7212          rts                                 ; return
                     7213  
                     7214  
                     7215  ;*  GetSRec Subroutine  =====================================================================
                     7216  ;*
                     7217  ;*  This subroutine will retrieve data in S19 record format via the SCI.
                     7218  ;*
                     7219  ;*  Calling convention:
                     7220  ;*
                     7221  ;*      ais     #-buffer_length             ; allocate stack space for data
                     7222  ;*      jsr     GetSRec                     ; go get S-record data
                     7223  ;*
                     7224  ;*  Returns:    CCRZ= 1 if valid S-Record retrieved.  Otherwise, CCRZ= 0.
                     7225  ;*              S-Record Type at SP+1     (1 byte)
                     7226  ;*              S-Record Size at SP+2     (1 byte)
                     7227  ;*              S-Record Address at SP+3  (2 bytes)
                     7228  ;*              S-Record Data at SP+5     (up to 32 bytes, typically)
                     7229  ;*
                     7230  ;*              |                |    <-sp (after local space allocation)
                     7231  ;*      H:X->   | SRecCount      |
                     7232  ;*              | SRecChkSum     |    <-sp (when called)
                     7233  ;*              | ReturnAddr msb |
                     7234  ;*              | ReturnAddr lsb |    <-sp (upon return)
                     7235  ;*              | SRecType       |
                     7236  ;*              | SRecSize       |
                     7237  ;*      H:X->   | SRecAddr msb   |
                     7238  ;*              | SRecAddr lsb   |
                     7239  ;*              | SRecData 00    |
                     7240  ;*              | SRecData 01    |  etc..
                     7241  ;*
                     7242  ;*  Changes:    everything
                     7243  ;*
 FC73                7244  SRecCount:      equ     1                   ; stack pointer offset for S-Record Counter
 FC73                7245  SRecChkSum:     equ     2                   ; stack pointer offset for S-Record Check Sum
 FC73                7246  SRecType:       equ     5                   ; stack pointer offset for S-Record Type
 FC73                7247  SRecSize:       equ     6                   ; stack pointer offset for S-Record Size
 FC73                7248  SRecAddr:       equ     7                   ; stack pointer offset for S-Record Address
 FC73                7249  SRedData:       equ     8                   ; stack pointer offset for S-Record Data
                     7250  ;
                     7251  GetSRec:
 FC73 [02] A7FE      7252          ais     #-2                         ; allocate local variable space
 FC75 [04] 9E6F06    7253          clr     SRecSize,sp                 ; initialize S-Record size
                     7254  GetSRec1:
 FC78 [04] ADF0      7255          bsr     GetChar                     ; get a character from the SCI
 FC7A [02] A10D      7256          cmp     #ascii_CR                   ; check for ASCII carriage return
 FC7C [03] 2602      7257          bne     GetSRec1a                   ; just loop back if so
 FC7E [02] A60A      7258          lda     #ascii_LF                   ; get ASCII line feed
                     7259  GetSRec1a:
 FC80 [02] A153      7260          cmp     #'S'                        ; check for start of record character
 FC82 [03] 26F4      7261          bne     GetSRec1                    ; loop back if not
 FC84 [04] ADE4      7262          bsr     GetChar                     ; else, get next character from the SCI
 FC86 [02] A130      7263          cmp     #'0'                        ; check for header record type
 FC88 [03] 27EE      7264          beq     GetSRec1                    ; loop back if so
 FC8A [02] A139      7265          cmp     #'9'                        ; else, check for end record type
 FC8C [03] 2704      7266          beq     GetSRec2                    ; continue if so
 FC8E [02] A131      7267          cmp     #'1'                        ; else, check for data record type
 FC90 [03] 26E6      7268          bne     GetSRec1                    ; loop back if not
                     7269  GetSRec2:
 FC92 [04] 9EE705    7270          sta     SRecType,sp                 ; save S-Record type
 FC95 [04] AD3B      7271          bsr     GetHexByte                  ; get the S-Record length
 FC97 [03] 2622      7272          bne     GetSRec4                    ; exit if not a valid hex byte
 FC99 [04] 9EE701    7273          sta     SRecCount,sp                ; initialize S-Record counter
 FC9C [04] 9EE702    7274          sta     SRecChkSum,sp               ; initialize S-Record check sum
 FC9F [02] A003      7275          sub     #3                          ; adjust for address and checksum
 FCA1 [04] 9EE706    7276          sta     SRecSize,sp                 ; save S-Record size
 FCA4 [02] 95        7277          tsx                                 ; use H:X as data stack frame pointer
 FCA5 [02] AF06      7278          aix     #{SRecAddr-1}               ; adjust so pointer starts at S-Record Address
                     7279  GetSRec3:
 FCA7 [04] AD29      7280          bsr     GetHexByte                  ; get next S-Record hex byte
 FCA9 [03] 2610      7281          bne     GetSRec4                    ; exit if not a valid hex byte
 FCAB [02] F7        7282          sta     ,x                          ; save data in stack frame
 FCAC [04] 9EEB02    7283          add     SRecChkSum,sp               ; add data to check sum
 FCAF [04] 9EE702    7284          sta     SRecChkSum,sp               ; save new check sum
 FCB2 [02] AF01      7285          aix     #1                          ; move data stack frame pointer
 FCB4 [06] 9E6B01EF  7286          dbnz    SRecCount,sp,GetSRec3       ; loop back until all data has been received
 FCB8 [05] 9E6C02    7287          inc     SRecChkSum,sp               ; final calculation zeros check sum if it's okay
                     7288  GetSRec4:
 FCBB [02] A702      7289          ais     #2                          ; deallocate local variables
 FCBD [04] 81        7290          rts                                 ; return
                     7291  
                     7292  
                     7293  ;*  Help Command Response  ==================================================================
                     7294  ;*
                     7295  Boot5:
 FCBE [02] A148      7296          cmp     #cmd_help                   ; check for Help command
 FCC0 [03] 2704      7297          beq     Boot6                       ; continue if so
 FCC2 [02] A11F      7298          cmp     #cmd_help1                  ; check for alternate Help command
 FCC4 [03] 2606      7299          bne     Boot7                       ; skip if not
                     7300  boot6:
 FCC6 [03] 45FD90    7301          ldhx    #msg_help                   ; point to Help command message
 FCC9 [03] CCFBE9    7302          jmp     BootDone1                   ; go output it
                     7303  
                     7304  
                     7305  ;*  Unknown Command Response  ===============================================================
                     7306  ;*
                     7307  Boot7:
 FCCC [03] 45FDD7    7308          ldhx    #msg_what                   ; point to unknown command message
 FCCF [03] CCFBE9    7309          jmp     BootDone1                   ; go output it
                     7310  
                     7311  
                     7312  ;*  GetHexByte Subroutine  ==================================================================
                     7313  ;*
                     7314  ;*  This subroutine retrieves two ASCII bytes via the SCI and converts (packs) them into one
                     7315  ;*  hex byte, which is returned in ACC.
                     7316  ;*
                     7317  ;*  Calling convention:
                     7318  ;*
                     7319  ;*      jsr     GetHexByte
                     7320  ;*
                     7321  ;*  Returns:    CCRZ= 1 if valid hex byte retrieved.  Otherwise, CCRZ= 0.
                     7322  ;*              ACC= data
                     7323  ;*
                     7324  ;*  Changes:    ACC
                     7325  ;*
                     7326  GetHexByte:
 FCD2 [04] AD96      7327          bsr     GetChar                     ; get msb character from the SCI
 FCD4 [04] AD20      7328          bsr     IsHex                       ; check if valid ASCII hex character
 FCD6 [03] 2614      7329          bne     GetHexByte2                 ; exit if not
 FCD8 [04] AD13      7330          bsr     ToHex                       ; convert ASCII hex character to hex value
 FCDA [03] 62        7331          nsa                                 ; swap lower nibble up
 FCDB [02] 87        7332          psha                                ; save temporarily
 FCDC [05] CDFC6A    7333          jsr     GetChar                     ; get lsb character from the SCI
 FCDF [04] AD15      7334          bsr     IsHex                       ; check if valid ASCII hex character
 FCE1 [03] 2607      7335          bne     GetHexByte1                 ; exit if not
 FCE3 [04] AD08      7336          bsr     ToHex                       ; convert ASCII hex character to hex value
 FCE5 [04] 9EEB01    7337          add     1,sp                        ; combine msb and lsb nibbles
 FCE8 [02] A500      7338          bit     #0                          ; CCRZ= 1
                     7339  GetHexByte1:
 FCEA [02] A701      7340          ais     #1                          ; deallocate local variable
                     7341  GetHexByte2:
 FCEC [04] 81        7342          rts                                 ; return
                     7343  
                     7344  
                     7345  ;*  ToHex Subroutine  =======================================================================
                     7346  ;*
                     7347  ;*  This subroutine converts the ASCII hex value passed in ACC to a binary hex value.
                     7348  ;*
                     7349  ;*  Calling convention:
                     7350  ;*
                     7351  ;*      lda     data
                     7352  ;*      jsr     ToHex
                     7353  ;*
                     7354  ;*  Returns:    ACC= data.
                     7355  ;*
                     7356  ;*  Changes:    ACC
                     7357  ;*
                     7358  ToHex:
 FCED [02] A030      7359          sub     #'0'                        ; adjust first by subtracting '0'
 FCEF [02] A109      7360          cmp     #9                          ; check if value was between '0' to '9'
 FCF1 [03] 2302      7361          bls     ToHex1                      ; exit if so
 FCF3 [02] A007      7362          sub     #7                          ; else, adjust for value between 'A' to 'F'
                     7363  ToHex1:
 FCF5 [04] 81        7364          rts                                 ; return
                     7365  
                     7366  
                     7367  ;*  IsHex Subroutine  =======================================================================
                     7368  ;*
                     7369  ;*  This subroutine checks if the value passed in ACC is a valid ASCII hex character within
                     7370  ;*  within the ranges of '0' to '9' or 'A' to 'F'.  Note that the range 'a' to 'f' is not
                     7371  ;*  checked.
                     7372  ;*
                     7373  ;*  Calling convention:
                     7374  ;*
                     7375  ;*      lda     data
                     7376  ;*      jsr     IsHex
                     7377  ;*
                     7378  ;*  Returns:    CCRZ= 1 if data is a valid hex character.  Otherwise, CCRZ= 0.
                     7379  ;*
                     7380  ;*  Changes:    nothing
                     7381  ;*
                     7382  IsHex:
 FCF6 [02] A130      7383          cmp     #'0'                        ; check value against '0'
 FCF8 [03] 250E      7384          blo     IsntHex                     ; not hex if lower
 FCFA [02] A139      7385          cmp     #'9'                        ; check value against '9'
 FCFC [03] 2308      7386          bls     IsHex1                      ; is hex if lower
 FCFE [02] A141      7387          cmp     #'A'                        ; check value against 'A'
 FD00 [03] 2506      7388          blo     IsntHex                     ; not hex if lower
 FD02 [02] A146      7389          cmp     #'F'                        ; check value against 'F'
 FD04 [03] 2202      7390          bhi     IsntHex                     ; not hex if higher
                     7391  IsHex1:
 FD06 [02] A500      7392          bit     #0                          ; CCRZ= 1
                     7393  IsntHex:
 FD08 [04] 81        7394          rts                                 ; return
                     7395  
                     7396  
                     7397  ;*  Flash Mass Erase Subroutine  ============================================================
                     7398  ;*
                     7399  ;*  This subroutine performs multiple Page Erase operations in order to erase the application
                     7400  ;*  space Flash memory between "flash_first" and "flash_last".  This subroutine has been
                     7401  ;*  tuned for a bus speed of 7.3728 MHz.
                     7402  ;*  This subroutine is copied into and executed from RAM.
                     7403  ;*
                     7404  MassErase:
 FD09 [04] 5545      7405          ldhx    flash_last                  ; initialize pointer to last Flash memory address
 FD0B [03] 2023      7406          bra     MassErase2                  ; go move pointer before erasing Flash
                     7407  MassErase1:
                     7408  ;
                     7409  ;   Set ERASE, read the Flash Block Protect Register and write any data into Flash page.
                     7410  ;
 FD0D [02] A602      7411          lda     #{ERASE}                    ; set ERASE control bit
 FD0F [04] C7FE08    7412          sta     flcr                        ;  in Flash Control Register
 FD12 [04] C6FF7E    7413          lda     flbpr                       ; read from Flash Block Protect Register
 FD15 [02] F7        7414          sta     ,x                          ; write any data to address within page
                     7415  ;
                     7416  ;   Wait for >10us, then set HVEN.
                     7417  ;
 FD16 [02] A601      7418          lda     #1                          ; wait
 FD18 [04] AD1F      7419          bsr     delay                       ;  for 11.7us
 FD1A [02] A60A      7420          lda     #{ERASE | HVEN}             ; set HVEN control bit
 FD1C [04] C7FE08    7421          sta     flcr                        ;  in Flash Control Register
                     7422  ;
                     7423  ;   Wait for >1ms, then clear ERASE.
                     7424  ;
 FD1F [02] A664      7425          lda     #100                        ; wait
 FD21 [04] AD16      7426          bsr     delay                       ;  for 1.005ms
 FD23 [02] A608      7427          lda     #{HVEN}                     ; clear ERASE control bit
 FD25 [04] C7FE08    7428          sta     flcr                        ;  in Flash Control Register
                     7429  ;
                     7430  ;   Wait for >5us, then clear HVEN.
                     7431  ;
 FD28 [02] A601      7432          lda     #1                          ; wait
 FD2A [04] AD0D      7433          bsr     delay                       ;  for 11.7us
 FD2C [01] 4F        7434          clra                                ; clear HVEN control bit
 FD2D [04] C7FE08    7435          sta     flcr                        ;  in Flash Control Register
                     7436  ;
                     7437  ;   Advance pointer and repeat until finished.
                     7438  ;
                     7439  MassErase2:
 FD30 [02] AFC0      7440          aix     #-64                        ; move pointer back
 FD32 [02] AFC0      7441          aix     #-64                        ;  by one complete erase page
 FD34 [04] 7543      7442          cphx    flash_first                 ; check if finished
 FD36 [03] 22D5      7443          bhi     MassErase1                  ; loop back if not
                     7444  ;
 FD38 [04] 81        7445          rts                                 ; return
                     7446  
                     7447  
                     7448  ;*  Delay Subroutine  =======================================================================
                     7449  ;*
                     7450  ;*  This subroutine performs a simple software delay loop based upon the value passed in ACC.
                     7451  ;*  The following timing calculation applies:
                     7452  ;*
                     7453  ;*              delay = ((ACC * 74) + 12) (tcyc)
                     7454  ;*
                     7455  ;*  Calling convention:
                     7456  ;*
                     7457  ;*      lda     data
                     7458  ;*      jsr     delay
                     7459  ;*
                     7460  ;*  Returns:    nothing
                     7461  ;*
                     7462  ;*  Changes:    ACC
                     7463  ;*
                     7464  Delay:
 FD39 [02] 87        7465          psha                                ; [2] save outer delay loop parameter
                     7466  Delay1:
 FD3A [02] A616      7467          lda     #22                         ; [2] initialize inner delay loop counter
                     7468  Delay2:
 FD3C [03] 4BFE      7469          dbnza   Delay2                      ; [3] decrement inner delay loop counter
 FD3E [06] 9E6B01F8  7470          dbnz    1,sp,Delay1                 ; [6] decrement outer delay loop counter
 FD42 [02] 86        7471          pula                                ; [2] deallocate local variable
 FD43 [04] 81        7472          rts                                 ; [4] return
                     7473  
 FD44                7474  EraseRamSize:   equ     {*-MassErase}
 FD44                7475  ProgramRam:     equ     {*-Delay}
                     7476  
                     7477  
                     7478  ;*  Flash Program Subroutine  ===============================================================
                     7479  ;*
                     7480  ;*  This subroutine controls the Flash programming sequence.  A stack frame data block is
                     7481  ;*  passed to it in the format shown below.  This subroutine has been tuned for a bus speed
                     7482  ;*  of 7.3728 MHz.
                     7483  ;*  This subroutine is copied into and executed from RAM.
                     7484  ;*
                     7485  ;*              |                |    <-sp (when called)
                     7486  ;*              | ReturnAddr msb |
                     7487  ;*              | ReturnAddr lsb |    <-sp (upon return)
                     7488  ;*              | SRecSize       |
                     7489  ;*              | SRecAddr msb   |
                     7490  ;*              | SRecAddr lsb   |
                     7491  ;*              | SRecData 00    |
                     7492  ;*              | SRecData 01    |  etc..
                     7493  ;*
                     7494  FlashProgram:
 FD44 [02] 95        7495          tsx                                 ; get the Stack Pointer
 FD45 [04] 3541      7496          sthx    temp_sp                     ; save it temporarily
                     7497  ;
                     7498  ;   Get S-Record size and use the Stack Pointer as the data source pointer.
                     7499  ;
 FD47 [02] A702      7500          ais     #2                          ; SP points to SRecSize
 FD49 [02] 86        7501          pula                                ; get SRecSize
 FD4A [03] B740      7502          sta     count                       ; save it temporarily
                     7503  ;
                     7504  ;   Establish H:X as the destination pointer.
                     7505  ;
 FD4C [02] 8A        7506          pulh                                ; get destination address msb
 FD4D [02] 88        7507          pulx                                ; get destination address lsb
                     7508  
                     7509  FlashProgram1:
 FD4E [04] 7543      7510          cphx    flash_first                 ; check against minimum address
 FD50 [03] 252D      7511          blo     FlashProgram2               ; skip if lower
 FD52 [04] 7545      7512          cphx    flash_last                  ; check against maximum address
 FD54 [03] 2429      7513          bhs     FlashProgram2               ; skip if the same or higher
                     7514  ;
                     7515  ;   Set PGM, read the Flash Block Protect Register and write anywhere in desired Flash row.
                     7516  ;
 FD56 [02] A601      7517          lda     #{PGM}                      ; set PGM control bit
 FD58 [04] C7FE08    7518          sta     flcr                        ;  in Flash Control Register
 FD5B [04] C6FF7E    7519          lda     flbpr                       ; read from Flash Block Protect Register
 FD5E [02] F7        7520          sta     ,x                          ; write any data to first Flash address
                     7521  ;
                     7522  ;   Wait for >10us, then set HVEN.
                     7523  ;
 FD5F [02] A601      7524          lda     #1                          ; wait
 FD61 [04] ADD6      7525          bsr     delay                       ;  for 11.7us
 FD63 [02] A609      7526          lda     #{PGM | HVEN}               ; set HVEN control bit
 FD65 [04] C7FE08    7527          sta     flcr                        ;  in Flash Control Register
                     7528  ;
                     7529  ;   Wait for >5us.
                     7530  ;
 FD68 [02] A601      7531          lda     #1                          ; wait
 FD6A [04] ADCD      7532          bsr     delay                       ;  for 11.7us
                     7533  ;
                     7534  ;   Write data to Flash and wait for 30 - 40us.
                     7535  ;
 FD6C [02] 86        7536          pula                                ; get S-Record data
 FD6D [02] F7        7537          sta     ,x                          ; write data to Flash
 FD6E [02] A603      7538          lda     #3                          ; wait
 FD70 [04] ADC7      7539          bsr     delay                       ;  for 31.7us
                     7540  ;
                     7541  ;   Clear PGM.
                     7542  ;
 FD72 [02] A608      7543          lda     #{HVEN}                     ; clear PGM
 FD74 [04] C7FE08    7544          sta     flcr                        ;  in Flash Control Register
                     7545  ;
                     7546  ;   Wait for >5us, then clear HVEN.
                     7547  ;
 FD77 [02] A601      7548          lda     #1                          ; wait
 FD79 [04] ADBE      7549          bsr     delay                       ;  for 11.7us
 FD7B [01] 4F        7550          clra                                ; clear HVEN control bit
 FD7C [04] C7FE08    7551          sta     flcr                        ;  in Flash Control Register
                     7552  ;
                     7553  ;   Advance destination pointer and data counter.
                     7554  ;
                     7555  FlashProgram2:
 FD7F [02] AF01      7556          aix     #1                          ; advance destination pointer
 FD81 [05] 3B40CA    7557          dbnz    count,FlashProgram1         ; decrement counter and loop back if not done.
                     7558  ;
 FD84 [04] 5541      7559          ldhx    temp_sp                     ; restore
 FD86 [02] 94        7560          txs                                 ;  Stack Pointer
 FD87 [04] 81        7561          rts                                 ; return
                     7562  
 FD88                7563  ProgramRamSize: equ     {*-Delay}
                     7564  
                     7565  
                     7566  ;*  Messages  ===================================================================================
                     7567  ;*
 FD88                7568  ascii_CR:       equ     $0D                 ; ASCII carriage return
 FD88                7569  ascii_LF:       equ     $0A                 ; ASCII line feed
                     7570  ;
 FD88      0D0A426F  7571  msg_hello:      db      ascii_CR,ascii_LF,'Boot>',0
           6F743E00 
 FD90      20202850  7572  msg_help:       db      '  (P)rogram (W)ipe (U)pgrade e(X)it',0
           29726F67 
           72616D20 
           28572969 
           70652028 
           55297067 
           72616465 
           20652858 
           29697400 
                     7573  ;
 FDB4      2020436F  7574  msg_complete:   db      '  Complete',0
           6D706C65 
           746500 
 FDBF      202D2077  7575  msg_waiting:    db      ' - waiting ...',0
           61697469 
           6E67202E 
           2E2E00 
 FDCE      202D2065  7576  msg_error:      db      ' - error',0
           72726F72 
           00 
 FDD7      202D2077  7577  msg_what:       db      ' - what?',0
           6861743F 
           00 
 FDE0      202D2052  7578  msg_noreset:    db      ' - Reset Vector Invalid',0
           65736574 
           20566563 
           746F7220 
           496E7661 
           6C696400 
                     7579  
                     7580  ;
                     7581  ;   Last location not to exceed $FDFF
                     7582  ;
                     7583  BootEnd:
                     7584  
                     7585  
                     7586  ;*  Vectors  ************************************************************************************
                     7587  ;*
 FFDC                7588          org     vec_timebase                ; Timebase vector
 FFDC      FACA      7589          dw      user_timebase
 FFDE                7590          org     vec_adc                     ; ADC vector
 FFDE      FACD      7591          dw      user_ADC
 FFE0                7592          org     vec_kbd                     ; Keyboard vector
 FFE0      FAD0      7593          dw      user_keyboard
 FFE2                7594          org     vec_scitx                   ; SCI transmit vector
 FFE2      FAD3      7595          dw      user_SCItx
 FFE4                7596          org     vec_scirx                   ; SCI receive vector
 FFE4      FAD6      7597          dw      user_SCIrx
 FFE6                7598          org     vec_scierr                  ; SCI error vector
 FFE6      FAD9      7599          dw      user_SCIerr
 FFE8                7600          org     vec_spitx                   ; SPI transmit vector
 FFE8      FADC      7601          dw      user_SPItx
 FFEA                7602          org     vec_spirx                   ; SPI receive vector
 FFEA      FADF      7603          dw      user_SPIrx
 FFEC                7604          org     vec_tim2ov                  ; Timer 2 overflow vector
 FFEC      FAE2      7605          dw      user_Tim2Ov
 FFEE                7606          org     vec_tim2ch1                 ; Timer 2 channel 1 vector
 FFEE      FAE5      7607          dw      user_Tim2Ch1
 FFF0                7608          org     vec_tim2ch0                 ; Timer 2 channel 0 vector
 FFF0      FAE8      7609          dw      user_Tim2Ch0
 FFF2                7610          org     vec_tim1ov                  ; Timer 1 oveflow vector
 FFF2      FAEB      7611          dw      user_Tim1Ov
 FFF4                7612          org     vec_tim1ch1                 ; Timer 1 channel 1 vector
 FFF4      FAEE      7613          dw      user_Tim1Ch1
 FFF6                7614          org     vec_tim1ch0                 ; Timer 1 channel 0 vector
 FFF6      FAF1      7615          dw      user_Tim1Ch0
 FFF8                7616          org     vec_pll                     ; PLL vector
 FFF8      FAF4      7617          dw      user_PLL
 FFFA                7618          org     vec_irq                     ; IRQ vector
 FFFA      FAF7      7619          dw      user_IRQ
 FFFC                7620          org     vec_swi                     ; SWI vector
 FFFC      FAFA      7621          dw      user_SWI
 FFFE                7622          org     vec_reset                   ; Reset vector
 FFFE      FB08      7623          dw      BootReset
                     7624  
                     7625  
                     7626  ;*  Flash Block Protect Register  ***************************************************************
                     7627  ;*
 FF7E                7628          org     flbpr
 FF7E      F6        7629          db      flash_protect
                     7630  
 FF7F                7631          end
                     7632  
 FF7F                7633  flash_1_size        equ {flash_table1_end-flash_table1}
 FF7F                7634  flash_2_size        equ {flash_table2_end-flash_table2}
 FF7F                7635  flash_3_size        equ {flash_table3_end-flash_table3}
 FF7F                7636  flash_4_size        equ {flash_table4_end-flash_table4}
 FF7F                7637  flash_5_size        equ {flash_table5_end-flash_table5}
                     7638  
 FF7F                7639       end
                     7640  
                     7641  ;***********************************************************************************************
                     7642  ; This marks the end of the program
                     7643  ;***********************************************************************************************
                     7644   

 Symbol Table 

ACCLLED          0001
ACK              0002
ACKK             0002
ACMULT           E429
ACQ              0005
ADCC             0001
ADCH0            0000
ADCH1            0001
ADCH2            0002
ADCH3            0003
ADCH4            0004
ADCLK            003E
ADCO             0005
ADCWAIT          832F
ADCWAIT2         833A
ADC_DONE         8473
ADC_ISR          8D39
ADC_LOOKUPS      83FC
ADD_TO_AE        871F
ADICLK           0004
ADIV0            0005
ADIV1            0006
ADIV2            0007
ADR              003D
ADSCR            003C
ADSEL            006E
AE_COMP_SHOOT_AM 869E
AFR1_F           E200
AFR1_R           00E0
AFR2_F           E300
AFR2_R           00E0
AIEN             0006
AIOT             0000
AIOTCNTR         00CA
AIOT_CHK_DONE    8A35
AIOT_OFF         8A33
AIRCOR           004C
AIRDENFACTOR     F300
ALARMBITS        0064
ALED             0001
ALTCOUNT         0082
ALTERNATE        E425
ASCII_CR         000D
ASCII_LF         000A
ASE1             863F
ASECOUNT         007F
ASEHI            E42F
ASELO            E430
ASETYPE          E437
ASE_END          8665
AUTO             0007
AV_DONE          8DB1
AV_HI_RES_PERIOD 8544
AWC              E41F
AWEV             E41E
BARO             0048
BAROCOR          004A
BAROFAC4250RJH   F000
BAROMETER        0049
BATT             0045
BATTCNT          00D8
BATTFAC          E427
BATTTH           00D6
BATTTL           00D7
BATT_AV          8D5D
BATT_CNT         8D47
BATT_CORR_COMP   88A4
BCFE             0007
BCS              0004
BKF              0001
BLANK1           00DC
BLANK2           00DD
BLANK3           00DE
BLANK4           00DF
BNKFLOWH         E435
BNKFLOWHMV       0067
BNKFLOWL         E436
BNKFLOWLMV       0068
BOOT             FBBB
BOOT1            FBD9
BOOT2            FBE0
BOOT3            FBFC
BOOT4            FC4A
BOOT5            FCBE
BOOT6            FCC6
BOOT7            FCCC
BOOTDONE         FBE6
BOOTDONE1        FBE9
BOOTDONE2        FBEB
BOOTEND          FDF8
BOOTPROG         FC04
BOOTPROG1        FC07
BOOTPROG2        FC14
BOOTPROG3        FC2D
BOOTPROG4        FC31
BOOTPROG5        FC42
BOOTPROG6        FC47
BOOTRESET        FB08
BOOTRESET1       FB59
BOOTRESET2       FB75
BOOTRESET3       FB7E
BOOTRESET4       FB87
BOOTRESET5       FB98
BOOTRESET6       FBA5
BOOTRESETUSER    FBA5
BOOT_START       FB00
BRKA             0006
BRKE             0007
BRKH             FE09
BRKL             FE0A
BRKSCR           FE0B
BURNCONST        8FD8
BURNCOUNT        00C8
BURNDST          00C6
BURNSRC          00C2
BURN_CONT        8FDF
BUS7372800       FB00
BUS8003584       FB04
B_LO_CONT        86D2
CALC_OFF_OC      8BBD
CANT_CRANK       0004
CANT_DELAY       0005
CANT_OFF         8B97
CANT_SET         8B93
CGMCHANGE        FB39
CH1_OFFH         00BC
CH1_OFFL         00BD
CH1_ONH          00B4
CH1_ONL          00B5
CHECK_ASE_HI     85EE
CHECK_ASE_LO     85E7
CHECK_GREATER_TH 8E3E
CHECK_LESS_THAN  8E36
CHECK_PIPN       89B6
CHECK_STALL      8A44
CHECK_TXCMD      8C31
CHK_LO_SPD_DONE  851F
CHK_MON_DIS      83B4
CHK_MON_EN       8DD6
CHK_MON_HI       83CA
CHK_MON_LO       8DF8
CHK_SPD_LO       8DDB
CHK_TRM_DONE     844A
CHK_VS_HI        83B9
CHXF             0007
CHXIE            0006
CHXMAX           0000
CLEARRAM         81BF
CLOCK100         0004
CLOCK250         0005
CLOCK500         0006
CLT              0043
CMD_ERASE        0057
CMD_EXIT         0058
CMD_HELP         0048
CMD_HELP1        001F
CMD_PROGRAM      0050
CMD_UPGRADE      0055
COCO             0007
CONFIG1          001F
CONFIG2          001E
CONT_TX          8CFF
COOLANT          006D
COP              0005
COPCTL           FFFF
COUNT            0040
CPHA             0003
CPOL             0004
CRANK            0001
CRANK_CHK        89FB
CT_CNT           E42D
CWH              E41D
CWU              E41C
DBCOR            E434
DDRA             0004
DDRB             0005
DDRC             0006
DDRD             0007
DDRE             000C
DEADBAND         0073
DECRMT           8EE8
DELAY            FD39
DELAY1           FD3A
DELAY2           FD3C
DELAY_DONE       83F6
DELAY_PH         00B2
DELAY_PL         00B3
DFC_EN           0002
DFC_RPM          E432
DFC_TPS          E433
DIVIDEND         008A
DIVIDER          E424
DIVISOR          008C
DIVROUND         8F12
DIVROUND0        8F22
DIVROUND1        8F24
DIVROUND2        8F1F
DLY_ANG_CALC_DON 89A8
DLY_ANG_FAC      005C
DMARE            0005
DMATE            0004
DONE_BYTE        8D10
DONE_LOAD        8D2D
DONE_RCV         8CC5
DONE_WITH_INTERP 8E85
DO_100MS         8B14
DO_100MS_COUNT   8B20
DO_250MS         8B2C
DO_250MS_COUNT   8B3A
DO_500MS         8B4C
DO_500MS_COUNT   8B5A
DO_ASE           85F3
DO_FUEL          89DA
DO_IGN_COUNT     89D8
DO_INTERP        8E49
DO_MON           8DFD
DO_SEC           8B66
DO_SEC_COUNT     8B72
DUMMY            8E15
EGO              0046
EGOCNT           00DB
EGOTH            00D9
EGOTL            00DA
EGO_AV           8D93
EGO_CNT          8D7D
ELSXA            0002
ELSXB            0003
END_AE_LONGBRANC 86D6
ENGINE           0063
ENGINE2          0069
ENG_START        8579
ENSCI            0006
EN_KYBD_DONE     83D9
EN_XMIT          8CBF
ERASE            0002
ERASEFLASH       FC5C
ERASEFLASH1      FC5F
ERASERAMSIZE     003B
ERRIE            0006
EXITSN           8F7A
FAST_RPM_CALC    84F5
FD               0055
FDCNTR           00C9
FDHRH            0071
FDHRL            0072
FDSECH           0056
FDSECL           0057
FDTH             00CB
FDTL             00CC
FE               0001
FEIE             0001
FINALNORM        8F52
FINAL_PW_CALC    88CA
FIN_TX           8D0A
FIRE_ADC         8AFA
FIRING1          0003
FIRING2          0005
FLASHPROGRAM     FD44
FLASHPROGRAM1    FD4E
FLASHPROGRAM2    FD7F
FLASH_1_SIZE     00A8
FLASH_2_SIZE     00A8
FLASH_3_SIZE     00A8
FLASH_4_SIZE     00A8
FLASH_5_SIZE     0038
FLASH_ERASED     00FF
FLASH_FIRST      0043
FLASH_LAST       0045
FLASH_PAGE       0080
FLASH_PROTECT    00F6
FLASH_ROW        0040
FLASH_TABLE1     E000
FLASH_TABLE1_END E0A8
FLASH_TABLE2     E100
FLASH_TABLE2_END E1A8
FLASH_TABLE3     E200
FLASH_TABLE3_END E2A8
FLASH_TABLE4     E300
FLASH_TABLE4_END E3A8
FLASH_TABLE5     E400
FLASH_TABLE5_END E438
FLBPR            FF7E
FLCR             FE08
FLDCLR           0002
FLOCKER          00C5
FLOODCLEAR       E428
FLOOD_CLEAR      8590
FPON             0000
FTEN             0005
FTRIMCALC        8432
FTRIMCOR         004D
FTRM_ON          83A5
FUELP            0000
GAMMAE           004E
GETCHAR          FC6A
GETHEXBYTE       FCD2
GETHEXBYTE1      FCEA
GETHEXBYTE2      FCEC
GETSREC          FC73
GETSREC1         FC78
GETSREC1A        FC80
GETSREC2         FC92
GETSREC3         FCA7
GETSREC4         FCBB
GET_TIMESTAMP    89AC
GOT_ORD_NUM      8E30
HI_RES_TACH      852D
HI_RES_TACH_DONE 856F
HVEN             0008
IDLE             0004
IGNCOUNT         0081
IGNITION_CALCS   847B
IGN_MON          0004
IGN_SEQ_DONE     8BD7
ILAD             0003
ILIE             0004
ILOP             0004
ILTY             0002
IMASK            0001
IMASKK           0001
INC_CUS          8AF2
INC_CUS_JMP      8ABC
INC_MS           8B00
INC_SEC          8B99
INC_VS_CNTR      8A35
INIT_CONFIG1     0001
INIT_CONFIG2     0001
INIT_FIRST       8000
INIT_LAST        FB00
INIT_SCBR        0012
INIT_SCC1        0040
INIT_SCC2        000C
INIT_STACK       01EC
INJ1             0000
INJ2             0001
INJECT1          0004
INJECT2          0005
INJF1            8A83
INJF2            8A86
INJOPEN          E426
INJSTRT          8A65
INJ_FIRE_CNTL    8A5C
INJ_FIRE_CNTL_DO 8AF2
INPUTS           006B
INT1             FE04
INT2             FE05
INT3             FE06
INTACC1          0088
INTACC2          008C
INTERP_CRANK_PW  859F
INTERP_PRIME_PW  834C
INTKBIER         001B
INTKBSCR         001A
INTSCR           001D
IN_A_OR_C_MODE   8CE8
IN_Q_MODE        8CFC
IN_S_MODE        8CF7
IN_T_MODE        8CF2
IN_V_MODE        8CEC
IRQF             0003
IRQ_DONE         8A18
IRQ_ISR          89AB
ISHEX            FCF6
ISHEX1           FD06
ISNTHEX          FD08
ITRM_ON          83AC
KBIE0            0000
KBIE1            0001
KBIE2            0002
KBIE3            0003
KBIE4            0004
KBIE5            0005
KBIE6            0006
KBIE7            0007
KEYBD_DONE       8E14
KEYF             0003
KNK_DET          0006
KNOCKING         0000
KNOCK_DONE       839A
KNOCK_ON         8395
KPA              006C
KPAFACTOR4250RJH F100
KPARANGEAFR1_F   E29C
KPARANGEAFR1_R   017C
KPARANGEAFR2_F   E39C
KPARANGEAFR2_R   017C
KPARANGEST_F     E19C
KPARANGEST_R     017C
KPARANGEVE_F     E09C
KPARANGEVE_R     017C
KYBD_ISR         8DD1
LAST_TPS         0080
LININTERP        8E31
LOAD_TABLE       8D22
LOCK             0006
LOOPCHK          0007
LOOPCHK_DONE     838B
LOOPCOUNTER      00C0
LOOPER           8381
LOOPS            0007
LOOP_DONE        89A8
LVI              0001
LVIOUT           0007
LVISR            FE0C
M                0004
MAP              0041
MASS             0004
MASSERASE        FD09
MASSERASE1       FD0D
MASSERASE2       FD30
MAT              0042
MBFF             88C0
MINPIP           00C1
MINPIP_DONE      83A0
MODE             0000
MODEK            0000
MODE_A           8C62
MODE_B           8C6C
MODE_C           8C80
MODE_P           8C8A
MODE_Q           8C8F
MODE_R           8C62
MODE_S           8CB8
MODE_T           8CAF
MODE_V           8C99
MODE_W           8CA4
MODE_X           8CAA
MODF             0004
MODFEN           0002
MODRST           0002
MONEN            0002
MON_PH           0060
MON_PL           0061
MON_TSH          00BE
MON_TSL          00BF
MS               007B
MSG_COMPLETE     FDB4
MSG_ERROR        FDCE
MSG_HELLO        FD88
MSG_HELP         FD90
MSG_NORESET      FDE0
MSG_WAITING      FDBF
MSG_WHAT         FDD7
MSX100           007A
MSX250           0079
MSXA             0004
MSXB             0005
MS_DELAY         9051
MS_DELAY1        9052
MS_DELAY2        9054
MS_ERASEFLASH    900D
MS_ERASEFLASH1   9010
MS_ERASERAMSIZE  0031
MS_FLASHPROGRAM  905C
MS_FLASHPROGRAM1 905C
MS_FLASHPROGRAM2 908B
MS_MASSERASE     902B
MS_PROGRAMFLASH  901C
MS_PROGRAMFLASH1 901F
MS_PROGRAMRAM    000B
MS_PROGRAMRAMSIZ 004A
MS_RAM_END       00E0
MS_RAM_SIZE      00A0
MS_RAM_START     0040
MS_RF_END        0188
MS_RF_SIZE       00A8
MS_RF_START      00E0
MS_TOTAL_RAM_SIZ 0148
NDA1             8718
NEG_SLOPE        8E78
NEIE             0002
NEW_SQUIRT1      8A88
NEW_SQUIRT2      8ABE
NF               0002
NOT_BATT_EGO     8DBA
NO_100MS_COUNT   8B22
NO_250MS_COUNT   8B3C
NO_500MS_COUNT   8B5C
NO_ADC_PASS      8475
NO_ASE           85F9
NO_CLOCK_PASS    879A
NO_IGN_COUNT     89DA
NO_PIP_PASS      857D
NO_SEC_COUNT     8B74
NO_WARMUP        85DF
ODO              00CF
ODOSEC           005D
OFF_DELAY        8BCA
OR               0003
ORD_TABLE_FIND   8E16
ORIE             0003
OVRF             0005
PAGE             00C4
PAGESIZE         00A8
PBWC             0037
PCTL             0036
PE               0000
PEIE             0000
PEN              0001
PGM              0001
PIN              0006
PIPRISE          0000
PIP_ANGLE        E42C
PIP_OK           89BE
PIP_PASS         847B
PIP_PASS_DONE    857B
PIP_PERIODH      00B8
PIP_PERIODL      00B9
PIP_PH           00AE
PIP_PH_DIF       00AC
PIP_PH_PRED      00B0
PIP_PH_PRV       00AA
PIP_PL           00AF
PIP_PL_DIF       00AD
PIP_PL_PRED      00B1
PIP_PL_PRV       00AB
PIP_TSH          00A6
PIP_TSH_PRV      00A8
PIP_TSL          00A7
PIP_TSL_PRV      00A9
PLLF             0006
PLLIE            0007
PLLON            0005
PLLSET           FB3D
PLLWAIT          FB4D
PLL_WAIT         8140
PMDS             003B
PMRS             003A
PMSH             0038
PMSL             0039
POR              0007
PORTA            0000
PORTABITS        0065
PORTB            0001
PORTC            0002
PORTCBITS        0066
PORTD            0003
PORTE            0008
POSINTERP        8E5C
PRE0             0002
PRE1             0003
PRH              E42B
PRINTSTRING      FBF8
PRINTSTRING1     FBF3
PROGRAMRAM       000B
PROGRAMRAMSIZE   004F
PRU              E42A
PS0              0000
PS1              0001
PS2              0002
PTAPUE           000D
PTCPUE           000E
PTDPUE           000F
PTY              0000
PUTCHAR          FB53
PUTSTRING        FBED
PW               0054
PWCALCH          0052
PWCALCL          0053
PWNADH           006F
PWNADL           0070
QUOTIENT         0088
R8               0007
RAILCALC         8F77
RAIL_DL_ANG_FAC  89A4
RAM_EXEC         01ED
RAM_LAST         023F
RAM_START        0040
RE               0002
REENT            8E1D
REMAINDER        0088
REQ_FUEL         E423
REVL             0001
REVNUM           8F97
REV_LIMIT        850E
REV_LIM_DONE     8513
ROM_LAST         FDFF
ROM_START        8000
ROUNDREM         8F42
RPF              0000
RPM20            0050
RPMCH            0077
RPMCL            0078
RPMPH            0075
RPMPL            0076
RPMRANGEAFR1_F   E290
RPMRANGEAFR1_R   0170
RPMRANGEAFR2_F   E390
RPMRANGEAFR2_R   0170
RPMRANGEST_F     E190
RPMRANGEST_R     0170
RPMRANGEVE_F     E090
RPMRANGEVE_R     0170
RPM_CALC_DONE    8501
RPM_CNTR_DONE    8A41
RPM_PERIOD       89BE
RST_ACCEL        8734
RUN              0000
RUNNING          0000
RUN_SET          89E3
RWU              0001
RXOFFSET         0087
SBFCR            FE03
SBK              0000
SBSR             FE00
SBSW             0001
SCBR             0019
SCC1             0013
SCC2             0014
SCC3             0015
SCDR             0018
SCHED1           0002
SCHED2           0004
SCHEDSPK         0001
SCHED_BOTH       8A14
SCHED_INJ1       8A08
SCHED_INJ2       8A0E
SCHED_SQUIRT     89F9
SCIRCV_ISR       8BD9
SCITX_ISR        8CC7
SCRF             0005
SCRIE            0005
SCS1             0016
SCS2             0017
SCTE             0007
SCTIE            0007
SECH             007D
SECL             0040
SETLSB           8EE6
SET_FUEL_CUT     8782
SET_LOOPCHK      8389
SET_LO_OC        8BB3
SET_RUN_E2       851D
SET_SPOUT_HI     83E2
SHFTLP           8EAA
SIGNATURE        8FB8
SLOW_SPOUT_DONE  83E4
SPARK            0001
SPARKING         0002
SPCR             0010
SPDR             0012
SPE              0001
SPK_ANG_FAC      005A
SPMSTR           0005
SPOUTON_PH       00BA
SPOUTON_PL       00BB
SPOUT_TSH        00B6
SPOUT_TSL        00B7
SPR0             0000
SPR1             0001
SPRF             0007
SPRIE            0007
SPSCR            0011
SPTE             0003
SPTIE            0000
SPWOM            0002
SQUIRT           006A
SRECADDR         0007
SRECCHKSUM       0002
SRECCOUNT        0001
SRECSIZE         0006
SRECTYPE         0005
SREDDATA         0008
SRSR             FE01
START            8128
STARTED          0003
STARTW           0002
STAT_TIM_ANG     000A
STB_ADC          8327
ST_F             E100
ST_R             00E0
SUBAR            FE02
SUPERNORM        8F25
T1CH0H           0026
T1CH0L           0027
T1CH1H           0029
T1CH1L           002A
T1CNTH           0021
T1CNTL           0022
T1MODH           0023
T1MODL           0024
T1SC             0020
T1SC0            0025
T1SC1            0028
T2CH0H           0031
T2CH0L           0032
T2CH1H           0034
T2CH1L           0035
T2CNTH           002C
T2CNTL           002D
T2MODH           002E
T2MODL           002F
T2SC             002B
T2SC0            0030
T2SC1            0033
T8               0006
TACHCNT          00D5
TACHCURH         00D0
TACHCURL         00D1
TACHH            0058
TACHL            0059
TACHTH           00D2
TACHTL           00D4
TACHTM           00D3
TACK             0003
TAE              8669
TAE_CHK_TIME     872B
TBCR             001C
TBIE             0002
TBIF             0007
TBON             0001
TBR0             0004
TBR1             0005
TBR2             0006
TC               0006
TCIE             0006
TDE              8755
TDE2             86D4
TDE_CHK_DONE     878D
TDE_CHK_FUEL_CUT 8771
TDE_DONE         8798
TE               0003
TEMP_SP          0041
TEXTVERSION_F    8F98
THERMFACTOR      F200
TIM2CH0_ISR      8A1C
TIM2CH0_ISR_DONE 8BA1
TIM2CH0_ISR_JMP  8B64
TIM2CH1_ISR      8BA3
TMP1             0090
TMP10            0099
TMP11            009A
TMP12            009B
TMP13            009C
TMP14            009D
TMP15            009E
TMP16            009F
TMP17            00A0
TMP18            00A1
TMP19            00A2
TMP2             0091
TMP20            00A3
TMP21            00A4
TMP22            00A5
TMP3             0092
TMP4             0093
TMP5             0094
TMP6             0095
TMP7             0096
TMP8             0097
TMP9             0098
TOF              0007
TOHEX            FCED
TOHEX1           FCF5
TOIE             0006
TOTALIZER1       8AB2
TOTALIZER2       8AE8
TOTALIZER_DONE1  8ABA
TOTALIZER_DONE2  8AF0
TOVX             0001
TPS              0044
TPSACCEL         004F
TPSACLK          007E
TPSACLKCMP       0083
TPSACOLD         E420
TPSAEN           0004
TPSAQ            E418
TPSASYNC         E422
TPSDEN           0005
TPSDOTRATE       E414
TPSDQ            E431
TPSFUELCUT       0074
TPSP             0062
TPSTHRESH        E421
TRIM             0047
TRMSEL_DONE      83B1
TRM_ANG_FAC      005B
TRM_SEL          0005
TRST             0004
TSTOP            0005
TXCNT            0084
TXGOAL           0085
TXINV            0005
TXMODE           0086
TXMODE_5         8BFB
TXMODE_6         8C03
TXMODE_7         8C0F
TXMODE_8         8C17
TXMODE_9         8C1F
TXMODE_9_CONT    8C2E
TXMODE_C         8D12
TXMODE_C1        8BF8
TX_DONE          8D33
UDVD32           8E86
UPPER_RAIL_AE    871B
USER_ADC         FACD
USER_CONFIG1     FAC4
USER_CONFIG2     FAC5
USER_FIRST       FAC6
USER_IRQ         FAF7
USER_KEYBOARD    FAD0
USER_LAST        FAC8
USER_PLL         FAF4
USER_RESET       FAFD
USER_SCBR        FAC3
USER_SCIERR      FAD9
USER_SCIRX       FAD6
USER_SCITX       FAD3
USER_SPIRX       FADF
USER_SPITX       FADC
USER_SWI         FAFA
USER_TIM1CH0     FAF1
USER_TIM1CH1     FAEE
USER_TIM1OV      FAEB
USER_TIM2CH0     FAE8
USER_TIM2CH1     FAE5
USER_TIM2OV      FAE2
USER_TIMEBASE    FACA
USX100           007C
VE1X             8F7B
VE1XC            8F88
VE1XF            8F85
VE2X             8F89
VE2XC            8F96
VE2XF            8F93
VECURR           0051
VEC_ADC          FFDE
VEC_IRQ          FFFA
VEC_KBD          FFE0
VEC_PLL          FFF8
VEC_RESET        FFFE
VEC_SCIERR       FFE6
VEC_SCIRX        FFE4
VEC_SCITX        FFE2
VEC_SPIRX        FFEA
VEC_SPITX        FFE8
VEC_SWI          FFFC
VEC_TIM1CH0      FFF6
VEC_TIM1CH1      FFF4
VEC_TIM1OV       FFF2
VEC_TIM2CH0      FFF0
VEC_TIM2CH1      FFEE
VEC_TIM2OV       FFEC
VEC_TIMEBASE     FFDC
VEH_SPD          0003
VE_F             E000
VE_R             00E0
VPR0             0000
VPR1             0001
VSCH             00CD
VSCL             00CE
VSEN             0003
VS_CNTR_DONE     8A3B
VS_PH            005E
VS_PL            005F
WAKE             0003
WARMCOR          004B
WARMUP           0003
WARM_UP_ENRICH   85CA
WLED             0002
WMLED            0002
WOT_CNT          E42E
WUE1             85FD
WUE2             8605
WUE3             863B
WUE_ASE_DONE     8669
WWU              E40A
WWURANGE         E400
ZERO_SLOPE       8E83
